═══════════════════════════════════════════════════════════════════════════════
  UPDATE SERVER v2.1.14 - FIX EXCEL IMPORT & CLEANUP DATA
═══════════════════════════════════════════════════════════════════════════════

📌 IMPORTANT: Backup database dulu sebelum update!
┌─────────────────────────────────────────────────────────────────────────────┐
│ ⚠️  Migration ini akan hapus customer dengan format CUST-*                   │
└─────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
🔄 QUICK UPDATE (COPY-PASTE)
═══════════════════════════════════════════════════════════════════════════════

cd /opt/billing && \
git pull origin main && \
npm install && \
npm run build && \
npm install --production && \
pm2 restart billing-app --update-env

# Setelah itu, jalankan migration:
mysql -u root -p billing < migrations/fix_customer_code_format.sql

═══════════════════════════════════════════════════════════════════════════════
📋 DETAILED UPDATE STEPS
═══════════════════════════════════════════════════════════════════════════════

1. Backup Database (WAJIB!):
   ──────────────────────────────────────────────────────────────────────────
   mysqldump -u username -p nama_database > backup_$(date +%Y%m%d_%H%M%S).sql

2. Masuk ke Direktori Aplikasi:
   ──────────────────────────────────────────────────────────────────────────
   cd /opt/billing

3. Git Pull:
   ──────────────────────────────────────────────────────────────────────────
   git pull origin main

4. Install Dependencies:
   ──────────────────────────────────────────────────────────────────────────
   npm install

5. Build TypeScript:
   ──────────────────────────────────────────────────────────────────────────
   npm run build

6. Install Production Dependencies:
   ──────────────────────────────────────────────────────────────────────────
   npm install --production

7. Restart PM2:
   ──────────────────────────────────────────────────────────────────────────
   pm2 restart billing-app --update-env

8. Check Status:
   ──────────────────────────────────────────────────────────────────────────
   pm2 status
   pm2 logs billing-app --lines 50

9. Run Migration (PENTING!):
   ──────────────────────────────────────────────────────────────────────────
   mysql -u username -p database_name < migrations/fix_customer_code_format.sql

═══════════════════════════════════════════════════════════════════════════════
✨ FITUR BARU v2.1.14
═══════════════════════════════════════════════════════════════════════════════

🔧 FIX EXCEL IMPORT
─────────────────────────────────────────────────────────────────────────────
✅ Tidak lagi double data saat import Excel
✅ Format customer_code: YYYYMMDDHHMMSS (konsisten)
✅ Menggunakan CustomerIdGenerator seperti PPPoE/Static IP

🗑️ DATA CLEANUP
─────────────────────────────────────────────────────────────────────────────
✅ Hapus customer dengan format CUST-* (format lama salah)
✅ Migration otomatis cleanup data tidak valid
✅ Konsistensi data across all customer types

🎯 CHANGES:
─────────────────────────────────────────────────────────────────────────────
• Excel import: CUST-{ts}-{random} → YYYYMMDDHHMMSS
• Semua import sekarang format sama
• No more duplicate data issue

═══════════════════════════════════════════════════════════════════════════════
⚠️  PENTING UNTUK DIKETAHUI
═══════════════════════════════════════════════════════════════════════════════

BEFORE MIGRATION:
─────────────────────────────────────────────────────────────────────────────
• Check data yang akan dihapus: `SELECT * FROM customers WHERE customer_code LIKE 'CUST-%'`
• Pastikan backup database sudah dijalankan
• Customer dengan format CUST-* akan dihapus

AFTER MIGRATION:
─────────────────────────────────────────────────────────────────────────────
• Verify: `SELECT COUNT(*) FROM customers WHERE customer_code LIKE 'CUST-%'` (should be 0)
• Test Excel import untuk memastikan tidak double
• All new customers format YYYYMMDDHHMMSS

BENEFITS:
─────────────────────────────────────────────────────────────────────────────
✅ Excel import lebih reliable
✅ Konsistensi data
✅ No duplicate customer issue
✅ Format standardized

═══════════════════════════════════════════════════════════════════════════════
🧪 VERIFICATION QUERIES
═══════════════════════════════════════════════════════════════════════════════

Pre-Migration Check:
─────────────────────────────────────────────────────────────────────────────
SELECT customer_code, COUNT(*) as count, name
FROM customers 
WHERE customer_code LIKE 'CUST-%'
GROUP BY customer_code
ORDER BY count DESC;

-- Lihat customer mana yang akan dihapus

Post-Migration Verification:
─────────────────────────────────────────────────────────────────────────────
-- Should return 0
SELECT COUNT(*) as invalid_count 
FROM customers 
WHERE customer_code LIKE 'CUST-%';

-- All should have 14-digit format
SELECT COUNT(*) as total,
       SUM(CASE WHEN LENGTH(customer_code) = 14 THEN 1 ELSE 0 END) as valid_count,
       SUM(CASE WHEN LENGTH(customer_code) != 14 THEN 1 ELSE 0 END) as invalid_count
FROM customers;

═══════════════════════════════════════════════════════════════════════════════
🚨 TROUBLESHOOTING
═══════════════════════════════════════════════════════════════════════════════

Problem: Excel import masih double
Solution:
─────────────────────────────────────────────────────────────────────────────
1. Check PM2 status: pm2 status
2. Check logs: pm2 logs billing-app --lines 100
3. Verify migration completed
4. Test import dengan data kecil dulu
5. Check browser console untuk errors

Problem: Customer hilang setelah migration
Solution:
─────────────────────────────────────────────────────────────────────────────
1. Check backup database
2. Verify which customers were deleted: should only be CUST-* format
3. Check logs untuk error messages
4. Restore from backup jika perlu

Problem: Migration error - foreign key constraint
Solution:
─────────────────────────────────────────────────────────────────────────────
1. Check which customers have related data
2. Backup those specific customers
3. Run migration
4. Restore if needed

═══════════════════════════════════════════════════════════════════════════════
📁 FILES CHANGED
═══════════════════════════════════════════════════════════════════════════════

Modified Files:
─────────────────────────────────────────────────────────────────────────────
✅ src/controllers/excelController.ts - Use CustomerIdGenerator
✅ migrations/fix_customer_code_format.sql - Add CUST-* cleanup

New Files:
─────────────────────────────────────────────────────────────────────────────
✅ migrations/cleanup_invalid_customers.sql
✅ CHANGELOG_v2.1.14.md
✅ UPDATE_SERVER_v2.1.14.txt (file ini)

Version Files:
─────────────────────────────────────────────────────────────────────────────
✅ VERSION, VERSION_MAJOR, VERSION_HOTFIX
✅ package.json

═══════════════════════════════════════════════════════════════════════════════
✅ UPDATE SELESAI
═══════════════════════════════════════════════════════════════════════════════

Check Version:
─────────────────────────────────────────────────────────────────────────────
cat VERSION
# Should show: 2.1.14

Check PM2:
─────────────────────────────────────────────────────────────────────────────
pm2 status
pm2 logs billing-app --lines 20

Verify Migration:
─────────────────────────────────────────────────────────────────────────────
mysql -u username -p database_name -e "SELECT COUNT(*) as invalid FROM customers WHERE customer_code LIKE 'CUST-%';"
# Should return: 0

Test Excel Import:
─────────────────────────────────────────────────────────────────────────────
1. Download template import
2. Fill dengan 5 test customers
3. Import Excel
4. Check customer list - should have 5 new customers
5. Verify all have format YYYYMMDDHHMMSS
6. Verify no duplicates

═══════════════════════════════════════════════════════════════════════════════
📞 SUPPORT
═══════════════════════════════════════════════════════════════════════════════

Jika ada masalah:
1. Check log: pm2 logs billing-app
2. Check error messages
3. Verify migration completed
4. Run verification queries
5. Rollback dengan backup jika perlu

═══════════════════════════════════════════════════════════════════════════════

Release: v2.1.14
Date: 30 Oktober 2025
Type: Bug Fix & Data Cleanup
Status: ✅ Production Ready
Requires Migration: Yes

═══════════════════════════════════════════════════════════════════════════════

