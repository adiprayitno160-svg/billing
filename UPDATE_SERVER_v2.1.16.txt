═══════════════════════════════════════════════════════════════════════════════
  UPDATE SERVER v2.1.16 - FIX DUPLICATE ENTRY & EXCEL EXPORT
═══════════════════════════════════════════════════════════════════════════════

📌 IMPORTANT: Backup database dulu sebelum update!
┌─────────────────────────────────────────────────────────────────────────────┐
│ ✅ Fix: Duplicate entry error saat import Excel                              │
│ ✅ Fix: Hapus kolom ID dari Excel export                                     │
│ ✅ Add: Milliseconds ke customer_code generation                             │
└─────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
🔄 QUICK UPDATE (COPY-PASTE)
═══════════════════════════════════════════════════════════════════════════════

# 1. Backup database
mysqldump -u root -p billing > backup_$(date +%Y%m%d_%H%M%S).sql

# 2. Fix divergent branches dan update
cd /opt/billing && \
git fetch origin && \
git reset --hard origin/main && \
git clean -fd && \
npm install && \
npm run build && \
npm install --production && \
pm2 restart billing-app --update-env

# 3. Run migration
mysql -u root -p billing < migrations/fix_customer_code_not_null.sql

═══════════════════════════════════════════════════════════════════════════════
📋 DETAILED UPDATE STEPS
═══════════════════════════════════════════════════════════════════════════════

1. Backup Database (WAJIB!):
   ──────────────────────────────────────────────────────────────────────────
   mysqldump -u username -p nama_database > backup_$(date +%Y%m%d_%H%M%S).sql

2. Masuk ke Direktori Aplikasi:
   ──────────────────────────────────────────────────────────────────────────
   cd /opt/billing

3. Check git status:
   ──────────────────────────────────────────────────────────────────────────
   git status

4. Fix Divergent Branches:
   ──────────────────────────────────────────────────────────────────────────
   git fetch origin
   git reset --hard origin/main
   git clean -fd

5. Install Dependencies:
   ──────────────────────────────────────────────────────────────────────────
   npm install

6. Build TypeScript:
   ──────────────────────────────────────────────────────────────────────────
   npm run build

7. Install Production Dependencies:
   ──────────────────────────────────────────────────────────────────────────
   npm install --production

8. Restart PM2:
   ──────────────────────────────────────────────────────────────────────────
   pm2 restart billing-app --update-env

9. Check Status:
   ──────────────────────────────────────────────────────────────────────────
   pm2 status
   pm2 logs billing-app --lines 50

10. Run Migration (PENTING!):
    ──────────────────────────────────────────────────────────────────────────
    mysql -u username -p database_name < migrations/fix_customer_code_not_null.sql

═══════════════════════════════════════════════════════════════════════════════
✨ FIXES v2.1.16
═══════════════════════════════════════════════════════════════════════════════

🔧 DUPLICATE ENTRY FIX
─────────────────────────────────────────────────────────────────────────────
✅ Customer_code sekarang: YYYYMMDDHHMMSSMMM (17 digits dengan milliseconds)
✅ Bisa generate 1000 unique codes per second
✅ Tidak ada lagi error "Duplicate entry for key 'customer-code'"

📊 EXCEL EXPORT FIX
─────────────────────────────────────────────────────────────────────────────
✅ Removed "ID" column dari Excel export
✅ Hanya menampilkan "Kode Pelanggan" (customer_code)
✅ Tidak ada lagi angka internal ID (12, 24, 54, dst)

🗄️ DATABASE FIX
─────────────────────────────────────────────────────────────────────────────
✅ Customer_code: UNIQUE NULL → UNIQUE NOT NULL
✅ Migration fix existing NULL values
✅ Better data integrity

═══════════════════════════════════════════════════════════════════════════════
⚠️  PENTING UNTUK DIKETAHUI
═══════════════════════════════════════════════════════════════════════════════

BEFORE MIGRATION:
─────────────────────────────────────────────────────────────────────────────
• Check: SELECT COUNT(*) FROM customers WHERE customer_code IS NULL;
• Check: SELECT COUNT(*) FROM customers WHERE customer_code LIKE 'CUST-%';
• Backup database WAJIB!

AFTER MIGRATION:
─────────────────────────────────────────────────────────────────────────────
• Verify: SELECT COUNT(*) FROM customers WHERE customer_code IS NULL; (should be 0)
• Verify: SELECT COUNT(*) FROM customers WHERE customer_code LIKE 'CUST-%'; (should be 0)
• Check format: SELECT customer_code FROM customers ORDER BY id DESC LIMIT 5;

BENEFITS:
─────────────────────────────────────────────────────────────────────────────
✅ Import Excel tidak akan error duplicate lagi
✅ Excel export clean tanpa internal ID
✅ Semua customer_code selalu ada (NOT NULL)
✅ Format standardized: 17 digits

═══════════════════════════════════════════════════════════════════════════════
🧪 VERIFICATION STEPS
═══════════════════════════════════════════════════════════════════════════════

1. Check Version:
─────────────────────────────────────────────────────────────────────────────
cat VERSION
# Should show: 2.1.16

2. Check PM2:
─────────────────────────────────────────────────────────────────────────────
pm2 status
pm2 logs billing-app --lines 20

3. Verify Migration:
─────────────────────────────────────────────────────────────────────────────
mysql -u root -p billing -e "SELECT COUNT(*) as null_count FROM customers WHERE customer_code IS NULL;"
# Should return: 0

mysql -u root -p billing -e "SELECT COUNT(*) as cust_count FROM customers WHERE customer_code LIKE 'CUST-%';"
# Should return: 0

mysql -u root -p billing -e "SELECT customer_code FROM customers ORDER BY id DESC LIMIT 5;"
# All should be 17 digits format

4. Test Excel Import:
─────────────────────────────────────────────────────────────────────────────
- Download template
- Fill 10 test customers
- Import Excel
- Verify NO duplicate entry errors
- Verify all customers have 17-digit codes

5. Test Excel Export:
─────────────────────────────────────────────────────────────────────────────
- Export customers to Excel
- Open Excel file
- Check NO "ID" column
- Check all "Kode Pelanggan" have 17 digits

6. Cleanup Test Data:
─────────────────────────────────────────────────────────────────────────────
- Delete test customers
- Database ready for production

═══════════════════════════════════════════════════════════════════════════════
🚨 TROUBLESHOOTING
═══════════════════════════════════════════════════════════════════════════════

Problem: Migration error - Duplicate entry
Solution:
─────────────────────────────────────────────────────────────────────────────
1. Check for duplicate customer_code values:
   SELECT customer_code, COUNT(*) as count 
   FROM customers 
   GROUP BY customer_code 
   HAVING count > 1;

2. Fix duplicates manually atau hapus salah satu

3. Re-run migration

Problem: Git reset failed
Solution:
─────────────────────────────────────────────────────────────────────────────
cd /opt/billing
git status
# Check what files have local changes

# Option 1: Stash changes
git stash
git reset --hard origin/main

# Option 2: Manual backup important files first
cp -r .env .env.backup
git reset --hard origin/main
# Restore important files if needed

Problem: PM2 won't start after update
Solution:
─────────────────────────────────────────────────────────────────────────────
1. Check npm install completed: npm list typescript
2. Check build completed: ls -la dist/
3. Check PM2 logs: pm2 logs billing-app --lines 100
4. Try manual start: node dist/server.js
5. If errors, check database connection and config

═══════════════════════════════════════════════════════════════════════════════
📁 FILES CHANGED
═══════════════════════════════════════════════════════════════════════════════

Modified Files:
─────────────────────────────────────────────────────────────────────────────
✅ src/utils/customerIdGenerator.ts - Added milliseconds
✅ src/controllers/customerController.ts - Removed ID from export
✅ src/controllers/excelController.ts - Removed ID from export
✅ src/db/pool.ts - customer_code NOT NULL

New Migration:
─────────────────────────────────────────────────────────────────────────────
✅ migrations/fix_customer_code_not_null.sql

Version Files:
─────────────────────────────────────────────────────────────────────────────
✅ VERSION, VERSION_MAJOR, VERSION_HOTFIX → 2.1.16
✅ package.json → 2.1.16

═══════════════════════════════════════════════════════════════════════════════
✅ UPDATE SELESAI
═══════════════════════════════════════════════════════════════════════════════

Summary:
─────────────────────────────────────────────────────────────────────────────
✅ Fix duplicate entry error (17-digit codes)
✅ Fix Excel export (no ID column)
✅ Better data integrity (NOT NULL constraint)
✅ All migrations completed

Next Steps:
─────────────────────────────────────────────────────────────────────────────
1. Test Excel import dengan banyak data
2. Verify Excel export tidak ada ID
3. Check customer list display normal
4. Monitor PM2 logs untuk errors

═══════════════════════════════════════════════════════════════════════════════
📞 SUPPORT
═══════════════════════════════════════════════════════════════════════════════

Jika ada masalah:
1. Check log: pm2 logs billing-app
2. Check error messages di browser console
3. Verify migration completed
4. Run verification queries
5. Rollback dengan backup jika perlu

═══════════════════════════════════════════════════════════════════════════════

Release: v2.1.16
Date: 30 Oktober 2025
Type: Critical Bug Fix
Status: ✅ Production Ready
Requires Migration: Yes (fix_customer_code_not_null.sql)

═══════════════════════════════════════════════════════════════════════════════

