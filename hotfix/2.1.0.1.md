# 🔧 Hotfix 2.1.0.1

**Date:** October 30, 2025  
**Type:** Database Schema Fix  
**Severity:** 🔴 Critical  
**Status:** ✅ Deployed

---

## 🐛 Problem

**Issue:** Customer Excel import completely failing

**Error Message:**
```
Field 'customer_code' doesn't have a default value
```

**Impact:**
- ❌ All customer imports return 0 success
- ❌ 100% failure rate on bulk imports
- ❌ Users unable to add customers via Excel
- ❌ Affects all installations

**Affected Users:** All users attempting Excel import

---

## 🔍 Root Cause Analysis

**Database Constraint Issue:**

The `customers` table had `customer_code` field configured as:
```sql
customer_code VARCHAR(191) NOT NULL UNIQUE
```

**Problems:**
1. Field is `NOT NULL` - requires a value
2. No `DEFAULT` value specified
3. Application code sends `NULL` when no code generated
4. MySQL strict mode rejects the insert

**Application Behavior:**
```javascript
// Code tries to insert NULL
INSERT INTO customers (..., customer_code, ...)
VALUES (..., NULL, ...)  // ❌ REJECTED by database
```

**Why it failed:**
- MySQL: "Hey, customer_code is NOT NULL and has no default!"
- Application: "But I'm sending NULL..."
- Result: ❌ Error on every insert

---

## ✅ Solution

**Database Schema Modification:**

Changed `customer_code` field to:
```sql
customer_code VARCHAR(191) UNIQUE NULL DEFAULT NULL
```

**Changes Made:**
1. ✅ Allow `NULL` values
2. ✅ Set `DEFAULT NULL`
3. ✅ Keep `UNIQUE` constraint
4. ✅ Keep `VARCHAR(191)` type

**SQL Command:**
```sql
ALTER TABLE customers 
MODIFY COLUMN customer_code VARCHAR(191) UNIQUE NULL DEFAULT NULL;
```

---

## 📋 Technical Details

### Before Fix:
```
Field:   customer_code
Type:    VARCHAR(191)
Null:    NO ❌
Key:     UNI
Default: (none) ❌
```

### After Fix:
```
Field:   customer_code
Type:    VARCHAR(191)
Null:    YES ✅
Key:     UNI
Default: NULL ✅
```

### Import Behavior After Fix:

**Scenario 1: Code Generated Successfully**
```javascript
const customerCode = `CUST-${timestamp}-${random}`;
// Insert: customer_code = 'CUST-1698765432-123'
✅ Success
```

**Scenario 2: Code Generation Fails**
```javascript
const customerCode = null;
// Insert: customer_code = NULL
✅ Success (NULL allowed now!)
```

---

## 📦 Files Changed

**Database Only:**
- Modified: `customers` table schema
- Field: `customer_code`

**No Code Changes Required:**
- Application code already handles NULL correctly
- Just needed database to accept it

---

## 🧪 Testing Results

### Test 1: Small Import (3 rows)
```
Input:  3 customers
Result: ✅ Success: 3, Failed: 0
Time:   < 1 second
```

### Test 2: Medium Import (27 rows)
```
Input:  27 customers
Result: ✅ Success: 27, Failed: 0
Time:   < 2 seconds
```

### Test 3: Large Import (100 rows)
```
Input:  100 customers
Result: ✅ Success: 100, Failed: 0
Time:   < 5 seconds
```

### Test 4: Duplicate Phone Check
```
Input:  Customer with existing phone
Result: ✅ Correctly skipped with proper error message
```

---

## 🚀 Deployment Instructions

### For New Installations:
No action needed - schema already updated in codebase

### For Existing Installations:

**Option 1: Using SQL File**
```bash
# Navigate to project directory
cd /path/to/billing

# Run SQL fix
mysql -u root -p billing < hotfix/2.1.0.1-fix.sql
```

**Option 2: Using Node.js Script**
```bash
# Navigate to project directory
cd /path/to/billing

# Run fix script
node hotfix/2.1.0.1-fix.js
```

**Option 3: Manual SQL**
```sql
-- Connect to database
mysql -u root -p billing

-- Run this command
ALTER TABLE customers 
MODIFY COLUMN customer_code VARCHAR(191) UNIQUE NULL DEFAULT NULL;

-- Verify
DESCRIBE customers;
```

### After Running Fix:
```bash
# Restart application
pm2 restart billing-app

# Verify version
pm2 list  # Should show 2.1.0.1
```

---

## ✅ Verification Steps

1. **Check Database Schema:**
   ```sql
   DESCRIBE customers;
   ```
   Verify: `customer_code` shows `Null: YES` and `Default: NULL`

2. **Test Import:**
   - Upload Excel with 3 test customers
   - Should show: "Berhasil: 3, Gagal: 0"

3. **Check Application Version:**
   ```bash
   pm2 list
   cat VERSION_HOTFIX
   ```
   Should show: `2.1.0.1`

---

## 🎯 Success Criteria

- [x] Database schema modified successfully
- [x] customer_code allows NULL values
- [x] customer_code has DEFAULT NULL
- [x] Excel import works without errors
- [x] Existing customers not affected
- [x] Unique constraint still enforced
- [x] Application version updated to 2.1.0.1
- [x] Documentation updated

---

## 📊 Impact Assessment

**Before Hotfix:**
- Import Success Rate: 0% ❌
- User Frustration: High
- Workaround: Manual entry only
- Business Impact: Severe

**After Hotfix:**
- Import Success Rate: 100% ✅
- User Satisfaction: Restored
- Bulk Import: Fully functional
- Business Impact: Resolved

---

## 🔄 Rollback Plan

If issues arise:

**Rollback Database:**
```sql
-- Revert to NOT NULL (if needed)
ALTER TABLE customers 
MODIFY COLUMN customer_code VARCHAR(191) UNIQUE NOT NULL;

-- Note: This will fail if NULL values exist!
-- Clean NULL values first if needed
UPDATE customers SET customer_code = CONCAT('CUST-', id) WHERE customer_code IS NULL;
```

**Rollback Version:**
```bash
git checkout VERSION_HOTFIX
git reset --hard HEAD~1
pm2 restart billing-app
```

---

## 📞 Support

**If you encounter issues:**

1. Check error logs: `pm2 logs billing-app`
2. Verify database schema: `DESCRIBE customers`
3. Check version: `cat VERSION_HOTFIX`
4. Contact support with:
   - Error message
   - Database schema screenshot
   - Sample Excel file (with dummy data)

---

## 📚 Related Documentation

- [HOTFIX.md](../HOTFIX.md) - Hotfix system documentation
- [CHANGELOG_v2.1.0.md](../CHANGELOG_v2.1.0.md) - Main release changelog
- [Excel Import Guide](../docs/EXCEL_IMPORT_GUIDE.md) - Import documentation

---

**Hotfix Applied:** ✅  
**Status:** Production Ready  
**Next Hotfix:** TBD



