<!-- Notification Templates Dashboard -->
<div class="animate-content-fade-in">
    <!-- Breadcrumbs & Search -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
            <nav class="flex mb-2" aria-label="Breadcrumb">
                <ol
                    class="inline-flex items-center space-x-1 md:space-x-3 text-xs font-bold uppercase tracking-widest text-gray-400">
                    <li class="inline-flex items-center">
                        <a href="/dashboard" class="hover:text-blue-600 transition-colors">DASHBOARD</a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <i class="fas fa-chevron-right mx-2 text-[8px]"></i>
                            <span class="text-gray-600">NOTIFIKASI</span>
                        </div>
                    </li>
                </ol>
            </nav>
            <h1 class="text-4xl font-black text-gray-900 tracking-tighter flex items-center gap-3">
                <span class="p-3 bg-blue-600 text-white rounded-2xl shadow-xl shadow-blue-100 italic">
                    <i class="fas fa-envelope-open-text"></i>
                </span>
                Template Notifikasi
            </h1>
        </div>
        <div class="flex items-center gap-3">
            <a href="/notification/templates/create"
                class="px-6 py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-[2rem] font-black text-sm tracking-tighter hover:shadow-2xl hover:shadow-blue-200 transition-all flex items-center gap-2 group">
                <i class="fas fa-plus group-hover:rotate-90 transition-transform"></i>
                BUAT TEMPLATE BARU
            </a>
        </div>
    </div>

    <!-- Stats Quick Glance -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
        <div
            class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 hover:shadow-xl transition-all group overflow-hidden relative">
            <div
                class="absolute -right-4 -top-4 w-24 h-24 bg-blue-50 rounded-full group-hover:scale-150 transition-transform duration-700">
            </div>
            <div class="relative">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-1">Total Templates</p>
                <h3 class="text-3xl font-black text-gray-900 leading-none">
                    <%= templates.length %>
                </h3>
            </div>
        </div>
        <div
            class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 hover:shadow-xl transition-all group overflow-hidden relative">
            <div
                class="absolute -right-4 -top-4 w-24 h-24 bg-green-50 rounded-full group-hover:scale-150 transition-transform duration-700">
            </div>
            <div class="relative">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-1">Delivered (30d)</p>
                <h3 class="text-3xl font-black text-green-600 leading-none">
                    <%= stats.sent || 0 %>
                </h3>
            </div>
        </div>
        <div
            class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 hover:shadow-xl transition-all group overflow-hidden relative">
            <div
                class="absolute -right-4 -top-4 w-24 h-24 bg-red-50 rounded-full group-hover:scale-150 transition-transform duration-700">
            </div>
            <div class="relative">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-1">Failures</p>
                <h3 class="text-3xl font-black text-red-600 leading-none">
                    <%= stats.failed || 0 %>
                </h3>
            </div>
        </div>
        <div
            class="bg-white p-6 rounded-[2.5rem] shadow-sm border border-gray-100 hover:shadow-xl transition-all group overflow-hidden relative">
            <div
                class="absolute -right-4 -top-4 w-24 h-24 bg-indigo-50 rounded-full group-hover:scale-150 transition-transform duration-700">
            </div>
            <div class="relative">
                <p class="text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] mb-1">Success Rate</p>
                <h3 class="text-3xl font-black text-blue-600 leading-none">
                    <%= stats.total> 0 ? ((stats.sent / stats.total) * 100).toFixed(1) : '0' %>%
                </h3>
            </div>
        </div>
    </div>

    <!-- Filters & List -->
    <div class="bg-white rounded-[3rem] shadow-xl shadow-gray-200/50 border border-gray-100 overflow-hidden mb-10">
        <!-- Filter Header -->
        <div class="p-8 border-b border-gray-50 bg-gray-50/30">
            <div class="flex flex-col lg:flex-row gap-6 items-end justify-between">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 flex-1 w-full">
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Event
                            Type</label>
                        <select id="filterType"
                            class="w-full px-5 py-3.5 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all font-bold text-gray-700 outline-none appearance-none">
                            <option value="">Semua Tipe</option>
                            <option value="invoice_created" <%=query.notification_type==='invoice_created' ? 'selected'
                                : '' %>>Invoice Dibuat</option>
                            <option value="invoice_overdue" <%=query.notification_type==='invoice_overdue' ? 'selected'
                                : '' %>>Invoice Terlambat</option>
                            <option value="payment_received" <%=query.notification_type==='payment_received'
                                ? 'selected' : '' %>>Pembayaran Diterima</option>
                            <option value="package_expiring" <%=query.notification_type==='package_expiring'
                                ? 'selected' : '' %>>Paket Akan Berakhir</option>
                        </select>
                    </div>
                    <div class="space-y-1.5">
                        <label
                            class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Channel</label>
                        <select id="filterChannel"
                            class="w-full px-5 py-3.5 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all font-bold text-gray-700 outline-none appearance-none">
                            <option value="">Semua Channel</option>
                            <option value="whatsapp" <%=query.channel==='whatsapp' ? 'selected' : '' %>>WhatsApp
                            </option>
                            <option value="email" <%=query.channel==='email' ? 'selected' : '' %>>Email</option>
                            <option value="sms" <%=query.channel==='sms' ? 'selected' : '' %>>SMS</option>
                        </select>
                    </div>
                    <div class="space-y-1.5">
                        <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">System
                            Status</label>
                        <select id="filterActive"
                            class="w-full px-5 py-3.5 bg-white border border-gray-200 rounded-2xl focus:ring-4 focus:ring-blue-100 focus:border-blue-500 transition-all font-bold text-gray-700 outline-none appearance-none">
                            <option value="">Semua Status</option>
                            <option value="true" <%=query.is_active==='true' ? 'selected' : '' %>>AKTIF</option>
                            <option value="false" <%=query.is_active==='false' ? 'selected' : '' %>>NON-AKTIF</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-3 w-full lg:w-auto">
                    <button onclick="applyFilters()"
                        class="flex-1 lg:px-8 py-3.5 bg-gray-900 text-white rounded-2xl font-black text-xs tracking-widest transition-all hover:bg-black active:scale-95 shadow-lg shadow-gray-200">
                        FILTER
                    </button>
                    <button onclick="resetFilters()"
                        class="px-5 py-3.5 bg-gray-100 text-gray-500 rounded-2xl hover:bg-gray-200 transition-all transition-all active:scale-95">
                        <i class="fas fa-undo"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Table Content -->
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead>
                    <tr class="bg-gray-50/50 border-b border-gray-50">
                        <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Template
                            Identifier</th>
                        <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">Context &
                            Channel</th>
                        <th class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em]">
                            Availability</th>
                        <th
                            class="px-8 py-5 text-[10px] font-black text-gray-400 uppercase tracking-[0.2em] text-right">
                            Commands</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-50">
                    <% if (templates.length===0) { %>
                        <tr>
                            <td colspan="4" class="px-8 py-20 text-center">
                                <div
                                    class="w-20 h-20 bg-gray-50 rounded-3xl flex items-center justify-center mx-auto mb-4 text-gray-200">
                                    <i class="fas fa-folder-open text-3xl"></i>
                                </div>
                                <p class="text-xs font-black text-gray-300 uppercase tracking-widest">No matching
                                    templates found</p>
                            </td>
                        </tr>
                        <% } %>
                            <% templates.forEach(template=> { %>
                                <tr class="group hover:bg-blue-50/30 transition-all duration-300">
                                    <td class="px-8 py-6">
                                        <div class="flex items-center gap-4">
                                            <div
                                                class="w-12 h-12 rounded-2xl bg-white shadow-sm border border-gray-100 flex items-center justify-center text-blue-600 group-hover:scale-110 transition-transform">
                                                <i class="fas fa-file-code"></i>
                                            </div>
                                            <div>
                                                <p class="font-black text-gray-900 tracking-tight">
                                                    <%= template.template_name %>
                                                </p>
                                                <code
                                                    class="text-[10px] font-black text-blue-500 uppercase tracking-widest"><%= template.template_code %></code>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-8 py-6">
                                        <div class="flex flex-col gap-2">
                                            <div class="flex items-center gap-2">
                                                <span
                                                    class="px-3 py-1 bg-white border border-gray-100 shadow-sm rounded-lg text-[10px] font-black text-gray-600 uppercase italic">
                                                    <%= template.notification_type.replace(/_/g, ' ' ) %>
                                                </span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="px-2.5 py-1 rounded-md text-[9px] font-black uppercase tracking-tighter flex items-center gap-1.5
                                            <%= template.channel === 'whatsapp' ? 'bg-green-100 text-green-700' : 
                                                template.channel === 'email' ? 'bg-blue-100 text-blue-700' : 
                                                'bg-purple-100 text-purple-700' %>">
                                                    <i
                                                        class="fab fa-<%= template.channel === 'email' ? 'google' : template.channel %>"></i>
                                                    <%= template.channel %>
                                                </span>
                                                <% if(template.priority==='high' ) { %>
                                                    <span
                                                        class="px-2.5 py-1 bg-red-100 text-red-600 rounded-md text-[8px] font-black uppercase">URGENT</span>
                                                    <% } %>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-8 py-6">
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" <%=template.is_active ? 'checked' : '' %>
                                            class="sr-only peer"
                                            onchange="toggleActive('<%= template.template_code %>', this.checked)">
                                                <div
                                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600">
                                                </div>
                                                <span
                                                    class="ms-3 text-[10px] font-black text-gray-400 uppercase tracking-widest">
                                                    <%= template.is_active ? 'Active' : 'Standby' %>
                                                </span>
                                        </label>
                                    </td>
                                    <td class="px-8 py-6 text-right">
                                        <div
                                            class="flex items-center justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity translate-x-4 group-hover:translate-x-0">
                                            <button onclick="viewTemplate('<%= template.template_code %>')"
                                                class="w-10 h-10 rounded-xl bg-white border border-gray-100 shadow-sm flex items-center justify-center text-gray-400 hover:text-blue-600 hover:border-blue-200 transition-all">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <a href="/notification/templates/edit/<%= template.template_code %>"
                                                class="w-10 h-10 rounded-xl bg-white border border-gray-100 shadow-sm flex items-center justify-center text-gray-400 hover:text-green-600 hover:border-green-200 transition-all">
                                                <i class="fas fa-pen-nib"></i>
                                            </a>
                                            <button onclick="deleteTemplate('<%= template.template_code %>')"
                                                class="w-10 h-10 rounded-xl bg-white border border-gray-100 shadow-sm flex items-center justify-center text-gray-400 hover:text-red-600 hover:border-red-200 transition-all">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                <% }); %>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div id="templateModal" class="hidden fixed inset-0 z-[100] p-4 flex items-center justify-center animate-fade-in">
    <div class="absolute inset-0 bg-gray-900/40 backdrop-blur-md" onclick="closeModal()"></div>
    <div class="relative bg-white w-full max-w-2xl rounded-[3rem] shadow-2xl overflow-hidden border border-white">
        <div class="px-10 py-8 border-b border-gray-50 flex items-center justify-between bg-blue-50/30">
            <div class="flex items-center gap-4">
                <div
                    class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-blue-100">
                    <i class="fas fa-scroll text-xl"></i>
                </div>
                <div>
                    <h3 class="text-xl font-black text-gray-900 tracking-tighter">Preview Payload</h3>
                    <p class="text-[10px] font-black text-gray-400 uppercase tracking-widest">TEMPLATE ARCHIVE SYSTEM
                    </p>
                </div>
            </div>
            <button onclick="closeModal()"
                class="w-10 h-10 rounded-full hover:bg-white transition-colors flex items-center justify-center text-gray-400">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div id="modalContent" class="p-10">
            <!-- Content dynamic inject -->
        </div>
    </div>
</div>

<style>
    @keyframes content-fade-in {
        from {
            opacity: 0;
            transform: scale(0.98);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .animate-content-fade-in {
        animation: content-fade-in 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    }

    .font-black {
        font-weight: 900;
    }
</style>

<script>
    function applyFilters() {
        const type = document.getElementById('filterType').value;
        const channel = document.getElementById('filterChannel').value;
        const active = document.getElementById('filterActive').value;

        const params = new URLSearchParams();
        if (type) params.append('notification_type', type);
        if (channel) params.append('channel', channel);
        if (active) params.append('is_active', active);

        window.location.href = '/notification/templates?' + params.toString();
    }

    function resetFilters() {
        window.location.href = '/notification/templates';
    }

    async function toggleActive(code, newStatus) {
        try {
            const response = await fetch(`/api/notification/templates/${code}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ is_active: newStatus })
            });

            const data = await response.json();
            if (!data.success) {
                alert('Action Required: ' + data.message);
                location.reload();
            }
        } catch (error) {
            console.error(error);
            location.reload();
        }
    }

    async function deleteTemplate(code) {
        if (!confirm('Hapus template secara permanen? Sesi ini tidak dapat dipulihkan.')) return;

        try {
            const response = await fetch(`/api/notification/templates/${code}`, {
                method: 'DELETE'
            });

            const data = await response.json();
            if (data.success) {
                location.reload();
            } else {
                alert('Process Failed: ' + data.message);
            }
        } catch (error) {
            alert('Fatal Failure: Check system logs.');
        }
    }

    async function viewTemplate(code) {
        try {
            const response = await fetch(`/api/notification/templates/${code}`);
            const data = await response.json();

            if (data.success) {
                const template = data.data;
                const modalContent = document.getElementById('modalContent');
                modalContent.innerHTML = `
                    <div class="space-y-8">
                        <div class="grid grid-cols-2 gap-8">
                            <div class="space-y-1.5">
                                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Internal Name</label>
                                <p class="px-5 py-4 bg-gray-50 rounded-2xl font-black text-gray-900 border border-gray-100">${template.template_name}</p>
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Header / Subject</label>
                                <p class="px-5 py-4 bg-gray-50 rounded-2xl font-black text-blue-600 border border-gray-100 italic truncate">${template.title_template || 'No Header'}</p>
                            </div>
                        </div>

                        <div class="space-y-1.5">
                            <label class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-1">Live Preview Message</label>
                            <div class="p-6 bg-gray-900 text-white rounded-[2rem] shadow-xl font-medium text-sm leading-relaxed whitespace-pre-wrap border border-gray-800">
                                ${template.message_template}
                            </div>
                        </div>

                        <div class="flex items-center justify-between pt-4 border-t border-gray-50">
                            <div class="flex gap-2">
                                <span class="px-4 py-2 bg-blue-100 text-blue-700 rounded-xl font-black text-[10px] uppercase tracking-widest leading-none flex items-center">
                                    ${template.channel}
                                </span>
                                <span class="px-4 py-2 bg-gray-100 text-gray-600 rounded-xl font-black text-[10px] uppercase tracking-widest leading-none flex items-center">
                                    ${template.notification_type}
                                </span>
                            </div>
                            <button onclick="closeModal()" class="px-8 py-3 bg-gray-900 text-white rounded-2xl font-black text-xs tracking-widest">CLOSE</button>
                        </div>
                    </div>
                `;
                document.getElementById('templateModal').classList.remove('hidden');
            }
        } catch (error) {
            console.error('Modal failed:', error);
        }
    }

    function closeModal() {
        document.getElementById('templateModal').classList.add('hidden');
    }

    document.addEventListener('keydown', (e) => { if (e.key === "Escape") closeModal(); });
</script>