<style>
    /* Prevent horizontal overflow */
    body {
        overflow-x: hidden;
    }

    .table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    /* Make buttons more responsive */
    button[data-action] {
        min-width: auto !important;
        flex-shrink: 0;
    }

    /* Ensure main content doesn't overflow */
    main {
        max-width: 100%;
        overflow-x: hidden;
    }

    /* Bulk items visibility */
    .bulk-delete-hidden {
        display: none !important;
    }

    .bulk-delete-visible {
        display: inline-flex !important;
    }

    /* Button gradients */
    .bg-wa-gradient {
        background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
    }
</style>

<!-- Action Buttons Section -->
<div class="glass-panel shadow-lg rounded-2xl mb-6 p-6 overflow-x-auto">
    <div class="flex flex-nowrap md:flex-wrap gap-4 items-center min-w-max md:min-w-0">
        <!-- Generate Tagihan -->
        <button type="button" id="btnGenerateTagihan" data-action="generate-invoice"
            class="inline-flex items-center bg-gradient-to-r from-emerald-500 to-green-600 hover:from-emerald-600 hover:to-green-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:shadow-green-500/30 transition-all duration-300 transform hover:-translate-y-0.5">
            <i class="fas fa-file-invoice mr-2 text-lg"></i>Generate
        </button>

        <!-- Print Area ODC -->
        <button type="button" id="btnPrintODC" onclick="showOdcPrintModal()"
            class="inline-flex items-center bg-gradient-to-r from-cyan-500 to-blue-600 hover:from-cyan-600 hover:to-blue-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:shadow-cyan-500/30 transition-all duration-300 transform hover:-translate-y-0.5">
            <i class="fas fa-map-marked-alt mr-2 text-lg"></i>Print Area
        </button>

        <div class="hidden md:block h-8 w-px bg-gray-200 mx-1"></div>

        <!-- Kirim Masal (Pindah ke samping Export sesuai permintaan) -->
        <button type="button" id="btnBulkSendWA" data-action="bulk-send-wa"
            class="inline-flex items-center bg-gradient-to-r from-green-600 to-emerald-700 hover:from-green-700 hover:to-emerald-800 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:shadow-green-500/30 transition-all duration-300 transform hover:-translate-y-0.5"
            title="Kirim tagihan terpilih ke antrian WhatsApp">
            <i class="fab fa-whatsapp mr-2 text-xl"></i>Kirim Masal (<span id="selectedSendWACount">0</span>)
        </button>

        <!-- Export PDF -->
        <button type="button" id="btnExportPDF" data-action="export-pdf"
            class="inline-flex items-center bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg hover:shadow-indigo-500/30 transition-all duration-300 transform hover:-translate-y-0.5">
            <i class="fas fa-file-pdf mr-2 text-lg"></i>Export PDF
        </button>

        <div class="hidden md:block h-8 w-px bg-gray-200 mx-1"></div>

        <!-- Bulk Actions (Hanya muncul jika ada yang dipilih) -->
        <div class="flex items-center gap-3">
            <button type="button" id="btnBulkReminder" data-action="bulk-reminder"
                class="bulk-reminder-hidden inline-flex items-center bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-600 hover:to-orange-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg transition-all transform hover:-translate-y-0.5"
                title="Kirim pengingat untuk tagihan terpilih">
                <i class="fas fa-bell mr-2"></i>Remind (<span id="selectedReminderCount">0</span>)
            </button>

            <button type="button" id="bulkDeleteBtn" data-action="bulk-delete"
                class="bulk-delete-hidden inline-flex items-center bg-gradient-to-r from-red-500 to-rose-600 hover:from-red-600 hover:to-rose-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg transition-all transform hover:-translate-y-0.5">
                <i class="fas fa-trash-alt mr-2"></i>Hapus (<span id="selectedCount">0</span>)
            </button>

            <button type="button" id="btnPrintSelected" data-action="print-selected"
                class="bulk-print-hidden inline-flex items-center bg-gradient-to-r from-violet-500 to-fuchsia-600 hover:from-violet-600 hover:to-fuchsia-700 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg transition-all transform hover:-translate-y-0.5">
                <i class="fas fa-check-double mr-2"></i>Print (<span id="selectedPrintCount">0</span>)
            </button>
        </div>

        <button type="button" id="btnPrintAll" data-action="print-all"
            class="inline-flex items-center bg-gray-600 hover:bg-gray-700 text-white px-5 py-2.5 rounded-xl font-bold transition-all">
            <i class="fas fa-print mr-2"></i>Print Semua
        </button>
    </div>
</div>

<!-- Filters -->
<div class="glass-panel rounded-2xl shadow-lg p-6 mb-6">
    <form method="GET">
        <div class="flex flex-wrap items-end gap-4">
            <!-- Status Filter -->
            <div class="flex-1 min-w-[180px]">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Status</label>
                <div class="relative">
                    <select name="status"
                        class="w-full pl-4 pr-10 py-2.5 text-sm bg-white/50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none backdrop-blur-sm transition-all duration-300 hover:bg-white/80">
                        <option value="">Semua Status</option>
                        <option value="draft" <%=filters.status==='draft' ? 'selected' : '' %>>Draft</option>
                        <option value="sent" <%=filters.status==='sent' ? 'selected' : '' %>>Terkirim</option>
                        <option value="partial" <%=filters.status==='partial' ? 'selected' : '' %>>Dibayar Sebagian
                        </option>
                        <option value="paid" <%=filters.status==='paid' ? 'selected' : '' %>>Lunas</option>
                        <option value="overdue" <%=filters.status==='overdue' ? 'selected' : '' %>>Jatuh Tempo</option>
                        <option value="cancelled" <%=filters.status==='cancelled' ? 'selected' : '' %>>Dibatalkan
                        </option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- Isolir Filter -->
            <div class="flex-1 min-w-[180px]">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Pelanggan
                    Isolir</label>
                <div class="relative">
                    <select name="hide_isolated"
                        class="w-full pl-4 pr-10 py-2.5 text-sm bg-white/50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 appearance-none backdrop-blur-sm transition-all duration-300 hover:bg-white/80">
                        <option value="">Tampilkan Semua</option>
                        <option value="1" <%=filters.hide_isolated==='1' || filters.hide_isolated===true ? 'selected'
                            : '' %>>🚫 Sembunyikan Isolir</option>
                        <option value="only" <%=filters.hide_isolated==='only' ? 'selected' : '' %>>⚠️ Hanya Isolir
                        </option>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- ODC Filter -->
            <div class="flex-1 min-w-[180px]">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Area ODC</label>
                <div class="relative">
                    <select name="odc_id"
                        class="w-full pl-4 pr-10 py-2.5 text-sm bg-white/50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 appearance-none backdrop-blur-sm transition-all duration-300 hover:bg-white/80">
                        <option value="">Semua ODC</option>
                        <% if (typeof odcList !=='undefined' && odcList && odcList.length> 0) { %>
                            <% odcList.forEach(function(odc) { %>
                                <option value="<%= odc.id %>" <%=filters.odc_id==odc.id ? 'selected' : '' %>><%=
                                        odc.name %>
                                </option>
                                <% }); %>
                                    <% } %>
                    </select>
                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-gray-500">
                        <i class="fas fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <!-- Search Input -->
            <div class="flex-1 min-w-[250px]">
                <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Cari</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fas fa-search text-gray-400"></i>
                    </div>
                    <input type="text" name="search" value="<%= filters.search %>"
                        placeholder="Nama, telepon, atau nomor tagihan..."
                        class="w-full pl-10 pr-4 py-2.5 text-sm bg-white/50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 backdrop-blur-sm transition-all duration-300 hover:bg-white/80">
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-2">
                <button type="submit"
                    class="bg-blue-600 text-white px-6 py-2.5 rounded-xl hover:bg-blue-700 transition-all duration-300 text-sm font-bold shadow-md hover:shadow-lg hover:-translate-y-0.5">
                    Filter
                </button>
                <a href="/billing/tagihan"
                    class="bg-white text-gray-700 border border-gray-200 px-6 py-2.5 rounded-xl hover:bg-gray-50 transition-all duration-300 text-center text-sm font-bold shadow-sm hover:shadow-md hover:-translate-y-0.5">
                    Reset
                </a>
            </div>
        </div>
    </form>
</div>

<!-- Invoices Table -->
<!-- Invoices Table -->
<div class="glass-panel rounded-2xl shadow-xl overflow-hidden border border-white/20 relative z-0">
    <div class="px-6 py-5 border-b border-gray-200/50 bg-white/40 backdrop-blur-md flex justify-between items-center">
        <div>
            <h3 class="text-lg font-bold text-gray-900 tracking-tight">Daftar Tagihan</h3>
            <p class="text-xs font-medium text-gray-500 mt-0.5">Total <%= pagination.totalCount %> tagihan</p>
        </div>
        <div class="flex items-center gap-2">
            <span class="inline-flex h-2 w-2 rounded-full bg-green-500 animate-pulse"></span>
            <span class="text-xs text-gray-500 font-medium">Live Data</span>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-sm text-left">
            <thead>
                <tr
                    class="bg-gradient-to-r from-gray-50/80 to-slate-50/80 border-b border-gray-200/60 text-xs uppercase tracking-wider font-bold text-gray-600 font-mono">
                    <th class="px-6 py-4 w-12 text-center">
                        <input type="checkbox" id="selectAll"
                            class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 shadow-sm transition-all duration-200">
                    </th>
                    <th class="px-6 py-4">No. Tagihan</th>
                    <th class="px-6 py-4">Pelanggan</th>
                    <th class="px-6 py-4">Area ODC</th>
                    <th class="px-6 py-4 text-right">Jumlah</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4">Tanggal</th>
                    <th class="px-6 py-4">Jatuh Tempo</th>
                    <th class="px-6 py-4 text-center">Aksi</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 bg-white/30 backdrop-blur-sm">
                <% if (invoices && invoices.length> 0) { %>
                    <% invoices.forEach(function(invoice) { %>
                        <tr class="hover:bg-blue-50/40 transition-colors duration-200 group">
                            <td class="px-6 py-4 text-center">
                                <input type="checkbox"
                                    class="invoice-checkbox rounded border-gray-300 text-blue-600 focus:ring-blue-500 shadow-sm cursor-pointer transition-all duration-200 transform hover:scale-110"
                                    value="<%= invoice.id %>">
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span
                                    class="font-mono text-xs font-bold bg-slate-100 text-slate-700 px-2 py-1 rounded border border-slate-200 group-hover:bg-white group-hover:border-blue-200 transition-colors">
                                    <%= invoice.invoice_number %>
                                </span>
                            </td>
                            <td class="px-6 py-4">
                                <div class="font-bold text-gray-900 group-hover:text-blue-700 transition-colors">
                                    <%= invoice.customer_name %>
                                </div>
                                <div class="text-xs text-gray-500 font-mono mt-0.5">
                                    <button data-action="send-wanew" data-invoice-id="<%= invoice.id %>"
                                        class="flex items-center gap-1 hover:text-emerald-600 transition-colors"
                                        title="Kirim WA Langsung">
                                        <i class="fas fa-phone-alt text-[10px]"></i>
                                        <%= invoice.customer_phone %>
                                    </button>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <% if (invoice.odc_name) { %>
                                    <div class="flex flex-col">
                                        <div class="text-xs font-semibold text-gray-700 flex items-center gap-1.5">
                                            <i class="fas fa-building text-cyan-600"></i>
                                            <%= invoice.odc_name %>
                                        </div>
                                        <span class="text-[10px] text-gray-400 pl-4">
                                            <%= invoice.odc_location || '-' %>
                                        </span>
                                    </div>
                                    <% } else { %>
                                        <span class="text-xs text-gray-400 italic flex items-center gap-1">
                                            <i class="fas fa-ban text-gray-300"></i> No ODC
                                        </span>
                                        <% } %>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-right">
                                <div class="font-bold text-gray-900 font-mono tracking-tight">
                                    Rp <%= new Intl.NumberFormat('id-ID').format(invoice.total_amount) %>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <% let statusClass='' ; let statusIcon='' ; let statusText='' ; switch(invoice.status) {
                                    case 'paid' : statusClass='bg-green-100 text-green-700 border border-green-200' ;
                                    statusIcon='fa-check-circle' ; statusText='Lunas' ; break; case 'draft' :
                                    statusClass='bg-gray-100 text-gray-700 border border-gray-200' ;
                                    statusIcon='fa-pencil-alt' ; statusText='Draft' ; break; case 'sent' :
                                    statusClass='bg-blue-100 text-blue-700 border border-blue-200' ;
                                    statusIcon='fa-paper-plane' ; statusText='Terkirim' ; break; case 'partial' :
                                    statusClass='bg-amber-100 text-amber-700 border border-amber-200' ;
                                    statusIcon='fa-adjust' ; statusText='Partial' ; break; case 'overdue' :
                                    statusClass='bg-red-100 text-red-700 border border-red-200' ;
                                    statusIcon='fa-exclamation-circle' ; statusText='Telat' ; break; case 'cancelled' :
                                    statusClass='bg-slate-100 text-slate-500 border border-slate-200 decoration-line-through'
                                    ; statusIcon='fa-times-circle' ; statusText='Batal' ; break; default:
                                    statusClass='bg-gray-100 text-gray-600' ; statusIcon='fa-question-circle' ;
                                    statusText=invoice.status; } %>
                                    <span
                                        class="inline-flex items-center gap-1.5 px-2.5 py-1 text-[11px] font-bold uppercase tracking-wide rounded-full shadow-sm <%= statusClass %>">
                                        <i class="fas <%= statusIcon %> text-[10px]"></i>
                                        <%= statusText %>
                                    </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-500 font-medium">
                                <%= new Date(invoice.created_at).toLocaleDateString('id-ID', {day: '2-digit' ,
                                    month: 'short' , year: 'numeric' }) %>
                            </td>
                            <td
                                class="px-6 py-4 whitespace-nowrap text-xs font-medium <%= new Date(invoice.due_date) < new Date() && invoice.status !== 'paid' ? 'text-red-600 font-bold' : 'text-gray-500' %>">
                                <%= new Date(invoice.due_date).toLocaleDateString('id-ID', {day: '2-digit' ,
                                    month: 'short' , year: 'numeric' }) %>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-center">
                                <div
                                    class="flex items-center justify-center gap-1 opacity-80 group-hover:opacity-100 transition-opacity">
                                    <!-- Detail -->
                                    <button data-action="detail" data-invoice-id="<%= invoice.id %>"
                                        class="w-8 h-8 rounded-lg flex items-center justify-center text-blue-600 hover:bg-blue-100 hover:text-blue-700 transition-all"
                                        title="Detail">
                                        <i class="fas fa-eye"></i>
                                    </button>

                                    <!-- Janji Bayar -->
                                    <button data-action="promise" data-invoice-id="<%= invoice.id %>"
                                        data-invoice-date="<%= invoice.due_date %>"
                                        class="w-8 h-8 rounded-lg flex items-center justify-center text-indigo-600 hover:bg-indigo-100 hover:text-indigo-700 transition-all"
                                        title="Janji Bayar">
                                        <i class="fas fa-calendar-alt"></i>
                                    </button>

                                    <!-- WhatsApp -->
                                    <% if (invoice.status !=='paid' ) { %>
                                        <button data-action="send-wanew" data-invoice-id="<%= invoice.id %>"
                                            class="w-8 h-8 rounded-lg flex items-center justify-center text-emerald-600 hover:bg-emerald-100 hover:text-emerald-700 transition-all"
                                            title="Kirim WhatsApp">
                                            <i class="fab fa-whatsapp"></i>
                                        </button>
                                        <% } %>

                                            <!-- Print -->
                                            <div class="relative inline-block">
                                                <button data-action="print" data-invoice-id="<%= invoice.id %>"
                                                    class="w-8 h-8 rounded-lg flex items-center justify-center text-purple-600 hover:bg-purple-100 hover:text-purple-700 transition-all"
                                                    title="Print">
                                                    <i class="fas fa-print"></i>
                                                </button>
                                                <!-- Print Menu Dropdown -->
                                                <div id="printMenu-<%= invoice.id %>"
                                                    class="hidden absolute right-0 mt-2 w-48 bg-white/90 backdrop-blur-xl rounded-xl shadow-xl border border-gray-100 z-50 overflow-hidden ring-1 ring-black/5">
                                                    <a href="/billing/tagihan/<%= invoice.id %>/print" target="_blank"
                                                        class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors border-b border-gray-100">
                                                        <i class="fas fa-file-pdf mr-3 text-red-500"></i>Print A4
                                                    </a>
                                                    <a href="/billing/tagihan/<%= invoice.id %>/print-thermal"
                                                        target="_blank"
                                                        class="flex items-center px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-700 transition-colors">
                                                        <i class="fas fa-receipt mr-3 text-gray-500"></i>Print Thermal
                                                    </a>
                                                </div>
                                            </div>

                                            <!-- Pay -->
                                            <% if (invoice.status !=='paid' && invoice.status !=='cancelled' ) { %>
                                                <button data-action="pay" data-invoice-id="<%= invoice.id %>"
                                                    class="w-8 h-8 rounded-lg flex items-center justify-center text-green-600 hover:bg-green-100 hover:text-green-700 transition-all"
                                                    title="Bayar">
                                                    <i class="fas fa-money-bill-wave"></i>
                                                </button>
                                                <% } %>

                                                    <!-- Isolate/Restore -->
                                                    <% if (invoice.status==='overdue' || invoice.customer_is_isolated) {
                                                        %>
                                                        <button data-action="restore"
                                                            data-customer-id="<%= invoice.customer_id %>"
                                                            data-customer-name="<%= invoice.customer_name %>"
                                                            class="w-8 h-8 rounded-lg flex items-center justify-center text-amber-600 hover:bg-amber-100 hover:text-amber-700 transition-all"
                                                            title="Unisolir">
                                                            <i class="fas fa-unlock"></i>
                                                        </button>
                                                        <% } else { %>
                                                            <button data-action="isolate"
                                                                data-customer-id="<%= invoice.customer_id %>"
                                                                data-customer-name="<%= invoice.customer_name %>"
                                                                class="w-8 h-8 rounded-lg flex items-center justify-center text-red-600 hover:bg-red-100 hover:text-red-700 transition-all"
                                                                title="Isolir">
                                                                <i class="fas fa-lock"></i>
                                                            </button>
                                                            <% } %>

                                                                <!-- Delete -->
                                                                <button data-action="delete"
                                                                    data-invoice-id="<%= invoice.id %>"
                                                                    data-invoice-number="<%= invoice.invoice_number %>"
                                                                    class="w-8 h-8 rounded-lg flex items-center justify-center text-gray-400 hover:bg-red-50 hover:text-red-600 transition-all"
                                                                    title="Hapus">
                                                                    <i class="fas fa-trash"></i>
                                                                </button>
                                </div>
                            </td>
                        </tr>
                        <% }); %>
                            <% } else { %>
                                <tr>
                                    <td colspan="9" class="px-6 py-16 text-center text-gray-400">
                                        <div class="flex flex-col items-center justify-center">
                                            <div
                                                class="w-16 h-16 bg-gray-50 rounded-full flex items-center justify-center mb-3 text-gray-300">
                                                <i class="fas fa-inbox text-3xl"></i>
                                            </div>
                                            <p class="font-medium text-gray-500">Tidak ada tagihan ditemukan</p>
                                            <p class="text-xs mt-1">Coba sesuaikan filter pencarian anda.</p>
                                        </div>
                                    </td>
                                </tr>
                                <% } %>
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
<!-- Pagination -->
<% if (pagination.totalPages> 1) { %>
    <div
        class="glass-panel px-4 py-4 flex items-center justify-between mt-6 rounded-xl shadow-lg border border-white/20">
        <div class="flex-1 flex justify-between sm:hidden">
            <% if (pagination.currentPage> 1) { %>
                <a href="?page=<%= pagination.currentPage - 1 %>"
                    class="relative inline-flex items-center px-4 py-2 border border-blue-200 text-sm font-medium rounded-lg text-blue-700 bg-white hover:bg-blue-50 transition-colors shadow-sm">
                    Sebelumnya
                </a>
                <% } %>
                    <% if (pagination.currentPage < pagination.totalPages) { %>
                        <a href="?page=<%= pagination.currentPage + 1 %>"
                            class="ml-3 relative inline-flex items-center px-4 py-2 border border-blue-200 text-sm font-medium rounded-lg text-blue-700 bg-white hover:bg-blue-50 transition-colors shadow-sm">
                            Selanjutnya
                        </a>
                        <% } %>
        </div>
        <div class="hidden sm:flex-1 sm:flex sm:items-center sm:justify-between">
            <div>
                <p class="text-sm text-gray-700 font-medium">
                    Menampilkan <span class="font-bold text-blue-700">
                        <%= ((pagination.currentPage - 1) * pagination.limit) + 1 %>
                    </span>
                    sampai <span class="font-bold text-blue-700">
                        <%= Math.min(pagination.currentPage * pagination.limit, pagination.totalCount) %>
                    </span>
                    dari <span class="font-bold text-blue-700">
                        <%= pagination.totalCount %>
                    </span> hasil
                </p>
            </div>
            <div>
                <nav class="relative z-0 inline-flex rounded-xl shadow-sm -space-x-px bg-white/50 backdrop-blur-sm"
                    aria-label="Pagination">
                    <% if (pagination.currentPage> 1) { %>
                        <a href="?page=<%= pagination.currentPage - 1 %>"
                            class="relative inline-flex items-center px-3 py-2 rounded-l-xl border border-gray-300 bg-white/60 text-sm font-medium text-gray-500 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                            <i class="fas fa-chevron-left"></i>
                        </a>
                        <% } %>

                            <% for (let i=Math.max(1, pagination.currentPage - 2); i <=Math.min(pagination.totalPages,
                                pagination.currentPage + 2); i++) { %>
                                <% if (i===pagination.currentPage) { %>
                                    <span
                                        class="relative inline-flex items-center px-4 py-2 border border-blue-500 bg-blue-50 text-sm font-bold text-blue-600 z-10">
                                        <%= i %>
                                    </span>
                                    <% } else { %>
                                        <a href="?page=<%= i %>"
                                            class="relative inline-flex items-center px-4 py-2 border border-gray-300 bg-white/60 text-sm font-medium text-gray-700 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                                            <%= i %>
                                        </a>
                                        <% } %>
                                            <% } %>

                                                <% if (pagination.currentPage < pagination.totalPages) { %>
                                                    <a href="?page=<%= pagination.currentPage + 1 %>"
                                                        class="relative inline-flex items-center px-3 py-2 rounded-r-xl border border-gray-300 bg-white/60 text-sm font-medium text-gray-500 hover:bg-blue-50 hover:text-blue-600 transition-colors">
                                                        <i class="fas fa-chevron-right"></i>
                                                    </a>
                                                    <% } %>
                </nav>
            </div>
        </div>
    </div>
    <% } %>

        <!-- Generate Invoice Modal -->
        <div id="generateInvoiceModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 12px; padding: 24px; max-width: 500px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; font-weight: bold; color: #111827; margin: 0;">
                        <i class="fas fa-file-invoice" style="color: #16a34a; margin-right: 8px;"></i>Generate Tagihan
                    </h3>
                    <button id="btnCloseModal" data-action="close-modal"
                        style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">
                        &times;
                    </button>
                </div>

                <!-- Form -->
                <form id="generateInvoiceForm">
                    <!-- Period Selection -->
                    <div style="margin-bottom: 20px;">
                        <div>
                            <label
                                style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">
                                Periode Tagihan:
                            </label>
                            <input type="month" id="invoicePeriod" required
                                style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                            <p style="margin-top: 6px; font-size: 12px; color: #6b7280; font-style: italic;">
                                *Jatuh tempo akan diset otomatis sesuai pengaturan scheduler/otomasi.
                            </p>
                        </div>
                    </div>

                    <!-- Target Selection -->
                    <div style="margin-bottom: 16px;">
                        <label
                            style="display: block; font-size: 14px; font-weight: 600; color: #374151; margin-bottom: 8px;">Target:</label>
                        <div
                            style="display: flex; gap: 16px; background: #f3f4f6; padding: 4px; border-radius: 8px; display: inline-flex;">
                            <label
                                style="display: flex; align-items: center; cursor: pointer; padding: 6px 12px; border-radius: 6px;"
                                id="lblTargetAll" class="bg-white shadow-sm">
                                <input type="radio" name="targetType" value="all" checked
                                    onchange="toggleCustomerSelect('all')" style="margin-right: 6px;">
                                <span style="font-size: 14px;">Semua Pelanggan</span>
                            </label>
                            <label
                                style="display: flex; align-items: center; cursor: pointer; padding: 6px 12px; border-radius: 6px;"
                                id="lblTargetSelected">
                                <input type="radio" name="targetType" value="selected"
                                    onchange="toggleCustomerSelect('selected')" style="margin-right: 6px;">
                                <span style="font-size: 14px;">Pilih Manual</span>
                            </label>
                        </div>
                    </div>

                    <!-- Customer Selector -->
                    <div id="customerSelectorContainer"
                        style="display: none; border: 1px solid #d1d5db; border-radius: 8px; padding: 12px; margin-bottom: 16px; background: #f9fafb;">
                        <input type="text" id="customerSearch" placeholder="Cari nama pelanggan..."
                            onkeyup="filterCustomers()"
                            style="width: 100%; padding: 8px 12px; margin-bottom: 8px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 13px;">

                        <div
                            style="margin-bottom: 6px; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: #6b7280; font-weight: 600;">Daftar Pelanggan
                                Aktif</span>
                            <button type="button" onclick="selectAllCustomersFiltered()"
                                style="font-size: 11px; color: #2563eb; background: none; border: none; cursor: pointer;">Pilih
                                Tampil</button>
                        </div>

                        <div id="customerList"
                            style="max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 1px; border: 1px solid #e5e7eb; background: white; border-radius: 6px;">
                            <% if (typeof activeCustomers !=='undefined' && activeCustomers) { %>
                                <% activeCustomers.forEach(c=> { %>
                                    <label class="customer-item"
                                        style="display: flex; align-items: center; cursor: pointer; padding: 8px; border-bottom: 1px solid #f3f4f6;">
                                        <input type="checkbox" name="customer_ids" value="<%= c.id %>"
                                            data-name="<%= c.name.toLowerCase() %> <%= (c.customer_code || '').toLowerCase() %>"
                                            onchange="updateSelectedCount()" style="margin-right: 10px;">
                                        <div style="flex: 1;">
                                            <div style="font-size: 13px; font-weight: 500; color: #1f2937;">
                                                <%= c.name %>
                                            </div>
                                            <div style="font-size: 11px; color: #6b7280;">
                                                <%= c.odc_name || 'No ODC' %> • <%= c.customer_code || '-' %>
                                            </div>
                                        </div>
                                    </label>
                                    <% }) %>
                                        <% } else { %>
                                            <div
                                                style="padding: 12px; text-align: center; color: #6b7280; font-size: 12px;">
                                                Data pelanggan tidak tersedia</div>
                                            <% } %>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: #6b7280; text-align: right;">
                            <span id="selectedCustomerCount">0</span> pelanggan dipilih
                        </div>
                    </div>

                    <!-- WhatsApp Option -->
                    <div style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="sendWhatsapp"
                                style="width: 18px; height: 18px; margin-right: 8px; cursor: pointer;">
                            <span style="font-size: 14px; color: #374151;">
                                <i class="fab fa-whatsapp" style="color: #25d366; margin-right: 4px;"></i>
                                Kirim notifikasi WhatsApp otomatis
                            </span>
                        </label>
                    </div>

                    <!-- Info Box -->
                    <div
                        style="background-color: #dbeafe; border-left: 4px solid #3b82f6; padding: 12px; border-radius: 6px; margin-bottom: 20px;">
                        <p style="font-size: 12px; color: #1e40af; margin: 0; line-height: 1.5;">
                            <i class="fas fa-info-circle" style="margin-right: 4px;"></i>
                            Fitur ini akan meng-generate tagihan untuk pelanggan yang <strong>belum memiliki
                                tagihan</strong> pada periode yang dipilih.
                        </p>
                    </div>

                    <!-- Buttons -->
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button type="button" id="btnCancelModal" data-action="cancel-modal"
                            style="padding: 10px 20px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 8px; font-weight: 500; cursor: pointer;">
                            Batal
                        </button>
                        <button type="submit"
                            style="padding: 10px 20px; border: none; background: #16a34a; color: white; border-radius: 8px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center;">
                            <i class="fas fa-check" style="margin-right: 6px;"></i>
                            Generate
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Print ODC Modal with Search -->
        <div id="odcPrintModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 12px; padding: 24px; max-width: 600px; width: 90%; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); max-height: 80vh; display: flex; flex-direction: column;">
                <!-- Header -->
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="font-size: 20px; font-weight: bold; color: #111827; margin: 0;">
                        <i class="fas fa-print" style="color: #0891b2; margin-right: 8px;"></i>Print Tagihan Area ODC
                    </h3>
                    <button onclick="closeOdcPrintModal()"
                        style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6b7280;">
                        &times;
                    </button>
                </div>

                <!-- Search Box -->
                <div style="margin-bottom: 16px;">
                    <div style="position: relative;">
                        <i class="fas fa-search"
                            style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: #9ca3af;"></i>
                        <input type="text" id="odcSearchInput" placeholder="Cari nama ODC atau lokasi..."
                            onkeyup="filterOdcList()"
                            style="width: 100%; padding: 10px 12px 10px 36px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
                    </div>
                </div>

                <!-- ODC List Container -->
                <div style="flex: 1; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px;">
                    <% if (typeof odcList !=='undefined' && odcList && odcList.length> 0) { %>
                        <div id="odcListContainer" style="display: grid; gap: 8px;">
                            <% odcList.forEach(function(odc) { %>
                                <div class="odc-item" data-name="<%= odc.name.toLowerCase() %>"
                                    data-location="<%= (odc.location || '').toLowerCase() %>"
                                    style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #f3f4f6; border-radius: 6px;"
                                    class="hover:bg-gray-50">
                                    <div>
                                        <div style="font-weight: 600; color: #1f2937;">
                                            <%= odc.name %>
                                        </div>
                                        <div style="font-size: 12px; color: #6b7280; margin-top: 2px;">
                                            <i class="fas fa-map-pin" style="margin-right: 4px;"></i>
                                            <%= odc.location || 'Lokasi tidak tersedia' %>
                                        </div>
                                    </div>
                                    <a href="/billing/tagihan/print-odc/<%= odc.id %>?period=<%= filters.period || '' %>&format=thermal"
                                        target="_blank"
                                        style="display: inline-flex; align-items: center; background-color: #0891b2; color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-size: 13px; font-weight: 500;">
                                        <i class="fas fa-print" style="margin-right: 6px;"></i> Print
                                    </a>
                                </div>
                                <% }); %>
                        </div>
                        <div id="odcNoResults"
                            style="display: none; text-align: center; padding: 20px; color: #6b7280;">
                            <i class="fas fa-search" style="font-size: 24px; margin-bottom: 8px; color: #d1d5db;"></i>
                            <p>Tidak ada ODC yang cocok</p>
                        </div>
                        <% } else { %>
                            <div style="text-align: center; padding: 40px; color: #6b7280;">
                                <i class="fas fa-inbox"
                                    style="font-size: 32px; margin-bottom: 12px; color: #d1d5db;"></i>
                                <p>Belum ada data ODC</p>
                            </div>
                            <% } %>
                </div>

                <!-- Footer -->
                <div
                    style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <span style="font-size: 12px; color: #6b7280;">
                        Total: <%= typeof odcList !=='undefined' ? odcList.length : 0 %> Area
                    </span>
                    <button onclick="closeOdcPrintModal()"
                        style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 14px;">
                        Tutup
                    </button>
                </div>
            </div>
        </div>

        <script>
            /**
             * TAGIHAN PAGE MANAGER
             * Consolidates all logic for WhatsApp, Isolation, Payments, and Bulk Actions.
             */

            // --- CONSTANTS & HELPERS ---
            const selectAll = document.getElementById('selectAll');
            const checkboxes = () => document.querySelectorAll('.invoice-checkbox');
            const checkedCheckboxes = () => document.querySelectorAll('.invoice-checkbox:checked');

            // --- INITIALIZATION ---
            document.addEventListener('DOMContentLoaded', () => {
                console.log('🚀 Tagihan Page Manager Initialized');
                updateBulkUI();

                // Set default month for generate modal
                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const periodInput = document.getElementById('invoicePeriod');
                if (periodInput && !periodInput.value) {
                    periodInput.value = currentMonth;
                }

                // Period change listener
                if (periodInput) {
                    periodInput.addEventListener('change', checkExistingInvoices);
                }
            });

            // --- UI STATE UPDATERS ---
            function updateBulkUI() {
                const count = checkedCheckboxes().length;

                // Update Badge Counts
                const badges = {
                    'selectedCount': count,
                    'selectedPrintCount': count,
                    'selectedReminderCount': count,
                    'selectedSendWACount': count
                };

                for (const [id, val] of Object.entries(badges)) {
                    const el = document.getElementById(id);
                    if (el) el.textContent = val;
                }

                // Toggle visibility of bulk items
                const bulkItems = document.querySelectorAll('.bulk-delete-hidden, .bulk-print-hidden, .bulk-reminder-hidden');
                if (count > 0) {
                    bulkItems.forEach(el => {
                        el.classList.add('bulk-delete-visible');
                        el.classList.remove('bulk-delete-hidden');
                    });
                } else {
                    bulkItems.forEach(el => {
                        el.classList.remove('bulk-delete-visible');
                        el.classList.add('bulk-delete-hidden', 'bulk-print-hidden', 'bulk-reminder-hidden');
                    });
                }

                // Update Select All Checkbox state
                if (selectAll) {
                    const total = checkboxes().length;
                    selectAll.checked = total > 0 && count === total;
                    selectAll.indeterminate = count > 0 && count < total;
                }
            }

            // --- ACTION HANDLERS ---

            // 1. WhatsApp Actions
            async function sendInvoiceWA(id, btn) {
                const res = await Swal.fire({
                    title: 'Kirim WhatsApp?',
                    text: "Kirim rincian tagihan ini langsung ke nomor pelanggan?",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Kirim Sekarang',
                    cancelButtonText: 'Batal',
                    confirmButtonColor: '#10b981',
                    cancelButtonColor: '#6b7280'
                });

                if (!res.isConfirmed) return;

                const originalInner = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

                try {
                    const response = await fetch(`/billing/tagihan/${id}/send-whatsapp`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const data = await response.json();

                    if (data.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Berhasil!',
                            text: data.message,
                            toast: true,
                            position: 'top-end',
                            timer: 3000,
                            showConfirmButton: false
                        });
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', 'Gagal menghubungi server.', 'error');
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalInner;
                }
            }

            async function processBulkWA(ids) {
                const btn = document.getElementById('btnBulkSendWA');
                const originalText = btn ? btn.innerHTML : '';

                if (btn) {
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
                }

                try {
                    const response = await fetch('/billing/tagihan/bulk-send-whatsapp', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ invoice_ids: ids })
                    });
                    const data = await response.json();

                    Swal.fire({
                        title: 'Antrean Dimulai',
                        text: data.message || 'Tagihan masuk dalam antrean pengiriman masal.',
                        icon: 'success'
                    }).then(() => location.reload());
                } catch (e) {
                    Swal.fire('Error', 'Gagal memproses pengiriman masal.', 'error');
                    if (btn) {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                }
            }

            async function bulkSendReminder() {
                const selected = Array.from(checkedCheckboxes()).map(cb => cb.value);
                if (selected.length === 0) return;

                const res = await Swal.fire({
                    title: 'Kirim Pengingat?',
                    text: `Kirim pengingat WhatsApp ke ${selected.length} pelanggan terpilih?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Kirim'
                });

                if (!res.isConfirmed) return;

                Swal.fire({ title: 'Memproses...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                try {
                    const response = await fetch('/billing/tagihan/bulk-reminder', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ invoiceIds: selected })
                    });
                    const data = await response.json();

                    if (data.success) {
                        Swal.fire('Sukses', data.message, 'success');
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', 'Terjadi kesalahan sistem.', 'error');
                }
            }

            // 2. Isolation / Restore
            async function toggleIsolation(customerId, customerName, action) {
                const isIsolate = action === 'isolate';
                const actionLabel = isIsolate ? 'Isolir' : 'Pulihkan';

                const res = await Swal.fire({
                    title: `${actionLabel} Pelanggan?`,
                    html: `Yakin ingin ${actionLabel.toLowerCase()} akses internet <b>${customerName}</b>?<br><br><small class="text-gray-500">Tindakan ini akan mempengaruhi status di MikroTik.</small>`,
                    icon: isIsolate ? 'warning' : 'info',
                    showCancelButton: true,
                    confirmButtonText: `Ya, ${actionLabel}!`,
                    confirmButtonColor: isIsolate ? '#ef4444' : '#10b981',
                    cancelButtonText: 'Batal'
                });

                if (!res.isConfirmed) return;

                const { value: reason } = await Swal.fire({
                    title: 'Alasan ' + actionLabel,
                    input: 'text',
                    inputValue: isIsolate ? 'Keterlambatan pembayaran' : 'Pembayaran telah diterima',
                    inputPlaceholder: 'Masukkan alasan...',
                    showCancelButton: true,
                    confirmButtonText: 'Submit'
                });

                if (reason === undefined) return;

                Swal.showLoading();
                try {
                    const endpoint = isIsolate ? '/billing/customer/isolate' : '/billing/customer/restore';
                    const response = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ customerId, reason })
                    });
                    const data = await response.json();

                    if (data.success) {
                        Swal.fire('Sukses', `Pelanggan berhasil ${isIsolate ? 'diisolir' : 'dipulihkan'}.`, 'success')
                            .then(() => location.reload());
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', 'Terjadi kesalahan sistem.', 'error');
                }
            }

            // 3. Invoice Actions (Single & Bulk Delete)
            async function deleteInvoice(id, number) {
                const res = await Swal.fire({
                    title: 'Hapus Tagihan?',
                    html: `Hapus permanent tagihan <b>${number}</b>?<br><br><span class="text-red-600 text-xs font-bold">⚠️ PERINGATAN: Data pembayaran terkait juga akan terhapus!</span>`,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Hapus!',
                    confirmButtonColor: '#ef4444',
                    cancelButtonText: 'Batal'
                });

                if (!res.isConfirmed) return;

                try {
                    const response = await fetch(`/billing/tagihan/${id}`, { method: 'DELETE' });
                    const data = await response.json();
                    if (data.success) {
                        Swal.fire('Terhapus', data.message, 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', 'Penghapusan gagal.', 'error');
                }
            }

            async function bulkDeleteInvoices() {
                const ids = Array.from(checkedCheckboxes()).map(cb => cb.value);
                if (ids.length === 0) return;

                const res = await Swal.fire({
                    title: `Hapus ${ids.length} Tagihan?`,
                    text: "Tindakan ini tidak dapat dibatalkan!",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Hapus Masal',
                    confirmButtonColor: '#ef4444'
                });

                if (!res.isConfirmed) return;

                Swal.showLoading();
                try {
                    const response = await fetch('/billing/tagihan/bulk-delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ invoiceIds: ids })
                    });
                    const data = await response.json();
                    Swal.fire('Selesai', `Berhasil: ${data.deleted}, Gagal: ${data.failed}`, 'success').then(() => location.reload());
                } catch (e) {
                    Swal.fire('Error', 'Gagal memproses penghapusan masal.', 'error');
                }
            }

            // 4. Modal Functions (Janji Bayar)
            window.openJanjiBayarModal = function (id, currentDueDate) {
                document.getElementById('janjiBayarInvoiceId').value = id;
                const inputDate = document.getElementById('janjiBayarDate');
                if (currentDueDate) {
                    const date = new Date(currentDueDate);
                    if (!isNaN(date)) inputDate.value = date.toISOString().split('T')[0];
                }
                document.getElementById('janjiBayarModal').style.display = 'block';
            };

            window.closeJanjiBayarModal = function () {
                document.getElementById('janjiBayarModal').style.display = 'none';
            };

            window.saveJanjiBayar = async function () {
                const id = document.getElementById('janjiBayarInvoiceId').value;
                const date = document.getElementById('janjiBayarDate').value;

                if (!date) return Swal.fire('Peringatan', 'Harap pilih tanggal!', 'warning');

                const res = await Swal.fire({
                    title: 'Simpan Janji Bayar?',
                    text: `Jatuh tempo akan diubah ke ${new Date(date).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}.`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Simpan'
                });

                if (!res.isConfirmed) return;

                try {
                    const response = await fetch(`/billing/tagihan/${id}/due-date`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ due_date: date })
                    });
                    const data = await response.json();
                    if (data.success) {
                        Swal.fire('Berhasil', 'Janji bayar telah disimpan.', 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', 'Kesalahan sistem.', 'error');
                }
            };

            // 5. Generate Modal Functions
            window.showGenerateInvoiceModal = function () {
                const modal = document.getElementById('generateInvoiceModal');
                if (modal) modal.style.display = 'flex';

                const now = new Date();
                const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;

                const periodInput = document.getElementById('invoicePeriod');
                if (periodInput) {
                    if (!periodInput.value) periodInput.value = currentMonth;
                    checkExistingInvoices();
                }
            };

            window.closeGenerateInvoiceModal = function () {
                const modal = document.getElementById('generateInvoiceModal');
                if (modal) modal.style.display = 'none';
            };

            window.toggleCustomerSelect = function (type) {
                const container = document.getElementById('customerSelectorContainer');
                const lblAll = document.getElementById('lblTargetAll');
                const lblSel = document.getElementById('lblTargetSelected');

                if (type === 'selected') {
                    container.style.display = 'block';
                    if (lblSel) lblSel.classList.add('bg-white', 'shadow-sm');
                    if (lblAll) lblAll.classList.remove('bg-white', 'shadow-sm');
                } else {
                    container.style.display = 'none';
                    if (lblAll) lblAll.classList.add('bg-white', 'shadow-sm');
                    if (lblSel) lblSel.classList.remove('bg-white', 'shadow-sm');
                }
            };

            window.filterCustomers = function () {
                const search = document.getElementById('customerSearch').value.toLowerCase();
                const items = document.querySelectorAll('.customer-item');
                items.forEach(item => {
                    const name = item.getAttribute('data-name').toLowerCase();
                    const alreadyHas = item.classList.contains('already-generated');

                    if (alreadyHas) {
                        item.style.display = 'none';
                    } else {
                        item.style.display = name.includes(search) ? 'flex' : 'none';
                    }
                });
            };

            window.selectAllCustomersFiltered = function () {
                const items = document.querySelectorAll('.customer-item');
                items.forEach(item => {
                    if (item.style.display !== 'none') {
                        const cb = item.querySelector('input');
                        if (cb) cb.checked = true;
                    }
                });
                updateSelectedCount();
            };

            window.updateSelectedCount = function () {
                const count = document.querySelectorAll('input[name="customer_ids"]:checked').length;
                const el = document.getElementById('selectedCustomerCount');
                if (el) el.textContent = count;
            };

            // Dynamic duplicate check
            let existingInvoicesCustomerIds = [];
            async function checkExistingInvoices() {
                const period = document.getElementById('invoicePeriod').value;
                if (!period) return;

                try {
                    const response = await fetch(`/billing/tagihan/check-duplicates?period=${period}`);
                    const data = await response.json();

                    if (data.success) {
                        existingInvoicesCustomerIds = data.customerIds;
                        updateCustomerListVisibility();
                    }
                } catch (error) {
                    console.error('Error checking existing invoices:', error);
                }
            }

            function updateCustomerListVisibility() {
                const container = document.getElementById('customerList');
                if (!container) return;

                const items = container.querySelectorAll('.customer-item');
                const search = document.getElementById('customerSearch')?.value.toLowerCase() || "";

                items.forEach(item => {
                    const cb = item.querySelector('input');
                    if (!cb) return;

                    const customerId = parseInt(cb.value);
                    const name = item.getAttribute('data-name').toLowerCase();
                    const alreadyHas = existingInvoicesCustomerIds.includes(customerId);

                    if (alreadyHas) {
                        item.style.display = 'none';
                        item.classList.add('already-generated');
                        cb.checked = false;
                    } else if (name.includes(search)) {
                        item.style.display = 'flex';
                        item.classList.remove('already-generated');
                    } else {
                        item.style.display = 'none';
                        item.classList.remove('already-generated');
                    }
                });

                updateSelectedCount();
            }

            // Generate Logic
            async function generateInvoicesFromForm() {
                const period = document.getElementById('invoicePeriod').value;
                const sendWA = document.getElementById('sendWhatsapp').checked;
                const targetType = document.querySelector('input[name="targetType"]:checked').value;

                let customerIds = null;
                if (targetType === 'selected') {
                    customerIds = Array.from(document.querySelectorAll('input[name="customer_ids"]:checked')).map(cb => cb.value);
                    if (customerIds.length === 0) return Swal.fire('Error', 'Pilih minimal satu pelanggan!', 'error');
                }

                const res = await Swal.fire({
                    title: 'Generate Tagihan?',
                    text: `Periode: ${period}. Ingin melanjutkan?`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Ya, Generate'
                });

                if (!res.isConfirmed) return;

                Swal.fire({ title: 'Memproses...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

                try {
                    const response = await fetch('/billing/tagihan/generate-bulk', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            period,
                            customer_ids: customerIds,
                            send_whatsapp: sendWA
                        })
                    });
                    const data = await response.json();

                    if (data.success) {
                        Swal.fire('Sukses', data.message, 'success').then(() => location.reload());
                    } else {
                        Swal.fire('Gagal', data.message, 'error');
                    }
                } catch (e) {
                    Swal.fire('Error', 'Terjadi kesalahan sistem.', 'error');
                }
            }

            // 6. Print & Export Functions
            function printAllInvoices() {
                const params = new URLSearchParams(window.location.search);
                window.open('/billing/tagihan/print-all?' + params.toString(), '_blank');
            }

            function printSelectedInvoices() {
                const selected = Array.from(checkedCheckboxes()).map(cb => cb.value);
                if (selected.length === 0) return;

                const params = new URLSearchParams();
                selected.forEach(id => params.append('ids[]', id));
                window.open('/billing/tagihan/print-all?' + params.toString(), '_blank');
            }

            function exportPDF() {
                const params = new URLSearchParams(window.location.search);
                window.open('/billing/tagihan/export/pdf?' + params.toString(), '_blank');
            }

            function showOdcPrintModal() {
                const modal = document.getElementById('odcPrintModal');
                if (modal) modal.style.display = 'flex';
            }

            function closeOdcPrintModal() {
                const modal = document.getElementById('odcPrintModal');
                if (modal) modal.style.display = 'none';
            }

            // --- EVENT DELEGATION ---
            document.addEventListener('click', function (e) {
                // 1. Action Buttons
                const btn = e.target.closest('[data-action]');
                if (btn) {
                    const action = btn.dataset.action;
                    const id = btn.dataset.invoiceId;
                    const number = btn.dataset.invoiceNumber;
                    const customerId = btn.dataset.customerId;
                    const customerName = btn.dataset.customerName;

                    switch (action) {
                        case 'detail':
                            window.location.href = `/billing/tagihan/${id}`;
                            break;
                        case 'pay':
                            window.location.href = `/billing/tagihan/${id}/pay`;
                            break;
                        case 'promise':
                            openJanjiBayarModal(id, btn.dataset.invoiceDate);
                            break;
                        case 'send-wanew':
                            sendInvoiceWA(id, btn);
                            break;
                        case 'print':
                            // Toggle dropdown
                            const menu = document.getElementById(`printMenu-${id}`);
                            if (menu) {
                                document.querySelectorAll('[id^="printMenu-"]').forEach(m => {
                                    if (m !== menu) m.classList.add('hidden');
                                });
                                menu.classList.toggle('hidden');
                                e.stopPropagation();
                            }
                            break;
                        case 'isolate':
                            toggleIsolation(customerId, customerName, 'isolate');
                            break;
                        case 'restore':
                            toggleIsolation(customerId, customerName, 'restore');
                            break;
                        case 'delete':
                            deleteInvoice(id, number);
                            break;
                        case 'bulk-delete':
                            bulkDeleteInvoices();
                            break;
                        case 'bulk-reminder':
                            bulkSendReminder();
                            break;
                        case 'bulk-send-wa':
                            const selectedIdsWA = Array.from(checkedCheckboxes()).map(cb => cb.value);
                            if (selectedIdsWA.length === 0) {
                                Swal.fire('Info', 'Pilih minimal satu tagihan!', 'info');
                            } else {
                                processBulkWA(selectedIdsWA);
                            }
                            break;
                        case 'print-all':
                            printAllInvoices();
                            break;
                        case 'print-selected':
                            printSelectedInvoices();
                            break;
                        case 'export-pdf':
                            exportPDF();
                            break;
                        case 'open-generate-modal':
                        case 'generate-invoice':
                            showGenerateInvoiceModal();
                            break;
                        case 'close-modal':
                            closeGenerateInvoiceModal();
                            break;
                    }
                }

                // 2. Hide print menus on outside click
                if (!e.target.closest('[data-action="print"]')) {
                    document.querySelectorAll('[id^="printMenu-"]').forEach(m => m.classList.add('hidden'));
                }
            });

            // 3. Selection Handlers
            if (selectAll) {
                selectAll.addEventListener('change', function () {
                    checkboxes().forEach(cb => cb.checked = this.checked);
                    updateBulkUI();
                });
            }

            document.addEventListener('change', (e) => {
                if (e.target.classList.contains('invoice-checkbox')) {
                    updateBulkUI();
                }
            });

            // 4. Form Handlers
            const genForm = document.getElementById('generateInvoiceForm');
            if (genForm) {
                genForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    generateInvoicesFromForm();
                });
            }

            // Expose global functions needed by HTML attributes
            window.showOdcPrintModal = showOdcPrintModal;
            window.closeOdcPrintModal = closeOdcPrintModal;
            window.showGenerateInvoiceModal = showGenerateInvoiceModal;
            window.closeGenerateInvoiceModal = closeGenerateInvoiceModal;
            window.toggleCustomerSelect = toggleCustomerSelect;
            window.filterCustomers = filterCustomers;
            window.selectAllCustomersFiltered = selectAllCustomersFiltered;
            window.updateSelectedCount = updateSelectedCount;
            window.saveJanjiBayar = saveJanjiBayar;
            window.openJanjiBayarModal = openJanjiBayarModal;
            window.closeJanjiBayarModal = closeJanjiBayarModal;

        </script>


        <!-- ODC Print Modal -->
        <div id="odcPrintModal"
            style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
            <div class="bg-white rounded-2xl p-8 max-w-md w-full shadow-2xl transform transition-all">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-xl font-bold text-gray-900 flex items-center gap-2">
                        <i class="fas fa-print text-blue-600"></i> Print Tagihan Area ODC
                    </h3>
                    <button onclick="closeOdcPrintModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form action="/billing/tagihan/print-all" target="_blank" method="GET">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Pilih Area ODC</label>
                            <select name="odc_id" required
                                class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all bg-gray-50">
                                <option value="">Semua ODC</option>
                                <% if (typeof odcList !=='undefined' && odcList) { %>
                                    <% odcList.forEach(odc=> { %>
                                        <option value="<%= odc.id %>">
                                            <%= odc.name %>
                                        </option>
                                        <% }) %>
                                            <% } %>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-2">Format Print</label>
                            <div class="grid grid-cols-2 gap-3">
                                <label class="cursor-pointer">
                                    <input type="radio" name="format" value="thermal" checked class="hidden peer">
                                    <div
                                        class="peer-checked:bg-blue-600 peer-checked:text-white bg-gray-100 p-4 rounded-xl text-center font-bold text-sm transition-all hover:bg-gray-200">
                                        <i class="fas fa-receipt mb-1 block"></i> Thermal (58mm)
                                    </div>
                                </label>
                                <label class="cursor-pointer">
                                    <input type="radio" name="format" value="a4" class="hidden peer">
                                    <div
                                        class="peer-checked:bg-blue-600 peer-checked:text-white bg-gray-100 p-4 rounded-xl text-center font-bold text-sm transition-all hover:bg-gray-200">
                                        <i class="fas fa-file-invoice mb-1 block"></i> Kertas A4
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mt-8">
                        <button type="submit"
                            class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold shadow-lg hover:bg-blue-700 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-print"></i> Mulai Print Area
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Janji Bayar Modal -->
        <div id="janjiBayarModal" style="display: none;"
            class="fixed inset-0 bg-black bg-opacity-50 overflow-y-auto h-full w-full" style="z-index: 9999;">
            <div class="relative top-20 mx-auto p-6 border w-full max-w-md shadow-2xl rounded-2xl bg-white">
                <!-- Header -->
                <div class="text-center">
                    <div
                        class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg mb-4">
                        <i class="fas fa-calendar-check text-white text-2xl"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-gray-900 mb-2">Janji Bayar</h3>
                    <p class="text-sm text-gray-600 mb-6 px-4">
                        Ubah tanggal jatuh tempo invoice. Sistem tidak akan melakukan isolir sebelum tanggal yang
                        ditentukan.
                    </p>
                </div>

                <!-- Form -->
                <div class="space-y-4">
                    <input type="hidden" id="janjiBayarInvoiceId">

                    <div>
                        <label for="janjiBayarDate" class="block text-sm font-semibold text-gray-700 mb-2">
                            <i class="fas fa-calendar text-indigo-600 mr-2"></i>Tanggal Janji Bayar
                        </label>
                        <input type="date" id="janjiBayarDate" required
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition-all text-lg">
                    </div>

                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-yellow-600"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-yellow-800">
                                    <strong>Catatan:</strong> Pelanggan akan menerima notifikasi WhatsApp tentang
                                    perpanjangan jatuh tempo ini.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Buttons -->
                <div class="mt-6 space-y-3">
                    <button type="button" onclick="saveJanjiBayar()"
                        class="w-full px-6 py-3.5 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-base font-semibold rounded-xl shadow-lg hover:shadow-xl hover:from-indigo-700 hover:to-purple-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all transform hover:-translate-y-0.5">
                        <i class="fas fa-save mr-2"></i>Simpan Janji Bayar
                    </button>
                    <button type="button" onclick="closeJanjiBayarModal()"
                        class="w-full px-6 py-3 bg-gray-200 text-gray-700 text-base font-medium rounded-xl hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-all">
                        <i class="fas fa-times mr-2"></i>Batal
                    </button>
                </div>
            </div>
        </div>