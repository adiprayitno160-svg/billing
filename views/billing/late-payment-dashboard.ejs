<div class="container-fluid px-4 py-6">
    <!-- Page Header -->
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
            Late Payment Management
        </h1>
        <p class="text-gray-600">Kelola tracking pembayaran telat</p>
    </div>

    <!-- Flash Messages -->
    <% if (typeof success !=='undefined' && success) { %>
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4">
            <i class="fas fa-check-circle mr-2"></i>
            <%= success %>
        </div>
        <% } %>
            <% if (typeof error !=='undefined' && error) { %>
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <%= error %>
                </div>
                <% } %>

                    <!-- Statistics Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                        <!-- Total High Risk -->
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl shadow-lg p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center"
                                    style="background-color: rgba(255, 255, 255, 0.3) !important;">
                                    <i class="fas fa-exclamation-triangle text-2xl"></i>
                                </div>
                                <span class="text-sm bg-white px-3 py-1 rounded-full"
                                    style="background-color: rgba(255, 255, 255, 0.3) !important;">High Risk</span>
                            </div>
                            <div class="text-3xl font-bold mb-1">
                                <%= stats.count_3_or_more || 0 %>
                            </div>
                            <div class="text-red-100 text-sm">Customer dengan Late Payment â‰¥ 3x</div>
                        </div>



                        <!-- Total Postpaid -->
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-lg p-6 text-white">
                            <div class="flex items-center justify-between mb-4">
                                <div class="w-12 h-12 bg-white rounded-lg flex items-center justify-center"
                                    style="background-color: rgba(255, 255, 255, 0.3) !important;">
                                    <i class="fas fa-users text-2xl"></i>
                                </div>
                                <span class="text-sm bg-white px-3 py-1 rounded-full"
                                    style="background-color: rgba(255, 255, 255, 0.3) !important;">Total</span>
                            </div>
                            <div class="text-3xl font-bold mb-1">
                                <%= stats.total_customers || 0 %>
                            </div>
                            <div class="text-blue-100 text-sm">Total Postpaid Customers</div>
                        </div>
                    </div>

                    <!-- Quick Actions -->
                    <div class="mb-6 flex gap-4">
                        <a href="/billing/late-payment/report"
                            class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-list mr-2"></i>Lihat Laporan Lengkap
                        </a>
                        <a href="/billing/late-payment/export?min_count=3"
                            class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </a>
                        <a href="/settings/system"
                            class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-semibold transition">
                            <i class="fas fa-cog mr-2"></i>Pengaturan
                        </a>
                    </div>

                    <!-- High Risk Customers -->
                    <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800">
                                <i class="fas fa-users text-red-600 mr-2"></i>
                                High Risk Customers
                            </h2>
                            <a href="/billing/late-payment/report?min_count=3"
                                class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                                Lihat Semua <i class="fas fa-arrow-right ml-1"></i>
                            </a>
                        </div>

                        <% if (highRiskCustomers && highRiskCustomers.length> 0) { %>
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Kode</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Nama</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Telepon</th>
                                            <th
                                                class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Late Count</th>
                                            <th
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Last Late Payment</th>
                                            <th
                                                class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
                                                Action</th>
                                        </tr>
                                    </thead>
                                    <tbody class="bg-white divide-y divide-gray-200">
                                        <% highRiskCustomers.forEach(customer=> { %>
                                            <tr
                                                class="<%= customer.late_payment_count >= 4 ? 'bg-red-50' : 'bg-orange-50' %>">
                                                <td
                                                    class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                                    <%= customer.customer_code %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                                    <%= customer.name %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    <%= customer.phone %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-center">
                                                    <span
                                                        class="px-3 py-1 rounded-full text-sm font-bold <%= customer.late_payment_count >= 4 ? 'bg-red-600 text-white' : customer.late_payment_count === 3 ? 'bg-orange-600 text-white' : 'bg-yellow-600 text-white' %>">
                                                        <%= customer.late_payment_count %>
                                                    </span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                                    <%= customer.last_late_payment_date ? new
                                                        Date(customer.last_late_payment_date).toLocaleDateString('id-ID')
                                                        : '-' %>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                                                    <a href="/billing/late-payment/customer/<%= customer.id %>"
                                                        class="text-blue-600 hover:text-blue-900 mr-3">
                                                        <i class="fas fa-eye"></i> Detail
                                                    </a>
                                                    <% if (customer.late_payment_count>= 4) { %>
                                                        <button onclick="resetCounter(<%= customer.id %>)"
                                                            class="text-green-600 hover:text-green-900">
                                                            <i class="fas fa-redo"></i> Reset
                                                        </button>
                                                        <% } %>
                                                </td>
                                            </tr>
                                            <% }); %>
                                    </tbody>
                                </table>
                            </div>
                            <% } else { %>
                                <div class="text-center py-8 text-gray-500">
                                    <i class="fas fa-check-circle text-4xl mb-2"></i>
                                    <p>Tidak ada customer dengan late payment tinggi</p>
                                </div>
                                <% } %>
                    </div>


</div>

<script>
    function resetCounter(customerId) {
        if (!confirm('Apakah Anda yakin ingin reset late payment counter untuk customer ini?')) {
            return;
        }

        fetch(`/billing/late-payment/customer/${customerId}/reset`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                reason: 'Manual reset from dashboard'
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    alert('Counter berhasil direset');
                    location.reload();
                } else {
                    alert('Gagal reset counter: ' + (data.message || 'Unknown error'));
                }
            })
            .catch(err => {
                console.error('Error:', err);
                alert('Terjadi kesalahan saat reset counter');
            });
    }
</script>