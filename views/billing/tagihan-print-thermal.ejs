<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Thermal - <%= invoice.invoice_number %>
    </title>
    <style>
        @page {
            size: 58mm auto;
            margin: 1mm 2mm;
        }

        @media print {
            body {
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                width: 58mm;
            }

            .no-print {
                display: none !important;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            font-size: 8pt;
            line-height: 1.3;
            color: #000;
            width: 58mm;
            max-width: 58mm;
            margin: 0 auto;
            background: white;
        }

        .receipt {
            padding: 2mm;
        }

        /* ===== HEADER ===== */
        .header {
            text-align: center;
            padding-bottom: 3mm;
            margin-bottom: 2mm;
        }

        .company-name {
            font-size: 11pt;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .company-detail {
            font-size: 6.5pt;
            line-height: 1.4;
            margin-top: 1mm;
        }

        /* ===== SEPARATORS ===== */
        .sep {
            border: none;
            border-top: 1px dashed #000;
            margin: 2mm 0;
        }

        .sep-bold {
            border: none;
            border-top: 2px solid #000;
            margin: 2mm 0;
        }

        /* ===== TITLE ===== */
        .title {
            text-align: center;
            font-size: 10pt;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 2mm 0;
        }

        .inv-number {
            text-align: center;
            font-size: 8pt;
            font-weight: bold;
            margin-bottom: 1mm;
        }

        /* ===== INFO ROWS ===== */
        .row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1mm;
            font-size: 7.5pt;
        }

        .row .lbl {
            font-weight: normal;
            flex-shrink: 0;
        }

        .row .val {
            font-weight: bold;
            text-align: right;
            word-break: break-word;
            max-width: 58%;
        }

        .section-title {
            font-size: 7.5pt;
            font-weight: bold;
            text-transform: uppercase;
            margin-bottom: 1mm;
            letter-spacing: 0.5px;
        }

        /* ===== ITEMS TABLE ===== */
        .items-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 7pt;
        }

        .items-table th {
            font-weight: bold;
            padding: 1mm 0;
            text-align: left;
            font-size: 7pt;
            border-bottom: 1px dashed #000;
        }

        .items-table td {
            padding: 1.5mm 0;
            vertical-align: top;
            font-size: 7pt;
        }

        .items-table .col-desc {
            width: 55%;
        }

        .items-table .col-price {
            width: 45%;
            text-align: right;
            font-weight: bold;
        }

        /* ===== TOTALS ===== */
        .total-row {
            display: flex;
            justify-content: space-between;
            font-size: 7.5pt;
            margin-bottom: 1mm;
        }

        .grand-total {
            border-top: 2px solid #000;
            padding-top: 2mm;
            margin-top: 2mm;
        }

        .grand-total .total-row {
            font-size: 10pt;
            font-weight: bold;
        }

        /* ===== PAID STAMP ===== */
        .paid-stamp {
            text-align: center;
            border: 2px solid #000;
            padding: 2mm;
            margin: 2mm 0;
            font-size: 10pt;
            font-weight: bold;
            letter-spacing: 2px;
        }

        /* ===== PAYMENT INFO ===== */
        .payment-box {
            text-align: center;
            font-size: 6.5pt;
            padding: 2mm;
            border: 1px dashed #000;
            line-height: 1.4;
            margin: 2mm 0;
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            font-size: 6pt;
            padding-top: 2mm;
            line-height: 1.4;
        }

        /* ===== SCREEN ONLY ===== */
        @media screen {
            body {
                width: auto;
                max-width: 400px;
                padding: 20px;
                background: #f0f0f0;
            }

            .receipt {
                background: white;
                padding: 15px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
                border-radius: 4px;
            }
        }
    </style>
</head>

<body>
    <!-- Print Controls -->
    <div class="no-print"
        style="position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1000; background: rgba(255,255,255,0.95); padding: 15px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); display: flex; gap: 10px; width: 90%; max-width: 350px; backdrop-filter: blur(5px); border: 1px solid rgba(0,0,0,0.1);">
        <button onclick="window.print()"
            style="flex: 2; background: #007bff; color: white; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: bold; display: flex; align-items: center; justify-content: center; gap: 8px;">
            <span>🖨️</span> Print Pos 58mm
        </button>
        <button onclick="window.close()"
            style="flex: 1; background: #f8f9fa; color: #333; padding: 12px; border: 1px solid #ddd; border-radius: 12px; cursor: pointer; font-size: 14px; font-weight: bold;">
            Tutup
        </button>
    </div>

    <script>
        // Auto print on load (with a small delay to ensure styles are applied)
        window.onload = function () {
            if (window.innerWidth < 768) {
                // On mobile, maybe wait for user to be ready
                console.log('Mobile print ready');
            } else {
                // On desktop, can trigger immediately
                // window.print(); 
            }
        };
    </script>

    <div class="receipt">
        <!-- PAID STAMP -->
        <% if (invoice.status==='paid' || (invoice.paid_amount && parseFloat(invoice.paid_amount)>=
            parseFloat(invoice.total_amount))) { %>
            <div class="paid-stamp">★ LUNAS ★</div>
            <% } %>

                <!-- Header -->
                <div class="header">
                    <div class="company-name">
                        <%= typeof companyInfo !=='undefined' && companyInfo && companyInfo.company_name ?
                            companyInfo.company_name : 'BILLING SYSTEM' %>
                    </div>
                    <div class="company-detail">
                        <% if (typeof companyInfo !=='undefined' && companyInfo) { %>
                            <% if (companyInfo.company_address) { %>
                                <%= companyInfo.company_address %><br>
                                    <% } %>
                                        <% if (companyInfo.company_phone) { %>Telp: <%= companyInfo.company_phone %>
                                                <% } %>
                                                    <% if (companyInfo.company_email) { %><br>
                                                        <%= companyInfo.company_email %>
                                                            <% } %>
                                                                <% } %>
                    </div>
                </div>

                <hr class="sep-bold">

                <!-- Invoice Title -->
                <div class="title">TAGIHAN PEMBAYARAN</div>
                <div class="inv-number">
                    <%= invoice.invoice_number %>
                </div>

                <hr class="sep">

                <!-- Invoice Info -->
                <div class="row">
                    <span class="lbl">Tanggal</span>
                    <span class="val">
                        <%= new Date(invoice.created_at).toLocaleDateString('id-ID', { day: '2-digit' , month: '2-digit'
                            , year: 'numeric' }) %>
                    </span>
                </div>
                <div class="row">
                    <span class="lbl">Periode</span>
                    <span class="val">
                        <% const periodParts=invoice.period.split('-'); const year=periodParts[0]; const
                            monthNum=parseInt(periodParts[1]); const monthNames=['Januari', 'Februari' , 'Maret'
                            , 'April' , 'Mei' , 'Juni' , 'Juli' , 'Agustus' , 'September' , 'Oktober' , 'November'
                            , 'Desember' ]; const monthName=monthNames[monthNum - 1] || invoice.period; %>
                            <%= monthName %>
                                <%= year %>
                    </span>
                </div>
                <div class="row">
                    <span class="lbl">Jatuh Tempo</span>
                    <span class="val" style="font-weight: bold;">
                        <%= new Date(invoice.due_date).toLocaleDateString('id-ID', { day: '2-digit' , month: '2-digit' ,
                            year: 'numeric' }) %>
                    </span>
                </div>

                <hr class="sep">

                <!-- Customer Info -->
                <div class="section-title">PELANGGAN</div>
                <div class="row">
                    <span class="lbl">Nama</span>
                    <span class="val">
                        <%= invoice.customer_name %>
                    </span>
                </div>
                <% if (invoice.customer_code) { %>
                    <div class="row">
                        <span class="lbl">ID</span>
                        <span class="val">
                            <%= invoice.customer_code %>
                        </span>
                    </div>
                    <% } %>
                        <% if (invoice.customer_address) { %>
                            <div class="row">
                                <span class="lbl">Alamat</span>
                                <span class="val">
                                    <%= invoice.customer_address %>
                                </span>
                            </div>
                            <% } %>

                                <hr class="sep">

                                <!-- Items -->
                                <div class="section-title">RINCIAN</div>
                                <table class="items-table">
                                    <thead>
                                        <tr>
                                            <th class="col-desc">Item</th>
                                            <th class="col-price">Harga</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% if (items && items.length> 0) { %>
                                            <% items.forEach(item=> { %>
                                                <tr>
                                                    <td class="col-desc">
                                                        <%= item.description %><br>
                                                            <span style="font-size: 6.5pt; color: #555;">
                                                                <%= item.quantity || 1 %> x Rp <%= new
                                                                        Intl.NumberFormat('id-ID').format(item.unit_price)
                                                                        %>
                                                            </span>
                                                    </td>
                                                    <td class="col-price">
                                                        Rp <%= new Intl.NumberFormat('id-ID').format(item.total_price)
                                                            %>
                                                    </td>
                                                </tr>
                                                <% }); %>
                                                    <% } %>
                                                        <% if (invoice.discount_amount && invoice.discount_amount> 0) {
                                                            %>
                                                            <tr style="color: #d9534f;">
                                                                <td class="col-desc">
                                                                    Diskon
                                                                    <% if (invoice.discount_reason) { %>
                                                                        <br><span style="font-size: 6pt;">(<%=
                                                                                invoice.discount_reason %>)</span>
                                                                        <% } %>
                                                                </td>
                                                                <td class="col-price">
                                                                    - Rp <%= new
                                                                        Intl.NumberFormat('id-ID').format(invoice.discount_amount)
                                                                        %>
                                                                </td>
                                                            </tr>
                                                            <% } %>
                                    </tbody>
                                </table>

                                <hr class="sep">

                                <!-- Totals -->
                                <div class="total-row">
                                    <span>Subtotal</span>
                                    <span style="font-weight: bold;">Rp <%= new
                                            Intl.NumberFormat('id-ID').format(invoice.subtotal || invoice.total_amount)
                                            %></span>
                                </div>
                                <% if (invoice.discount_amount && invoice.discount_amount> 0) { %>
                                    <div class="total-row" style="color: #d9534f;">
                                        <span>Diskon</span>
                                        <span style="font-weight: bold;">- Rp <%= new
                                                Intl.NumberFormat('id-ID').format(invoice.discount_amount) %></span>
                                    </div>
                                    <% } %>

                                        <div class="grand-total">
                                            <div class="total-row">
                                                <span>TOTAL</span>
                                                <span>Rp <%= new Intl.NumberFormat('id-ID').format(invoice.total_amount)
                                                        %></span>
                                            </div>
                                        </div>

                                        <% if (invoice.paid_amount> 0) { %>
                                            <div class="total-row" style="margin-top: 1mm;">
                                                <span>Terbayar</span>
                                                <span style="font-weight: bold; color: #2e7d32;">Rp <%= new
                                                        Intl.NumberFormat('id-ID').format(invoice.paid_amount) %></span>
                                            </div>
                                            <div class="total-row">
                                                <span style="font-weight: bold;">Sisa Bayar</span>
                                                <span style="font-weight: bold; color: #d32f2f;">Rp <%= new
                                                        Intl.NumberFormat('id-ID').format(invoice.remaining_amount ||
                                                        (invoice.total_amount - invoice.paid_amount)) %></span>
                                            </div>
                                            <% } %>

                                                <hr class="sep">

                                                <!-- Payment Info -->
                                                <div class="payment-box">
                                                    <div style="font-weight: bold; margin-bottom: 1mm;">INFORMASI
                                                        PEMBAYARAN</div>
                                                    Harap bayar sebelum jatuh tempo<br>
                                                    Konfirmasi via WhatsApp
                                                    <% if (typeof companyInfo !=='undefined' && companyInfo &&
                                                        companyInfo.company_phone) { %>
                                                        <br>📞 <%= companyInfo.company_phone %>
                                                            <% } %>
                                                                <% if (invoice.notes) { %>
                                                                    <div style="margin-top: 1mm; font-style: italic;">
                                                                        <%= invoice.notes %>
                                                                    </div>
                                                                    <% } %>
                                                </div>

                                                <!-- Footer -->
                                                <div class="footer">
                                                    Terima kasih atas kepercayaan Anda<br>
                                                    <%= new Date().toLocaleString('id-ID', { day: '2-digit' ,
                                                        month: '2-digit' , year: 'numeric' , hour: '2-digit' ,
                                                        minute: '2-digit' }) %>
                                                </div>
    </div>
</body>

</html>