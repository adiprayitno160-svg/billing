<div class="max-w-7xl mx-auto">
    <div class="flex items-center justify-between mb-8">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">Verifikasi Pembayaran</h1>
            <p class="text-gray-500 mt-1">Kelola konfirmasi pembayaran manual dari WhatsApp</p>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-yellow-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Menunggu Verifikasi</p>
                    <h3 class="text-2xl font-bold text-gray-900" id="statPending">0</h3>
                </div>
                <div class="w-12 h-12 bg-yellow-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-clock text-yellow-600 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Disetujui</p>
                    <h3 class="text-2xl font-bold text-gray-900" id="statApproved">0</h3>
                </div>
                <div class="w-12 h-12 bg-green-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-check-circle text-green-600 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Ditolak</p>
                    <h3 class="text-2xl font-bold text-gray-900" id="statRejected">0</h3>
                </div>
                <div class="w-12 h-12 bg-red-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-times-circle text-red-600 text-xl"></i>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500 mb-1">Total Hari Ini</p>
                    <h3 class="text-2xl font-bold text-gray-900" id="statToday">0</h3>
                </div>
                <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
                    <i class="fas fa-calendar-day text-blue-600 text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="bg-white rounded-xl shadow-sm overflow-hidden">
        <!-- Tabs -->
        <div class="flex border-b border-gray-100">
            <button onclick="switchTab('pending')" id="tab-pending"
                class="px-6 py-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600 focus:outline-none transition-colors">
                Menunggu Verifikasi
            </button>
            <button onclick="switchTab('approved')" id="tab-approved"
                class="px-6 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none transition-colors">
                Riwayat Disetujui
            </button>
            <button onclick="switchTab('rejected')" id="tab-rejected"
                class="px-6 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none transition-colors">
                Riwayat Ditolak
            </button>
        </div>

        <!-- Table -->
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Waktu</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Pelanggan</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Bukti</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase tracking-wider">
                            Opsi</th>
                    </tr>
                </thead>
                <tbody id="verificationTableBody" class="divide-y divide-gray-100">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div class="px-6 py-4 border-t border-gray-100 flex items-center justify-between">
            <span class="text-sm text-gray-500" id="paginationInfo">Showing 0 to 0 of 0
                entries</span>
            <div class="flex gap-2">
                <button id="prevBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Prev</button>
                <button id="nextBtn" class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50">Next</button>
            </div>
        </div>
    </div>
</div>

<!-- Verification Modal -->
<div id="verifyModal"
    class="fixed inset-0 z-50 hidden overflow-y-auto w-full h-full bg-black bg-opacity-50 backdrop-blur-sm flex items-center justify-center">
    <div
        class="relative w-full max-w-4xl max-h-[90vh] bg-white rounded-2xl shadow-xl flex flex-col md:flex-row overflow-hidden">

        <!-- Image Section -->
        <div class="w-full md:w-1/2 bg-gray-900 flex items-center justify-center p-4">
            <img id="modalImage" src="" alt="Bukti Transfer"
                class="max-w-full max-h-[60vh] md:max-h-[80vh] object-contain rounded-lg shadow-lg">
            <div id="modalNoImage" class="hidden text-gray-400 flex flex-col items-center">
                <i class="fas fa-image-slash text-5xl mb-3"></i>
                <span>Tidak ada gambar</span>
            </div>
        </div>

        <!-- Form Section -->
        <div class="w-full md:w-1/2 flex flex-col h-full max-h-[90vh]">
            <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                <h3 class="text-xl font-bold text-gray-900">Verifikasi Pembayaran</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600 transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 overflow-y-auto flex-1">
                <!-- Customer Info -->
                <div class="mb-6 p-4 bg-gray-50 rounded-xl">
                    <p class="text-sm text-gray-500 mb-1">Pelanggan</p>
                    <div class="font-semibold text-gray-900 text-lg" id="modalCustomerName">-</div>
                    <div class="text-sm text-gray-600 flex items-center mt-1">
                        <i class="fas fa-phone-alt text-gray-400 mr-2"></i>
                        <span id="modalCustomerPhone">-</span>
                    </div>
                </div>

                <form id="verifyForm" class="space-y-4">
                    <input type="hidden" name="verificationId" id="modalVerificationId">

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Pilih Invoice</label>
                        <select name="invoiceId" id="modalInvoiceSelect"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                            required>
                            <option value="">-- Pilih Tagihan --</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nominal Pembayaran</label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-500">Rp</span>
                            <input type="number" name="amount" id="modalAmount"
                                class="w-full pl-10 rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                                placeholder="0" required>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Catatan (Optional)</label>
                        <textarea name="notes" id="modalNotes" rows="2"
                            class="w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500"
                            placeholder="Catatan verifikasi..."></textarea>
                    </div>
                </form>
            </div>

            <div class="p-6 border-t border-gray-100 bg-gray-50 flex gap-3">
                <button onclick="processVerification('reject')"
                    class="flex-1 py-2.5 bg-white border border-red-300 text-red-600 rounded-lg hover:bg-red-50 font-medium transition-colors">
                    Tolak
                </button>
                <button onclick="processVerification('approve')"
                    class="flex-1 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 font-medium shadow-sm transition-colors">
                    <i class="fas fa-check mr-2"></i> Verifikasi
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentStatus = 'pending';
    let currentPage = 1;

    async function loadData() {
        const tbody = document.getElementById('verificationTableBody');
        tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8"><i class="fas fa-spinner fa-spin text-3xl text-gray-300"></i></td></tr>';

        try {
            const response = await fetch(`/billing/verification/list?status=${currentStatus}&page=${currentPage}`);
            const result = await response.json();

            if (result.success) {
                renderTable(result.data);
                updatePagination(result.pagination);
                updateStats(result.stats);
            } else {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-8 text-red-500">${result.error}</td></tr>`;
            }
        } catch (error) {
            console.error('Error:', error);
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-8 text-red-500">Gagal memuat data</td></tr>';
        }
    }

    function renderTable(data) {
        const tbody = document.getElementById('verificationTableBody');
        if (data.length === 0) {
            tbody.innerHTML = `
            <tr>
                <td colspan="4" class="text-center py-12">
                    <div class="text-gray-300 mb-2"><i class="fas fa-inbox text-5xl"></i></div>
                    <p class="text-gray-500">Tidak ada data verifikasi</p>
                </td>
            </tr>`;
            return;
        }

        tbody.innerHTML = data.map(item => `
        <tr class="hover:bg-gray-50 transition-colors">
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                ${new Date(item.created_at).toLocaleString('id-ID')}
            </td>
            <td class="px-6 py-4">
                <div class="text-sm font-medium text-gray-900">${item.customer_name || 'Unknown'}</div>
                <div class="text-xs text-gray-500">${item.customer_phone || '-'}</div>
            </td>
            <td class="px-6 py-4">
                ${item.proof_image ?
                `<div onclick="openModal(${item.id})" class="cursor-pointer group relative w-16 h-16 rounded-lg overflow-hidden border border-gray-200">
                        <img src="${item.proof_image}" class="w-full h-full object-cover group-hover:scale-110 transition-transform">
                        <div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-20 transition-all flex items-center justify-center">
                            <i class="fas fa-search-plus text-white opacity-0 group-hover:opacity-100"></i>
                        </div>
                    </div>` :
                '<span class="text-xs text-gray-400 italic">Tanpa Gambar</span>'}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                ${item.status === 'pending' ?
                `<button onclick="openModal(${item.id})" class="text-blue-600 hover:text-blue-900 bg-blue-50 hover:bg-blue-100 px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-search mr-1"></i> Periksa
                    </button>` :
                `<span class="px-3 py-1 rounded-full text-xs font-semibold ${item.status === 'approved' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }">${item.status.toUpperCase()}</span>`
            }
            </td>
        </tr>
    `).join('');
    }

    function updatePagination(pagination) {
        document.getElementById('paginationInfo').innerText =
            `Showing ${((pagination.page - 1) * pagination.limit) + 1} to ${Math.min(pagination.total, pagination.page * pagination.limit)} of ${pagination.total} entries`;

        document.getElementById('prevBtn').disabled = pagination.page <= 1;
        document.getElementById('nextBtn').disabled = (pagination.page * pagination.limit) >= pagination.total;

        document.getElementById('prevBtn').onclick = () => { currentPage--; loadData(); };
        document.getElementById('nextBtn').onclick = () => { currentPage++; loadData(); };
    }

    function updateStats(stats) {
        document.getElementById('statPending').innerText = stats.pending || 0;
        document.getElementById('statApproved').innerText = stats.approved || 0;
        document.getElementById('statRejected').innerText = stats.rejected || 0;
        document.getElementById('statToday').innerText = stats.today || 0;
    }

    function switchTab(status) {
        currentStatus = status;
        currentPage = 1;

        // Update tab styles
        ['pending', 'approved', 'rejected'].forEach(t => {
            const btn = document.getElementById(`tab-${t}`);
            if (t === status) {
                btn.className = 'px-6 py-4 text-sm font-medium text-blue-600 border-b-2 border-blue-600 focus:outline-none transition-colors';
            } else {
                btn.className = 'px-6 py-4 text-sm font-medium text-gray-500 hover:text-gray-700 focus:outline-none transition-colors';
            }
        });

        loadData();
    }

    async function openModal(id) {
        try {
            const response = await fetch(`/billing/verification/detail/${id}`);
            const result = await response.json();

            if (!result.success) {
                alert('Gagal memuat detail');
                return;
            }

            const data = result.data;
            document.getElementById('modalVerificationId').value = data.id;
            document.getElementById('modalCustomerName').innerText = data.customer_name;
            document.getElementById('modalCustomerPhone').innerText = data.customer_phone;
            document.getElementById('modalNotes').value = data.notes || '';
            document.getElementById('modalAmount').value = data.amount || '';

            const img = document.getElementById('modalImage');
            const noImg = document.getElementById('modalNoImage');

            if (data.proof_image) {
                img.src = data.proof_image;
                img.classList.remove('hidden');
                noImg.classList.add('hidden');
            } else {
                img.classList.add('hidden');
                noImg.classList.remove('hidden');
            }

            // Load invoices
            const invResponse = await fetch(`/billing/verification/customer-invoices/${data.customer_id}`);
            const invResult = await invResponse.json();

            const select = document.getElementById('modalInvoiceSelect');
            select.innerHTML = '<option value="">-- Pilih Tagihan --</option>';

            if (invResult.success && invResult.data.length > 0) {
                invResult.data.forEach(inv => {
                    const option = document.createElement('option');
                    option.value = inv.id;
                    option.text = `#${inv.invoice_number} - Rp ${Number(inv.remaining_amount).toLocaleString('id-ID')} (${inv.status})`;
                    if (data.invoice_id == inv.id) option.selected = true;
                    // Auto select if only one invoice and amount matches?
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.text = "Tidak ada tagihan aktif";
                option.disabled = true;
                select.appendChild(option);
            }

            document.getElementById('verifyModal').classList.remove('hidden');
        } catch (error) {
            console.error(error);
            alert('Error loading detail');
        }
    }

    function closeModal() {
        document.getElementById('verifyModal').classList.add('hidden');
    }

    async function processVerification(action) {
        if (!confirm(`Apakah Anda yakin ingin ${action === 'approve' ? 'menyetujui' : 'menolak'} verifikasi ini?`)) return;

        const form = document.getElementById('verifyForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        data.action = action; // approve or reject

        if (action === 'approve') {
            if (!data.invoiceId) { alert('Pilih invoice terlebih dahulu!'); return; }
            if (!data.amount) { alert('Isi nominal pembayaran!'); return; }
        }

        try {
            const response = await fetch('/billing/verification/process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            const result = await response.json();

            if (result.success) {
                alert(result.message);
                closeModal();
                loadData();
            } else {
                alert('Gagal: ' + result.message);
            }
        } catch (error) {
            alert('Error processing verification');
        }
    }

    // Init
    loadData();
</script>