<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
        <%= title || 'Form Pembayaran' %>
    </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #f8fafc;
        }

        .payment-type-card {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-width: 2px;
        }

        .payment-type-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        .payment-type-card.selected {
            border-color: #2563eb;
            background-color: #eff6ff;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.1);
        }

        .payment-type-card.selected::before {
            content: '\f058';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #2563eb;
            font-size: 1.25rem;
        }

        .quick-amount-btn {
            position: relative;
            overflow: hidden;
        }

        .quick-amount-btn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 120%;
            height: 120%;
            background: rgba(255, 255, 255, 0.1);
            transform: translate(-50%, -50%) scale(0);
            border-radius: 50%;
            transition: transform 0.5s;
        }

        .quick-amount-btn:active::after {
            transform: translate(-50%, -50%) scale(1);
            transition: 0s;
        }

        .reveal-anim {
            animation: reveal 0.5s ease-out forwards;
        }

        @keyframes reveal {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .highlight-border {
            position: relative;
        }

        .highlight-border::after {
            content: '';
            position: absolute;
            inset: -2px;
            background: linear-gradient(45deg, #3b82f6, #6366f1);
            border-radius: inherit;
            z-index: -1;
            opacity: 0.5;
        }

        input::-webkit-outer-spin-button,
        input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .payment-method-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.1);
        }
    </style>
</head>

<body class="bg-gradient-to-br from-gray-50 via-blue-50 to-gray-100 min-h-screen">
    <div class="min-h-screen py-12">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <!-- Header with animated gradient -->
            <div class="mb-10">
                <a href="/billing/tagihan/<%= invoice.id %>"
                    class="inline-flex items-center text-blue-600 hover:text-blue-700 mb-6 font-bold transition-all hover:-translate-x-1">
                    <i class="fas fa-arrow-left mr-2"></i>Kembali
                </a>
                <div
                    class="bg-gradient-to-br from-blue-700 to-indigo-800 rounded-3xl p-10 text-white shadow-2xl relative overflow-hidden group">
                    <div
                        class="absolute -right-10 -bottom-10 w-64 h-64 bg-white/10 rounded-full blur-3xl group-hover:scale-110 transition-transform duration-700">
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center gap-4 mb-4">
                            <div
                                class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-md">
                                <i class="fas fa-receipt text-2xl"></i>
                            </div>
                            <span
                                class="px-3 py-1 bg-white/20 rounded-lg text-[10px] font-black uppercase tracking-widest backdrop-blur-md">Pembayaran
                                Invoice</span>
                        </div>
                        <h1 class="text-4xl font-black mb-2">Form Kasir Digital</h1>
                        <div class="flex flex-wrap items-center gap-y-2 gap-x-6 text-blue-100">
                            <p class="flex items-center gap-2">
                                <i class="fas fa-hashtag opacity-70"></i>
                                <span class="font-mono bg-white/10 px-2 py-0.5 rounded text-white font-bold">
                                    <%= invoice.invoice_number %>
                                </span>
                            </p>
                            <span class="hidden md:inline opacity-30">|</span>
                            <p class="flex items-center gap-2">
                                <i class="fas fa-user-circle opacity-70"></i>
                                <span class="text-xl font-bold text-white uppercase tracking-tight">
                                    <%= invoice.customer_name %>
                                </span>
                            </p>
                            <span class="hidden md:inline opacity-30">|</span>
                            <p class="flex items-center gap-2">
                                <i class="fas fa-id-card opacity-70"></i>
                                <span class="font-bold text-white">
                                    <%= invoice.customer_code || '-' %>
                                </span>
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Invoice Summary Quick View -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                    <div class="w-10 h-10 bg-blue-50 text-blue-600 rounded-xl flex items-center justify-center"><i
                            class="fas fa-file-invoice"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Total Tagihan</p>
                        <p class="font-black text-slate-800">Rp <%= new
                                Intl.NumberFormat('id-ID').format(invoice.total_amount) %>
                        </p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                    <div class="w-10 h-10 bg-emerald-50 text-emerald-600 rounded-xl flex items-center justify-center"><i
                            class="fas fa-check-circle"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sudah Bayar</p>
                        <p class="font-black text-emerald-600">Rp <%= new
                                Intl.NumberFormat('id-ID').format(invoice.paid_amount || 0) %>
                        </p>
                    </div>
                </div>
                <div
                    class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4 highlight-border">
                    <div class="w-10 h-10 bg-rose-50 text-rose-600 rounded-xl flex items-center justify-center"><i
                            class="fas fa-clock"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Sisa Tagihan</p>
                        <p class="font-black text-rose-600 text-lg">Rp <%= new
                                Intl.NumberFormat('id-ID').format(invoice.remaining_amount) %>
                        </p>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100 flex items-center gap-4">
                    <div class="w-10 h-10 bg-amber-50 text-amber-600 rounded-xl flex items-center justify-center"><i
                            class="fas fa-calendar-alt"></i></div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Jatuh Tempo</p>
                        <p class="font-black text-slate-800">
                            <%= invoice.due_date ? new Date(invoice.due_date).toLocaleDateString('id-ID',
                                {day: '2-digit' , month: 'short' }) : '-' %>
                        </p>
                    </div>
                </div>

                <% if (totalDebt> invoice.remaining_amount) { %>
                    <div
                        class="bg-rose-50 p-5 rounded-2xl shadow-sm border border-rose-100 flex items-center gap-4 highlight-border">
                        <div class="w-10 h-10 bg-rose-100 text-rose-600 rounded-xl flex items-center justify-center">
                            <i class="fas fa-exclamation-triangle"></i>
                        </div>
                        <div>
                            <p class="text-[10px] font-bold text-rose-400 uppercase tracking-widest">Total Tunggakan</p>
                            <p class="font-black text-rose-700 text-lg">Rp <%= new
                                    Intl.NumberFormat('id-ID').format(totalDebt) %>
                            </p>
                        </div>
                    </div>
                    <% } %>
            </div>

            <!-- Payment Form Body -->
            <div class="bg-white rounded-3xl shadow-xl border border-slate-200 overflow-hidden mb-8">
                <div class="bg-slate-50 border-b border-slate-200 px-8 py-5 flex items-center justify-between">
                    <h2 class="text-xl font-black text-slate-800 flex items-center gap-3">
                        <i class="fas fa-cash-register text-blue-600"></i>
                        PROSES TRANSAKSI
                    </h2>
                    <span
                        class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-[10px] font-black uppercase tracking-tighter ring-1 ring-blue-200">Mode
                        Kasir</span>
                </div>

                <form id="payment-form" class="p-8">
                    <!-- Step 1: Payment Type -->
                    <div class="mb-12">
                        <label class="block text-sm font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Pilih
                            Opsi Pembayaran</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="payment-type-card relative group border-2 border-slate-100 rounded-2xl p-6 cursor-pointer hover:border-emerald-400 hover:bg-emerald-50/30 transition-all duration-300"
                                data-type="full">
                                <input type="radio" name="payment_type" value="full" id="type-full" class="hidden">
                                <div class="text-center">
                                    <div
                                        class="w-16 h-16 mx-auto mb-4 bg-emerald-50 text-emerald-600 rounded-2xl flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                        <i class="fas fa-check-double text-2xl"></i>
                                    </div>
                                    <h3 class="font-black text-slate-800 text-lg mb-1 tracking-tight">LUNAS</h3>
                                    <p class="text-xs text-slate-400 font-medium mb-4">Bayar Seluruh Tagihan</p>
                                    <span
                                        class="text-[9px] font-black uppercase tracking-widest py-1 px-2 rounded-md bg-emerald-100 text-emerald-700">Auto
                                        Approve</span>
                                </div>
                            </div>

                            <div class="payment-type-card relative group border-2 border-slate-100 rounded-2xl p-6 cursor-pointer hover:border-blue-400 hover:bg-blue-50/30 transition-all duration-300"
                                data-type="partial">
                                <input type="radio" name="payment_type" value="partial" id="type-partial"
                                    class="hidden">
                                <div class="text-center">
                                    <div
                                        class="w-16 h-16 mx-auto mb-4 bg-blue-50 text-blue-600 rounded-2xl flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                        <i class="fas fa-calculator text-2xl"></i>
                                    </div>
                                    <h3 class="font-black text-slate-800 text-lg mb-1 tracking-tight">CICILAN</h3>
                                    <p class="text-xs text-slate-400 font-medium mb-4">Bayar Sebagian Saja</p>
                                    <span
                                        class="text-[9px] font-black uppercase tracking-widest py-1 px-2 rounded-md bg-blue-100 text-blue-700">Fleksibel</span>
                                </div>
                            </div>

                            <div class="payment-type-card relative group border-2 border-slate-100 rounded-2xl p-6 cursor-pointer hover:border-amber-400 hover:bg-amber-50/30 transition-all duration-300"
                                data-type="debt">
                                <input type="radio" name="payment_type" value="debt" id="type-debt" class="hidden">
                                <div class="text-center">
                                    <div
                                        class="w-16 h-16 mx-auto mb-4 bg-amber-50 text-amber-600 rounded-2xl flex items-center justify-center shadow-sm group-hover:scale-110 transition-transform">
                                        <i class="fas fa-file-invoice text-2xl"></i>
                                    </div>
                                    <h3 class="font-black text-slate-800 text-lg mb-1 tracking-tight">HUTANG</h3>
                                    <p class="text-xs text-slate-400 font-medium mb-4">Tunda (Catat Saja)</p>
                                    <span
                                        class="text-[9px] font-black uppercase tracking-widest py-1 px-2 rounded-md bg-amber-100 text-amber-700">Tanpa
                                        Bayar</span>
                                </div>
                            </div>
                        </div>
                    </div>

            </div>
        </div>

        <!-- Step 1.5: Payment Method -->
        <div class="mb-12">
            <label class="block text-sm font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Metode
                Pembayaran</label>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="payment-method-card selected relative p-6 border-2 border-slate-100 rounded-2xl cursor-pointer hover:border-blue-300 transition-all flex items-center gap-4 bg-white"
                    onclick="selectPaymentMethod('cash')">
                    <div class="w-12 h-12 rounded-full bg-green-100 flex items-center justify-center text-green-600">
                        <i class="fas fa-money-bill-wave text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800">TUNAI (CASH)</h3>
                        <p class="text-xs text-slate-400">Bayar langsung di tempat</p>
                    </div>
                    <input type="radio" name="payment_method" value="cash" id="method-cash" class="hidden" checked>
                    <div class="absolute top-4 right-4 text-blue-600 check-icon">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                </div>

                <div class="payment-method-card relative p-6 border-2 border-slate-100 rounded-2xl cursor-pointer hover:border-blue-300 transition-all flex items-center gap-4 bg-white"
                    onclick="selectPaymentMethod('transfer')">
                    <div class="w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center text-blue-600">
                        <i class="fas fa-university text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800">TRANSFER</h3>
                        <p class="text-xs text-slate-400">Via Bank / E-Wallet</p>
                    </div>
                    <input type="radio" name="payment_method" value="transfer" id="method-transfer" class="hidden">
                    <div class="absolute top-4 right-4 text-blue-600 check-icon hidden">
                        <i class="fas fa-check-circle text-xl"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- SLA Section -->
        <% if (typeof slaDiscount !=='undefined' && slaDiscount) { %>
            <div
                class="mb-12 <%= slaDiscount.applicable ? 'bg-slate-900' : 'bg-slate-50' %> rounded-3xl p-8 relative overflow-hidden <%= slaDiscount.applicable ? 'text-white shadow-2xl' : 'text-slate-800 border border-slate-200' %>">
                <% if (slaDiscount.applicable) { %>
                    <div class="absolute -right-20 -top-20 w-64 h-64 bg-blue-600/20 rounded-full blur-3xl">
                    </div>
                    <% } %>

                        <div class="relative z-10">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-6 mb-8">
                                <div class="flex items-center gap-4">
                                    <div
                                        class="w-14 h-14 <%= slaDiscount.applicable ? 'bg-blue-600' : 'bg-slate-200 text-slate-500' %> rounded-2xl flex items-center justify-center shadow-xl <%= slaDiscount.applicable ? 'shadow-blue-900/50' : '' %>">
                                        <i class="fas fa-shield-virus text-2xl"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-black text-xl tracking-tight">
                                            <%= slaDiscount.applicable ? 'PROTEKSI SLA AKTIF' : 'MONITORING SLA' %>
                                        </h3>
                                        <p
                                            class="<%= slaDiscount.applicable ? 'text-slate-400' : 'text-slate-500' %> text-xs font-medium uppercase tracking-widest">
                                            <%= slaDiscount.applicable ? 'Kompensasi Gangguan Uptime'
                                                : 'Target SLA Terpenuhi' %>
                                        </p>
                                    </div>
                                </div>

                                <% if (slaDiscount.applicable) { %>
                                    <div
                                        class="bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 px-6 py-3 rounded-2xl flex items-center gap-3">
                                        <span class="text-3xl font-black">
                                            <%= slaDiscount.discount_percentage.toFixed(1) %>%
                                        </span>
                                        <span
                                            class="text-[10px] font-black leading-tight uppercase opacity-70">Potongan<br>Tagihan</span>
                                    </div>
                                    <% } else { %>
                                        <div
                                            class="bg-blue-100 text-blue-700 border border-blue-200 px-6 py-3 rounded-2xl flex items-center gap-3">
                                            <span class="text-xl font-black italic">No Discount</span>
                                        </div>
                                        <% } %>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div
                                    class="<%= slaDiscount.applicable ? 'bg-white/5 border-white/10' : 'bg-white border-slate-200 shadow-sm' %> backdrop-blur-md rounded-2xl p-5 border">
                                    <p
                                        class="text-[10px] font-black <%= slaDiscount.applicable ? 'text-slate-500' : 'text-slate-400' %> uppercase tracking-widest mb-2">
                                        Performa Uptime</p>
                                    <div class="flex items-center gap-3">
                                        <span
                                            class="text-2xl font-black <%= slaDiscount.sla_met ? 'text-emerald-400' : 'text-rose-400' %>">
                                            <%= (slaDiscount.uptime_percentage || 0).toFixed(2) %>%
                                        </span>
                                        <span
                                            class="text-[10px] <%= slaDiscount.applicable ? 'text-slate-500' : 'text-slate-400' %>">TGT
                                            <%= (slaDiscount.sla_target || 90).toFixed(0) %>%
                                        </span>
                                    </div>
                                </div>
                                <div
                                    class="<%= slaDiscount.applicable ? 'bg-white/5 border-white/10' : 'bg-white border-slate-200 shadow-sm' %> backdrop-blur-md rounded-2xl p-5 border">
                                    <p
                                        class="text-[10px] font-black <%= slaDiscount.applicable ? 'text-slate-500' : 'text-slate-400' %> uppercase tracking-widest mb-2">
                                        Total Downtime</p>
                                    <div
                                        class="text-2xl font-black <%= slaDiscount.applicable ? 'text-amber-400' : 'text-slate-600' %>">
                                        <%= Math.floor((slaDiscount.total_downtime_minutes || 0) / 60) %>h
                                            <%= (slaDiscount.total_downtime_minutes || 0) % 60 %>m
                                    </div>
                                </div>
                                <div
                                    class="<%= slaDiscount.applicable ? 'bg-white/5 border-white/10' : 'bg-white border-slate-200 shadow-sm' %> backdrop-blur-md rounded-2xl p-5 border">
                                    <p
                                        class="text-[10px] font-black <%= slaDiscount.applicable ? 'text-slate-500' : 'text-slate-400' %> uppercase tracking-widest mb-2">
                                        Kompensasi</p>
                                    <div
                                        class="text-2xl font-black <%= slaDiscount.applicable ? 'text-blue-400' : 'text-slate-400' %>">
                                        Rp <%= new Intl.NumberFormat('id-ID').format(slaDiscount.discount_amount || 0)
                                            %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="sla-discount-amount" value="<%= slaDiscount.discount_amount || 0 %>">
                        <input type="hidden" id="sla-discount-percentage"
                            value="<%= slaDiscount.discount_percentage || 0 %>">
            </div>
            <% } %>

                <!-- Step 2: Amount Entry -->
                <div id="amount-field" class="mb-12 hidden">
                    <label class="block text-sm font-black text-slate-400 uppercase tracking-[0.2em] mb-6">Nominal
                        Pembayaran</label>
                    <div
                        class="bg-gradient-to-br from-blue-700 to-indigo-900 rounded-[2.5rem] p-10 shadow-2xl shadow-blue-200 text-white relative overflow-hidden group">
                        <div
                            class="absolute -right-20 -bottom-20 w-80 h-80 bg-white/10 rounded-full blur-3xl group-hover:scale-110 transition-transform duration-1000">
                        </div>
                        <div class="relative z-10">
                            <div class="relative mb-10">
                                <span
                                    class="absolute left-0 top-1/2 -translate-y-1/2 text-blue-300 font-bold text-3xl opacity-50">Rp</span>
                                <input type="number" name="payment_amount" id="payment_amount"
                                    class="w-full pl-16 pr-6 py-4 text-6xl font-black bg-transparent border-b-4 border-white/20 rounded-none focus:border-white focus:outline-none transition-all placeholder:text-blue-300/30 selection:bg-blue-500 selection:text-white"
                                    placeholder="0" min="1000" step="1000">
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                                <% [25, 50, 75, 100].forEach(p=> { %>
                                    <button type="button" data-percent="<%= p %>"
                                        class="quick-amount-btn py-4 bg-white/10 hover:bg-white text-white hover:text-blue-900 rounded-2xl border border-white/10 transition-all font-black flex items-center justify-center gap-2 group/btn">
                                        <%= p %>%
                                    </button>
                                    <% }) %>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Discounts & Notes -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-10 mb-12">
                    <div class="space-y-8">
                        <div class="p-8 bg-slate-50 rounded-3xl border border-slate-200 shadow-inner">
                            <div class="flex items-center justify-between mb-8">
                                <div class="flex items-center gap-3">
                                    <div
                                        class="w-10 h-10 bg-white shadow-sm border border-slate-200 rounded-xl flex items-center justify-center">
                                        <i class="fas fa-tag text-slate-400 text-sm"></i>
                                    </div>
                                    <h3 class="font-black text-slate-700 tracking-tight">DISKON MANUAL</h3>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer group">
                                    <input type="checkbox" id="discount-toggle" class="sr-only peer">
                                    <div
                                        class="w-14 h-7 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[4px] after:left-[4px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-7 after:transition-all peer-checked:bg-blue-600">
                                    </div>
                                </label>
                            </div>

                            <div id="discount-fields" class="hidden space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="space-y-2">
                                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">
                                            Tipe</p>
                                        <select id="discount_type" name="discount_type"
                                            class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold">
                                            <option value="fixed">Nominal (Rp)</option>
                                            <option value="percentage">Persentase (%)</option>
                                        </select>
                                    </div>
                                    <div class="space-y-2">
                                        <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">
                                            Nilai</p>
                                        <input type="number" id="discount_value" name="discount_value"
                                            class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold"
                                            placeholder="0">
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">
                                        Keterangan Alasan</p>
                                    <input type="text" id="discount_reason" name="discount_reason"
                                        class="w-full px-5 py-4 bg-white border border-slate-200 rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-semibold text-slate-600"
                                        placeholder="Misal: Promo Akhir Tahun">
                                </div>
                            </div>
                        </div>

                        <div class="space-y-2">
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">
                                Catatan Internal / Pelanggan</p>
                            <textarea name="notes" id="notes" rows="3"
                                class="w-full px-6 py-5 bg-slate-50 border border-slate-200 rounded-3xl focus:ring-2 focus:ring-blue-500 focus:bg-white transition-all outline-none font-medium text-slate-700"
                                placeholder="Opsional: Tambahkan catatan jika ada..."></textarea>
                        </div>
                    </div>

                    <!-- Right Column: Final Summary Receipt -->
                    <div id="calculation-display" class="hidden">
                        <div
                            class="bg-slate-900 rounded-[2.5rem] p-10 text-white relative shadow-2xl overflow-hidden min-h-[400px] flex flex-col font-mono">
                            <div
                                class="absolute -right-20 -top-20 w-80 h-80 bg-indigo-600/20 rounded-full blur-[100px]">
                            </div>

                            <div class="relative z-10 flex-1">
                                <div class="flex items-center justify-between mb-10">
                                    <h3 class="text-xs font-black uppercase tracking-[0.3em] text-slate-500">
                                        Receipt Preview</h3>
                                    <i class="fas fa-barcode text-2xl opacity-30"></i>
                                </div>

                                <div class="space-y-6 mb-10">
                                    <div class="flex justify-between items-center group">
                                        <span class="text-sm font-bold text-slate-400">Subtotal
                                            Transaksi</span>
                                        <span class="font-black text-xl" id="calc-subtotal">Rp 0</span>
                                    </div>

                                    <div id="calc-discount-row"
                                        class="hidden flex justify-between items-center text-emerald-400 bg-emerald-400/5 px-5 py-4 rounded-2xl border border-emerald-400/20">
                                        <div class="flex flex-col">
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest opacity-60">Potongan</span>
                                            <span class="text-xs font-bold" id="calc-discount-label">Total
                                                Diskon</span>
                                        </div>
                                        <span class="font-black text-lg" id="calc-discount">- Rp 0</span>
                                    </div>

                                    <div class="border-t border-dashed border-white/20 pt-6">
                                        <div class="flex flex-col gap-1 items-end">
                                            <span
                                                class="text-[10px] font-black uppercase tracking-widest text-blue-400">Total
                                                Bayar</span>
                                            <span class="text-5xl font-black text-white" id="calc-total">Rp
                                                0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="relative z-10 space-y-3">
                                <div id="calc-remaining-row"
                                    class="hidden flex justify-between items-center py-4 px-6 bg-white/5 rounded-2xl border border-white/5">
                                    <span class="text-[10px] font-black uppercase tracking-widest text-slate-500">Sisa
                                        Tagihan</span>
                                    <span class="text-sm font-black text-amber-500" id="calc-remaining">Rp
                                        0</span>
                                </div>
                                <div id="calc-overpayment-row"
                                    class="hidden flex justify-between items-center py-4 px-6 bg-emerald-500/10 rounded-2xl border border-emerald-500/20">
                                    <span
                                        class="text-[10px] font-black uppercase tracking-widest text-emerald-500">Saldo
                                        Akun+</span>
                                    <span class="text-sm font-black text-emerald-400" id="calc-overpayment">Rp 0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row gap-6">
                    <button type="submit" id="submit-btn" disabled
                        class="flex-[2] bg-gradient-to-r from-blue-600 to-indigo-700 text-white px-10 py-6 rounded-[1.5rem] transition-all hover:shadow-3xl hover:shadow-blue-200 font-black text-2xl flex items-center justify-center gap-4 disabled:from-slate-200 disabled:to-slate-300 disabled:text-slate-500 disabled:cursor-not-allowed group active:scale-[0.98]">
                        <span id="btn-text">PROSES PEMBAYARAN</span>
                        <i class="fas fa-chevron-right text-sm group-hover:translate-x-1 transition-transform"></i>
                    </button>
                    <button type="button" onclick="history.back()"
                        class="flex-1 bg-white border-2 border-slate-200 text-slate-500 px-10 py-6 rounded-2xl hover:bg-slate-50 transition-all font-bold text-lg">
                        BATAL
                    </button>
                </div>

                <div id="auto-approve-notice" class="mt-8 hidden">
                    <div class="flex flex-col items-center gap-2">
                        <span
                            class="px-4 py-1 bg-emerald-50 text-emerald-700 text-[10px] font-black uppercase tracking-widest rounded-full">Automated
                            Processing Aktif</span>
                    </div>
                </div>
                </form>
    </div>
    </div>
    </div>

    <script>
        // Constants
        let selectedType = null;
        const invoiceId = <%= invoice.id %>;
        const remainingAmount = <%= invoice.remaining_amount %>;
        let currentDiscount = 0;
        let finalAmount = remainingAmount;

        // Format currency
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID').format(Math.round(number));
        }

        // Calculate discount
        function calculateDiscount() {
            let totalDiscount = 0;

            // 1. SLA Discount (Auto-applied)
            const slaDiscountAmountInput = document.getElementById('sla-discount-amount');
            if (slaDiscountAmountInput) {
                totalDiscount += parseFloat(slaDiscountAmountInput.value) || 0;
            }

            // 2. Manual Discount (Optional)
            const discountToggle = document.getElementById('discount-toggle');
            if (discountToggle && discountToggle.checked) {
                const discountType = document.getElementById('discount_type').value;
                const discountValueInput = document.getElementById('discount_value');
                const discountValue = parseFloat(discountValueInput ? discountValueInput.value : 0) || 0;

                let baseAmount = remainingAmount;
                if (selectedType === 'partial') {
                    const partialAmountInput = document.getElementById('payment_amount');
                    baseAmount = parseFloat(partialAmountInput ? partialAmountInput.value : 0) || 0;
                }

                if (discountType === 'percentage') {
                    totalDiscount += (baseAmount * discountValue) / 100;
                } else {
                    totalDiscount += Math.min(discountValue, baseAmount);
                }
            }

            return totalDiscount;
        }

        // Update calculation display
        function updateCalculation() {
            if (!selectedType) return;

            const calcDisplay = document.getElementById('calculation-display');
            const calcSubtotal = document.getElementById('calc-subtotal');
            const calcDiscountRow = document.getElementById('calc-discount-row');
            const calcDiscount = document.getElementById('calc-discount');
            const calcDiscountLabel = document.getElementById('calc-discount-label');
            const calcTotal = document.getElementById('calc-total');
            const calcRemainingRow = document.getElementById('calc-remaining-row');
            const calcRemaining = document.getElementById('calc-remaining');
            const calcOverpaymentRow = document.getElementById('calc-overpayment-row');
            const calcOverpayment = document.getElementById('calc-overpayment');

            let subtotal = remainingAmount;

            if (selectedType === 'partial') {
                const paymentAmountInput = document.getElementById('payment_amount');
                subtotal = parseFloat(paymentAmountInput ? paymentAmountInput.value : 0) || 0;
            } else if (selectedType === 'debt') {
                subtotal = remainingAmount;
            }

            // Calculate discount
            currentDiscount = calculateDiscount();
            finalAmount = Math.max(0, subtotal - currentDiscount);

            // Update display
            if (calcSubtotal) calcSubtotal.textContent = 'Rp ' + formatRupiah(subtotal);
            if (calcTotal) calcTotal.textContent = 'Rp ' + formatRupiah(finalAmount);

            // Check for overpayment
            const remainingToPay = remainingAmount - calculateDiscountOnlySLA();

            if (selectedType === 'partial' && finalAmount > (remainingAmount - calculateDiscountOnlySLA())) {
                const overpayment = finalAmount - (remainingAmount - calculateDiscountOnlySLA());
                if (calcOverpayment) calcOverpayment.textContent = 'Rp ' + formatRupiah(overpayment);
                if (calcOverpaymentRow) calcOverpaymentRow.classList.remove('hidden');
                if (calcRemainingRow) calcRemainingRow.classList.add('hidden');
            } else {
                if (calcOverpaymentRow) calcOverpaymentRow.classList.add('hidden');

                if ((selectedType === 'partial' || selectedType === 'debt')) {
                    let remaining = 0;
                    if (selectedType === 'partial') {
                        remaining = Math.max(0, remainingAmount - finalAmount - currentDiscount);
                    } else if (selectedType === 'debt') {
                        remaining = finalAmount;
                    }
                    if (calcRemaining) calcRemaining.textContent = 'Rp ' + formatRupiah(remaining);
                    if (calcRemainingRow) calcRemainingRow.classList.remove('hidden');
                } else {
                    if (calcRemainingRow) calcRemainingRow.classList.add('hidden');
                }
            }

            // Show/hide discount row
            if (currentDiscount > 0) {
                let labels = [];
                const slaInput = document.getElementById('sla-discount-amount');
                if (slaInput && parseFloat(slaInput.value) > 0) labels.push('SLA');
                const manualToggle = document.getElementById('discount-toggle');
                if (manualToggle && manualToggle.checked) labels.push('Manual');

                if (calcDiscountLabel) calcDiscountLabel.textContent = labels.join(' + ') + ' Discount';
                if (calcDiscount) calcDiscount.textContent = '- Rp ' + formatRupiah(currentDiscount);
                if (calcDiscountRow) calcDiscountRow.classList.remove('hidden');
            } else {
                if (calcDiscountRow) calcDiscountRow.classList.add('hidden');
            }

            if (calcDisplay) calcDisplay.classList.remove('hidden');
        }

        function calculateDiscountOnlySLA() {
            const slaInput = document.getElementById('sla-discount-amount');
            return slaInput ? (parseFloat(slaInput.value) || 0) : 0;
        }

        // Select payment type
        function selectPaymentType(type) {
            selectedType = type;

            document.querySelectorAll('.payment-type-card').forEach(card => {
                card.classList.remove('selected');
                if (card.dataset.type === type) card.classList.add('selected');
            });

            const radio = document.getElementById(`type-${type}`);
            if (radio) radio.checked = true;

            const amountField = document.getElementById('amount-field');
            const autoApproveNotice = document.getElementById('auto-approve-notice');
            const submitBtn = document.getElementById('submit-btn');

            if (type === 'partial') {
                if (amountField) amountField.classList.remove('hidden');
                if (autoApproveNotice) autoApproveNotice.classList.add('hidden');
            } else {
                if (amountField) amountField.classList.add('hidden');
                if (type === 'full') {
                    if (autoApproveNotice) autoApproveNotice.classList.remove('hidden');
                } else {
                    if (autoApproveNotice) autoApproveNotice.classList.add('hidden');
                }
            }

            if (submitBtn) submitBtn.disabled = false;
            updateCalculation();
        }

        // Select payment method
        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-method-card').forEach(card => {
                card.classList.remove('selected');
                card.querySelector('.check-icon').classList.add('hidden');
            });

            const radio = document.getElementById(`method-${method}`);
            if (radio) {
                radio.checked = true;
                const card = radio.closest('.payment-method-card');
                card.classList.add('selected');
                card.querySelector('.check-icon').classList.remove('hidden');
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            document.querySelectorAll('.payment-type-card').forEach(card => {
                card.addEventListener('click', () => selectPaymentType(card.dataset.type));
            });

            const discountToggle = document.getElementById('discount-toggle');
            if (discountToggle) {
                discountToggle.addEventListener('change', function () {
                    const fields = document.getElementById('discount-fields');
                    if (fields) fields.classList.toggle('hidden', !this.checked);
                    updateCalculation();
                });
            }

            ['discount_type', 'discount_value', 'payment_amount'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener('input', updateCalculation);
            });

            document.querySelectorAll('.quick-amount-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const percent = parseInt(this.dataset.percent);
                    const amount = Math.round((remainingAmount * percent) / 100);
                    const input = document.getElementById('payment_amount');
                    if (input) input.value = amount;
                    updateCalculation();
                });
            });

            document.getElementById('payment-form').addEventListener('submit', async function (e) {
                e.preventDefault();

                const formData = new FormData(this);
                const paymentMethod = document.querySelector('input[name="payment_method"]:checked').value;

                const data = {
                    invoice_id: invoiceId,
                    payment_method: paymentMethod,
                    notes: formData.get('notes') || ''
                };

                if (selectedType === 'partial') {
                    data.payment_amount = parseFloat(formData.get('payment_amount')) || 0;
                } else if (selectedType === 'full') {
                    data.payment_amount = remainingAmount;
                } else {
                    data.payment_amount = 0;
                }

                if (currentDiscount > 0) {
                    data.discount_amount = currentDiscount;
                    const slaInput = document.getElementById('sla-discount-amount');
                    if (slaInput && parseFloat(slaInput.value) > 0) {
                        data.sla_discount_amount = parseFloat(slaInput.value);
                        data.sla_discount_percentage = parseFloat(document.getElementById('sla-discount-percentage').value);
                    }
                    const manualToggle = document.getElementById('discount-toggle');
                    if (manualToggle && manualToggle.checked) {
                        data.manual_discount_type = document.getElementById('discount_type').value;
                        data.manual_discount_value = parseFloat(document.getElementById('discount_value').value);
                        data.discount_reason = document.getElementById('discount_reason').value;
                    }
                }

                // Construct detailed confirmation message
                let confirmMsg = `💳 KONFIRMASI PEMBAYARAN\n\n`;
                confirmMsg += `Metode: ${paymentMethod.toUpperCase()}\n`;
                confirmMsg += `Opsi: ${selectedType.toUpperCase()}\n`;
                confirmMsg += `Nominal: Rp ${formatRupiah(data.payment_amount)}\n`;
                if (currentDiscount > 0) {
                    confirmMsg += `Diskon: - Rp ${formatRupiah(currentDiscount)}\n`;
                }
                confirmMsg += `Total: Rp ${formatRupiah(finalAmount)}\n\n`;

                if (selectedType === 'partial' && finalAmount > (remainingAmount - calculateDiscountOnlySLA())) {
                    confirmMsg += `⚠️ NOTIFIKASI SALDO\n`;
                    confirmMsg += `Ada kelebihan bayar sebesar Rp ${formatRupiah(finalAmount - (remainingAmount - calculateDiscountOnlySLA()))}.\n`;
                    confirmMsg += `Kelebihan akan masuk ke Saldo Pelanggan.\n\n`;
                }

                confirmMsg += `Lanjutkan transaksi?`;

                if (!confirm(confirmMsg)) return;

                const endpoints = { 'full': '/billing/payments/full', 'partial': '/billing/payments/partial', 'debt': '/billing/payments/debt' };

                try {
                    const btn = document.getElementById('submit-btn');
                    btn.disabled = true;
                    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Processing...';

                    const res = await fetch(endpoints[selectedType], {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    const result = await res.json();
                    if (result.success) {
                        alert('✅ Pembayaran berhasil!');
                        window.location.href = '/billing/tagihan/' + invoiceId;
                    } else {
                        alert('❌ Error: ' + result.message);
                        btn.disabled = false;
                        btn.textContent = 'PROSES PEMBAYARAN';
                    }
                } catch (err) {
                    alert('❌ Connection Error');
                    document.getElementById('submit-btn').disabled = false;
                }
            });
        });
    </script>
</body>

</html>