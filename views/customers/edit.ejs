<div class="space-y-6">
    <!-- Header Section -->
    <div
        class="rounded-2xl border border-modern-blue-200 bg-gradient-to-br from-modern-blue-50 to-modern-cyan-50 p-6 shadow-sm">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-modern-blue-900">Edit Pelanggan</h1>
                <p class="text-modern-blue-600 mt-1">Ubah data pelanggan sistem billing</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="/customers/list"
                    class="px-4 py-2 border border-modern-blue-300 text-modern-blue-700 rounded-lg hover:bg-modern-blue-50 transition-all duration-300 font-medium text-sm">
                    ← Kembali
                </a>
            </div>
        </div>
    </div>

    <!-- Main Edit Form -->
    <form method="POST" action="/customers/<%= customer.id %>" class="space-y-6">

        <!-- CARD 1: Basic Information -->
        <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                <span class="p-1.5 bg-blue-100 text-blue-600 rounded-lg">👤</span>
                <h3 class="font-bold text-slate-800">Informasi Pelanggan</h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Name -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nama Lengkap *</label>
                    <input type="text" name="name" value="<%= customer.name %>" required
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-all font-medium">
                </div>

                <!-- Code -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Kode Pelanggan</label>
                    <div class="flex gap-2">
                        <input type="text" name="customer_code" value="<%= customer.customer_code || '' %>"
                            placeholder="Auto-generate jika kosong"
                            class="flex-1 px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-all">
                        <button type="button" id="generate_customer_code" title="Generate Code"
                            class="px-3 bg-blue-50 text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-100 transition-colors">
                            🔄
                        </button>
                    </div>
                </div>

                <!-- Phone -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nomor Telepon</label>
                    <input type="tel" name="phone" value="<%= customer.phone || '' %>"
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-all">
                </div>

                <!-- Status -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Status Langganan</label>
                    <select name="status" required
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500">
                        <option value="active" <%=customer.status==='active' ? 'selected' : '' %>>✅ Aktif</option>
                        <option value="inactive" <%=customer.status==='inactive' ? 'selected' : '' %>>❌ Tidak Aktif
                            (Isolir)</option>
                    </select>
                </div>

                <!-- Address -->
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Alamat Pemasangan</label>
                    <textarea name="address" rows="2"
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-200 focus:border-blue-500 transition-all"><%= customer.address || '' %></textarea>
                </div>
            </div>
        </div>

        <!-- CARD 2: Billing & Finance -->
        <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                <span class="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg">💳</span>
                <h3 class="font-bold text-slate-800">Tagihan & Pembayaran</h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Billing Mode -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Mode Pembayaran</label>
                    <select id="billing_mode" name="billing_mode"
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200 focus:border-indigo-500">
                        <option value="postpaid" <%=(!customer.billing_mode || customer.billing_mode==='postpaid' )
                            ? 'selected' : '' %>>📅 Pascabayar (Bulanan)</option>
                        <option value="prepaid" <%=customer.billing_mode==='prepaid' ? 'selected' : '' %>>💰 Prabayar
                            (Voucher/Topup)</option>
                    </select>
                </div>

                <!-- Expiry View (Prepaid Only) -->
                <% if (customer.billing_mode==='prepaid' && customer.expiry_date) { %>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Masa Aktif</label>
                        <div
                            class="px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg flex justify-between items-center">
                            <span class="font-bold text-slate-700">
                                <%= new Date(customer.expiry_date).toLocaleString('id-ID', { dateStyle: 'medium' ,
                                    timeStyle: 'short' }) %>
                            </span>
                            <% if (new Date(customer.expiry_date) <=new Date()) { %>
                                <span
                                    class="px-2 py-0.5 bg-red-100 text-red-700 text-xs rounded-full font-bold">Expired</span>
                                <% } else { %>
                                    <span
                                        class="px-2 py-0.5 bg-green-100 text-green-700 text-xs rounded-full font-bold">Active</span>
                                    <% } %>
                        </div>
                    </div>
                    <% } %>

                        <!-- Flags -->
                        <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                            <!-- PPN Checkbox -->
                            <label
                                class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                <input type="checkbox" name="is_taxable" value="1" <%=customer.is_taxable ? 'checked'
                                    : '' %>
                                class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                                <div>
                                    <span class="block text-sm font-bold text-slate-700">Kena PPN</span>
                                    <span class="block text-xs text-slate-500">Tambahkan pajak PPN pada invoice</span>
                                </div>
                            </label>

                            <!-- Device Rental Checkbox -->
                            <label
                                class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                <input type="checkbox" name="use_device_rental" id="use_device_rental" value="1"
                                    <%=customer.use_device_rental ? 'checked' : '' %>
                                class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                                <div>
                                    <span class="block text-sm font-bold text-slate-700">Sewa Perangkat</span>
                                    <span class="block text-xs text-slate-500">Tagihan sewa alat bulanan</span>
                                </div>
                            </label>
                        </div>

                        <!-- Rental Details (Hidden by default or JS toggled) -->
                        <div id="rental_options"
                            class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-indigo-50 rounded-lg border border-indigo-100 <%= customer.use_device_rental ? '' : 'hidden' %>">
                            <div>
                                <label class="block text-xs font-semibold text-indigo-700 mb-1">Mode Sewa</label>
                                <select name="rental_mode"
                                    class="w-full px-3 py-2 text-sm border-indigo-200 rounded focus:border-indigo-500">
                                    <option value="flat" <%=(!customer.rental_mode || customer.rental_mode==='flat' )
                                        ? 'selected' : '' %>>Flat (Bulanan)</option>
                                    <option value="daily" <%=customer.rental_mode==='daily' ? 'selected' : '' %>>Harian
                                        (Proporsional)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-indigo-700 mb-1">Biaya (Rp)</label>
                                <input type="number" name="rental_cost" value="<%= customer.rental_cost || '' %>"
                                    placeholder="Default Global"
                                    class="w-full px-3 py-2 text-sm border-indigo-200 rounded focus:border-indigo-500">
                            </div>
                        </div>
            </div>
        </div>

        <!-- CARD 3: Technical Configuration -->
        <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                <span class="p-1.5 bg-purple-100 text-purple-600 rounded-lg">⚙️</span>
                <h3 class="font-bold text-slate-800">Konfigurasi Koneksi</h3>
            </div>

            <div class="p-6 space-y-6">
                <!-- Connection Type Selector -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-3">Tipe Koneksi</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <label class="cursor-pointer">
                            <input type="radio" name="connection_type" value="pppoe" class="peer sr-only"
                                <%=customer.connection_type==='pppoe' ? 'checked' : '' %>>
                            <div
                                class="p-4 border-2 rounded-xl transition-all hover:bg-blue-50 peer-checked:border-blue-500 peer-checked:bg-blue-50 border-slate-200">
                                <span class="block font-bold text-slate-700 peer-checked:text-blue-700">PPPoE</span>
                                <span class="text-xs text-slate-500">Username & Password</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="connection_type" value="static_ip" class="peer sr-only"
                                <%=customer.connection_type==='static_ip' ? 'checked' : '' %>>
                            <div
                                class="p-4 border-2 rounded-xl transition-all hover:bg-green-50 peer-checked:border-green-500 peer-checked:bg-green-50 border-slate-200">
                                <span class="block font-bold text-slate-700 peer-checked:text-green-700">Static
                                    IP</span>
                                <span class="text-xs text-slate-500">IP Address Manual</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- PPPoE Form -->
                <div id="pppoe-config"
                    class="<%= customer.connection_type === 'pppoe' ? '' : 'hidden' %> space-y-4 pt-4 border-t border-slate-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Secret Search (Optional) -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Cari Secret (Opsional)</label>
                            <input type="text" id="pppoe_search" placeholder="Cari username yang ada..."
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg text-sm bg-slate-50">
                        </div>

                        <!-- Create Secret Action -->
                        <div class="flex items-end">
                            <button type="button" id="create_pppoe_secret_btn"
                                class="w-full px-4 py-2.5 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium text-sm transition-colors">
                                ⚡ Buat Secret di MikroTik
                            </button>
                        </div>

                        <!-- Username -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Username PPPoE *</label>
                            <input type="text" name="pppoe_username" value="<%= customer.pppoe_username || '' %>"
                                id="pppoe_username"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-200">
                        </div>

                        <!-- Password -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Password PPPoE</label>
                            <div class="flex gap-2">
                                <input type="text" name="pppoe_password" id="pppoe_password"
                                    placeholder="<%= customer.pppoe_password ? '****** (Tersimpan)' : 'Input password' %>"
                                    class="flex-1 px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-200">
                                <button type="button" id="generate_password_btn"
                                    class="px-3 bg-slate-100 border border-slate-300 rounded-lg text-sm text-slate-600">🔑</button>
                            </div>
                        </div>

                        <!-- Package Select -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Paket Internet</label>
                            <select name="pppoe_package"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-200">
                                <option value="">-- Pilih Paket (Opsional) --</option>
                                <% if (typeof packages !=='undefined' && packages) { packages.forEach(pkg=> { %>
                                    <option value="<%= pkg.id %>" <%=(String(customer.package_id)===String(pkg.id) ||
                                        String(customer.pppoe_package_id)===String(pkg.id)) ? 'selected' : '' %>>
                                        <%= pkg.name %> (<%= pkg.price.toLocaleString('id-ID') %>)
                                    </option>
                                    <% }); } %>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Static IP Form -->
                <div id="static-ip-config"
                    class="<%= customer.connection_type === 'static_ip' ? '' : 'hidden' %> space-y-4 pt-4 border-t border-slate-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- IP Address -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">IP Address *</label>
                            <input type="text" name="ip_address" value="<%= customer.ip_address || '' %>"
                                placeholder="192.168.1.x/24"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-200">
                        </div>

                        <!-- Gateway -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Gateway</label>
                            <input type="text" name="gateway" value="<%= customer.gateway || '' %>"
                                placeholder="192.168.1.1"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-200">
                        </div>

                        <!-- Interface Select (Clean) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Interface MikroTik *</label>
                            <select name="interface"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-200">
                                <option value="">-- Pilih Interface --</option>
                                <% if (typeof interfaces !=='undefined' && Array.isArray(interfaces)) {
                                    interfaces.forEach(ifc=> { %>
                                    <option value="<%= ifc.name %>" <%=customer.interface===ifc.name ? 'selected' : ''
                                        %>>
                                        <%= ifc.name %> (<%= ifc.type %>)
                                    </option>
                                    <% }); } else if (customer.interface) { %>
                                        <option value="<%= customer.interface %>" selected>
                                            <%= customer.interface %> (Current)
                                        </option>
                                        <% } %>
                            </select>
                            <% if (typeof interfaceError !=='undefined' && interfaceError) { %>
                                <p class="text-xs text-red-500 mt-1">Error: <%= interfaceError %>
                                </p>
                                <% } %>
                        </div>

                        <!-- Package Select (Static) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Paket Internet</label>
                            <select name="static_ip_package"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-200">
                                <option value="">-- Pilih Paket (Opsional) --</option>
                                <% if (typeof packages !=='undefined' && packages) { packages.forEach(pkg=> { %>
                                    <option value="<%= pkg.id %>" <%=(String(customer.package_id)===String(pkg.id))
                                        ? 'selected' : '' %>>
                                        <%= pkg.name %> (<%= pkg.price.toLocaleString('id-ID') %>)
                                    </option>
                                    <% }); } %>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 4: Infrastructure (ODC/ODP) -->
        <% var initialOdpName='' ; var initialOdcName='' ; var initialOltName='Auto' ; // Logic to preset names if
            (customer.odp_id && typeof odpData !=='undefined' && Array.isArray(odpData)) { var found=odpData.find(o=>
            String(o.id) === String(customer.odp_id));
            if (found) {
            initialOdpName = found.odp_name;
            initialOdcName = found.odc_name;
            initialOltName = found.olt_name || 'Auto';
            }
            }
            if (!initialOdpName && customer.odp_name) initialOdpName = customer.odp_name;
            if (!initialOdcName && customer.odc_name) initialOdcName = customer.odc_name;
            if (!initialOltName && customer.olt_name) initialOltName = customer.olt_name;
            %>
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                    <span class="p-1.5 bg-cyan-100 text-cyan-600 rounded-lg">🏗️</span>
                    <h3 class="font-bold text-slate-800">Infrastruktur Jaringan (FTTH)</h3>
                </div>
                <div class="p-6 space-y-6">
                    <!-- Wireless Toggle -->
                    <div class="p-4 bg-cyan-50 border border-cyan-100 rounded-lg flex items-center gap-3">
                        <input type="checkbox" id="is_wireless"
                            class="w-5 h-5 text-cyan-600 rounded border-gray-300 focus:ring-cyan-500"
                            <%=(!customer.odp_id && !initialOdcName) ? 'checked' : '' %>>
                        <div>
                            <span class="block text-sm font-bold text-cyan-900">Koneksi Wireless / Tanpa ODP</span>
                            <span class="block text-xs text-cyan-700">Centang opsi ini jika pelanggan tidak menggunakan
                                jalur fiber optik (ODP/ODC)</span>
                        </div>
                    </div>

                    <!-- ODC/ODP Inputs -->
                    <div id="infra_wrapper" class="space-y-5 transition-all duration-300">
                        <!-- ODC Step -->
                        <div class="relative">
                            <label class="block text-sm font-bold text-slate-700 mb-1">1. Pilih ODC (Optical
                                Distribution Cabinet)</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="text" id="odc_search" value="<%= initialOdcName %>"
                                        placeholder="Ketik nama ODC..."
                                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500"
                                        autocomplete="off">
                                    <input type="hidden" name="odc_id" id="odc_id" value="<%= customer.odc_id || '' %>">
                                    <!-- Results container -->
                                    <div id="odc_search_results"
                                        class="absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 shadow-xl rounded-lg max-h-60 overflow-y-auto hidden">
                                    </div>
                                </div>
                                <button type="button" id="reset_odc_btn"
                                    class="px-3 border border-slate-300 rounded-lg bg-slate-50 text-slate-500 hover:bg-slate-100">✕</button>
                            </div>
                        </div>

                        <!-- ODP Step -->
                        <div id="odp_section_wrapper"
                            class="relative transition-all <%= (customer.odc_id || initialOdcName) ? '' : 'opacity-50 pointer-events-none' %>">
                            <label class="block text-sm font-bold text-slate-700 mb-1">2. Pilih ODP (Optical
                                Distribution Point)</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="text" id="odp_search" value="<%= initialOdpName %>"
                                        placeholder="Pilih ODP dari ODC..."
                                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-200 focus:border-cyan-500"
                                        autocomplete="off">
                                    <input type="hidden" name="odp_id" id="odp_id" value="<%= customer.odp_id || '' %>">
                                    <!-- Results -->
                                    <div id="odp_search_results"
                                        class="absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 shadow-xl rounded-lg max-h-60 overflow-y-auto hidden">
                                    </div>
                                </div>
                                <button type="button" id="reload_odp_btn"
                                    class="px-3 border border-slate-300 rounded-lg bg-cyan-50 text-cyan-600 hover:bg-cyan-100">🔄</button>
                            </div>
                            <p class="text-xs text-cyan-700 mt-1" id="selected_odp_info">
                                <%= customer.odp_id ? '✓ Tersimpan: ' + initialOdpName : '' %>
                            </p>
                        </div>

                        <!-- OLT Display -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1">OLT (Auto)</label>
                                <input type="text" id="olt_display" value="<%= initialOltName %>" readonly
                                    class="w-full px-3 py-2 bg-slate-100 border border-slate-200 rounded text-slate-600 text-sm">
                                <input type="hidden" name="olt_id" id="olt_id" value="<%= customer.olt_id || '' %>">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Submit Actions -->
            <div class="flex items-center justify-end gap-3 pt-4 border-t border-slate-200">
                <a href="/customers/list"
                    class="px-6 py-3 border border-slate-300 text-slate-600 font-medium rounded-xl hover:bg-slate-50 transition-colors">Batal</a>
                <button type="submit"
                    class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-0.5">
                    💾 Simpan Perubahan
                </button>
            </div>
    </form>
</div>

<!-- SCRIPTS: Clean & Consolidated -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // === 1. Tipe Koneksi Toggle ===
        const typeRadios = document.querySelectorAll('input[name="connection_type"]');
        const pppoeGroup = document.getElementById('pppoe-config');
        const staticGroup = document.getElementById('static-ip-config');

        typeRadios.forEach(r => r.addEventListener('change', (e) => {
            if (e.target.value === 'pppoe') {
                pppoeGroup.classList.remove('hidden');
                staticGroup.classList.add('hidden');
            } else {
                pppoeGroup.classList.add('hidden');
                staticGroup.classList.remove('hidden');
            }
        }));

        // === 2. Device Rental Toggle ===
        const rentalCheck = document.getElementById('use_device_rental');
        const rentalOptions = document.getElementById('rental_options');
        if (rentalCheck && rentalOptions) {
            rentalCheck.addEventListener('change', function () {
                if (this.checked) rentalOptions.classList.remove('hidden');
                else rentalOptions.classList.add('hidden');
            });
        }

        // === 3. Infrastruktur (Wireless vs FTTH) ===
        const isWireless = document.getElementById('is_wireless');
        const infraWrapper = document.getElementById('infra_wrapper');
        const odcId = document.getElementById('odc_id');
        const odpId = document.getElementById('odp_id');

        function updateWirelessState() {
            if (isWireless.checked) {
                infraWrapper.classList.add('opacity-40', 'pointer-events-none');
                // Remove required
                if (odpId) odpId.required = false;
            } else {
                infraWrapper.classList.remove('opacity-40', 'pointer-events-none');
                // Add required if needed, or rely on backend validation
                if (odpId) odpId.required = true;
            }
        }

        if (isWireless) {
            isWireless.addEventListener('change', updateWirelessState);
            updateWirelessState(); // Init
        }

        // === 4. ODC/ODP Search Logic (Simplified) ===
        const odcSearch = document.getElementById('odc_search');
        const odcResults = document.getElementById('odc_search_results');
        const resetOdc = document.getElementById('reset_odc_btn');
        const odpSearch = document.getElementById('odp_search');
        const odpResults = document.getElementById('odp_search_results');
        const odpWrapper = document.getElementById('odp_section_wrapper');
        const oltDisplay = document.getElementById('olt_display');
        const oltId = document.getElementById('olt_id');

        let debounceTimer;

        // Search ODC
        if (odcSearch) {
            odcSearch.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                const q = e.target.value.trim();
                odcId.value = ''; // Reset ID on edit
                if (odpWrapper) odpWrapper.classList.add('opacity-50', 'pointer-events-none');

                if (q.length < 1) { odcResults.classList.add('hidden'); return; }

                debounceTimer = setTimeout(() => {
                    fetch('/api/ftth/odc/search?q=' + encodeURIComponent(q))
                        .then(r => r.json())
                        .then(data => {
                            if (data.results && data.results.length) {
                                odcResults.innerHTML = data.results.map(odc => `
                                <div class="px-4 py-2 hover:bg-slate-50 cursor-pointer border-b border-light" onclick="selectOdc('${odc.id}', '${odc.name}')">
                                    <div class="font-bold text-slate-700">${odc.name}</div>
                                    <div class="text-xs text-slate-500">${odc.location || ''}</div>
                                </div>
                            `).join('');
                                odcResults.classList.remove('hidden');
                            } else {
                                odcResults.innerHTML = '<div class="p-2 text-sm text-slate-500 text-center">Tidak ditemukan</div>';
                                odcResults.classList.remove('hidden');
                            }
                        });
                }, 300);
            });

            // Search ODP (Dependent on ODC ID)
            odpSearch.addEventListener('input', (e) => {
                clearTimeout(debounceTimer);
                const q = e.target.value.trim();
                const currentOdcId = odcId.value;
                if (!currentOdcId) return;

                debounceTimer = setTimeout(() => {
                    fetch(`/api/ftth/odp/search?q=${encodeURIComponent(q)}&odc_id=${currentOdcId}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.results && data.results.length) {
                                odpResults.innerHTML = data.results.map(odp => `
                                <div class="px-4 py-2 hover:bg-slate-50 cursor-pointer border-b border-light" 
                                     onclick="selectOdp('${odp.id}', '${odp.name}', '${odp.olt_id}', '${odp.olt_name}')">
                                    <div class="font-bold text-slate-700">${odp.odp_name}</div>
                                    <div class="text-xs text-slate-500">Ports: ${odp.available_ports} Free</div>
                                </div>
                            `).join('');
                                odpResults.classList.remove('hidden');
                            } else {
                                odpResults.innerHTML = '<div class="p-2 text-sm text-slate-500 text-center">Tidak ditemukan</div>';
                                odpResults.classList.remove('hidden');
                            }
                        });
                }, 300);
            });

            // Hide results on blur
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#odc_search') && !e.target.closest('#odc_search_results')) odcResults.classList.add('hidden');
                if (!e.target.closest('#odp_search') && !e.target.closest('#odp_search_results')) odpResults.classList.add('hidden');
            });
        }

        // Helper: Select ODC
        window.selectOdc = function (id, name) {
            odcSearch.value = name;
            odcId.value = id;
            odcResults.classList.add('hidden');
            // Unlock ODP
            odpWrapper.classList.remove('opacity-50', 'pointer-events-none');
            odpSearch.focus();
            // Reset ODP
            odpSearch.value = '';
            odpId.value = '';
        };

        // Helper: Select ODP
        window.selectOdp = function (id, name, oltIdVal, oltNameVal) {
            odpSearch.value = name;
            odpId.value = id;
            odpResults.classList.add('hidden');
            // Set OLT
            if (oltId) oltId.value = oltIdVal || '';
            if (oltDisplay) oltDisplay.value = oltNameVal || 'Auto';
        };

        if (resetOdc) {
            resetOdc.addEventListener('click', () => {
                if (isWireless.checked) return;
                odcSearch.value = '';
                odcId.value = '';
                odcSearch.focus();
                odpWrapper.classList.add('opacity-50', 'pointer-events-none');
            });
        }
    });
</script>