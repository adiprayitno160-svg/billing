<div class="space-y-8">
    <!-- Header Section -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div class="flex items-center gap-3">
            <div class="p-3 bg-blue-600 shadow-lg shadow-blue-200 rounded-2xl text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                    </path>
                </svg>
            </div>
            <div>
                <h1 class="text-2xl font-bold text-slate-800">Edit Pelanggan</h1>
                <p class="text-sm text-slate-500 font-medium">Perbarui data dan konfigurasi layanan</p>
            </div>
        </div>
        <div class="flex items-center gap-3">
            <a href="/customers/list"
                class="px-5 py-2.5 border border-slate-200 text-slate-600 rounded-xl hover:bg-slate-50 hover:text-blue-600 transition-all font-bold text-sm">
                Batal
            </a>
            <button type="submit" form="edit-form"
                class="px-6 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all font-bold text-sm flex items-center gap-2">
                <span>💾</span> Simpan Perubahan
            </button>
        </div>
    </div>

    <form method="POST" action="/customers/<%= customer.id %>" id="edit-form" class="space-y-8">
        <!-- Main Grid: Data & Map -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Left Column: Identity, Billing, Connection (Col 7) -->
            <div class="lg:col-span-7 space-y-8">

                <!-- Identity Card -->
                <div
                    class="rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden transition-all duration-300 hover:shadow-md">
                    <div class="px-8 py-5 bg-slate-50/50 border-b border-slate-100 flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-2xl bg-indigo-100 text-indigo-600 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 leading-none text-base">Informasi Dasar</h3>
                            <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-tighter">Identitas & Kontak</p>
                        </div>
                    </div>
                    <div class="p-8">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="md:col-span-2">
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Nama
                                    Lengkap <span class="text-red-500">*</span></label>
                                <% if (customer.name_edited_at) { %>
                                    <input type="text" name="name" value="<%= customer.name %>" readonly
                                        class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 bg-slate-100 text-slate-500 cursor-not-allowed font-bold outline-none text-sm" />
                                    <p class="text-[10px] text-orange-500 mt-1.5 flex items-center gap-1 font-bold">
                                        <span>🔒</span> Nama sudah pernah diubah dan dikunci. Hubungi Super Admin untuk
                                        Response / Loss SNResponse / Loss SN
                                    </p>
                                    <% } else { %>
                                        <input type="text" name="name" value="<%= customer.name %>" required
                                            class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 transition-all font-bold text-slate-800 outline-none text-sm placeholder:text-slate-300" />
                                        <p class="text-[10px] text-slate-400 mt-1.5 font-medium">⚠️ Kesempatan ubah nama
                                            hanya 1x setelah registrasi.</p>
                                        <% } %>
                            </div>

                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Kode
                                    Pelanggan</label>
                                <div class="relative">
                                    <div
                                        class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400 pointer-events-none">
                                        #</div>
                                    <input type="text" name="customer_code" value="<%= customer.customer_code || '' %>"
                                        readonly
                                        class="w-full pl-10 rounded-2xl border border-slate-200 px-5 py-3.5 bg-slate-50 text-slate-500 font-mono cursor-not-allowed outline-none text-sm" />
                                </div>
                            </div>

                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Status</label>
                                <select name="status" required
                                    class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 bg-white font-bold text-slate-800 focus:ring-4 focus:ring-blue-50 focus:border-blue-300 transition-all outline-none text-sm appearance-none cursor-pointer">
                                    <option value="active" <%=customer.status==='active' ? 'selected' : '' %>>✅ Aktif
                                    </option>
                                    <option value="inactive" <%=customer.status==='inactive' ? 'selected' : '' %>>❌
                                        Non-Aktif (Isolir)</option>
                                </select>
                            </div>

                            <div class="md:col-span-2">
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Nomor
                                    Telepon</label>
                                <div class="relative group">
                                    <div
                                        class="absolute inset-y-0 left-0 pl-4 flex items-center text-slate-400 pointer-events-none font-bold text-sm transition-colors group-focus-within:text-green-500">
                                        📞</div>
                                    <input type="tel" name="phone" value="<%= customer.phone || '' %>"
                                        class="w-full pl-12 rounded-2xl border border-slate-200 px-5 py-3.5 focus:border-green-500 focus:ring-4 focus:ring-green-50 transition-all font-mono font-bold text-slate-800 outline-none text-sm" />
                                </div>
                            </div>

                            <div class="md:col-span-2">
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Alamat
                                    Pemasangan</label>
                                <textarea name="address" rows="2"
                                    class="w-full rounded-2xl border border-slate-200 px-5 py-4 focus:border-orange-500 focus:ring-4 focus:ring-orange-50 transition-all min-h-[90px] text-slate-700 text-sm leading-relaxed outline-none"><%= customer.address || '' %></textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Connection Config Card -->
                <div
                    class="rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden transition-all duration-300 hover:shadow-md">
                    <div class="px-8 py-5 bg-slate-50/50 border-b border-slate-100 flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-2xl bg-purple-100 text-purple-600 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 leading-none text-base">Konfigurasi Koneksi</h3>
                            <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-tighter">PPPoE / Static IP</p>
                        </div>
                    </div>
                    <div class="p-8 space-y-6">
                        <!-- Type Switcher -->
                        <div class="grid grid-cols-2 gap-4 p-1 bg-slate-100 rounded-2xl">
                            <label class="cursor-pointer">
                                <input type="radio" name="connection_type" value="pppoe" class="peer sr-only"
                                    <%=customer.connection_type==='pppoe' ? 'checked' : '' %>>
                                <div
                                    class="px-4 py-3 rounded-xl text-center text-sm font-bold text-slate-500 transition-all peer-checked:bg-white peer-checked:text-blue-600 peer-checked:shadow-sm">
                                    PPPoE
                                </div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="radio" name="connection_type" value="static_ip" class="peer sr-only"
                                    <%=customer.connection_type==='static_ip' ? 'checked' : '' %>>
                                <div
                                    class="px-4 py-3 rounded-xl text-center text-sm font-bold text-slate-500 transition-all peer-checked:bg-white peer-checked:text-green-600 peer-checked:shadow-sm">
                                    Static IP
                                </div>
                            </label>
                        </div>

                        <!-- PPPoE Form -->
                        <div id="pppoe-config"
                            class="<%= customer.connection_type === 'pppoe' ? '' : 'hidden' %> space-y-6 animate-fade-in">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Username
                                        PPPoE <span class="text-red-500">*</span></label>
                                    <div class="flex gap-2">
                                        <input type="text" name="pppoe_username"
                                            value="<%= customer.pppoe_username || '' %>" id="pppoe_username"
                                            class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 transition-all font-bold text-blue-700 outline-none text-sm" />
                                        <button type="button" id="btn-import-active-pppoe"
                                            class="shrink-0 px-4 bg-blue-50 text-blue-600 rounded-2xl hover:bg-blue-100 border border-blue-100 transition-colors text-xs font-bold flex items-center gap-1"
                                            title="Import dari Active Connection">
                                            📥 Import
                                        </button>
                                    </div>
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Password</label>
                                    <div class="flex gap-2">
                                        <input type="text" name="pppoe_password" id="pppoe_password"
                                            placeholder="Input password"
                                            value="<%= customer.pppoe_password || '12345' %>"
                                            class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 focus:border-blue-500 focus:ring-4 focus:ring-blue-50 transition-all font-mono font-bold text-slate-800 outline-none text-sm" />
                                        <button type="button" id="generate_password_btn"
                                            class="px-4 bg-slate-100 hover:bg-slate-200 rounded-2xl border border-slate-200 text-slate-600 transition-colors">🔑</button>
                                    </div>
                                </div>
                                <div class="md:col-span-2">
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Paket
                                        Layanan</label>
                                    <select name="pppoe_package"
                                        class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 bg-white font-bold text-slate-800 focus:ring-4 focus:ring-blue-50 focus:border-blue-300 transition-all outline-none text-sm appearance-none cursor-pointer">
                                        <option value="">-- Pilih Paket (Opsional) --</option>
                                        <% if (typeof packages !=='undefined' && packages) { packages.forEach(pkg=> { %>
                                            <option value="<%= pkg.id %>"
                                                <%=(String(customer.package_id)===String(pkg.id) ||
                                                String(customer.pppoe_package_id)===String(pkg.id)) ? 'selected' : '' %>
                                                >
                                                <%= pkg.name %> (<%= pkg.price.toLocaleString('id-ID') %>)
                                            </option>
                                            <% }); } %>
                                    </select>
                                </div>
                                <div class="md:col-span-2 flex justify-end">
                                    <button type="button" id="create_pppoe_secret_btn"
                                        class="text-xs px-4 py-2 bg-blue-50 text-blue-700 rounded-xl hover:bg-blue-100 border border-blue-100 font-bold transition-all flex items-center gap-2">
                                        ⚡ Sync Data ke MikroTik (Force Update)
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Static IP Form -->
                        <div id="static-ip-config"
                            class="<%= customer.connection_type === 'static_ip' ? '' : 'hidden' %> space-y-6 animate-fade-in">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">IP
                                        Address <span class="text-red-500">*</span></label>
                                    <input type="text" name="ip_address" value="<%= customer.ip_address || '' %>"
                                        placeholder="10.10.x.x"
                                        class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 focus:border-green-500 focus:ring-4 focus:ring-green-50 transition-all font-mono font-bold text-green-700 outline-none text-sm" />
                                </div>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Gateway</label>
                                    <input type="text" name="gateway" value="<%= customer.gateway || '' %>"
                                        placeholder="10.10.x.1"
                                        class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 focus:border-green-500 focus:ring-4 focus:ring-green-50 transition-all font-mono font-bold text-slate-600 outline-none text-sm" />
                                </div>
                                <div class="md:col-span-2">
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Interface
                                        MikroTik <span class="text-red-500">*</span></label>
                                    <select name="interface"
                                        class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 bg-white font-bold text-slate-800 focus:ring-4 focus:ring-green-50 focus:border-green-300 transition-all outline-none text-sm appearance-none cursor-pointer">
                                        <option value="">-- Pilih Interface --</option>
                                        <% if (typeof interfaces !=='undefined' && Array.isArray(interfaces)) {
                                            interfaces.forEach(ifc=> { %>
                                            <option value="<%= ifc.name %>" <%=customer.interface===ifc.name
                                                ? 'selected' : '' %>>
                                                <%= ifc.name %> (<%= ifc.type %>)
                                            </option>
                                            <% }); } else if (customer.interface) { %>
                                                <option value="<%= customer.interface %>" selected>
                                                    <%= customer.interface %> (Current)
                                                </option>
                                                <% } %>
                                    </select>
                                    <button type="button" id="import_mikrotik_ip_btn"
                                        class="mt-2 text-xs text-green-600 hover:text-green-800 font-bold flex items-center gap-1">
                                        📥 Import IP dari ARP/Leases Mikrotik
                                    </button>
                                </div>
                                <div class="md:col-span-2">
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Paket
                                        Layanan (Static)</label>
                                    <select name="static_ip_package"
                                        class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 bg-white font-bold text-slate-800 focus:ring-4 focus:ring-green-50 focus:border-green-300 transition-all outline-none text-sm appearance-none cursor-pointer">
                                        <option value="">-- Pilih Paket --</option>
                                        <% if (typeof packages !=='undefined' && packages) { packages.forEach(pkg=> { %>
                                            <option value="<%= pkg.id %>"
                                                <%=(String(customer.package_id)===String(pkg.id) ||
                                                String(customer.static_ip_package_id)===String(pkg.id)) ? 'selected'
                                                : '' %>>
                                                <%= pkg.name %> (<%= pkg.price.toLocaleString('id-ID') %>)
                                            </option>
                                            <% }); } %>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Billing Card -->
                <div
                    class="rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden transition-all duration-300 hover:shadow-md">
                    <div class="px-8 py-5 bg-slate-50/50 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-2xl bg-amber-100 text-amber-600 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z">
                                </path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 leading-none text-base">Tagihan & Pembayaran</h3>
                        </div>
                    </div>
                    <div class="p-8 space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Mode
                                    Pembayaran</label>
                                <select id="billing_mode" name="billing_mode"
                                    class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 bg-white font-bold text-slate-800 focus:ring-4 focus:ring-amber-50 focus:border-amber-300 transition-all outline-none text-sm appearance-none cursor-pointer">
                                    <option value="postpaid" <%=(!customer.billing_mode ||
                                        customer.billing_mode==='postpaid' ) ? 'selected' : '' %>>📅 Pascabayar
                                        (Bulanan)</option>
                                    <option value="prepaid" <%=customer.billing_mode==='prepaid' ? 'selected' : '' %>>💰
                                        Prabayar (Sistem Voucher)</option>
                                </select>
                            </div>

                            <% if (customer.billing_mode==='prepaid' && customer.expiry_date) { %>
                                <div>
                                    <label
                                        class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Masa
                                        Aktif</label>
                                    <div
                                        class="px-5 py-3.5 bg-slate-50 border border-slate-200 rounded-2xl flex justify-between items-center">
                                        <span class="font-bold text-slate-700 text-sm">
                                            <%= new Date(customer.expiry_date).toLocaleString('id-ID', {
                                                dateStyle: 'medium' , timeStyle: 'short' }) %>
                                        </span>
                                        <% if (new Date(customer.expiry_date) <=new Date()) { %>
                                            <span
                                                class="px-2 py-0.5 bg-red-100 text-red-700 text-[10px] rounded-full font-bold">EXPIRED</span>
                                            <% } else { %>
                                                <span
                                                    class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] rounded-full font-bold">ACTIVE</span>
                                                <% } %>
                                    </div>
                                </div>
                                <% } %>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 pt-2">
                            <label
                                class="group flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-200 cursor-pointer hover:border-amber-300 hover:bg-white transition-all">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" name="is_taxable" value="1" <%=customer.is_taxable
                                        ? 'checked' : '' %> class="w-5 h-5 text-amber-600 rounded-lg border-slate-300
                                    focus:ring-amber-500">
                                    <div>
                                        <span class="block text-sm font-bold text-slate-700">Kena PPN</span>
                                        <span class="block text-[10px] text-slate-400 uppercase tracking-tight">Tagihan
                                            + Pajak</span>
                                    </div>
                                </div>
                            </label>
                            <label
                                class="group flex items-center justify-between p-4 bg-blue-50 rounded-2xl border border-blue-200 cursor-pointer hover:border-blue-300 hover:bg-white transition-all">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" name="enable_billing" value="1"
                                        <%=customer.has_active_subscription ? 'checked' : '' %> class="w-5 h-5
                                    text-blue-600 rounded-lg border-blue-300
                                    focus:ring-blue-500">
                                    <div>
                                        <span class="block text-sm font-bold text-blue-700">✅ Aktifkan Tagihan
                                            Otomatis</span>
                                        <span class="block text-[10px] text-blue-500 uppercase tracking-tight">Buat
                                            subscription aktif</span>
                                    </div>
                                </div>
                            </label>

                            <label
                                class="group flex items-center justify-between p-4 bg-slate-50 rounded-2xl border border-slate-200 cursor-pointer hover:border-amber-300 hover:bg-white transition-all">
                                <div class="flex items-center gap-3">
                                    <input type="checkbox" name="use_device_rental" id="use_device_rental" value="1"
                                        <%=customer.use_device_rental ? 'checked' : '' %> class="w-5 h-5 text-amber-600
                                    rounded-lg border-slate-300 focus:ring-amber-500">
                                    <div>
                                        <span class="block text-sm font-bold text-slate-700">Sewa Alat</span>
                                        <span class="block text-[10px] text-slate-400 uppercase tracking-tight">Biaya
                                            ONT/STB</span>
                                    </div>
                                </div>
                            </label>
                        </div>

                        <!-- Rental Options -->
                        <div id="rental_options"
                            class="grid grid-cols-2 gap-6 p-6 bg-amber-50/50 border border-amber-100 rounded-2xl <%= customer.use_device_rental ? '' : 'hidden' %>">
                            <div>
                                <label
                                    class="block text-xs font-bold text-amber-800 uppercase tracking-widest mb-2 px-1">Mode
                                    Sewa</label>
                                <select name="rental_mode"
                                    class="w-full rounded-xl border-amber-200 px-4 py-2.5 text-sm focus:border-amber-500">
                                    <option value="flat" <%=(!customer.rental_mode || customer.rental_mode==='flat' )
                                        ? 'selected' : '' %>>Flat (Bulanan)</option>
                                    <option value="daily" <%=customer.rental_mode==='daily' ? 'selected' : '' %>>Harian
                                        (Proporsional)</option>
                                </select>
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-amber-800 uppercase tracking-widest mb-2 px-1">Biaya
                                    (Rp)</label>
                                <input type="number" name="rental_cost" value="<%= customer.rental_cost || '' %>"
                                    placeholder="Default"
                                    class="w-full rounded-xl border-amber-200 px-4 py-2.5 text-sm focus:border-amber-500">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Monitoring Schedule Card -->
                <div
                    class="rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden transition-all duration-300 hover:shadow-md">
                    <div class="px-8 py-5 bg-slate-50/50 border-b border-slate-100 flex items-center gap-3">
                        <div class="w-10 h-10 rounded-2xl bg-rose-100 text-rose-600 flex items-center justify-center">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h3 class="font-bold text-slate-800 leading-none text-base">Jadwal Monitoring (SLA)</h3>
                            <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-tighter">Abaikan Monitoring
                                (Maintenance)</p>
                        </div>
                    </div>
                    <div class="p-8 space-y-4">
                        <div class="p-4 bg-yellow-50 text-yellow-800 border-l-4 border-yellow-400 text-sm rounded-r-xl">
                            <p><strong>Info:</strong> Rentang waktu ini akan diabaikan oleh sistem monitoring dan
                                perhitungan SLA (tidak dianggap downtime).</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Mulai
                                    Abaikan (Jam)</label>
                                <input type="time" name="ignore_monitoring_start"
                                    value="<%= customer.ignore_monitoring_start %>"
                                    class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 focus:border-rose-500 focus:ring-4 focus:ring-rose-50 transition-all font-bold text-slate-800 outline-none text-sm" />
                            </div>
                            <div>
                                <label
                                    class="block text-xs font-bold text-slate-500 uppercase tracking-widest mb-2 px-1">Selesai
                                    Abaikan (Jam)</label>
                                <input type="time" name="ignore_monitoring_end"
                                    value="<%= customer.ignore_monitoring_end %>"
                                    class="w-full rounded-2xl border border-slate-200 px-5 py-3.5 focus:border-rose-500 focus:ring-4 focus:ring-rose-50 transition-all font-bold text-slate-800 outline-none text-sm" />
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right Column: Maps & Location (Col 5) -->
            <div class="lg:col-span-5 h-full">
                <div
                    class="sticky top-6 rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden flex flex-col transition-all duration-300 hover:shadow-md">
                    <div class="px-8 py-5 bg-slate-50/50 border-b border-slate-100 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div
                                class="w-10 h-10 rounded-2xl bg-green-100 text-green-600 flex items-center justify-center text-sm">
                                📍</div>
                            <h3 class="font-bold text-slate-800 leading-none text-base">Peta Lokasi</h3>
                        </div>
                        <button type="button" id="btnGetLocation"
                            class="px-4 py-2 bg-green-600 text-white rounded-2xl hover:bg-green-700 transition-all flex items-center gap-2 text-[10px] font-black uppercase tracking-widest shadow-lg shadow-green-200">
                            Auto GPS
                        </button>
                    </div>
                    <div class="p-8 flex flex-col gap-6">
                        <!-- Search Location Box -->
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-4 w-4 text-slate-400" fill="none" viewBox="0 0 24 24"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                                </svg>
                            </div>
                            <input type="text" id="map_search" placeholder="Cari desa, jalan, atau kota..."
                                class="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl text-xs font-bold text-slate-700 shadow-sm focus:ring-2 focus:ring-green-100 focus:border-green-400 outline-none transition-all placeholder:text-slate-300"
                                autocomplete="off">
                        </div>
                        <div
                            class="w-full h-[400px] bg-slate-100 rounded-3xl border-2 border-slate-100 overflow-hidden relative z-0">
                            <!-- Overlay Paste Link -->
                            <div
                                class="absolute top-2 left-2 right-2 z-[400] bg-white/90 backdrop-blur p-2 rounded-xl shadow-lg border border-slate-200 flex gap-2">
                                <input type="text" id="paste_map_link"
                                    placeholder="Paste Link Google Maps / WA ShareLoc..."
                                    class="flex-1 bg-transparent border-none text-xs font-bold text-slate-700 placeholder:text-slate-400 focus:ring-0 outline-none">
                                <button type="button" onclick="parseMapLink()"
                                    class="bg-blue-600 text-white text-[10px] uppercase font-black px-3 py-1.5 rounded-lg hover:bg-blue-700 shadow-sm transition-all whitespace-nowrap">
                                    Cari
                                </button>
                            </div>
                            <div id="map" class="w-full h-full z-0" style="min-height: 400px;"></div>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            <div>
                                <label
                                    class="block text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 px-1">Koordinat
                                    (Latitude, Longitude)</label>
                                <input name="coordinates" id="coordinates"
                                    value="<% if(customer.latitude && customer.longitude) { %><%= customer.latitude %>, <%= customer.longitude %><% } %>"
                                    placeholder="-6.xxxx, 106.xxxx"
                                    class="w-full px-5 py-3.5 border border-slate-200 rounded-2xl focus:ring-4 focus:ring-green-50 focus:border-green-300 transition-all font-mono text-xs font-bold text-slate-800 bg-slate-50/50 outline-none" />
                                <!-- Hidden inputs for backend compatibility if needed, or handle splitting in backend -->
                                <input type="hidden" name="latitude" id="latitude"
                                    value="<%= customer.latitude || '' %>">
                                <input type="hidden" name="longitude" id="longitude"
                                    value="<%= customer.longitude || '' %>">
                            </div>
                        </div>
                        <% if (customer.latitude && customer.longitude) { %>
                            <div class="text-center">
                                <a href="https://www.google.com/maps?q=<%= customer.latitude %>,<%= customer.longitude %>"
                                    target="_blank"
                                    class="inline-flex items-center gap-2 text-xs font-bold text-blue-600 hover:text-blue-800 hover:underline">
                                    <span>🗺️</span> Buka di Google Maps
                                </a>
                            </div>
                            <% } %>
                    </div>
                </div>
            </div>
        </div>

        <!-- Infrastructure Card -->
        <div
            class="rounded-3xl border border-slate-200 bg-white shadow-sm overflow-hidden transition-all duration-300 hover:shadow-md">
            <div class="px-8 py-5 bg-slate-50/50 border-b border-slate-100 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-2xl bg-cyan-100 text-cyan-600 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10">
                            </path>
                        </svg>
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800 leading-none text-base">Infrastruktur FTTH</h3>
                        <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-tighter">Manajemen Jalur &
                            Perangkat</p>
                    </div>
                </div>
            </div>
            <div class="p-8 space-y-8">
                <% var initialOdpName=customer.odp_name || '' ; var initialOdcName=customer.odc_name || '' ; var
                    initialOltName=customer.olt_name || 'Auto' ; %>

                    <!-- Wireless Toggle -->
                    <div
                        class="flex items-center justify-between p-6 bg-cyan-50/50 border border-cyan-100 rounded-3xl group shadow-sm">
                        <div class="flex items-center gap-4">
                            <div
                                class="w-12 h-12 rounded-2xl bg-white flex items-center justify-center text-cyan-600 shadow-sm transition-transform group-hover:rotate-12">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8.111 16.404a5.5 5.5 0 017.778 0M12 20h.01m-7.08-7.071a10 10 0 0114.142 0">
                                    </path>
                                </svg>
                            </div>
                            <div>
                                <span class="font-bold text-cyan-900 block text-lg">Koneksi Wireless Dedicated</span>
                                <span class="text-xs text-cyan-700 font-medium">Bypass infrastruktur fiber (menggunakan
                                    Point-to-Point)</span>
                            </div>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="is_wireless" class="sr-only peer" <%=(!customer.odp_id &&
                                !initialOdcName) ? 'checked' : '' %>>
                            <div
                                class="w-14 h-7 bg-slate-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-cyan-100 rounded-full peer peer-checked:after:translate-x-7 peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-0.5 after:bg-white after:border-gray-300 after:border after:rounded-full after:h-6 after:w-6 after:transition-all peer-checked:bg-cyan-600">
                            </div>
                        </label>
                    </div>

                    <!-- ODC/ODP Search -->
                    <div id="infra_wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-8 transition-all duration-300">
                        <div class="space-y-3">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest px-1">1. Cari
                                ODC Cabinet</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1 group">
                                    <input type="text" id="odc_search" value="<%= initialOdcName %>"
                                        placeholder="Ketik nama ODC..."
                                        class="w-full pl-5 rounded-2xl border border-slate-200 px-5 py-3.5 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-50 transition-all font-bold text-slate-800 outline-none placeholder:text-slate-300 text-sm"
                                        autocomplete="off">
                                    <input type="hidden" name="odc_id" id="odc_id" value="<%= customer.odc_id || '' %>">
                                    <div id="odc_search_results"
                                        class="absolute z-20 w-full mt-2 bg-white border border-slate-200 shadow-2xl rounded-2xl max-h-48 overflow-y-auto hidden">
                                    </div>
                                </div>
                                <button type="button" id="reset_odc_btn"
                                    class="px-4 border border-slate-200 rounded-2xl text-slate-400 hover:text-red-500 hover:bg-red-50 hover:border-red-100 transition-all">✕</button>
                            </div>
                        </div>

                        <div id="odp_section_wrapper"
                            class="space-y-3 relative transition-all <%= (customer.odc_id) ? '' : 'opacity-50 pointer-events-none' %>">
                            <label class="block text-xs font-bold text-slate-500 uppercase tracking-widest px-1">2.
                                Pilih ODP (Filtered)</label>
                            <div class="relative">
                                <input type="text" id="odp_search" value="<%= initialOdpName %>"
                                    placeholder="Pilih ODP dari ODC..."
                                    class="w-full border border-slate-200 rounded-2xl px-5 py-3.5 focus:border-cyan-500 focus:ring-4 focus:ring-cyan-50 transition-all font-bold text-slate-800 outline-none placeholder:text-slate-300 text-sm"
                                    autocomplete="off">
                                <input type="hidden" name="odp_id" id="odp_id" value="<%= customer.odp_id || '' %>">
                                <div id="odp_search_results"
                                    class="absolute z-20 w-full mt-2 bg-white border border-slate-200 shadow-2xl rounded-2xl max-h-48 overflow-y-auto hidden">
                                </div>
                            </div>

                            <!-- Device Info (OLT) -->
                            <div class="absolute top-0 right-0">
                                <div class="flex items-center gap-2">
                                    <label class="text-[10px] font-bold text-slate-400 uppercase">OLT Device:</label>
                                    <input type="text" id="olt_display" value="<%= initialOltName %>" readonly
                                        class="bg-transparent text-xs font-bold text-cyan-700 text-right w-24 outline-none">
                                    <input type="hidden" name="olt_id" id="olt_id" value="<%= customer.olt_id || '' %>">
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>

    </form>
</div>

<!-- SCRIPTS -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // === Tipe Koneksi Toggle ===
        const typeRadios = document.querySelectorAll('input[name="connection_type"]');
        const pppoeGroup = document.getElementById('pppoe-config');
        const staticGroup = document.getElementById('static-ip-config');

        typeRadios.forEach(r => r.addEventListener('change', (e) => {
            if (e.target.value === 'pppoe') {
                pppoeGroup.classList.remove('hidden');
                staticGroup.classList.add('hidden');
            } else {
                pppoeGroup.classList.add('hidden');
                staticGroup.classList.remove('hidden');
            }
        }));

        // === Check PPPoE Username Availability ===
        const pppoeInput = document.getElementById('pppoe_username');
        if (pppoeInput) {
            const pppoeMsg = document.createElement('div');
            pppoeMsg.id = 'pppoe-check-msg';
            pppoeMsg.className = 'text-xs font-bold mt-1 min-h-[20px]';
            // Insert after the input group (flex container)
            pppoeInput.closest('div').parentNode.appendChild(pppoeMsg);

            let pppoeCheckTimeout;
            pppoeInput.addEventListener('input', function () {
                clearTimeout(pppoeCheckTimeout);
                pppoeMsg.innerHTML = '';
                pppoeInput.classList.remove('border-green-500', 'border-red-500', 'border-yellow-500');

                const username = this.value.trim();
                const currentId = '<%= customer.id %>';

                if (username.length < 3) return;

                pppoeCheckTimeout = setTimeout(() => {
                    pppoeMsg.innerHTML = '<span class="text-blue-500 animate-pulse">🔍 Memeriksa ketersediaan...</span>';

                    fetch('/api/customers/check-pppoe?username=' + encodeURIComponent(username) + '&exclude_id=' + currentId)
                        .then(r => r.json())
                        .then(data => {
                            pppoeInput.classList.remove('border-green-500', 'border-red-500', 'border-yellow-500');

                            if (data.existsInDb) {
                                // Used by another customer
                                pppoeInput.classList.add('border-red-500');
                                pppoeMsg.innerHTML = `<span class="text-red-500 flex items-center gap-1">⛔ Digunakan oleh: <strong>${data.customerName}</strong> (#${data.customerCode})</span>`;
                            } else if (data.existsInMikrotik) {
                                // Exists in MikroTik (Unlinked or Orphaned)
                                pppoeInput.classList.add('border-yellow-500');
                                // Store data in window/global to verify
                                window.foundMikrotikData = data;

                                pppoeMsg.innerHTML = `
                                    <div class="flex flex-col gap-1 items-start text-yellow-700 bg-yellow-50 p-2 rounded-lg border border-yellow-200">
                                        <div class="flex items-center gap-1">
                                            <span>⚠️ Ditemukan di MikroTik (Belum terdaftar di DB).</span>
                                        </div>
                                        <button type="button" onclick="importMikrotikPppoeData()" class="px-3 py-1 bg-yellow-200 hover:bg-yellow-300 rounded-lg text-xs font-bold shadow-sm transition-all">
                                            📥 Import Password & Profile
                                        </button>
                                    </div>
                                 `;
                            } else {
                                // Available
                                pppoeInput.classList.add('border-green-500');
                                pppoeMsg.innerHTML = '<span class="text-green-600 flex items-center gap-1">✅ Username tersedia (Baru)</span>';
                            }
                        })
                        .catch(err => {
                            console.error('Check failed:', err);
                            pppoeMsg.innerHTML = '<span class="text-slate-400">Gagal memeriksa (Offline?)</span>';
                        });
                }, 800); // 800ms debounce
            });

            window.importMikrotikPppoeData = () => {
                if (window.foundMikrotikData) {
                    const d = window.foundMikrotikData;
                    const passInput = document.getElementById('pppoe_password');

                    if (passInput && d.password) {
                        passInput.value = d.password;
                        passInput.classList.add('bg-yellow-50', 'transition-all');
                        setTimeout(() => passInput.classList.remove('bg-yellow-50'), 1000);
                    }

                    // Attempt to select profile/package if matched logic exists (optional)
                    alert('✅ Data MikroTik Berhasil Di-load:\nPassword: ' + (d.password || '*****') + '\nProfile: ' + (d.profile || '-'));
                }
            };
        }

        // === Maps & Get Location ===
        const btnGetLocation = document.getElementById('btnGetLocation');
        const coordInput = document.getElementById('coordinates');
        const latInput = document.getElementById('latitude');
        const lngInput = document.getElementById('longitude');

        // Check if map container exists
        if (document.getElementById('map')) {
            // Safety check for Leaflet
            if (typeof L === 'undefined') {
                console.error('Leaflet JS (Map) not loaded. Check internet connection or CDN.');
                return;
            }

            try {
                // Default center (Indonesia -> Jakarta approx, or user's current value)
                let defaultLat = -6.200000;
                let defaultLng = 106.816666;
                let initialZoom = 5;

                if (latInput.value && lngInput.value) {
                    defaultLat = parseFloat(latInput.value);
                    defaultLng = parseFloat(lngInput.value);
                    initialZoom = 15;
                }

                // Init Map
                const map = L.map('map').setView([defaultLat, defaultLng], initialZoom);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                let marker;

                // Function to set marker
                function setMarker(lat, lng) {
                    if (marker) {
                        marker.setLatLng([lat, lng]);
                    } else {
                        marker = L.marker([lat, lng], { draggable: true }).addTo(map);

                        // Drag event
                        marker.on('dragend', function (e) {
                            const position = e.target.getLatLng();
                            latInput.value = position.lat.toFixed(6);
                            lngInput.value = position.lng.toFixed(6);
                            coordInput.value = `${position.lat.toFixed(6)}, ${position.lng.toFixed(6)}`;
                            updateAddress(position.lat, position.lng); // Update address field
                        });
                    }
                    // Determine zoom level: if it was default (5), zoom in. If already zoomed, keep it.
                    if (map.getZoom() < 12) map.setZoom(15);
                    map.panTo([lat, lng]);
                }

                // If initial values exist, place marker
                if (latInput.value && lngInput.value) {
                    setMarker(defaultLat, defaultLng);
                }

                // Map click event
                map.on('click', function (e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;

                    latInput.value = lat.toFixed(6);
                    lngInput.value = lng.toFixed(6);
                    coordInput.value = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;

                    setMarker(lat, lng);
                });

                // Function to update address from coords (Reverse Geocoding)
                const updateAddress = (lat, lng) => {
                    const addressInput = document.querySelector('textarea[name="address"]') || document.getElementById('address');
                    if (addressInput) {
                        addressInput.placeholder = 'Mengambil alamat...';
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1`)
                            .then(r => r.json())
                            .then(data => {
                                if (data && data.display_name) {
                                    // Make it cleaner: Road, Village, District
                                    const addr = data.address;
                                    const parts = [];
                                    if (addr.road) parts.push(addr.road);
                                    if (addr.village || addr.suburb || addr.hamlet) parts.push(addr.village || addr.suburb || addr.hamlet);
                                    if (addr.city || addr.town || addr.county) parts.push(addr.city || addr.town || addr.county);

                                    const cleanAddr = parts.length > 0 ? parts.join(', ') : data.display_name;
                                    addressInput.value = cleanAddr;
                                }
                            })
                            .catch(e => console.warn('Reverse geocode failed:', e))
                            .finally(() => addressInput.placeholder = 'Alamat lengkap...');
                    }
                };

                // Input change event (manual typing)
                coordInput.addEventListener('change', () => {
                    const parts = coordInput.value.split(',').map(s => s.trim());
                    if (parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))) {
                        const lat = parseFloat(parts[0]);
                        const lng = parseFloat(parts[1]);
                        latInput.value = lat;
                        lngInput.value = lng;
                        setMarker(lat, lng);
                    }
                });

                // Map Search Logic
                const searchInput = document.getElementById('map_search');
                if (searchInput) {
                    searchInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault(); // Prevent form submit
                            const q = searchInput.value.trim();
                            if (q.length > 2) {
                                searchInput.classList.add('opacity-50');
                                fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`)
                                    .then(r => r.json())
                                    .then(data => {
                                        if (data && data.length > 0) {
                                            const res = data[0];
                                            const lat = parseFloat(res.lat);
                                            const lon = parseFloat(res.lon);
                                            latInput.value = lat.toFixed(6);
                                            lngInput.value = lon.toFixed(6);
                                            coordInput.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
                                            setMarker(lat, lon, 16);
                                            searchInput.value = res.display_name; // Show found name
                                            updateAddress(lat, lon); // Update address field
                                        } else {
                                            alert('Lokasi tidak ditemukan');
                                        }
                                    })
                                    .catch(err => console.error('Map search err:', err))
                                    .finally(() => searchInput.classList.remove('opacity-50'));
                            }
                        }
                    });
                }

                // Get Location Button
                if (btnGetLocation) {
                    const fallbackToIP = () => {
                        btnGetLocation.textContent = 'IP Loc...';
                        fetch('/api/proxy/ip-location')
                            .then(r => r.json())
                            .then(data => {
                                if (data && (data.status === 'success' || data.lat)) {
                                    const lat = data.lat;
                                    const lon = data.lon || data.lng;
                                    latInput.value = lat;
                                    lngInput.value = lon;
                                    coordInput.value = `${lat}, ${lon}`;
                                    setMarker(lat, lon, 13);
                                    btnGetLocation.textContent = 'IP OK';
                                }
                            })
                            .catch(err => {
                                console.error('Fallback IP Failed:', err);
                                btnGetLocation.textContent = 'Gagal';
                            })
                            .finally(() => {
                                setTimeout(() => btnGetLocation.textContent = 'Auto GPS', 3000);
                            });
                    };

                    btnGetLocation.addEventListener('click', () => {
                        btnGetLocation.textContent = '...';
                        if ("geolocation" in navigator) {
                            navigator.geolocation.getCurrentPosition(pos => {
                                const { latitude, longitude } = pos.coords;
                                latInput.value = latitude.toFixed(6);
                                lngInput.value = longitude.toFixed(6);
                                coordInput.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                                setMarker(latitude, longitude);
                                updateAddress(latitude, longitude);
                                btnGetLocation.textContent = 'GPS OK';
                                setTimeout(() => btnGetLocation.textContent = 'Auto GPS', 2000);
                            }, err => {
                                console.warn('GPS failed, trying IP fallback...');
                                fallbackToIP();
                            }, {
                                enableHighAccuracy: true,
                                timeout: 5000,
                                maximumAge: 0
                            });
                        } else {
                            fallbackToIP();
                        }
                    });
                }

                // Resolve rendering issues (map hidden/shown in tabs or just loaded)
                setTimeout(() => { map.invalidateSize(); }, 200);
            } catch (err) {
                console.error('Error initializing map:', err);
            }
        }

        // === Infrastruktur (Wireless vs FTTH) ===
        const isWireless = document.getElementById('is_wireless');
        const infraWrapper = document.getElementById('infra_wrapper');
        const odpId = document.getElementById('odp_id');
        const odcId = document.getElementById('odc_id');
        const odpSearchInput = document.getElementById('odp_search');

        function updateWirelessState() {
            if (isWireless.checked) {
                // Wireless Mode: Disable ODC/ODP interaction and remove requirements
                infraWrapper.classList.add('opacity-40', 'pointer-events-none');

                // Remove required attributes
                if (odpId) {
                    odpId.required = false;
                    odpId.removeAttribute('required'); // Force remove
                }
                if (odpSearchInput) {
                    odpSearchInput.required = false;
                    odpSearchInput.removeAttribute('required');
                }

            } else {
                // FTTH Mode: Enable interaction and enforce ODP if needed
                infraWrapper.classList.remove('opacity-40', 'pointer-events-none');

                // Enforce required only if strict mode is desired (usually yes for FTTH)
                if (odpId) odpId.required = true;
                if (odpSearchInput) odpSearchInput.required = false;
            }
        }

        if (isWireless) {
            isWireless.addEventListener('change', updateWirelessState);
            // Run immediately
            setTimeout(updateWirelessState, 100);
        }

        // === ODC/ODP Search ===
        const odcSearch = document.getElementById('odc_search');
        const odcResults = document.getElementById('odc_search_results');
        //const odcId = document.getElementById('odc_id'); // Defined above
        const resetOdc = document.getElementById('reset_odc_btn');
        const odpSearch = document.getElementById('odp_search');
        const odpResults = document.getElementById('odp_search_results');
        const odpIdInput = document.getElementById('odp_id');
        const odpWrapper = document.getElementById('odp_section_wrapper');
        const oltDisplay = document.getElementById('olt_display');
        const oltId = document.getElementById('olt_id');

        let t;
        if (odcSearch) {
            odcSearch.addEventListener('input', (e) => {
                clearTimeout(t);
                const q = e.target.value.trim();
                odcId.value = '';
                odpWrapper.classList.add('opacity-50', 'pointer-events-none');
                if (q.length < 1) { odcResults.classList.add('hidden'); return; }
                t = setTimeout(() => {
                    fetch('/api/ftth/odc/search?q=' + encodeURIComponent(q))
                        .then(r => r.json())
                        .then(data => {
                            if (data.results && data.results.length) {
                                odcResults.innerHTML = data.results.map(o => `
                                <div class="px-4 py-3 hover:bg-slate-50 cursor-pointer border-b border-light" onclick="selOdc('${o.id}', '${o.name}')">
                                    <div class="font-bold text-slate-800 text-sm">${o.name}</div>
                                    <div class="text-[10px] text-slate-500">${o.location || ''}</div>
                                </div>
                            `).join('');
                                odcResults.classList.remove('hidden');
                            }
                        });
                }, 300);
            });

            odpSearch.addEventListener('input', (e) => {
                clearTimeout(t);
                const q = e.target.value.trim();
                const curOdc = odcId.value;
                if (!curOdc) return;
                t = setTimeout(() => {
                    fetch(`/api/ftth/odp/search?q=${encodeURIComponent(q)}&odc_id=${curOdc}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data.results && data.results.length) {
                                odpResults.innerHTML = data.results.map(o => `
                            <div class="px-4 py-3 hover:bg-slate-50 cursor-pointer border-b border-light" 
                                     onclick="selOdp('${o.id}', '${o.odp_name}', '${o.olt_id}', '${o.olt_name}')">
                                    <div class="font-bold text-slate-800 text-sm">${o.odp_name}</div>
                                    <div class="text-[10px] text-slate-500">Free: ${o.available_ports} Ports</div>
                                </div>
                            `).join('');
                                odpResults.classList.remove('hidden');
                            }
                        });
                }, 300);
            });
        }

        window.selOdc = (id, name) => {
            odcSearch.value = name;
            odcId.value = id;
            odcResults.classList.add('hidden');
            odpWrapper.classList.remove('opacity-50', 'pointer-events-none');
            odpSearch.value = '';
            odpIdInput.value = '';
            odpSearch.focus();
        };

        window.selOdp = (id, name, oltIdVal, oltNameVal) => {
            odpSearch.value = name;
            odpIdInput.value = id;
            odpResults.classList.add('hidden');
            if (oltId) oltId.value = oltIdVal || '';
            if (oltDisplay) oltDisplay.value = oltNameVal || 'Auto';
        };

        if (resetOdc) {
            resetOdc.addEventListener('click', () => {
                odcSearch.value = ''; odcId.value = '';
                odpWrapper.classList.add('opacity-50', 'pointer-events-none');
            });
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#odc_search')) odcResults.classList.add('hidden');
            if (!e.target.closest('#odp_search')) odpResults.classList.add('hidden');
        });

        // === Import Mikrotik IP ===
        const importBtn = document.getElementById('import_mikrotik_ip_btn');
        if (importBtn) {
            importBtn.addEventListener('click', async () => {
                const originalText = importBtn.innerHTML;
                importBtn.innerHTML = '⏳ Loading...';
                importBtn.disabled = true;

                try {
                    // Fetch ARP/Leases from API
                    const response = await fetch('/api/mikrotik/arp-leases');
                    const data = await response.json();

                    if (!data.success) throw new Error(data.message);

                    if (data.results.length === 0) {
                        alert('Tidak ada data ARP/Leases yang ditemukan di Mikrotik.');
                        return;
                    }

                    // Create a simple modal/dialog to select IP
                    const modal = document.createElement('div');
                    modal.className = 'flex items-center justify-center bg-black/50 backdrop-blur-sm p-4';
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999;';

                    const content = document.createElement('div');
                    content.className = 'bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]';

                    content.innerHTML = `
                        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold text-gray-800">Pilih IP dari Mikrotik</h3>
                            <button class="text-gray-400 hover:text-red-500 font-bold text-xl">&times;</button>
                        </div>
                        <div class="overflow-y-auto p-2 space-y-1">
                            ${data.results.map(item => `
                                <div class="p-3 hover:bg-blue-50 cursor-pointer rounded-xl border border-transparent hover:border-blue-100 transition-all flex justify-between items-center group"
                                     onclick="selectMikrotikIP('${item.ip}', '${item.mac}', '${item.comment}')">
                                    <div>
                                        <div class="font-mono font-bold text-blue-600">${item.ip}</div>
                                        <div class="text-xs text-gray-400">${item.mac} ${item.comment ? '• ' + item.comment : ''}</div>
                                    </div>
                                    <div class="text-xs font-bold text-gray-300 group-hover:text-blue-500">PILIH</div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    modal.appendChild(content);
                    document.body.appendChild(modal);

                    // Close handler
                    const closeBtn = content.querySelector('button');
                    const close = () => document.body.removeChild(modal);
                    closeBtn.onclick = close;
                    modal.onclick = (e) => { if (e.target === modal) close(); };

                    // Selection handler (global function for onclick)
                    window.selectMikrotikIP = (ip, mac, comment) => {
                        const ipInput = document.querySelector('input[name="ip_address"]');
                        if (ipInput) {
                            ipInput.value = ip;
                            // Trigger pulse effect
                            ipInput.classList.add('ring-4', 'ring-green-200');
                            setTimeout(() => ipInput.classList.remove('ring-4', 'ring-green-200'), 500);
                        }
                        close();
                    };

                } catch (error) {
                    console.error('Error fetching Mikrotik IPs:', error);
                    alert('Gagal mengambil data dari Mikrotik: ' + error.message);
                } finally {
                    importBtn.innerHTML = originalText;
                    importBtn.disabled = false;
                }
            });
        }

        // Import Active PPPoE Handler
        const importPppoeBtn = document.getElementById('btn-import-active-pppoe');
        if (importPppoeBtn) {
            importPppoeBtn.addEventListener('click', async () => {
                const originalText = importPppoeBtn.innerHTML;
                importPppoeBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
                importPppoeBtn.disabled = true;

                try {
                    console.log('Fetching active PPPoE connections...');
                    const response = await fetch('/api/mikrotik/pppoe/active-unregistered?exclude_id=<%= customer.id %>');

                    if (!response.ok) {
                        const text = await response.text();
                        console.error('Server Error Response:', text);
                        // Try to parse JSON from error response if possible
                        try {
                            const jsonErr = JSON.parse(text);
                            throw new Error(jsonErr.message || `Server Error ${response.status}`);
                        } catch (e) {
                            throw new Error(`Gagal mengambil data (${response.status}): ${text.substring(0, 50)}...`);
                        }
                    }

                    const result = await response.json();
                    console.log('Data received:', result);

                    if (result.status !== 'success') {
                        throw new Error(result.message || 'Unknown error from backend');
                    }

                    const users = result.data || [];

                    if (users.length === 0) {
                        alert('Tidak ada user PPPoE aktif yang belum terdaftar di database.');
                        return;
                    }

                    // Create Modal
                    const modal = document.createElement('div');
                    modal.className = 'flex items-center justify-center bg-black/50 backdrop-blur-sm px-4';
                    modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 99999;';

                    const content = document.createElement('div');
                    content.className = 'bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col max-h-[80vh]';

                    content.innerHTML = `
                        <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                            <h3 class="font-bold text-gray-800">Pilih User Active PPPoE</h3>
                            <button class="text-gray-400 hover:text-red-500 font-bold text-xl clos-btn">&times;</button>
                        </div>
                        <div class="overflow-y-auto p-2 space-y-1">
                            ${users.map(u => `
                                <div class="p-3 hover:bg-blue-50 cursor-pointer rounded-xl border border-transparent hover:border-blue-100 transition-all flex justify-between items-center group"
                                      onclick="selectActivePppoe('${u.name}', '${u['caller-id'] || ''}', '${u.address || ''}')">
                                    <div>
                                        <div class="font-bold text-blue-700">${u.name}</div>
                                        <div class="text-xs text-gray-500 flex gap-2">
                                            <span>IP: ${u.address}</span>
                                            <span>MAC: ${u['caller-id']}</span>
                                        </div>
                                    </div>
                                    <div class="text-xs font-bold text-gray-300 group-hover:text-blue-500">PILIH</div>
                                </div>
                            `).join('')}
                        </div>
                    `;

                    modal.appendChild(content);
                    document.body.appendChild(modal);

                    // Close handler
                    const closeBtn = content.querySelector('.clos-btn');
                    const close = () => document.body.removeChild(modal);
                    closeBtn.onclick = close;
                    modal.onclick = (e) => { if (e.target === modal) close(); };

                    // Select Handler
                    window.selectActivePppoe = (username, callerId, address) => {
                        const userInput = document.getElementById('pppoe_username');
                        if (userInput) {
                            userInput.value = username;
                            userInput.classList.add('ring-4', 'ring-blue-200');
                            setTimeout(() => userInput.classList.remove('ring-4', 'ring-blue-200'), 500);
                        }
                        close();
                    };

                } catch (error) {
                    console.error(error);
                    alert('Gagal mengambil data: ' + error.message);
                } finally {
                    importPppoeBtn.innerHTML = originalText;
                    importPppoeBtn.disabled = false;
                }
            });
        }

        // === Sync PPPoE Secret Handler ===
        const syncPppoeBtn = document.getElementById('create_pppoe_secret_btn');
        if (syncPppoeBtn) {
            syncPppoeBtn.addEventListener('click', async () => {
                const usernameInput = document.getElementById('pppoe_username');
                const passwordInput = document.getElementById('pppoe_password');
                const pkgSelect = document.querySelector('select[name="pppoe_package"]');

                if (!usernameInput || !passwordInput) return;

                const payload = {
                    customerId: '<%= customer.id %>',
                    customerName: '<%= customer.name %>',
                    username: usernameInput.value,
                    password: passwordInput.value,
                    packageId: pkgSelect ? pkgSelect.value : ''
                };

                if (!payload.username || !payload.password) {
                    alert('Username dan Password harus diisi!');
                    return;
                }

                if (!confirm('Apakah Anda yakin ingin melakukan sinkronisasi data PPPoE ini ke MikroTik? Data di Router akan ditimpa/dibuat baru.')) return;

                const originalText = syncPppoeBtn.innerHTML;
                syncPppoeBtn.innerHTML = '⏳ Processing...';
                syncPppoeBtn.disabled = true;

                try {
                    const res = await fetch('/api/pppoe/secret/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    let data;
                    try {
                        data = await res.json();
                    } catch (err) {
                        console.error('JSON Parse error', err);
                        throw new Error('Server returned invalid response');
                    }

                    if (data.success) {
                        alert('✅ Sukses! Data PPPoE berhasil disinkronisasi ke MikroTik.');
                    } else {
                        alert('❌ Gagal: ' + (data.error || data.message || 'Unknown error'));
                    }
                } catch (e) {
                    console.error(e);
                    alert('❌ Terjadi kesalahan sistem: ' + e.message);
                } finally {
                    syncPppoeBtn.innerHTML = originalText;
                    syncPppoeBtn.disabled = false;
                }
            });
        }
    });
</script>

<!-- SMART LOCATION & MAP TOOLS -->
<script>
    document.addEventListener('DOMContentLoaded', function () {

        // Helper: Update Inputs & Marker
        window.updateLocationInputs = function (lat, lng) {
            const latInput = document.getElementById('latitude');
            const lngInput = document.getElementById('longitude');
            const coordInput = document.getElementById('coordinates');

            if (latInput) latInput.value = lat;
            if (lngInput) lngInput.value = lng;
            if (coordInput) coordInput.value = `${lat}, ${lng}`;

            // Try to update Leaflet Map if instance exists globally
            // Check common variable names: map, mymap, leafletMap
            const mapInstance = window.map || window.mymap || window.leafletMap;
            const markerInstance = window.marker || window.customerMarker;

            if (mapInstance && typeof L !== 'undefined') {
                const newLatLng = new L.LatLng(lat, lng);
                mapInstance.setView(newLatLng, 16);
                if (markerInstance) {
                    markerInstance.setLatLng(newLatLng);
                } else {
                    // Create new marker if not exists
                    if (window.L) {
                        window.marker = L.marker(newLatLng, { draggable: true }).addTo(mapInstance);
                        // Add drag listener to new marker
                        window.marker.on('dragend', function (e) {
                            const pos = e.target.getLatLng();
                            updateLocationInputs(pos.lat, pos.lng);
                        });
                    }
                }
            }
        };

        // 1. Link Parser Logic
        window.parseMapLink = function () {
            const input = document.getElementById('paste_map_link');
            if (!input || !input.value) {
                alert('Silakan paste link terlebih dahulu!');
                return;
            }
            const text = input.value;
            let lat, lng;

            // Regex patterns
            const patterns = [
                /(-?\d+\.\d+),\s*(-?\d+\.\d+)/, // Raw coords
                /q=(-?\d+\.\d+),(-?\d+\.\d+)/, // Google Maps q param
                /@(-?\d+\.\d+),(-?\d+\.\d+)/,   // Google Maps @ param
                /!3d(-?\d+\.\d+)!4d(-?\d+\.\d+)/ // Google Maps embed param
            ];

            for (let p of patterns) {
                const m = text.match(p);
                if (m) { lat = m[1]; lng = m[2]; break; }
            }

            if (lat && lng) {
                updateLocationInputs(lat, lng);
                // alert(`Lokasi ditemukan: ${lat}, ${lng}`);
            } else {
                if (text.includes('goo.gl') || text.includes('maps.app') || text.includes('bit.ly')) {
                    const confirmOpen = confirm('Link pendek terdeteksi. Sistem tidak bisa membaca koordinat langsung dari link pendek.\n\nKlik OK untuk membuka link ini di tab baru, lalu COPY link hasil redirect (yang panjang dan ada angkanya) dan PASTE kembali di sini.');
                    if (confirmOpen) window.open(text, '_blank');
                } else {
                    alert('Maaf, koordinat tidak ditemukan dalam link tersebut. Pastikan link mengandung angka koordinat (contoh: -6.123, 106.123).');
                }
            }
        };

        // 2. Auto GPS Override (HTTP Friendly)
        const btnLoc = document.getElementById('btnGetLocation');
        if (btnLoc) {
            // Cloning button to strip existing event listeners is safer
            const newBtn = btnLoc.cloneNode(true);
            btnLoc.parentNode.replaceChild(newBtn, btnLoc);

            newBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                const originalText = newBtn.innerHTML;
                newBtn.innerHTML = '⏳ MENCARI...';
                newBtn.disabled = true;

                const onCpuSuccess = (pos) => {
                    updateLocationInputs(pos.coords.latitude, pos.coords.longitude);
                    newBtn.innerHTML = '✅ GPS OK';
                    setTimeout(() => { newBtn.innerHTML = originalText; newBtn.disabled = false; }, 2000);
                };

                const onCpuError = async (err) => {
                    console.warn('[AutoGPS] Browser GPS failed/blocked:', err);
                    newBtn.innerHTML = '🌍 IP LOOKUP...';

                    // Fallback to IP API
                    try {
                        const isHttps = window.location.protocol === 'https:';
                        // ip-api.com is very accurate for HTTP, ipapi.co is backup for HTTPS
                        const apiUrl = isHttps ? 'https://ipapi.co/json/' : 'http://ip-api.com/json';

                        console.log('Fetching IP Location from:', apiUrl);
                        const response = await fetch(apiUrl);
                        const data = await response.json();

                        // normalize keys
                        const lat = data.lat || data.latitude;
                        const lng = data.lon || data.longitude;

                        if (lat && lng) {
                            updateLocationInputs(lat, lng);
                            alert('⚠️ GPS Hardware gagal (Blokir Browser). Lokasi estimasi ISP digunakan.\n\nTips: Untuk lokasi 100% akurat, gunakan fitur "Paste Link Google Maps" di atas peta.');
                        } else {
                            throw new Error('IP API no coords');
                        }
                    } catch (ipErr) {
                        console.error(ipErr);
                        alert('❌ Gagal mendapatkan lokasi otomatis.\n\nSilakan gunakan metode "Paste Link Google Maps" atau input manual.');
                    } finally {
                        newBtn.innerHTML = originalText;
                        newBtn.disabled = false;
                    }
                };

                // Logic: Try Navigator first
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(onCpuSuccess, onCpuError, {
                        enableHighAccuracy: true,
                        timeout: 5000,
                        maximumAge: 0
                    });
                } else {
                    onCpuError('Geolocation not supported');
                }
            });
        }
    });
</script>