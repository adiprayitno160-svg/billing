<div class="space-y-6">
    <!-- Header Section -->
    <div
        class="rounded-2xl border border-modern-blue-200 bg-gradient-to-br from-modern-blue-50 to-modern-cyan-50 p-6 shadow-sm">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-modern-blue-900">Edit Pelanggan</h1>
                <p class="text-modern-blue-600 mt-1">Ubah data pelanggan sistem billing</p>
            </div>
            <div class="flex items-center gap-3">
                <a href="/customers/list"
                    class="px-4 py-2 border border-modern-blue-300 text-modern-blue-700 rounded-lg hover:bg-modern-blue-50 transition-all duration-300 font-medium text-sm">
                    ← Kembali
                </a>
            </div>
        </div>
    </div>

    <!-- Main Edit Form -->
    <form method="POST" action="/customers/<%= customer.id %>" class="space-y-6">

        <!-- CARD 1: Basic Information -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                    <span class="p-1.5 bg-blue-100 text-blue-600 rounded-lg">👤</span>
                    <h3 class="font-bold text-slate-800">Informasi Pelanggan</h3>
                </div>
                <div class="p-6 space-y-4">
                    <!-- Name -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Nama Lengkap *</label>
                        <input type="text" name="name" value="<%= customer.name %>" required
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-100 focus:border-blue-500 transition-all font-medium">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <!-- Code -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Kode Pelanggan</label>
                            <input type="text" name="customer_code" value="<%= customer.customer_code || '' %>"
                                class="w-full px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg text-slate-600 font-mono text-sm"
                                readonly>
                        </div>
                        <!-- Phone -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Nomor Telepon</label>
                            <input type="tel" name="phone" value="<%= customer.phone || '' %>"
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-100 transition-all">
                        </div>
                    </div>

                    <!-- Status -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Status Langganan</label>
                        <select name="status" required
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-100">
                            <option value="active" <%=customer.status==='active' ? 'selected' : '' %>>✅ Aktif</option>
                            <option value="inactive" <%=customer.status==='inactive' ? 'selected' : '' %>>❌ Tidak Aktif
                                (Isolir)</option>
                        </select>
                    </div>

                    <!-- Address -->
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Alamat Pemasangan</label>
                        <textarea name="address" rows="2"
                            class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-100 transition-all"><%= customer.address || '' %></textarea>
                    </div>
                </div>
            </div>

            <!-- CARD: Location & Coordinates -->
            <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden col-span-1 lg:col-span-2">
                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <span class="p-1.5 bg-green-100 text-green-600 rounded-lg">📍</span>
                        <h3 class="font-bold text-slate-800">Lokasi & Koordinat</h3>
                    </div>
                    <button type="button" id="btnGetLocation"
                        class="text-xs px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all font-medium flex items-center gap-1">
                        <span>📍</span> Ambil Lokasi GPS
                    </button>
                </div>
                <div class="p-6">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <!-- Left: Inputs -->
                        <div class="lg:col-span-1 space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Latitude</label>
                                <input type="text" name="latitude" id="latitude" value="<%= customer.latitude || '' %>"
                                    placeholder="-6.xxxx"
                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-100 font-mono">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Longitude</label>
                                <input type="text" name="longitude" id="longitude"
                                    value="<%= customer.longitude || '' %>" placeholder="106.xxxx"
                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-100 font-mono">
                            </div>

                            <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg">
                                <p class="text-[11px] text-blue-700 leading-relaxed">
                                    <strong>Panduan:</strong><br>
                                    1. Klik tombol "Ambil Lokasi GPS" saat berada di rumah pelanggan.<br>
                                    2. Atau klik lokasi pada peta di sebelah kanan.<br>
                                    3. Geser pin merah untuk penyesuaian akurat.
                                </p>
                            </div>

                            <% if (customer.latitude && customer.longitude) { %>
                                <a href="https://www.google.com/maps?q=<%= customer.latitude %>,<%= customer.longitude %>"
                                    target="_blank"
                                    class="inline-flex items-center gap-2 text-xs text-blue-600 hover:underline font-medium mt-2">
                                    🗺️ Buka di Google Maps
                                </a>
                                <% } %>
                        </div>

                        <!-- Right: Map -->
                        <div class="lg:col-span-2">
                            <div
                                class="w-full h-[300px] lg:h-full min-h-[300px] bg-slate-100 rounded-lg border border-slate-200 overflow-hidden relative z-0">
                                <div id="map" class="w-full h-full z-0"
                                    style="min-height: 300px; height: 100%; width: 100%;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spacer for visual separation -->
        <div class="h-1"></div>

        <!-- CARD 2: Billing & Finance -->
        <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                <span class="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg">💳</span>
                <h3 class="font-bold text-slate-800">Tagihan & Pembayaran</h3>
            </div>
            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Billing Mode -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Mode Pembayaran</label>
                    <select id="billing_mode" name="billing_mode"
                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-200">
                        <option value="postpaid" <%=(!customer.billing_mode || customer.billing_mode==='postpaid' )
                            ? 'selected' : '' %>>📅 Pascabayar (Bulanan)</option>
                        <option value="prepaid" <%=customer.billing_mode==='prepaid' ? 'selected' : '' %>>💰 Prabayar
                            (Sistem Voucher)</option>
                    </select>
                </div>

                <!-- Expiry View (Prepaid Only) -->
                <% if (customer.billing_mode==='prepaid' && customer.expiry_date) { %>
                    <div>
                        <label class="block text-sm font-medium text-slate-700 mb-1">Masa Aktif</label>
                        <div
                            class="px-4 py-2 bg-slate-50 border border-slate-200 rounded-lg flex justify-between items-center h-[46px]">
                            <span class="font-bold text-slate-700 text-sm">
                                <%= new Date(customer.expiry_date).toLocaleString('id-ID', { dateStyle: 'medium' ,
                                    timeStyle: 'short' }) %>
                            </span>
                            <% if (new Date(customer.expiry_date) <=new Date()) { %>
                                <span
                                    class="px-2 py-0.5 bg-red-100 text-red-700 text-[10px] rounded-full font-bold">EXPIRED</span>
                                <% } else { %>
                                    <span
                                        class="px-2 py-0.5 bg-green-100 text-green-700 text-[10px] rounded-full font-bold">ACTIVE</span>
                                    <% } %>
                        </div>
                    </div>
                    <% } %>

                        <!-- Flags -->
                        <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <!-- PPN Checkbox -->
                            <label
                                class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                <input type="checkbox" name="is_taxable" value="1" <%=customer.is_taxable ? 'checked'
                                    : '' %>
                                class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                                <div>
                                    <span class="block text-sm font-bold text-slate-700">Kena PPN</span>
                                    <span class="block text-xs text-slate-500">Tambahkan pajak PPN pada invoice</span>
                                </div>
                            </label>

                            <!-- Device Rental Checkbox -->
                            <label
                                class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                <input type="checkbox" name="use_device_rental" id="use_device_rental" value="1"
                                    <%=customer.use_device_rental ? 'checked' : '' %>
                                class="w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 border-gray-300">
                                <div>
                                    <span class="block text-sm font-bold text-slate-700">Sewa Perangkat</span>
                                    <span class="block text-xs text-slate-500">Tagihan sewa ONT/STB bulanan</span>
                                </div>
                            </label>
                        </div>

                        <!-- Rental Details -->
                        <div id="rental_options"
                            class="md:col-span-2 grid grid-cols-2 gap-4 p-4 bg-indigo-50 rounded-lg border border-indigo-100 <%= customer.use_device_rental ? '' : 'hidden' %>">
                            <div>
                                <label class="block text-xs font-semibold text-indigo-700 mb-1">Mode Sewa</label>
                                <select name="rental_mode"
                                    class="w-full px-3 py-2 text-sm border-indigo-200 rounded focus:border-indigo-500">
                                    <option value="flat" <%=(!customer.rental_mode || customer.rental_mode==='flat' )
                                        ? 'selected' : '' %>>Flat (Bulanan)</option>
                                    <option value="daily" <%=customer.rental_mode==='daily' ? 'selected' : '' %>>Harian
                                        (Proporsional)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-indigo-700 mb-1">Biaya (Rp)</label>
                                <input type="number" name="rental_cost" value="<%= customer.rental_cost || '' %>"
                                    placeholder="Default"
                                    class="w-full px-3 py-2 text-sm border-indigo-200 rounded focus:border-indigo-500">
                            </div>
                        </div>
            </div>
        </div>

        <!-- CARD 3: Technical Configuration -->
        <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                <span class="p-1.5 bg-purple-100 text-purple-600 rounded-lg">⚙️</span>
                <h3 class="font-bold text-slate-800">Konfigurasi Koneksi</h3>
            </div>

            <div class="p-6 space-y-6">
                <!-- Connection Type Selector -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-3">Tipe Koneksi</label>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <label class="cursor-pointer">
                            <input type="radio" name="connection_type" value="pppoe" class="peer sr-only"
                                <%=customer.connection_type==='pppoe' ? 'checked' : '' %>>
                            <div
                                class="p-4 border-2 rounded-xl transition-all hover:bg-blue-50 peer-checked:border-blue-500 peer-checked:bg-blue-50 border-slate-200">
                                <span class="block font-bold text-slate-700 peer-checked:text-blue-700">PPPoE</span>
                                <span class="text-xs text-slate-500">Username & Password</span>
                            </div>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="connection_type" value="static_ip" class="peer sr-only"
                                <%=customer.connection_type==='static_ip' ? 'checked' : '' %>>
                            <div
                                class="p-4 border-2 rounded-xl transition-all hover:bg-green-50 peer-checked:border-green-500 peer-checked:bg-green-50 border-slate-200">
                                <span class="block font-bold text-slate-700 peer-checked:text-green-700">Static
                                    IP</span>
                                <span class="text-xs text-slate-500">IP Address Manual</span>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- PPPoE Form -->
                <div id="pppoe-config"
                    class="<%= customer.connection_type === 'pppoe' ? '' : 'hidden' %> space-y-4 pt-4 border-t border-slate-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Secret Search (Optional) -->
                        <div
                            class="md:col-span-2 p-4 bg-blue-50 border border-blue-100 rounded-lg flex items-center justify-between">
                            <div class="text-sm text-blue-800 font-medium">Link ke MikroTik</div>
                            <button type="button" id="create_pppoe_secret_btn"
                                class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold text-xs transition-colors shadow-sm">
                                ⚡ Sync Ke MikroTik
                            </button>
                        </div>

                        <!-- Username -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Username PPPoE *</label>
                            <input type="text" name="pppoe_username" value="<%= customer.pppoe_username || '' %>"
                                id="pppoe_username"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-100 font-medium text-blue-700">
                        </div>

                        <!-- Password -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Password PPPoE</label>
                            <div class="flex gap-2">
                                <input type="text" name="pppoe_password" id="pppoe_password"
                                    placeholder="<%= customer.pppoe_password ? '****** (Tersimpan)' : 'Input password' %>"
                                    class="flex-1 px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-100 font-mono">
                                <button type="button" id="generate_password_btn"
                                    class="px-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-500">🔑</button>
                            </div>
                        </div>

                        <!-- Package Select -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Paket Layanan</label>
                            <select name="pppoe_package"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-100 font-medium">
                                <option value="">-- Pilih Paket (Opsional) --</option>
                                <% if (typeof packages !=='undefined' && packages) { packages.forEach(pkg=> { %>
                                    <option value="<%= pkg.id %>" <%=(String(customer.package_id)===String(pkg.id) ||
                                        String(customer.pppoe_package_id)===String(pkg.id)) ? 'selected' : '' %>>
                                        <%= pkg.name %> (<%= pkg.price.toLocaleString('id-ID') %>)
                                    </option>
                                    <% }); } %>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Static IP Form -->
                <div id="static-ip-config"
                    class="<%= customer.connection_type === 'static_ip' ? '' : 'hidden' %> space-y-4 pt-4 border-t border-slate-100">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- IP Address -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">IP Address *</label>
                            <input type="text" name="ip_address" value="<%= customer.ip_address || '' %>"
                                placeholder="10.10.x.x"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-100 font-mono text-green-700">
                        </div>

                        <!-- Gateway -->
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Gateway</label>
                            <input type="text" name="gateway" value="<%= customer.gateway || '' %>"
                                placeholder="10.10.x.1"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-100 font-mono">
                        </div>

                        <!-- Interface Select -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Interface MikroTik *</label>
                            <select name="interface"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-100 font-medium">
                                <option value="">-- Pilih Interface --</option>
                                <% if (typeof interfaces !=='undefined' && Array.isArray(interfaces)) {
                                    interfaces.forEach(ifc=> { %>
                                    <option value="<%= ifc.name %>" <%=customer.interface===ifc.name ? 'selected' : ''
                                        %>>
                                        <%= ifc.name %> (<%= ifc.type %>)
                                    </option>
                                    <% }); } else if (customer.interface) { %>
                                        <option value="<%= customer.interface %>" selected>
                                            <%= customer.interface %> (Current)
                                        </option>
                                        <% } %>
                            </select>
                        </div>

                        <!-- Package Select (Static) -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Paket Layanan (Static
                                IP)</label>
                            <select name="static_ip_package"
                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-100 font-medium">
                                <option value="">-- Pilih Paket --</option>
                                <% if (typeof packages !=='undefined' && packages) { packages.forEach(pkg=> { %>
                                    <option value="<%= pkg.id %>" <%=(String(customer.package_id)===String(pkg.id) ||
                                        String(customer.static_ip_package_id)===String(pkg.id)) ? 'selected' : '' %>>
                                        <%= pkg.name %> (<%= pkg.price.toLocaleString('id-ID') %>)
                                    </option>
                                    <% }); } %>
                            </select>
                            <p class="text-[10px] text-green-600 mt-1 italic">Pastikan paket terpilih untuk update
                                limitasi bandwith.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CARD 4: Infrastructure -->
        <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
            <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                <span class="p-1.5 bg-cyan-100 text-cyan-600 rounded-lg">🏗️</span>
                <h3 class="font-bold text-slate-800">Infrastruktur FTTH</h3>
            </div>
            <div class="p-6 space-y-5">
                <% var initialOdpName=customer.odp_name || '' ; var initialOdcName=customer.odc_name || '' ; var
                    initialOltName=customer.olt_name || 'Auto' ; %>
                    <!-- Wireless Toggle -->
                    <div class="p-4 bg-cyan-50 border border-cyan-100 rounded-lg flex items-center gap-3">
                        <input type="checkbox" id="is_wireless" class="w-6 h-6 text-cyan-600 rounded border-gray-300"
                            <%=(!customer.odp_id && !initialOdcName) ? 'checked' : '' %>>
                        <div>
                            <span class="block text-sm font-bold text-cyan-900">Koneksi Wireless / Tanpa ODP</span>
                            <span class="block text-xs text-cyan-700">Pelanggan tidak menggunakan box ODP (lewat
                                radio/PTP)</span>
                        </div>
                    </div>

                    <!-- ODC/ODP Inputs -->
                    <div id="infra_wrapper" class="space-y-4 transition-all duration-300">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">1. Cari ODC Cabinet</label>
                            <div class="flex gap-2">
                                <div class="relative flex-1">
                                    <input type="text" id="odc_search" value="<%= initialOdcName %>"
                                        placeholder="Ketik nama ODC..."
                                        class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-100 font-medium"
                                        autocomplete="off">
                                    <input type="hidden" name="odc_id" id="odc_id" value="<%= customer.odc_id || '' %>">
                                    <div id="odc_search_results"
                                        class="absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 shadow-xl rounded-lg max-h-48 overflow-y-auto hidden">
                                    </div>
                                </div>
                                <button type="button" id="reset_odc_btn"
                                    class="px-3 border border-slate-200 rounded-lg bg-slate-50 text-slate-400">✕</button>
                            </div>
                        </div>

                        <div id="odp_section_wrapper"
                            class="relative transition-all <%= (customer.odc_id) ? '' : 'opacity-50 pointer-events-none' %>">
                            <label class="block text-sm font-bold text-slate-700 mb-1">2. Pilih ODP (Filtered)</label>
                            <div class="relative">
                                <input type="text" id="odp_search" value="<%= initialOdpName %>"
                                    placeholder="Pilih ODP dari ODC..."
                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-100 font-medium"
                                    autocomplete="off">
                                <input type="hidden" name="odp_id" id="odp_id" value="<%= customer.odp_id || '' %>">
                                <div id="odp_search_results"
                                    class="absolute z-50 left-0 right-0 mt-1 bg-white border border-slate-200 shadow-xl rounded-lg max-h-48 overflow-y-auto hidden">
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-[10px] font-bold text-slate-500 uppercase">OLT Device</label>
                                <input type="text" id="olt_display" value="<%= initialOltName %>" readonly
                                    class="w-full px-3 py-2 bg-slate-100 border border-slate-200 rounded text-slate-600 text-xs font-medium">
                                <input type="hidden" name="olt_id" id="olt_id" value="<%= customer.olt_id || '' %>">
                            </div>
                        </div>
                    </div>
            </div>
        </div>

        <!-- Submit Actions -->
        <div class="flex items-center justify-end gap-3 pt-6">
            <a href="/customers/list"
                class="px-6 py-3 text-slate-500 font-bold hover:text-slate-700 transition-colors">Batal</a>
            <button type="submit"
                class="px-10 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-0.5">
                💾 Simpan Perubahan
            </button>
        </div>
    </form>
</div>

<!-- SCRIPTS -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // === Tipe Koneksi Toggle ===
        const typeRadios = document.querySelectorAll('input[name="connection_type"]');
        const pppoeGroup = document.getElementById('pppoe-config');
        const staticGroup = document.getElementById('static-ip-config');

        typeRadios.forEach(r => r.addEventListener('change', (e) => {
            if (e.target.value === 'pppoe') {
                pppoeGroup.classList.remove('hidden');
                staticGroup.classList.add('hidden');
            } else {
                pppoeGroup.classList.add('hidden');
                staticGroup.classList.remove('hidden');
            }
        }));

        // === Device Rental Toggle ===
        const rentalCheck = document.getElementById('use_device_rental');
        const rentalOptions = document.getElementById('rental_options');
        if (rentalCheck && rentalOptions) {
            rentalCheck.addEventListener('change', function () {
                if (this.checked) rentalOptions.classList.remove('hidden');
                else rentalOptions.classList.add('hidden');
            });
        }

        // === Maps & Get Location ===
        const btnGetLocation = document.getElementById('btnGetLocation');
        const latInput = document.getElementById('latitude');
        const lngInput = document.getElementById('longitude');

        // Check if map container exists
        if (document.getElementById('map')) {
            // Safety check for Leaflet
            if (typeof L === 'undefined') {
                console.error('Leaflet JS (Map) not loaded. Check internet connection or CDN.');
                return;
            }

            try {
                // Default center (Indonesia -> Jakarta approx, or user's current value)
                let defaultLat = -6.200000;
                let defaultLng = 106.816666;
                let initialZoom = 5;

                if (latInput.value && lngInput.value) {
                    defaultLat = parseFloat(latInput.value);
                    defaultLng = parseFloat(lngInput.value);
                    initialZoom = 15;
                }

                // Init Map
                const map = L.map('map').setView([defaultLat, defaultLng], initialZoom);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                let marker;

                // Function to set marker
                function setMarker(lat, lng) {
                    if (marker) {
                        marker.setLatLng([lat, lng]);
                    } else {
                        marker = L.marker([lat, lng], { draggable: true }).addTo(map);

                        // Drag event
                        marker.on('dragend', function (e) {
                            const position = e.target.getLatLng();
                            latInput.value = position.lat.toFixed(6);
                            lngInput.value = position.lng.toFixed(6);
                        });
                    }
                    // Determine zoom level: if it was default (5), zoom in. If already zoomed, keep it.
                    if (map.getZoom() < 12) map.setZoom(15);
                    map.panTo([lat, lng]);
                }

                // If initial values exist, place marker
                if (latInput.value && lngInput.value) {
                    setMarker(defaultLat, defaultLng);
                }

                // Map click event
                map.on('click', function (e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;

                    latInput.value = lat.toFixed(6);
                    lngInput.value = lng.toFixed(6);

                    setMarker(lat, lng);
                });

                // Input change event (manual typing)
                [latInput, lngInput].forEach(input => {
                    input.addEventListener('change', () => {
                        const lat = parseFloat(latInput.value);
                        const lng = parseFloat(lngInput.value);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            setMarker(lat, lng);
                        }
                    });
                });

                // Get Location Button
                if (btnGetLocation) {
                    btnGetLocation.addEventListener('click', () => {
                        btnGetLocation.textContent = '⌛ Mencari...';
                        if ("geolocation" in navigator) {
                            navigator.geolocation.getCurrentPosition((pos) => {
                                const lat = pos.coords.latitude;
                                const lng = pos.coords.longitude;

                                latInput.value = lat.toFixed(6);
                                lngInput.value = lng.toFixed(6);

                                setMarker(lat, lng);

                                btnGetLocation.innerHTML = '<span>✅</span> Lokasi Didapat';
                                setTimeout(() => btnGetLocation.innerHTML = '<span>📍</span> Ambil Lokasi GPS', 2000);
                            }, (err) => {
                                alert('Gagal mengambil lokasi: ' + err.message);
                                btnGetLocation.textContent = '❌ Gagal';
                            });
                        } else {
                            alert('Geolocation tidak didukung browser ini.');
                        }
                    });
                }

                // Resolve rendering issues (map hidden/shown in tabs or just loaded)
                setTimeout(() => { map.invalidateSize(); }, 200);
            } catch (err) {
                console.error('Error initializing map:', err);
            }
        }

        // === Infrastruktur (Wireless vs FTTH) ===
        const isWireless = document.getElementById('is_wireless');
        const infraWrapper = document.getElementById('infra_wrapper');
        const odpId = document.getElementById('odp_id');
        const odcId = document.getElementById('odc_id');
        const odpSearchInput = document.getElementById('odp_search');

        function updateWirelessState() {
            if (isWireless.checked) {
                // Wireless Mode: Disable ODC/ODP interaction and remove requirements
                infraWrapper.classList.add('opacity-40', 'pointer-events-none');

                // Remove required attributes
                if (odpId) {
                    odpId.required = false;
                    odpId.removeAttribute('required'); // Force remove
                }
                if (odpSearchInput) {
                    odpSearchInput.required = false;
                    odpSearchInput.removeAttribute('required');
                }

                // Optional: Clear values to ensure clean data submission (discuss if needed, currently just allowing submission)
                // if (odpId) odpId.value = ''; 
                // if (odcId) odcId.value = '';

            } else {
                // FTTH Mode: Enable interaction and enforce ODP if needed
                infraWrapper.classList.remove('opacity-40', 'pointer-events-none');

                // Enforce required only if strict mode is desired (usually yes for FTTH)
                if (odpId) odpId.required = true;
                if (odpSearchInput) odpSearchInput.required = false; // Search input itself usually doesn't need required if hidden ID handles it, but safety first
            }
        }

        if (isWireless) {
            isWireless.addEventListener('change', updateWirelessState);
            // Run immediately
            setTimeout(updateWirelessState, 100);
        }

        // === ODC/ODP Search ===
        const odcSearch = document.getElementById('odc_search');
        const odcResults = document.getElementById('odc_search_results');
        const odcId = document.getElementById('odc_id');
        const resetOdc = document.getElementById('reset_odc_btn');
        const odpSearch = document.getElementById('odp_search');
        const odpResults = document.getElementById('odp_search_results');
        const odpIdInput = document.getElementById('odp_id');
        const odpWrapper = document.getElementById('odp_section_wrapper');
        const oltDisplay = document.getElementById('olt_display');
        const oltId = document.getElementById('olt_id');

        let t;
        if (odcSearch) {
            odcSearch.addEventListener('input', (e) => {
                clearTimeout(t);
                const q = e.target.value.trim();
                odcId.value = '';
                odpWrapper.classList.add('opacity-50', 'pointer-events-none');
                if (q.length < 1) { odcResults.classList.add('hidden'); return; }
                t = setTimeout(() => {
                    fetch('/api/ftth/odc/search?q=' + encodeURIComponent(q))
                        .then(r => r.json())
                        .then(data => {
                            if (data.results && data.results.length) {
                                odcResults.innerHTML = data.results.map(o => `
                                <div class="px-4 py-2 hover:bg-slate-50 cursor-pointer border-b border-light" onclick="selOdc('${o.id}', '${o.name}')">
                                    <div class="font-bold text-slate-700">${o.name}</div>
                                    <div class="text-[10px] text-slate-500">${o.location || ''}</div>
                                </div>
                            `).join('');
                                odcResults.classList.remove('hidden');
                            }
                        });
                }, 300);
            });

            odpSearch.addEventListener('input', (e) => {
                clearTimeout(t);
                const q = e.target.value.trim();
                const curOdc = odcId.value;
                if (!curOdc) return;
                t = setTimeout(() => {
                    fetch(\`/api/ftth/odp/search?q=\${encodeURIComponent(q)}&odc_id=\${curOdc}\`)
                    .then(r => r.json())
                    .then(data => {
                        if(data.results && data.results.length) {
                             odpResults.innerHTML = data.results.map(o => `
                        < div class= "px-4 py-2 hover:bg-slate-50 cursor-pointer border-b border-light" 
                                     onclick = "selOdp('\${o.id}', '\${o.name}', '\${o.olt_id}', '\${o.olt_name}')" >
                                    <div class="font-bold text-slate-700">\${o.odp_name}</div>
                                    <div class="text-[10px] text-slate-500">Free: \${o.available_ports} Ports</div>
                                </div >
                            `).join('');
                            odpResults.classList.remove('hidden');
                        }
                    });
             }, 300);
        });
    }

    window.selOdc = (id, name) => {
        odcSearch.value = name;
        odcId.value = id;
        odcResults.classList.add('hidden');
        odpWrapper.classList.remove('opacity-50', 'pointer-events-none');
        odpSearch.value = '';
        odpIdInput.value = '';
        odpSearch.focus();
    };

    window.selOdp = (id, name, oltIdVal, oltNameVal) => {
        odpSearch.value = name;
        odpIdInput.value = id;
        odpResults.classList.add('hidden');
        if(oltId) oltId.value = oltIdVal || '';
        if(oltDisplay) oltDisplay.value = oltNameVal || 'Auto';
    };

    if(resetOdc) {
        resetOdc.addEventListener('click', () => {
            odcSearch.value = ''; odcId.value = '';
            odpWrapper.classList.add('opacity-50', 'pointer-events-none');
        });
    }

    document.addEventListener('click', (e) => {
        if(!e.target.closest('#odc_search')) odcResults.classList.add('hidden');
        if(!e.target.closest('#odp_search')) odpResults.classList.add('hidden');
    });
});
</script>