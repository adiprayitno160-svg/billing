<div class="space-y-6">
    <!-- Header Section -->
    <div class="rounded-2xl border border-blue-200 bg-gradient-to-br from-blue-50 to-cyan-50 p-6 shadow-sm">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-blue-900">Pelanggan PPPOE Baru</h1>
                <p class="text-blue-600 mt-1">Buat akun pelanggan baru dengan koneksi PPPOE</p>
            </div>
            <a href="/customers/list"
                class="px-4 py-2 border border-blue-300 text-blue-700 rounded-lg hover:bg-blue-50 transition-all font-medium flex items-center gap-2 text-sm">
                ← Kembali
            </a>
        </div>
    </div>

    <!-- Feedback Messages -->
    <% if (typeof error !=='undefined' && error) { %>
        <div class="p-4 bg-red-50 border border-red-200 rounded-xl flex items-center shadow-sm animate-fade-in">
            <span class="p-2 bg-red-100 rounded-lg mr-3">⚠️</span>
            <div>
                <span class="text-red-800 font-bold block">Gagal Menyimpan</span>
                <span class="text-red-700 text-sm">
                    <%= error %>
                </span>
            </div>
        </div>
        <% } %>

            <% if (typeof success !=='undefined' && success) { %>
                <div
                    class="p-4 bg-green-50 border border-green-200 rounded-xl flex items-center shadow-sm animate-fade-in">
                    <span class="p-2 bg-green-100 rounded-lg mr-3">✅</span>
                    <div>
                        <span class="text-green-800 font-bold block">Berhasil</span>
                        <span class="text-green-700 text-sm">Pelanggan PPPOE berhasil dibuat!</span>
                    </div>
                </div>
                <% } %>

                    <form method="post" action="/customers/new-pppoe" id="pppoe-form" class="space-y-6">

                        <!-- ROW 1: Identity & Location -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- Basic Identity Card -->
                            <div
                                class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden lg:col-span-2">
                                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                                    <span class="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg">👤</span>
                                    <h3 class="font-bold text-slate-800">Identitas Pelanggan</h3>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-12 gap-6">
                                        <!-- ID Pelanggan -->
                                        <div class="md:col-span-3">
                                            <label class="block text-xs font-semibold text-slate-500 mb-1">ID Pelanggan
                                                (Otomatis)</label>
                                            <input name="customer_code" readonly
                                                value="<%= typeof initial_customer_code !== 'undefined' ? initial_customer_code : '' %>"
                                                class="w-full rounded-lg border border-slate-200 px-3 py-2.5 bg-slate-50 text-slate-600 text-sm font-mono cursor-not-allowed" />
                                        </div>

                                        <!-- Nama Lengkap -->
                                        <div class="md:col-span-5">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Nama Lengkap
                                                *</label>
                                            <input name="client_name" required placeholder="Nama lengkap pelanggan"
                                                class="w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 transition-all font-medium" />
                                        </div>

                                        <!-- Nomor Telepon -->
                                        <div class="md:col-span-4">
                                            <label class="block text-xs font-semibold text-slate-500 mb-1">Nomor
                                                Telepon</label>
                                            <div class="relative">
                                                <span
                                                    class="absolute inset-y-0 left-0 pl-3 flex items-center text-slate-400 text-sm">+62</span>
                                                <input name="phone_number" placeholder="8xxxxxxxxxx" type="tel"
                                                    class="w-full rounded-lg border border-slate-300 pl-12 pr-4 py-2.5 focus:ring-2 focus:ring-indigo-100 font-mono" />
                                            </div>
                                        </div>

                                        <!-- Alamat (Full Width) -->
                                        <div class="md:col-span-12">
                                            <label class="block text-sm font-semibold text-slate-700 mb-1">Alamat
                                                Pemasangan</label>
                                            <div class="relative">
                                                <i
                                                    class="fas fa-map-marker-alt absolute top-3 left-3 text-slate-400"></i>
                                                <textarea name="address"
                                                    placeholder="Detail alamat lengkap (RT/RW, Jalan, Blok, Nomor Rumah, Kelurahan, Kecamatan)..."
                                                    class="w-full rounded-lg border border-slate-300 pl-10 pr-4 py-2.5 focus:ring-2 focus:ring-indigo-100 min-h-[80px]"
                                                    rows="2"></textarea>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Location & Maps Card -->
                            <div
                                class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden col-span-1 lg:col-span-2">
                                <div
                                    class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center justify-between">
                                    <div class="flex items-center gap-2">
                                        <span class="p-1.5 bg-green-100 text-green-600 rounded-lg">📍</span>
                                        <h3 class="font-bold text-slate-800">Lokasi & Maps (Opsional)</h3>
                                    </div>
                                    <button type="button" id="btnGetLocation"
                                        class="text-xs px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all flex items-center gap-1">
                                        <span>📍</span> Ambil Lokasi GPS
                                    </button>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                                        <!-- Left: Inputs -->
                                        <div class="lg:col-span-1 space-y-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-slate-700 mb-1">Latitude</label>
                                                <input name="latitude" id="latitude" placeholder="-6.xxxx"
                                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-100 font-mono" />
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-slate-700 mb-1">Longitude</label>
                                                <input name="longitude" id="longitude" placeholder="106.xxxx"
                                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-green-100 font-mono" />
                                            </div>

                                            <div class="p-3 bg-blue-50 border border-blue-100 rounded-lg">
                                                <p class="text-[11px] text-blue-700 leading-relaxed">
                                                    <strong>Panduan:</strong><br>
                                                    1. Klik tombol "Ambil Lokasi GPS" saat berada di rumah
                                                    pelanggan.<br>
                                                    2. Atau klik lokasi pada peta di sebelah kanan.<br>
                                                    3. Geser pin merah untuk penyesuaian akurat.
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Right: Map -->
                                        <div class="lg:col-span-2">
                                            <div
                                                class="w-full h-[300px] lg:h-full min-h-[300px] bg-slate-100 rounded-lg border border-slate-200 overflow-hidden relative z-0">
                                                <div id="map" class="w-full h-full z-0"
                                                    style="min-height: 300px; height: 100%; width: 100%;"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ROW 2: PPPoE & Package -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- PPPoE Credentials Card -->
                            <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
                                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                                    <span class="p-1.5 bg-blue-100 text-blue-600 rounded-lg">🔐</span>
                                    <h3 class="font-bold text-slate-800">Kredensial PPPOE</h3>
                                </div>
                                <div class="p-6 space-y-4">
                                    <div class="relative">
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Username PPPOE
                                            *</label>
                                        <div class="flex gap-2">
                                            <div class="relative flex-1">
                                                <input type="text" name="username" id="pppoe_search" autocomplete="off"
                                                    value="<%= typeof initial_customer_code !== 'undefined' ? initial_customer_code + '.net' : '' %>"
                                                    placeholder="Username MikroTik..." required
                                                    class="w-full rounded-lg border border-slate-300 px-4 py-2.5 focus:ring-2 focus:ring-blue-100 font-medium text-blue-700">
                                                <div id="pppoe_search_results"
                                                    class="absolute z-10 w-full mt-1 bg-white border border-slate-200 shadow-xl rounded-lg max-h-48 overflow-y-auto hidden">
                                                </div>
                                            </div>
                                            <button type="button" id="reload_secrets_btn"
                                                class="px-3 bg-slate-50 border border-slate-200 rounded-lg text-slate-500 hover:bg-slate-100">🔄</button>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Password PPPOE
                                            *</label>
                                        <div class="flex gap-2">
                                            <input name="password" id="pppoe_password" type="text" required
                                                placeholder="Pasword koneksi"
                                                class="flex-1 rounded-lg border border-slate-300 px-4 py-2.5 focus:ring-2 focus:ring-blue-100 font-mono" />
                                            <button type="button" onclick="generatePassword()"
                                                class="px-3 bg-blue-50 text-blue-600 border border-blue-200 rounded-lg text-sm font-bold">Generated</button>
                                        </div>
                                    </div>

                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Paket Layanan
                                            *</label>
                                        <select name="package_id" required
                                            class="w-full rounded-lg border border-slate-300 px-4 py-2.5 bg-white font-medium">
                                            <option value="">-- Pilih Paket PPPoE --</option>
                                            <% (packages || []).forEach(function(pkg){ %>
                                                <option value="<%= pkg.id %>">
                                                    <%= pkg.name %> (<%= pkg.price.toLocaleString('id-ID') %>)
                                                </option>
                                                <% }) %>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Billing & Status Card -->
                            <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
                                <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                                    <span class="p-1.5 bg-purple-100 text-purple-600 rounded-lg">💳</span>
                                    <h3 class="font-bold text-slate-800">Sistem Pembayaran</h3>
                                </div>
                                <div class="p-6 space-y-4">
                                    <div>
                                        <label class="block text-sm font-semibold text-slate-700 mb-1">Mode
                                            Pembayaran</label>
                                        <select name="billing_mode" id="billing_mode"
                                            class="w-full rounded-lg border border-slate-300 px-4 py-2.5 bg-white font-medium">
                                            <option value="postpaid" selected>📅 Pascabayar (Bulanan)</option>
                                            <option value="prepaid">💰 Prabayar (Sistem Voucher)</option>
                                        </select>
                                    </div>

                                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-2">
                                        <label
                                            class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                            <input type="checkbox" name="is_taxable" value="1"
                                                class="w-5 h-5 text-purple-600 rounded border-gray-300">
                                            <div>
                                                <span class="block text-sm font-bold text-slate-700">Kena PPN</span>
                                                <span class="block text-xs text-slate-500">Harga + Pajak</span>
                                            </div>
                                        </label>

                                        <label
                                            class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-slate-50 transition-colors">
                                            <input type="checkbox" name="use_device_rental" id="use_device_rental"
                                                value="1" class="w-5 h-5 text-purple-600 rounded border-gray-300">
                                            <div>
                                                <span class="block text-sm font-bold text-slate-700">Sewa Alat</span>
                                                <span class="block text-xs text-slate-500">Biaya sewa ONT/STB</span>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Infrastructure Card (Full Width) -->
                        <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
                            <div class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center gap-2">
                                <span class="p-1.5 bg-cyan-100 text-cyan-600 rounded-lg">🏗️</span>
                                <h3 class="font-bold text-slate-800">Infrastruktur FTTH</h3>
                            </div>
                            <div class="p-6 space-y-6">
                                <!-- Wireless Switcher -->
                                <div class="flex items-center gap-4 p-4 bg-cyan-50 border border-cyan-100 rounded-lg">
                                    <input type="checkbox" id="is_wireless"
                                        class="w-6 h-6 text-cyan-600 border-gray-300 rounded focus:ring-cyan-500">
                                    <div>
                                        <span class="font-bold text-cyan-900 block">Koneksi Wireless / Tanpa Jalur
                                            ODP</span>
                                        <span class="text-xs text-cyan-700">Aktifkan ini jika pelanggan tidak
                                            menggunakan infrastruktur kabel fiber (langsung ke BTS/PTP)</span>
                                    </div>
                                </div>

                                <!-- ODC/ODP Hierarchical -->
                                <div id="infra_wrapper"
                                    class="grid grid-cols-1 md:grid-cols-2 gap-6 transition-all duration-300">
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-1">1. Cari ODC
                                            Cabinet</label>
                                        <div class="flex gap-2">
                                            <div class="relative flex-1">
                                                <input type="text" id="odc_search" placeholder="Type ODC Name..."
                                                    class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-200 transition-all font-medium"
                                                    autocomplete="off">
                                                <input type="hidden" name="odc_id" id="odc_id">
                                                <div id="odc_search_results"
                                                    class="absolute z-20 w-full mt-1 bg-white border border-slate-200 shadow-xl rounded-lg max-h-48 overflow-y-auto hidden">
                                                </div>
                                            </div>
                                            <button type="button" id="reset_odc_btn"
                                                class="px-3 border border-slate-300 rounded-lg text-slate-400">✕</button>
                                        </div>
                                    </div>
                                    <div id="odp_section_wrapper"
                                        class="opacity-50 pointer-events-none grayscale transition-all duration-300">
                                        <label class="block text-sm font-bold text-slate-700 mb-1">2. Pilih ODP
                                            (Filtered by ODC)</label>
                                        <div class="relative">
                                            <input type="text" id="odp_search"
                                                placeholder="Select ODP from above ODC..."
                                                class="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-cyan-200 transition-all font-medium"
                                                autocomplete="off">
                                            <input type="hidden" name="odp_id" id="odp_id" required>
                                            <div id="odp_search_results"
                                                class="absolute z-20 w-full mt-1 bg-white border border-slate-200 shadow-xl rounded-lg max-h-48 overflow-y-auto hidden">
                                            </div>
                                        </div>
                                        <p class="text-[10px] text-cyan-600 mt-1 pl-1" id="odp_info">Pilih ODC terlebih
                                            dahulu.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="flex items-center justify-end gap-3 pt-6">
                            <a href="/customers/list"
                                class="px-6 py-3 border border-slate-300 text-slate-600 font-medium rounded-xl hover:bg-slate-50">Batal</a>
                            <button type="submit"
                                class="px-8 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-0.5">
                                🚀 Aktifkan Pelanggan
                            </button>
                        </div>
                    </form>
</div>

<!-- Scripts Section -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- Identity ---
        window.generatePassword = function () {
            const pass = Math.random().toString(36).slice(-8);
            document.getElementById('pppoe_password').value = pass;
        };

        // --- Wireless vs FTTH ---
        const isWireless = document.getElementById('is_wireless');
        const infraWrapper = document.getElementById('infra_wrapper');
        const odpInput = document.getElementById('odp_id');

        function updateWirelessUI() {
            if (isWireless.checked) {
                infraWrapper.classList.add('opacity-40', 'pointer-events-none', 'grayscale');
                if (odpInput) odpInput.required = false;
            } else {
                infraWrapper.classList.remove('opacity-40', 'pointer-events-none', 'grayscale');
                if (odpInput) odpInput.required = true;
            }
        }
        isWireless.addEventListener('change', updateWirelessUI);

        // --- ODC & ODP Search ---
        const odcSearch = document.getElementById('odc_search');
        const odcIdInput = document.getElementById('odc_id');
        const odcResults = document.getElementById('odc_search_results');
        const odpWrapper = document.getElementById('odp_section_wrapper');
        const odpSearch = document.getElementById('odp_search');
        const odpIdInput = document.getElementById('odp_id');
        const odpResults = document.getElementById('odp_search_results');
        const resetOdc = document.getElementById('reset_odc_btn');

        let t;
        odcSearch.addEventListener('input', (e) => {
            clearTimeout(t);
            const q = e.target.value.trim();
            odcIdInput.value = '';
            odpWrapper.classList.add('opacity-50', 'pointer-events-none');
            if (q.length < 2) { odcResults.classList.add('hidden'); return; }
            t = setTimeout(() => {
                fetch('/api/ftth/odc/search?q=' + q)
                    .then(r => r.json())
                    .then(data => {
                        if (data.results.length) {
                            odcResults.innerHTML = data.results.map(o => `
                            <div class="p-3 hover:bg-slate-50 cursor-pointer border-b" onclick="selOdc('${o.id}','${o.name}')">
                                <div class="font-bold text-slate-800">${o.name}</div>
                                <div class="text-[10px] text-slate-500">${o.location || ''}</div>
                            </div>
                        `).join('');
                            odcResults.classList.remove('hidden');
                        }
                    });
            }, 300);
        });

        window.selOdc = (id, name) => {
            odcIdInput.value = id;
            odcSearch.value = name;
            odcResults.classList.add('hidden');
            odpWrapper.classList.remove('opacity-50', 'pointer-events-none', 'grayscale');
            odpSearch.focus();
            odpSearch.value = '';
            odpIdInput.value = '';
        };

        odpSearch.addEventListener('input', (e) => {
            const odcId = odcIdInput.value;
            if (!odcId) return;
            clearTimeout(t);
            const q = e.target.value.trim();
            t = setTimeout(() => {
                fetch(`/api/ftth/odp/search?q=${q}&odc_id=${odcId}`)
                    .then(r => r.json())
                    .then(data => {
                        if (data.results.length) {
                            odpResults.innerHTML = data.results.map(o => `
                            <div class="p-3 hover:bg-slate-50 cursor-pointer border-b" onclick="selOdp('${o.id}','${o.name}')">
                                <div class="font-bold text-slate-800">${o.odp_name}</div>
                                <div class="text-[10px] text-slate-500">${o.available_ports} Ports Free</div>
                            </div>
                        `).join('');
                            odpResults.classList.remove('hidden');
                        }
                    });
            }, 300);
        });

        window.selOdp = (id, name) => {
            odpIdInput.value = id;
            odpSearch.value = name;
            odpResults.classList.add('hidden');
        };

        resetOdc.addEventListener('click', () => {
            odcSearch.value = '';
            odcIdInput.value = '';
            odpWrapper.classList.add('opacity-50', 'pointer-events-none');
        });

        // Close on click outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#odc_search')) odcResults.classList.add('hidden');
            if (!e.target.closest('#odp_search')) odpResults.classList.add('hidden');
        });

        // === Maps & Get Location ===
        const btnGetLocation = document.getElementById('btnGetLocation');
        const latInput = document.getElementById('latitude');
        const lngInput = document.getElementById('longitude');

        // Check if map container exists
        if (document.getElementById('map')) {
            // Safety check for Leaflet
            if (typeof L === 'undefined') {
                console.error('Leaflet JS (Map) not loaded. Check internet connection or CDN.');
                return;
            }

            try {
                console.log('Initializing Leaflet Map...');
                // Default center (Indonesia -> Jakarta approx, or user's current value)
                let defaultLat = -6.200000;
                let defaultLng = 106.816666;
                let initialZoom = 5;

                // Init Map
                const map = L.map('map').setView([defaultLat, defaultLng], initialZoom);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                let marker;

                // Function to set marker
                function setMarker(lat, lng) {
                    if (marker) {
                        marker.setLatLng([lat, lng]);
                    } else {
                        marker = L.marker([lat, lng], { draggable: true }).addTo(map);

                        // Drag event
                        marker.on('dragend', function (e) {
                            const position = e.target.getLatLng();
                            latInput.value = position.lat.toFixed(6);
                            lngInput.value = position.lng.toFixed(6);
                        });
                    }
                    // Automatically zoom in when location is found/set
                    if (map.getZoom() < 12) map.setZoom(15);
                    map.panTo([lat, lng]);
                }

                // Map click event
                map.on('click', function (e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;

                    latInput.value = lat.toFixed(6);
                    lngInput.value = lng.toFixed(6);

                    setMarker(lat, lng);
                });

                // Input change event (manual typing)
                [latInput, lngInput].forEach(input => {
                    input.addEventListener('change', () => {
                        const lat = parseFloat(latInput.value);
                        const lng = parseFloat(lngInput.value);
                        if (!isNaN(lat) && !isNaN(lng)) {
                            setMarker(lat, lng);
                        }
                    });
                });

                // Get Location Button
                if (btnGetLocation) {
                    btnGetLocation.addEventListener('click', () => {
                        btnGetLocation.textContent = '⌛ Mencari...';
                        if ("geolocation" in navigator) {
                            navigator.geolocation.getCurrentPosition((pos) => {
                                const lat = pos.coords.latitude;
                                const lng = pos.coords.longitude;

                                latInput.value = lat.toFixed(6);
                                lngInput.value = lng.toFixed(6);

                                setMarker(lat, lng);

                                btnGetLocation.innerHTML = '<span>✅</span> Lokasi Didapat';
                                setTimeout(() => btnGetLocation.innerHTML = '<span>📍</span> Ambil Lokasi GPS', 2000);
                            }, (err) => {
                                alert('Gagal mengambil lokasi: ' + err.message);
                                btnGetLocation.textContent = '❌ Gagal';
                            });
                        } else {
                            alert('Geolocation tidak didukung browser ini.');
                        }
                    });
                }

                // Resolve rendering issues (map hidden/shown in tabs or just loaded)
                setTimeout(() => { map.invalidateSize(); }, 200);
            } catch (err) {
                console.error('Error initializing map:', err);
            }
        }
    });
</script>