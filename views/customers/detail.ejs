<div class="space-y-6">
	<!-- Header Section -->
	<div
		class="rounded-2xl border border-modern-blue-200 bg-gradient-to-br from-modern-blue-50 to-modern-cyan-50 p-6 shadow-lg">
		<div class="flex items-center justify-between">
			<div>
				<h1 class="text-2xl font-bold text-modern-blue-900">Detail Pelanggan</h1>
				<p class="text-modern-blue-600 mt-1">Informasi lengkap pelanggan sistem billing</p>
			</div>
			<div class="flex items-center gap-3">
				<a href="/customers/list"
					class="px-4 py-2 border border-modern-blue-300 text-modern-blue-700 rounded-lg hover:bg-modern-blue-50 transition-all duration-300 font-medium">
					← Kembali ke Daftar
				</a>
				<a href="/customers/<%= customer.id %>/edit"
					class="px-4 py-2 bg-gradient-to-r from-modern-blue-500 to-modern-cyan-500 text-white rounded-lg hover:from-modern-blue-600 hover:to-modern-cyan-600 transition-all duration-300 font-medium shadow-lg">
					✏️ Edit
				</a>
			</div>
		</div>
	</div>

	<!-- Customer Info -->
	<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
		<!-- Main Info -->
		<div class="lg:col-span-2 space-y-6">
			<!-- Basic Information -->
			<div
				class="rounded-2xl border border-modern-purple-200 bg-gradient-to-br from-white to-modern-purple-50/30 p-6 shadow-lg">
				<h2 class="text-lg font-bold text-modern-purple-900 mb-4">Informasi Dasar</h2>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						<label class="block text-sm font-medium text-modern-purple-600 mb-1">Kode Pelanggan</label>
						<div class="text-lg font-semibold text-modern-purple-800">
							<%= customer.customer_code || '-' %>
						</div>
					</div>
					<div>
						<label class="block text-sm font-medium text-modern-purple-600 mb-1">Nama Lengkap</label>
						<div class="text-lg font-semibold text-modern-purple-800">
							<%= customer.name %>
						</div>
					</div>
					<div>
						<label class="block text-sm font-medium text-modern-purple-600 mb-1">Email</label>
						<div class="text-lg text-modern-purple-700">
							<%= customer.email || '-' %>
						</div>
					</div>
					<div>
						<label class="block text-sm font-medium text-modern-purple-600 mb-1">Nomor Telepon</label>
						<div class="text-lg text-modern-purple-700">
							<%= customer.phone || '-' %>
						</div>
					</div>
					<div>
						<label class="block text-sm font-medium text-modern-purple-600 mb-1">Status</label>
						<span
							class="inline-flex items-center rounded-full px-3 py-1 text-xs <%= customer.status === 'active' ? 'bg-modern-green-100 text-modern-green-700' : 'bg-modern-red-100 text-modern-red-700' %>">
							<%= customer.status==='active' ? 'Aktif' : 'Tidak Aktif' %>
						</span>
					</div>
				</div>
			</div>

			<!-- Connection Information -->
			<div
				class="rounded-2xl border border-modern-blue-200 bg-gradient-to-br from-white to-modern-blue-50/30 p-6 shadow-lg">
				<h2 class="text-lg font-bold text-modern-blue-900 mb-4">Informasi Koneksi</h2>
				<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
					<div>
						<label class="block text-sm font-medium text-modern-blue-600 mb-1">Jenis Koneksi</label>
						<span
							class="inline-flex items-center rounded-full px-3 py-1 text-xs <%= customer.connection_type === 'pppoe' ? 'bg-modern-blue-100 text-modern-blue-700' : 'bg-modern-green-100 text-modern-green-700' %>">
							<%= customer.connection_type==='pppoe' ? 'PPPOE' : 'IP Static' %>
						</span>
					</div>
					<% if (customer.pppoe_username) { %>
						<div>
							<label class="block text-sm font-medium text-modern-blue-600 mb-1">Username PPPOE</label>
							<div class="text-lg text-modern-blue-700">
								<%= customer.pppoe_username %>
							</div>
						</div>
						<% } %>
							<% if (customer.pppoe_profile_id) { %>
								<div>
									<label class="block text-sm font-medium text-modern-blue-600 mb-1">Profile
										ID</label>
									<div class="text-lg text-modern-blue-700">
										<%= customer.pppoe_profile_id %>
									</div>
								</div>
								<% } %>
									<% if (customer.connection_type==='static_ip' && customer.static_ip_address) { %>
										<div>
											<label class="block text-sm font-medium text-modern-blue-600 mb-1">IP
												Address</label>
											<div class="text-lg text-modern-blue-700 font-mono">
												<%= customer.static_ip_address %>
											</div>
										</div>
										<% if (customer.static_ip_interface) { %>
											<div>
												<label
													class="block text-sm font-medium text-modern-blue-600 mb-1">Interface</label>
												<div class="text-lg text-modern-blue-700">
													<%= customer.static_ip_interface %>
												</div>
											</div>
											<% } %>
												<% } %>
				</div>
			</div>

			<!-- Package Information -->
			<% if ((customer.pppoe_package && customer.connection_type==='pppoe' ) || (customer.static_ip_package &&
				customer.connection_type==='static_ip' )) { %>
				<div
					class="rounded-2xl border border-modern-yellow-200 bg-gradient-to-br from-white to-modern-yellow-50/30 p-6 shadow-lg">
					<h2 class="text-lg font-bold text-modern-yellow-900 mb-4">Informasi Paket</h2>
					<% if (customer.connection_type==='pppoe' && customer.pppoe_package) { %>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
							<div>
								<label class="block text-sm font-medium text-modern-yellow-600 mb-1">Nama Paket</label>
								<div class="text-lg font-semibold text-modern-yellow-800">
									<%= customer.pppoe_package.name %>
								</div>
							</div>
							<div>
								<label class="block text-sm font-medium text-modern-yellow-600 mb-1">Harga</label>
								<div class="text-lg font-semibold text-modern-yellow-800">Rp <%=
										parseFloat(customer.pppoe_package.price || 0).toLocaleString('id-ID') %>
								</div>
							</div>
							<% if (customer.pppoe_package.rate_limit_rx && customer.pppoe_package.rate_limit_tx) { %>
								<div>
									<label class="block text-sm font-medium text-modern-yellow-600 mb-1">Download
										Limit</label>
									<div class="text-lg text-modern-yellow-700">
										<%= customer.pppoe_package.rate_limit_rx %>
									</div>
								</div>
								<div>
									<label class="block text-sm font-medium text-modern-yellow-600 mb-1">Upload
										Limit</label>
									<div class="text-lg text-modern-yellow-700">
										<%= customer.pppoe_package.rate_limit_tx %>
									</div>
								</div>
								<% } %>
									<% if (customer.pppoe_package.description) { %>
										<div class="md:col-span-2">
											<label
												class="block text-sm font-medium text-modern-yellow-600 mb-1">Deskripsi</label>
											<div class="text-sm text-modern-yellow-700">
												<%= customer.pppoe_package.description %>
											</div>
										</div>
										<% } %>
						</div>
						<% } else if (customer.connection_type==='static_ip' && customer.static_ip_package) { %>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
								<div>
									<label class="block text-sm font-medium text-modern-yellow-600 mb-1">Nama
										Paket</label>
									<div class="text-lg font-semibold text-modern-yellow-800">
										<%= customer.static_ip_package.package_name || customer.static_ip_package.name
											|| '-' %>
									</div>
								</div>
								<div>
									<label class="block text-sm font-medium text-modern-yellow-600 mb-1">Harga</label>
									<div class="text-lg font-semibold text-modern-yellow-800">Rp <%=
											parseFloat(customer.static_ip_package.price || 0).toLocaleString('id-ID') %>
									</div>
								</div>
								<% if (customer.static_ip_package.max_limit_download) { %>
									<div>
										<label class="block text-sm font-medium text-modern-yellow-600 mb-1">Download
											Limit</label>
										<div class="text-lg text-modern-yellow-700">
											<%= customer.static_ip_package.max_limit_download %>
										</div>
									</div>
									<% } %>
										<% if (customer.static_ip_package.max_limit_upload) { %>
											<div>
												<label
													class="block text-sm font-medium text-modern-yellow-600 mb-1">Upload
													Limit</label>
												<div class="text-lg text-modern-yellow-700">
													<%= customer.static_ip_package.max_limit_upload %>
												</div>
											</div>
											<% } %>
												<% if (customer.static_ip_package.parent_download_name) { %>
													<div>
														<label
															class="block text-sm font-medium text-modern-yellow-600 mb-1">Parent
															Download</label>
														<div class="text-lg text-modern-yellow-700">
															<%= customer.static_ip_package.parent_download_name %>
														</div>
													</div>
													<% } %>
														<% if (customer.static_ip_package.parent_upload_name) { %>
															<div>
																<label
																	class="block text-sm font-medium text-modern-yellow-600 mb-1">Parent
																	Upload</label>
																<div class="text-lg text-modern-yellow-700">
																	<%= customer.static_ip_package.parent_upload_name %>
																</div>
															</div>
															<% } %>
																<% if (customer.static_ip_package.description) { %>
																	<div class="md:col-span-2">
																		<label
																			class="block text-sm font-medium text-modern-yellow-600 mb-1">Deskripsi</label>
																		<div class="text-sm text-modern-yellow-700">
																			<%= customer.static_ip_package.description
																				%>
																		</div>
																	</div>
																	<% } %>
							</div>
							<% } %>
				</div>
				<% } %>

					<!-- ONT / Device Status (GenieACS) -->
					<% if (typeof deviceDetails !=='undefined' && deviceDetails) { %>
						<div
							class="rounded-2xl border border-modern-blue-200 bg-gradient-to-br from-white to-modern-blue-50/30 p-6 shadow-lg">
							<div class="flex items-center justify-between mb-4">
								<h2 class="text-lg font-bold text-modern-blue-900">Status ONT / Perangkat</h2>
								<span
									class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium <%= deviceDetails.online ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800' %>">
									<span
										class="mr-1 h-2 w-2 rounded-full <%= deviceDetails.online ? 'bg-green-500' : 'bg-red-500' %> animate-pulse"></span>
									<%= deviceDetails.online ? 'Online' : 'Offline' %>
								</span>
							</div>

							<div class="grid grid-cols-1 md:grid-cols-3 gap-6">
								<!-- Signal Info -->
								<div class="space-y-3">
									<h3 class="text-xs font-bold text-modern-blue-400 uppercase tracking-wider">
										Informasi Sinyal</h3>
									<div class="flex justify-between items-center text-sm">
										<span class="text-modern-blue-600">RX Power:</span>
										<span
											class="font-mono font-bold <%= parseFloat(deviceDetails.signal.rxPower) < -27 ? 'text-red-600' : 'text-modern-blue-800' %>">
											<%= deviceDetails.signal.rxPower %> dBm
										</span>
									</div>
									<div class="flex justify-between items-center text-sm">
										<span class="text-modern-blue-600">TX Power:</span>
										<span class="font-mono text-modern-blue-800">
											<%= deviceDetails.signal.txPower %> dBm
										</span>
									</div>
									<div class="flex justify-between items-center text-sm">
										<span class="text-modern-blue-600">Suhu:</span>
										<span class="text-modern-blue-800">
											<%= deviceDetails.signal.temperature %> °C
										</span>
									</div>
								</div>

								<!-- Connection Info -->
								<div class="space-y-3 border-l border-modern-blue-100 pl-6">
									<h3 class="text-xs font-bold text-modern-blue-400 uppercase tracking-wider">Koneksi
										WAN</h3>
									<div class="flex justify-between items-center text-sm">
										<span class="text-modern-blue-600">Mode:</span>
										<span class="font-bold text-modern-blue-800">
											<%= deviceDetails.wan.mode %>
										</span>
									</div>
									<div class="flex justify-between items-center text-sm">
										<span class="text-modern-blue-600">VLAN:</span>
										<span class="text-modern-blue-800">
											<%= deviceDetails.wan.vlan %>
										</span>
									</div>
									<div class="flex justify-between items-center text-sm">
										<span class="text-modern-blue-600">IP WAN:</span>
										<span class="font-mono text-modern-blue-800">
											<%= deviceDetails.wan.ip %>
										</span>
									</div>
								</div>

								<!-- WiFi Info -->
								<div class="space-y-3 border-l border-modern-blue-100 pl-6">
									<h3 class="text-xs font-bold text-modern-blue-400 uppercase tracking-wider">WiFi
										Status</h3>
									<div class="flex justify-between items-center text-sm">
										<span class="text-modern-blue-600">SSID:</span>
										<span class="font-bold text-modern-blue-800">
											<%= deviceDetails.wifi.ssid %>
										</span>
									</div>
									<div class="flex justify-between items-center text-sm">
										<span class="text-modern-blue-600">Password:</span>
										<div class="flex items-center gap-2">
											<span class="font-mono text-modern-blue-800 password-masked">••••••••</span>
											<span class="font-mono text-modern-blue-800 hidden password-text">
												<%= deviceDetails.wifi.password %>
											</span>
											<button onclick="togglePassword(this)"
												class="text-modern-blue-400 hover:text-modern-blue-600">
												<svg class="h-4 w-4" fill="none" stroke="currentColor"
													viewBox="0 0 24 24">
													<path stroke-linecap="round" stroke-linejoin="round"
														stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
													<path stroke-linecap="round" stroke-linejoin="round"
														stroke-width="2"
														d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
												</svg>
											</button>
										</div>
									</div>
									<div class="flex justify-between items-center text-sm">
										<span class="text-modern-blue-600">Active Clients:</span>
										<span class="font-bold text-emerald-600">
											<%= deviceDetails.signal.wifiClients %> Perangkat
										</span>
									</div>
								</div>
							</div>

							<div class="mt-6 pt-4 border-t border-modern-blue-100 flex gap-3">
								<button onclick="refreshONT('<%= deviceDetails.id %>')"
									class="flex items-center gap-2 text-xs font-bold text-modern-blue-600 hover:text-modern-blue-800 bg-modern-blue-100 px-3 py-1.5 rounded-lg transition-all">
									🔄 Refresh Data
								</button>
								<button onclick="rebootONT('<%= deviceDetails.id %>')"
									class="flex items-center gap-2 text-xs font-bold text-modern-red-600 hover:text-modern-red-800 bg-modern-red-100 px-3 py-1.5 rounded-lg transition-all">
									🔌 Reboot ONT
								</button>
							</div>
						</div>
						<% } %>

							<!-- Address Information -->
							<% if (customer.address) { %>
								<div
									class="rounded-2xl border border-modern-orange-200 bg-gradient-to-br from-white to-modern-orange-50/30 p-6 shadow-lg">
									<h2 class="text-lg font-bold text-modern-orange-900 mb-4">Alamat</h2>
									<div class="text-lg text-modern-orange-800">
										<%= customer.address %>
									</div>
								</div>
								<% } %>

		</div>

		<!-- Sidebar -->
		<div class="space-y-6">
			<!-- Quick Actions -->
			<div
				class="rounded-2xl border border-modern-purple-200 bg-gradient-to-br from-white to-modern-purple-50/30 p-6 shadow-lg">
				<h3 class="text-lg font-bold text-modern-purple-900 mb-4">Aksi Cepat</h3>
				<div class="space-y-3">
					<a href="/customers/<%= customer.id %>/edit"
						class="w-full flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-modern-green-500 to-modern-emerald-500 text-white rounded-lg hover:from-modern-green-600 hover:to-modern-emerald-600 transition-all duration-300 font-medium shadow-lg">
						<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
							<path
								d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" />
						</svg>
						Edit Pelanggan
					</a>
					<button onclick="deleteCustomer(<%= customer.id %>, '<%= customer.name %>')"
						class="w-full flex items-center gap-3 px-4 py-3 bg-gradient-to-r from-modern-red-500 to-modern-pink-500 text-white rounded-lg hover:from-modern-red-600 hover:to-modern-pink-600 transition-all duration-300 font-medium shadow-lg">
						<svg class="h-4 w-4" fill="currentColor" viewBox="0 0 20 20">
							<path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd" />
							<path fill-rule="evenodd"
								d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z"
								clip-rule="evenodd" />
						</svg>
						Hapus Pelanggan
					</button>
				</div>
			</div>

			<!-- Customer Stats -->
			<div
				class="rounded-2xl border border-modern-cyan-200 bg-gradient-to-br from-white to-modern-cyan-50/30 p-6 shadow-lg">
				<h3 class="text-lg font-bold text-modern-cyan-900 mb-4">Statistik</h3>
				<div class="space-y-3">
					<div class="flex justify-between items-center">
						<span class="text-sm text-modern-cyan-600">Tanggal Daftar</span>
						<span class="text-sm font-medium text-modern-cyan-800">
							<%= new Date(customer.created_at).toLocaleDateString('id-ID') %>
						</span>
					</div>
					<div class="flex justify-between items-center">
						<span class="text-sm text-modern-cyan-600">Terakhir Diupdate</span>
						<span class="text-sm font-medium text-modern-cyan-800">
							<%= new Date(customer.updated_at).toLocaleDateString('id-ID') %>
						</span>
					</div>
					<div class="flex justify-between items-center">
						<span class="text-sm text-modern-cyan-600">ODP</span>
						<span class="text-sm font-medium text-modern-cyan-800">
							<%= customer.odp_name || '-' %>
						</span>
					</div>
					<div class="flex justify-between items-center">
						<span class="text-sm text-modern-cyan-600">ODC</span>
						<span class="text-sm font-medium text-modern-cyan-800">
							<%= customer.odc_name || '-' %>
						</span>
					</div>
					<div class="flex justify-between items-center">
						<span class="text-sm text-modern-cyan-600">OLT</span>
						<span class="text-sm font-medium text-modern-cyan-800">
							<%= customer.olt_name || '-' %>
						</span>
					</div>
					<% if (customer.is_isolated) { %>
						<div class="flex justify-between items-center">
							<span class="text-sm text-modern-red-600">Status</span>
							<span class="text-sm font-medium text-modern-red-800">Terisolasi</span>
						</div>
						<% } %>
				</div>
			</div>
		</div>
	</div>

	<!-- Histori Bandwidth (12 Jam Terakhir) -->
	<div class="rounded-2xl border border-gray-200 bg-white p-6 shadow-lg">
		<div class="flex flex-wrap items-center justify-between mb-4 gap-2">
			<div>
				<h2 class="text-lg font-bold text-gray-800">📊 Histori Pemakaian Bandwidth</h2>
				<p class="text-sm text-gray-500">Data 12 jam terakhir</p>
			</div>
			<div class="flex items-center gap-3">
				<button id="refreshTrafficBtn" onclick="loadBandwidthData()"
					class="px-3 py-1.5 text-xs font-medium text-blue-600 bg-blue-100 rounded-lg hover:bg-blue-200">
					🔄 Refresh
				</button>
				<div class="flex items-center gap-3 text-xs">
					<span class="flex items-center gap-1">
						<span class="w-3 h-3 rounded-full bg-blue-500"></span> Download
					</span>
					<span class="flex items-center gap-1">
						<span class="w-3 h-3 rounded-full bg-green-500"></span> Upload
					</span>
				</div>
			</div>
		</div>

		<!-- Stats Cards - 4 Columns -->
		<div class="grid grid-cols-4 gap-3 mb-4">
			<!-- Avg Download -->
			<div class="p-3 rounded-lg bg-blue-500 text-white">
				<p class="text-xs opacity-80">⬇️ Avg Download</p>
				<p class="text-xl font-bold" id="avgDownload">0</p>
				<p class="text-xs opacity-70">Mbps</p>
			</div>
			<!-- Avg Upload -->
			<div class="p-3 rounded-lg bg-green-500 text-white">
				<p class="text-xs opacity-80">⬆️ Avg Upload</p>
				<p class="text-xl font-bold" id="avgUpload">0</p>
				<p class="text-xs opacity-70">Mbps</p>
			</div>
			<!-- Total Download -->
			<div class="p-3 rounded-lg bg-purple-500 text-white">
				<p class="text-xs opacity-80">📥 Total Download</p>
				<p class="text-xl font-bold" id="totalDownload">0 B</p>
			</div>
			<!-- Total Upload -->
			<div class="p-3 rounded-lg bg-orange-500 text-white">
				<p class="text-xs opacity-80">📤 Total Upload</p>
				<p class="text-xl font-bold" id="totalUpload">0 B</p>
			</div>
		</div>

		<!-- Chart -->
		<div class="relative bg-gray-50 rounded-lg p-3" style="height: 280px;">
			<canvas id="usageChart"></canvas>
			<div id="usageLoader" class="absolute inset-0 flex items-center justify-center bg-white/80 rounded-lg">
				<div class="text-center">
					<div class="w-8 h-8 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto">
					</div>
					<p class="mt-2 text-sm text-gray-500">Memuat data...</p>
				</div>
			</div>
		</div>
	</div>

	<!-- Location Information with Full Page Map -->
	<% if (customer.latitude && customer.longitude) { %>
		<div
			class="rounded-2xl border border-modern-green-200 bg-gradient-to-br from-white to-modern-green-50/30 p-6 shadow-lg">
			<h2 class="text-lg font-bold text-modern-green-900 mb-4">Lokasi Pelanggan</h2>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
				<div>
					<label class="block text-sm font-medium text-modern-green-600 mb-1">Latitude</label>
					<div class="text-lg font-semibold text-modern-green-800">
						<%= customer.latitude %>
					</div>
				</div>
				<div>
					<label class="block text-sm font-medium text-modern-green-600 mb-1">Longitude</label>
					<div class="text-lg font-semibold text-modern-green-800">
						<%= customer.longitude %>
					</div>
				</div>
			</div>
			<div class="mt-4">
				<div id="detailCustomerMap"
					style="height: 500px; width: 100%; border: 1px solid #bbf7d0; border-radius: 0.75rem;"
					class="rounded-lg shadow-sm bg-white"></div>
				<p class="text-xs text-modern-green-700 mt-2">Lokasi ditampilkan sesuai koordinat tersimpan (read-only).
				</p>
			</div>
		</div>
		<% } %>

			<!-- Invoices Section -->
			<% if (typeof invoices !=='undefined' && invoices && invoices.length> 0) { %>
				<div
					class="rounded-2xl border border-modern-yellow-200 bg-gradient-to-br from-white to-modern-yellow-50/30 p-6 shadow-lg">
					<h2 class="text-lg font-bold text-modern-yellow-900 mb-4">Riwayat Tagihan</h2>
					<div class="overflow-x-auto">
						<table class="min-w-full">
							<thead>
								<tr class="border-b border-modern-yellow-200">
									<th class="text-left py-3 px-4 text-modern-yellow-600 font-medium">No. Tagihan</th>
									<th class="text-left py-3 px-4 text-modern-yellow-600 font-medium">Periode</th>
									<th class="text-left py-3 px-4 text-modern-yellow-600 font-medium">Jumlah</th>
									<th class="text-left py-3 px-4 text-modern-yellow-600 font-medium">Status</th>
									<th class="text-left py-3 px-4 text-modern-yellow-600 font-medium">Tanggal</th>
								</tr>
							</thead>
							<tbody>
								<% invoices.forEach(invoice=> { %>
									<tr class="border-b border-modern-yellow-100">
										<td class="py-4 px-4 text-modern-yellow-800 font-medium">
											<%= invoice.invoice_number %>
										</td>
										<td class="py-4 px-4 text-modern-yellow-700">
											<%= invoice.period %>
										</td>
										<td class="py-4 px-4 text-modern-yellow-700">Rp <%=
												parseFloat(invoice.total_amount).toLocaleString('id-ID') %>
										</td>
										<td class="py-4 px-4">
											<span
												class="inline-flex items-center rounded-full px-3 py-1 text-xs <%= invoice.status === 'paid' ? 'bg-modern-green-100 text-modern-green-700' : invoice.status === 'overdue' ? 'bg-modern-red-100 text-modern-red-700' : 'bg-modern-yellow-100 text-modern-yellow-700' %>">
												<%= invoice.status==='paid' ? 'Lunas' : invoice.status==='overdue'
													? 'Jatuh Tempo' : 'Belum Bayar' %>
											</span>
										</td>
										<td class="py-4 px-4 text-modern-yellow-700">
											<%= new Date(invoice.created_at).toLocaleDateString('id-ID') %>
										</td>
									</tr>
									<% }) %>
							</tbody>
						</table>
					</div>
				</div>
				<% } %>
</div>

<script>
	function togglePassword(btn) {
		const parent = btn.parentElement;
		const masked = parent.querySelector('.password-masked');
		const text = parent.querySelector('.password-text');
		if (masked.classList.contains('hidden')) {
			masked.classList.remove('hidden');
			text.classList.add('hidden');
			btn.innerHTML = '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>';
		} else {
			masked.classList.add('hidden');
			text.classList.remove('hidden');
			btn.innerHTML = '<svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l18 18" /></svg>';
		}
	}

	function refreshONT(deviceId) {
		if (confirm('Refresh data ONT? Ini akan meminta GenieACS untuk mengambil parameter terbaru.')) {
			fetch(`/genieacs/devices/${encodeURIComponent(deviceId)}/refresh`, { method: 'POST' })
				.then(res => res.json())
				.then(data => {
					if (data.success) alert('Perintah refresh terkirim!');
					else alert('Gagal: ' + data.message);
				});
		}
	}

	function rebootONT(deviceId) {
		if (confirm('Yakin ingin me-reboot ONT pelanggan ini? Koneksi akan terputus sementara.')) {
			fetch(`/genieacs/devices/${encodeURIComponent(deviceId)}/reboot`, { method: 'POST' })
				.then(res => res.json())
				.then(data => {
					if (data.success) alert('Perintah reboot terkirim!');
					else alert('Gagal: ' + data.message);
				});
		}
	}

	function deleteCustomer(id, name) {
		if (confirm(`Apakah Anda yakin ingin menghapus pelanggan "${name}"?`)) {
			fetch(`/customers/${id}`, {
				method: 'DELETE',
				headers: {
					'Content-Type': 'application/json',
				}
			})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						alert('Pelanggan berhasil dihapus!');
						window.location.href = '/customers/list';
					} else {
						alert('Gagal menghapus pelanggan: ' + data.error);
					}
				})
				.catch(error => {
					console.error('Error:', error);
					alert('Terjadi kesalahan saat menghapus pelanggan');
				});
		}
	}

	// Map render (read-only) on detail page
	document.addEventListener('DOMContentLoaded', function () {
		// --- Map Stats ---
		var mapEl = document.getElementById('detailCustomerMap');
		if (mapEl) {
			if (typeof L === 'undefined') {
				console.error('Leaflet JS not loaded!');
				return;
			}
			try {
				var lat = Number('<%= customer.latitude %>');
				var lng = Number('<%= customer.longitude %>');
				if (lat && lng) {
					console.log('Initializing Detail Map:', lat, lng);
					var map = L.map('detailCustomerMap', {
						zoomControl: true,
						dragging: false,
						scrollWheelZoom: false,
						doubleClickZoom: false,
						boxZoom: false,
						keyboard: false,
						tap: false
					}).setView([lat, lng], 15);

					L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
						attribution: '© OpenStreetMap contributors',
						maxZoom: 19
					}).addTo(map);

					var marker = L.marker([lat, lng]).addTo(map);
					marker.bindPopup('<b>Lokasi Pelanggan</b>').openPopup();

					// Fix render
					setTimeout(function () {
						map.invalidateSize();
					}, 200);
				}
			} catch (e) {
				console.error('Map init error:', e);
			}
		}

		// --- Bandwidth Chart (12 Hours History) ---
		const ctx = document.getElementById('usageChart')?.getContext('2d');
		const customerId = '<%= customer.id %>';
		let usageChart = null;

		// Format bytes to human readable
		function formatBytes(bytes, decimals = 2) {
			if (!bytes || bytes === 0) return '0 B';
			const k = 1024;
			const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
			const i = Math.floor(Math.log(Math.abs(bytes)) / Math.log(k));
			return parseFloat((bytes / Math.pow(k, i)).toFixed(decimals)) + ' ' + sizes[i];
		}

		// Load bandwidth data (12 hours) with fallback to real-time
		async function loadBandwidthData() {
			const btn = document.getElementById('refreshTrafficBtn');
			if (btn) {
				btn.disabled = true;
				btn.textContent = '⏳ Loading...';
			}

			try {
				const response = await fetch(`/monitoring/usage/${customerId}/graph?hours=12`);
				const result = await response.json();

				document.getElementById('usageLoader')?.classList.add('hidden');

				if (!result.success || !result.data || !result.data.length) {
					// No historical data - try to get real-time from MikroTik
					await loadRealTimeData();
					return;
				}

				const data = result.data;

				// Calculate averages and totals
				const totalDownloadBytes = data.reduce((sum, d) => sum + (d.total_bytes_in || 0), 0);
				const totalUploadBytes = data.reduce((sum, d) => sum + (d.total_bytes_out || 0), 0);
				const avgDownload = data.reduce((sum, d) => sum + (d.avg_download_mbps || 0), 0) / data.length;
				const avgUpload = data.reduce((sum, d) => sum + (d.avg_upload_mbps || 0), 0) / data.length;

				// Update stats
				document.getElementById('avgDownload').textContent = avgDownload.toFixed(2);
				document.getElementById('avgUpload').textContent = avgUpload.toFixed(2);
				document.getElementById('totalDownload').textContent = formatBytes(totalDownloadBytes);
				document.getElementById('totalUpload').textContent = formatBytes(totalUploadBytes);

				// Prepare chart data
				const labels = data.map(d => d.time_label || '-');
				const downloadData = data.map(d => d.avg_download_mbps || 0);
				const uploadData = data.map(d => d.avg_upload_mbps || 0);

				// Create or update chart
				if (usageChart) {
					usageChart.data.labels = labels;
					usageChart.data.datasets[0].data = downloadData;
					usageChart.data.datasets[1].data = uploadData;
					usageChart.update();
				} else if (ctx) {
					usageChart = new Chart(ctx, {
						type: 'line',
						data: {
							labels: labels,
							datasets: [
								{
									label: 'Download (Mbps)',
									data: downloadData,
									borderColor: '#3b82f6',
									backgroundColor: 'rgba(59, 130, 246, 0.1)',
									fill: true,
									tension: 0.3,
									pointRadius: 2,
									borderWidth: 2
								},
								{
									label: 'Upload (Mbps)',
									data: uploadData,
									borderColor: '#10b981',
									backgroundColor: 'rgba(16, 185, 129, 0.1)',
									fill: true,
									tension: 0.3,
									pointRadius: 2,
									borderWidth: 2
								}
							]
						},
						options: {
							responsive: true,
							maintainAspectRatio: false,
							plugins: {
								legend: {
									display: true,
									position: 'top',
									labels: { font: { size: 11 } }
								},
								tooltip: {
									mode: 'index',
									intersect: false,
									callbacks: {
										label: (context) => `${context.dataset.label}: ${context.parsed.y.toFixed(2)} Mbps`
									}
								}
							},
							scales: {
								x: {
									grid: { display: false },
									ticks: { maxRotation: 45, autoSkip: true, maxTicksLimit: 12, font: { size: 10 } }
								},
								y: {
									beginAtZero: true,
									grid: { color: '#f1f5f9' },
									ticks: {
										font: { size: 10 },
										callback: (value) => value.toFixed(1)
									},
									title: { display: true, text: 'Mbps', font: { size: 10 } }
								}
							}
						}
					});
				}
			} catch (error) {
				console.error('Error loading bandwidth data:', error);
				document.getElementById('usageLoader').innerHTML = '<p class="text-red-500 text-sm">Gagal memuat data</p>';
			} finally {
				if (btn) {
					btn.disabled = false;
					btn.textContent = '🔄 Refresh';
				}
			}

			// Load real-time data as fallback
			async function loadRealTimeData() {
				try {
					const response = await fetch(`/api/mikrotik/customer/${customerId}/traffic`);
					const result = await response.json();

					if (result.success && result.data) {
						const data = result.data;

						// Update stats with real-time values
						document.getElementById('avgDownload').textContent = (data.downloadMbps || 0).toFixed(2);
						document.getElementById('avgUpload').textContent = (data.uploadMbps || 0).toFixed(2);
						document.getElementById('totalDownload').textContent = formatBytes(data.bytesIn || 0);
						document.getElementById('totalUpload').textContent = formatBytes(data.bytesOut || 0);

						if (ctx) {
							if (usageChart) {
								usageChart.destroy();
								usageChart = null;
							}

							// Show simple message instead of empty chart
							ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
							ctx.font = '14px Inter';
							ctx.fillStyle = '#64748b';
							ctx.textAlign = 'center';
							ctx.fillText('📡 Menampilkan data Real-time (Belum ada histori)', ctx.canvas.width / 2, ctx.canvas.height / 2 - 10);
							ctx.font = '12px Inter';
							ctx.fillStyle = '#94a3b8';
							ctx.fillText('Data histori akan muncul setelah penjadwalan berjalan', ctx.canvas.width / 2, ctx.canvas.height / 2 + 15);
						}
					} else {
						throw new Error('No real-time data');
					}
				} catch (error) {
					console.error('Error fetching real-time fallback:', error);
					// Clear stats
					document.getElementById('avgDownload').textContent = '0';
					document.getElementById('avgUpload').textContent = '0';
					document.getElementById('totalDownload').textContent = '0 B';
					document.getElementById('totalUpload').textContent = '0 B';

					if (ctx) {
						ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
						ctx.font = '14px Inter';
						ctx.fillStyle = '#94a3b8';
						ctx.textAlign = 'center';
						ctx.fillText('Tidak ada data histori & offline', ctx.canvas.width / 2, ctx.canvas.height / 2);
					}
				}
			}

			// Load data on page load
			loadBandwidthData();
		});
</script>