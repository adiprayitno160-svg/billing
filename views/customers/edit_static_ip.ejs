<div class="rounded border border-slate-200 bg-white p-4">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Edit Pelanggan IP Static</h2>
        <a href="/packages/static-ip/clients"
            class="px-3 py-1.5 rounded border border-slate-300 text-slate-700 hover:bg-slate-50">
            ← Kembali
        </a>
    </div>

    <% if (error && error.length> 0) { %>
        <div class="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded">
            <%= error[0] %>
        </div>
        <% } %>

            <% if (success && success.length> 0) { %>
                <div class="mb-4 p-3 bg-green-100 border border-green-300 text-green-700 rounded">
                    <%= success[0] %>
                </div>
                <% } %>

                    <!-- Informasi Paket -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
                        <h3 class="font-medium text-blue-700 mb-2">ℹ️ Informasi Paket</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-600">
                            <div><span class="font-medium">Nama Paket:</span>
                                <%= package.name %>
                            </div>
                            <div><span class="font-medium">Max Clients:</span>
                                <%= package.max_clients || 1 %>
                            </div>
                            <div><span class="font-medium">Upload Limit:</span>
                                <%= package.max_limit_upload %>
                            </div>
                            <div><span class="font-medium">Download Limit:</span>
                                <%= package.max_limit_download %>
                            </div>
                            <div><span class="font-medium">Parent Upload:</span>
                                <%= package.parent_upload_name || '-' %>
                            </div>
                            <div><span class="font-medium">Parent Download:</span>
                                <%= package.parent_download_name || '-' %>
                            </div>
                        </div>
                    </div>

                    <form method="post" action="/customers/edit-static-ip/<%= client.id %>"
                        class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Nama Pelanggan *</label>
                            <input name="client_name" value="<%= client.client_name %>" required
                                placeholder="Contoh: Pelanggan A"
                                class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            <p class="text-xs text-slate-500 mt-1">Nama untuk mengidentifikasi pelanggan</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">IP Address *</label>
                            <input name="ip_address" value="<%= client.ip_address %>" required
                                placeholder="192.168.1.1/30"
                                class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            <p class="text-xs text-slate-500 mt-1">IP address yang akan digunakan pelanggan</p>
                        </div>

                        <!-- Paket Internet -->
                        <div class="sm:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Paket Internet *</label>
                            <select name="package_id" required
                                class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                <option value="">-- Pilih Paket --</option>
                                <% (packages || []).forEach(function(pkg){ %>
                                    <option value="<%= pkg.id %>" <%=client.package_id==pkg.id ? 'selected' : '' %>>
                                        <%= pkg.name %> (<%= pkg.max_limit_download %>) - Rp <%= parseInt(pkg.price ||
                                                    0).toLocaleString('id-ID') %>
                                    </option>
                                    <% }) %>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">Pilih paket internet untuk pelanggan ini</p>
                        </div>

                        <!-- Informasi Kontak -->
                        <div class="sm:col-span-2">
                            <h3 class="text-md font-medium text-slate-700 mb-3 border-b border-slate-200 pb-2">📞
                                Informasi Kontak</h3>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Alamat</label>
                            <textarea name="address" placeholder="Alamat lengkap pelanggan"
                                class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                                rows="3"><%= client.address || '' %></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Nomor Telepon</label>
                            <input name="phone_number" value="<%= client.phone_number || '' %>"
                                placeholder="08123456789"
                                class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                        </div>

                        <!-- Koordinat & Maps Card (Combined) -->
                        <div class="sm:col-span-2 mt-4">
                            <div class="rounded-xl border border-slate-200 bg-white shadow-sm overflow-hidden">
                                <div
                                    class="px-6 py-4 bg-slate-50 border-b border-slate-100 flex items-center justify-between">
                                    <h3 class="text-md font-bold text-slate-700 flex items-center gap-2">
                                        <span class="p-1.5 bg-green-100 rounded-lg">📍</span> Koordinat & Maps
                                    </h3>
                                    <button type="button" id="btnGetLocation"
                                        class="text-xs px-3 py-1.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-all flex items-center gap-1">
                                        <span>📍</span> Ambil Lokasi GPS
                                    </button>
                                </div>
                                <div class="p-6">
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <!-- Inputs -->
                                        <div class="md:col-span-1 space-y-4">
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-slate-700 mb-1">Latitude</label>
                                                <input name="latitude" id="latitude" type="number" step="any"
                                                    value="<%= client.latitude || '' %>" placeholder="-6.xxxxx"
                                                    class="w-full rounded border border-slate-300 px-3 py-2 bg-white font-mono text-sm" />
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-medium text-slate-700 mb-1">Longitude</label>
                                                <input name="longitude" id="longitude" type="number" step="any"
                                                    value="<%= client.longitude || '' %>" placeholder="106.xxxxx"
                                                    class="w-full rounded border border-slate-300 px-3 py-2 bg-white font-mono text-sm" />
                                            </div>
                                            <div
                                                class="text-xs text-slate-500 bg-slate-50 p-2 rounded border border-slate-200">
                                                <p>💡 Geser pin pada peta untuk menyesuaikan lokasi pelanggan.</p>
                                            </div>
                                        </div>

                                        <!-- Map Container -->
                                        <div class="md:col-span-2">
                                            <div
                                                class="w-full h-[300px] bg-slate-100 rounded-lg border border-slate-200 overflow-hidden relative z-0">
                                                <div id="map" class="w-full h-full z-0"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- OLT, ODC, ODP (Modern Card - HIERARCHICAL) -->
                        <div class="sm:col-span-2 mt-4">
                            <div class="rounded-xl border border-cyan-200 bg-white shadow-sm overflow-hidden">
                                <div class="px-6 py-4 bg-gradient-to-r from-cyan-50 to-white border-b border-cyan-100">
                                    <h3 class="text-md font-bold text-cyan-900 flex items-center gap-2">
                                        <span class="p-1.5 bg-cyan-100 rounded-lg">🏗️</span> Infrastruktur FTTH (ODC &
                                        ODP)
                                    </h3>
                                </div>
                                <div class="p-6 space-y-4">
                                    <!-- Wireless Toggle -->
                                    <div
                                        class="flex items-center justify-between bg-slate-50 p-3 rounded-lg border border-slate-200 shadow-sm mb-4">
                                        <label class="flex items-center gap-2 cursor-pointer select-none">
                                            <input type="checkbox" id="is_wireless" <%=(!client.odp_id &&
                                                !client.odc_id) ? 'checked' : '' %>
                                            class="w-5 h-5 rounded text-cyan-600 focus:ring-cyan-500 border-gray-300
                                            transition-all">
                                            <span class="text-sm font-bold text-cyan-900">Koneksi Wireless / Tanpa
                                                ODP</span>
                                        </label>
                                        <span class="text-xs text-cyan-600 hidden sm:inline">Centang jika tidak
                                            menggunakan jalur Fiber</span>
                                    </div>

                                    <div id="infra_wrapper" class="space-y-4 transition-all duration-300">

                                        <!-- STEP 1: ODC SELECTION -->
                                        <div class="relative">
                                            <label class="block text-sm font-semibold text-cyan-800 mb-1">1. Cari &
                                                Pilih ODC (Optical Distribution Cabinet) *</label>
                                            <div class="flex gap-2">
                                                <div class="relative w-full">
                                                    <input type="text" id="odc_search"
                                                        value="<%= client.odc_name || '' %>"
                                                        placeholder="Ketik nama ODC..." autocomplete="off"
                                                        class="w-full rounded-lg border border-cyan-300 px-4 py-2.5 focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 font-medium transition-all duration-300 bg-white">
                                                    <input type="hidden" name="odc_id" id="odc_id"
                                                        value="<%= client.odc_id || '' %>">

                                                    <!-- ODC Results -->
                                                    <div id="odc_search_results"
                                                        class="absolute z-20 w-full mt-1 bg-white border border-cyan-200 rounded-xl shadow-xl max-h-60 overflow-y-auto hidden">
                                                    </div>
                                                </div>
                                                <button type="button" id="reset_odc_btn"
                                                    class="px-3 py-2 bg-slate-100 text-slate-500 rounded-lg border border-slate-200 hover:bg-slate-200 transition-colors"
                                                    title="Reset ODC">
                                                    ✕
                                                </button>
                                            </div>
                                        </div>

                                        <!-- STEP 2: ODP SELECTION (Dependent on ODC) -->
                                        <div id="odp_section_wrapper"
                                            class="relative transition-all duration-300 <%= client.odc_id ? '' : 'opacity-50 pointer-events-none grayscale' %>">
                                            <label class="block text-sm font-semibold text-cyan-800 mb-1">2. Pilih ODP
                                                (Optical Distribution Point) *</label>
                                            <div class="flex gap-2">
                                                <div class="relative w-full">
                                                    <input type="text" id="odp_search"
                                                        value="<%= client.odp_name || '' %>"
                                                        placeholder="Pilih ODP dari ODC diatas..." autocomplete="off"
                                                        class="w-full rounded-lg border border-cyan-300 px-4 py-2.5 focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-200 font-medium transition-all duration-300 bg-white">
                                                    <input type="hidden" name="odp_id" id="odp_id"
                                                        value="<%= client.odp_id || '' %>" required>

                                                    <!-- ODP Results -->
                                                    <div id="odp_search_results"
                                                        class="absolute z-20 w-full mt-1 bg-white border border-cyan-200 rounded-xl shadow-xl max-h-60 overflow-y-auto hidden">
                                                    </div>
                                                </div>
                                                <button type="button" id="reload_odp_btn"
                                                    class="px-3 py-2 bg-cyan-50 text-cyan-600 rounded-lg border border-cyan-200 hover:bg-cyan-100 transition-colors"
                                                    title="Reload ODP List">
                                                    🔄
                                                </button>
                                            </div>
                                            <p class="text-xs text-cyan-600 mt-1" id="selected_odp_info">
                                                <%= client.odp_id ? '✓ ODP Terpilih: ' + (client.odp_name||'')
                                                    : 'Pilih ODC dahulu, lalu pilih ODP.' %>
                                            </p>
                                        </div>

                                        <!-- INFO: OLT (Auto Display) -->
                                        <div>
                                            <label class="text-xs font-semibold text-slate-500">OLT (Terisi
                                                Otomatis)</label>
                                            <input name="olt_display" id="olt_display" readonly
                                                value="<%= client.olt_name || '' %>"
                                                class="w-full text-sm bg-slate-50 rounded border border-slate-200 px-3 py-2 text-slate-600"
                                                placeholder="-" />
                                            <input name="olt_id" id="olt_id" type="hidden"
                                                value="<%= client.olt_id || '' %>" />
                                        </div>

                                    </div>
                                </div>
                            </div>

                            <!-- ONT Information -->
                            <div class="sm:col-span-2">
                                <h3 class="text-md font-medium text-slate-700 mb-3 border-b border-slate-200 pb-2">📡
                                    Informasi ONT</h3>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">ONT Serial Number</label>
                                <input name="ont_serial" value="<%= client.ont_serial || '' %>"
                                    placeholder="ABC123456789"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p class="text-xs text-slate-500 mt-1">Serial number ONT yang digunakan customer</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">ONT Model</label>
                                <input name="ont_model" value="<%= client.ont_model || '' %>"
                                    placeholder="Huawei HG8245H"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p class="text-xs text-slate-500 mt-1">Model ONT yang digunakan</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">ONT Status</label>
                                <select name="ont_status"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="offline" <%=client.ont_status==='offline' ? 'selected' : '' %>
                                        >Offline
                                    </option>
                                    <option value="online" <%=client.ont_status==='online' ? 'selected' : '' %>>Online
                                    </option>
                                    <option value="maintenance" <%=client.ont_status==='maintenance' ? 'selected' : ''
                                        %>
                                        >Maintenance</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">ONT MAC Address</label>
                                <input name="ont_mac" value="<%= client.ont_mac || '' %>"
                                    placeholder="00:11:22:33:44:55"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p class="text-xs text-slate-500 mt-1">MAC address ONT</p>
                            </div>

                            <!-- Interface MikroTik -->
                            <div class="sm:col-span-2">
                                <h3 class="text-md font-medium text-slate-700 mb-3 border-b border-slate-200 pb-2">🔧
                                    Konfigurasi MikroTik</h3>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Interface MikroTik
                                    *</label>
                                <select name="interface" required
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                    <option value="">-- Pilih Interface --</option>
                                    <% (interfaces || []).forEach(function(ifc){ %>
                                        <option value="<%= ifc.name %>" <%=client.interface===ifc.name ? 'selected' : ''
                                            %>>
                                            <%= ifc.name %>
                                        </option>
                                        <% }) %>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">Packet Mark
                                    (preview)</label>
                                <input id="editPacketMarkPreview" readonly
                                    class="w-full rounded border border-slate-300 px-3 py-2 bg-slate-50" />
                            </div>

                            <!-- Informasi Sistem Share -->
                            <div class="sm:col-span-2">
                                <label class="block text-sm font-medium text-slate-700 mb-1">Sistem Share</label>
                                <div class="p-3 bg-green-50 border border-green-200 rounded text-sm text-green-700">
                                    <p class="font-medium mb-1">✅ Informasi Sistem Share:</p>
                                    <p>• Child parent diambil dari parent paket (view only)</p>
                                    <p>• Bandwidth akan dibagi rata sesuai max clients</p>
                                    <p>• Contoh: <%= package.max_limit_upload %> untuk <%= package.max_clients || 1 %>
                                                clients =
                                                <%= package.max_clients> 1 ?
                                                    Math.floor(parseInt(package.max_limit_upload.replace(/[^0-9]/g, ''))
                                                    /
                                                    package.max_clients) + 'M' : package.max_limit_upload %> per client
                                    </p>
                                </div>
                            </div>

                            <div class="sm:col-span-2 flex justify-end gap-3">
                                <a href="/packages/static-ip/clients"
                                    class="px-4 py-2 rounded border border-slate-300 text-slate-700 hover:bg-slate-50">
                                    Batal
                                </a>
                                <button type="submit"
                                    class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
                                    Simpan Perubahan
                                </button>
                            </div>
                    </form>

                    <script>
                        // === DATA TEKNIS: ODC -> ODP HIERARCHY LOGIC ===
                        (function () {
                            // Elements
                            const odcSearch = document.getElementById('odc_search');
                            const odcIdInput = document.getElementById('odc_id');
                            const odcResults = document.getElementById('odc_search_results');
                            const resetOdcBtn = document.getElementById('reset_odc_btn');

                            const odpSearch = document.getElementById('odp_search');
                            const odpIdInput = document.getElementById('odp_id');
                            const odpResults = document.getElementById('odp_search_results');
                            const odpSection = document.getElementById('odp_section_wrapper');
                            const odpInfo = document.getElementById('selected_odp_info');
                            const reloadOdpBtn = document.getElementById('reload_odp_btn');

                            const oltDisplay = document.getElementById('olt_display');
                            const oltIdInput = document.getElementById('olt_id');

                            const isWireless = document.getElementById('is_wireless');
                            // Note: In edit_static_ip, the wrapper for entire card content (except wireless toggle) is #infra_wrapper ???
                            // In my HTML update above, I wrapped ODC+ODP+OLT in #infra_wrapper.
                            // But Wireless Toggle is OUTSIDE #infra_wrapper.
                            const infraWrapper = document.getElementById('infra_wrapper');

                            let odcTimeout, odpTimeout;

                            // === 1. WIRELESS TOGGLE ===
                            function toggleWireless() {
                                if (isWireless && isWireless.checked) {
                                    if (infraWrapper) infraWrapper.classList.add('opacity-40', 'pointer-events-none');
                                    // Clear requirements
                                    if (odpIdInput) {
                                        odpIdInput.required = false;
                                        // Don't clear value immediately on Edit? 
                                        // Maybe better to Keep value hidden in case user toggles back?
                                        // But logic says: Wireless = No ODP.
                                        // If user saves, ODP ID will be null.
                                        // Let's clear visual feedback but maybe keep ID? No, clear everything to be safe.
                                        odpIdInput.value = '';
                                    }
                                    if (odcIdInput) odcIdInput.value = '';
                                } else {
                                    if (infraWrapper) infraWrapper.classList.remove('opacity-40', 'pointer-events-none');
                                    if (odpIdInput) odpIdInput.required = true;
                                }
                            }
                            if (isWireless) {
                                isWireless.addEventListener('change', toggleWireless);
                                toggleWireless(); // Init
                            }

                            // === 2. ODC SEARCH LOGIC ===
                            if (odcSearch) {
                                odcSearch.addEventListener('input', function (e) {
                                    clearTimeout(odcTimeout);
                                    const query = e.target.value.trim();

                                    // User ketik manual -> Reset ID dulu
                                    if (odcIdInput) odcIdInput.value = '';
                                    lockOdpSection(); // Lock ODP until ODC selected again

                                    if (query.length < 1) {
                                        odcResults.classList.add('hidden');
                                        return;
                                    }

                                    odcTimeout = setTimeout(() => {
                                        odcResults.innerHTML = '<div class="p-2 text-xs text-center">Loading...</div>';
                                        odcResults.classList.remove('hidden');

                                        fetch('/api/ftth/odc/search?q=' + encodeURIComponent(query))
                                            .then(r => r.json())
                                            .then(res => {
                                                if (res.success && res.results.length > 0) {
                                                    odcResults.innerHTML = res.results.map(odc => `
                                                    <div class="p-2 hover:bg-cyan-50 cursor-pointer border-b border-gray-100 last:border-b-0 text-sm odc-item"
                                                         data-id="${odc.id}" data-name="${odc.name}">
                                                        <div class="font-bold text-cyan-900">${odc.name}</div>
                                                        <div class="text-xs text-slate-500">${odc.location || '-'} (${odc.used_ports}/${odc.total_ports})</div>
                                                    </div>
                                                `).join('');
                                                } else {
                                                    odcResults.innerHTML = '<div class="p-2 text-xs text-center text-yellow-600">ODC tidak ditemukan</div>';
                                                }
                                            }).catch(e => {
                                                odcResults.innerHTML = '<div class="p-2 text-xs text-center text-red-500">Error</div>';
                                            });
                                    }, 300);
                                });

                                // Select ODC
                                odcResults.addEventListener('click', function (e) {
                                    const item = e.target.closest('.odc-item');
                                    if (item) {
                                        const id = item.dataset.id;
                                        const name = item.dataset.name;

                                        odcSearch.value = name;
                                        odcIdInput.value = id;
                                        odcResults.classList.add('hidden');

                                        // Unlock ODP Section
                                        unlockOdpSection();

                                        // Auto expand ODP search
                                        odpInfo.textContent = `ODC: ${name} terpilih. Silakan pilih ODP.`;
                                        odpSearch.focus();
                                    }
                                });

                                // Hide on blur
                                odcSearch.addEventListener('blur', () => setTimeout(() => odcResults.classList.add('hidden'), 200));
                            }

                            // Reset ODC
                            if (resetOdcBtn) {
                                resetOdcBtn.addEventListener('click', () => {
                                    if (isWireless && isWireless.checked) return;
                                    odcSearch.value = '';
                                    odcIdInput.value = '';
                                    lockOdpSection();
                                    odcSearch.focus();
                                });
                            }

                            // === 3. ODP SEARCH LOGIC (Filtered by ODC) ===
                            function lockOdpSection() {
                                if (odpSection) odpSection.classList.add('opacity-50', 'pointer-events-none', 'grayscale');
                                if (odpSearch) odpSearch.value = '';
                                if (odpIdInput) odpIdInput.value = '';
                                if (oltDisplay) oltDisplay.value = '';
                                if (oltIdInput) oltIdInput.value = '';
                            }

                            function unlockOdpSection() {
                                if (odpSection) odpSection.classList.remove('opacity-50', 'pointer-events-none', 'grayscale');
                            }

                            if (odpSearch) {
                                // Show all ODPs in ODC automatically on focus
                                odpSearch.addEventListener('focus', function () {
                                    if (!odcIdInput.value) return;
                                    triggerOdpSearch('');
                                });

                                odpSearch.addEventListener('input', function (e) {
                                    triggerOdpSearch(e.target.value.trim());
                                });

                                function triggerOdpSearch(query) {
                                    clearTimeout(odpTimeout);
                                    const odcId = odcIdInput.value;
                                    if (!odcId) return;

                                    odpTimeout = setTimeout(() => {
                                        odpResults.classList.remove('hidden');
                                        odpResults.innerHTML = '<div class="p-2 text-xs text-center">Loading ODPs...</div>';

                                        fetch(`/api/ftth/odp/search?odc_id=${odcId}&q=${encodeURIComponent(query)}`)
                                            .then(r => r.json())
                                            .then(res => {
                                                if (res.success && res.results.length > 0) {
                                                    odpResults.innerHTML = res.results.map(odp => `
                                                    <div class="p-2 hover:bg-cyan-50 cursor-pointer border-b border-gray-100 last:border-b-0 text-sm odp-item"
                                                         data-id="${odp.id}" data-name="${odp.name}"
                                                         data-capacity="${odp.total_ports}" data-used="${odp.used_ports}">
                                                        <div class="flex justify-between">
                                                            <span class="font-bold text-cyan-900">${odp.name}</span>
                                                            <span class="text-xs ${odp.used_ports >= odp.total_ports ? 'text-red-500' : 'text-green-600'}">
                                                                ${odp.used_ports}/${odp.total_ports}
                                                            </span>
                                                        </div>
                                                    </div>
                                                `).join('');
                                                } else {
                                                    odpResults.innerHTML = '<div class="p-2 text-xs text-center text-yellow-600">Tidak ada ODP ditemukan di ODC ini</div>';
                                                }
                                            });
                                    }, 300);
                                }

                                // Select ODP
                                odpResults.addEventListener('click', function (e) {
                                    const item = e.target.closest('.odp-item');
                                    if (item) {
                                        odpSearch.value = item.dataset.name;
                                        odpIdInput.value = item.dataset.id;
                                        odpInfo.textContent = `✓ ODP: ${item.dataset.name} (${item.dataset.used}/${item.dataset.capacity})`;
                                        odpResults.classList.add('hidden');
                                        oltDisplay.value = 'Auto (Saved)';
                                    }
                                });
                                // Hide on blur
                                odpSearch.addEventListener('blur', () => setTimeout(() => odpResults.classList.add('hidden'), 200));
                            }

                            // Initial State Check
                            // If ODC ID exists on load, unlock ODP section
                            if (odcIdInput && odcIdInput.value) {
                                unlockOdpSection();
                            }

                        })();

                        // Maps integration
                        function initMaps() {
                            const btnGetLocation = document.getElementById('btnGetLocation');
                            const latInput = document.getElementById('latitude');
                            const lngInput = document.getElementById('longitude');

                            if (document.getElementById('map')) {
                                // Safety check for Leaflet
                                if (typeof L === 'undefined') {
                                    console.error('Leaflet JS (Map) not loaded. Check internet connection or CDN.');
                                    return;
                                }

                                try {
                                    // Default center (Indonesia -> Jakarta approx, or user's current value)
                                    let defaultLat = -6.200000;
                                    let defaultLng = 106.816666;
                                    let initialZoom = 5;

                                    if (latInput.value && lngInput.value) {
                                        defaultLat = parseFloat(latInput.value);
                                        defaultLng = parseFloat(lngInput.value);
                                        initialZoom = 15;
                                    }

                                    // Init Map
                                    const map = L.map('map').setView([defaultLat, defaultLng], initialZoom);

                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        maxZoom: 19,
                                        attribution: '© OpenStreetMap'
                                    }).addTo(map);

                                    let marker;

                                    // Function to set marker
                                    function setMarker(lat, lng) {
                                        if (marker) {
                                            marker.setLatLng([lat, lng]);
                                        } else {
                                            marker = L.marker([lat, lng], { draggable: true }).addTo(map);

                                            // Drag event
                                            marker.on('dragend', function (e) {
                                                const position = e.target.getLatLng();
                                                latInput.value = position.lat.toFixed(6);
                                                lngInput.value = position.lng.toFixed(6);
                                            });
                                        }
                                        if (map.getZoom() < 12) map.setZoom(15);
                                        map.panTo([lat, lng]);
                                    }

                                    // If initial values exist, place marker
                                    if (latInput.value && lngInput.value) {
                                        setMarker(defaultLat, defaultLng);
                                    }

                                    // Map click event
                                    map.on('click', function (e) {
                                        const lat = e.latlng.lat;
                                        const lng = e.latlng.lng;

                                        latInput.value = lat.toFixed(6);
                                        lngInput.value = lng.toFixed(6);

                                        setMarker(lat, lng);
                                    });

                                    // Input change event (manual typing)
                                    [latInput, lngInput].forEach(input => {
                                        input.addEventListener('change', () => {
                                            const lat = parseFloat(latInput.value);
                                            const lng = parseFloat(lngInput.value);
                                            if (!isNaN(lat) && !isNaN(lng)) {
                                                setMarker(lat, lng);
                                            }
                                        });
                                    });

                                    // Get Location Button
                                    if (btnGetLocation) {
                                        btnGetLocation.addEventListener('click', () => {
                                            btnGetLocation.textContent = '⌛ Mencari...';
                                            if ("geolocation" in navigator) {
                                                navigator.geolocation.getCurrentPosition((pos) => {
                                                    const lat = pos.coords.latitude;
                                                    const lng = pos.coords.longitude;

                                                    latInput.value = lat.toFixed(6);
                                                    lngInput.value = lng.toFixed(6);

                                                    setMarker(lat, lng);

                                                    btnGetLocation.innerHTML = '<span>✅</span> Lokasi Didapat';
                                                    setTimeout(() => btnGetLocation.innerHTML = '<span>📍</span> Ambil Lokasi GPS', 2000);
                                                }, (err) => {
                                                    alert('Gagal mengambil lokasi: ' + err.message);
                                                    btnGetLocation.textContent = '❌ Gagal';
                                                });
                                            } else {
                                                alert('Geolocation tidak didukung browser ini.');
                                            }
                                        });
                                    }

                                    // Fix map rendering
                                    setTimeout(() => { map.invalidateSize(); }, 200);
                                } catch (err) {
                                    console.error('Error initializing map:', err);
                                }
                            }
                        }

                        (function () {
                            const ipInput = document.querySelector('input[name="ip_address"]');
                            const preview = document.getElementById('editPacketMarkPreview');
                            const nameInput = document.querySelector('input[name="client_name"]');

                            function ipToInt(ip) { return ip.split('.').reduce((acc, oct) => (acc << 8) + parseInt(oct), 0) >>> 0 }
                            function intToIp(int) { return [(int >>> 24) & 255, (int >>> 16) & 255, (int >>> 8) & 255, int & 255].join('.') }

                            function update() {
                                const v = (ipInput.value || '').trim();
                                const [ip, prefStr] = v.split('/');
                                const pref = Number(prefStr || '0');
                                if (!ip || !pref) { if (preview) preview.value = ''; return; }
                                const mask = pref === 0 ? 0 : (0xFFFFFFFF << (32 - pref)) >>> 0;
                                const net = ipToInt(ip) & mask;
                                let peer = ip;
                                if (pref === 30) {
                                    const firstHost = net + 1;
                                    const secondHost = net + 2;
                                    const ipInt = ipToInt(ip);
                                    peer = (ipInt === firstHost) ? intToIp(secondHost) : (ipInt === secondHost ? intToIp(firstHost) : intToIp(secondHost));
                                }
                                if (preview) preview.value = `Download: ${peer} | Upload: UP-${peer}`;
                            }

                            if (ipInput) ipInput.addEventListener('input', update);
                            update(); // Initial update

                            // Initialize maps
                            initMaps();
                        })();
                    </script>
</div>