<div class="rounded border border-slate-200 bg-white p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold text-slate-800">Database Management</h2>
        <div class="flex gap-2">
            <button onclick="checkDatabaseIssues()" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
                Cek Masalah Database
            </button>
            <button onclick="fixAllIssues()" class="px-4 py-2 rounded bg-green-600 text-white hover:bg-green-700">
                Perbaiki Semua
            </button>
        </div>
    </div>

    <% if (success && success.length > 0) { %>
    <div class="mb-4 p-3 bg-green-100 border border-green-300 text-green-700 rounded">
        <%= success[0] %>
    </div>
    <% } %>

    <% if (error && error.length > 0) { %>
    <div class="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded">
        <%= error[0] %>
    </div>
    <% } %>

    <!-- Database Status -->
    <div class="mb-8 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
        <h3 class="text-lg font-semibold text-slate-800 mb-3">ğŸ“Š Status Database</h3>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-slate-600">Status Koneksi</label>
                <p class="text-lg font-bold <%= dbStatus.connected ? 'text-green-600' : 'text-red-600' %>">
                    <%= dbStatus.connected ? 'Terhubung' : 'Terputus' %>
                </p>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-600">Versi Database</label>
                <p class="text-sm text-slate-700"><%= dbStatus.version %></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-600">Total Tabel</label>
                <p class="text-lg font-bold text-blue-600"><%= dbStatus.totalTables %></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-slate-600">Total Data</label>
                <p class="text-lg font-bold text-green-600"><%= dbStatus.totalRows.toLocaleString() %></p>
            </div>
        </div>
    </div>

    <!-- Schema Issues -->
    <div class="mb-8">
        <h3 class="text-lg font-semibold text-slate-800 mb-4">âš ï¸ Masalah Database</h3>
        <% if (schemaIssues && schemaIssues.length > 0) { %>
        <div class="space-y-3">
            <% schemaIssues.forEach(function(issue) { %>
            <div class="p-4 border rounded-lg <%= issue.severity === 'critical' ? 'border-red-300 bg-red-50' : issue.severity === 'high' ? 'border-orange-300 bg-orange-50' : issue.severity === 'medium' ? 'border-yellow-300 bg-yellow-50' : 'border-blue-300 bg-blue-50' %>">
                <div class="flex items-start justify-between">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-2">
                            <span class="px-2 py-1 text-xs rounded <%= issue.severity === 'critical' ? 'bg-red-100 text-red-700' : issue.severity === 'high' ? 'bg-orange-100 text-orange-700' : issue.severity === 'medium' ? 'bg-yellow-100 text-yellow-700' : 'bg-blue-100 text-blue-700' %>">
                                <%= issue.severity === 'critical' ? 'Critical' : issue.severity === 'high' ? 'High' : issue.severity === 'medium' ? 'Medium' : 'Low' %>
                            </span>
                            <span class="font-semibold text-slate-800"><%= issue.table %></span>
                        </div>
                        <p class="text-sm text-slate-700 mb-2"><%= issue.description %></p>
                        <code class="text-xs bg-slate-100 p-2 rounded block"><%= issue.fixCommand %></code>
                    </div>
                    <form method="post" action="/database/fix" class="ml-4">
                        <input type="hidden" name="issueType" value="missing_columns">
                        <button type="submit" class="px-3 py-1 text-xs rounded bg-green-600 text-white hover:bg-green-700">
                            Perbaiki
                        </button>
                    </form>
                </div>
            </div>
            <% }) %>
        </div>
        <% } else { %>
        <div class="p-4 bg-green-50 border border-green-200 rounded-lg text-center">
            <p class="text-green-700">âœ… Tidak ada masalah database yang ditemukan</p>
        </div>
        <% } %>
    </div>

    <!-- Quick Actions -->
    <div class="mb-8">
        <h3 class="text-lg font-semibold text-slate-800 mb-4">ğŸ”§ Aksi Cepat</h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <form method="post" action="/database/fix" class="p-4 border border-slate-200 rounded-lg">
                <input type="hidden" name="issueType" value="missing_columns">
                <h4 class="font-semibold text-slate-800 mb-2">Perbaiki Kolom</h4>
                <p class="text-sm text-slate-600 mb-3">Tambahkan kolom yang hilang (olt_card, olt_port, max_clients)</p>
                <button type="submit" class="w-full px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                    Perbaiki Kolom
                </button>
            </form>
            
            <form method="post" action="/database/migrate" class="p-4 border border-slate-200 rounded-lg">
                <input type="hidden" name="migrationType" value="full">
                <h4 class="font-semibold text-slate-800 mb-2">Jalankan Migrasi</h4>
                <p class="text-sm text-slate-600 mb-3">Jalankan semua migrasi database</p>
                <button type="submit" class="w-full px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700">
                    Jalankan Migrasi
                </button>
            </form>
            
            <div class="p-4 border border-slate-200 rounded-lg">
                <h4 class="font-semibold text-slate-800 mb-2">Cek Log Database</h4>
                <p class="text-sm text-slate-600 mb-3">Lihat log aktivitas database</p>
                <button onclick="showDatabaseLogs()" class="w-full px-3 py-2 bg-slate-600 text-white rounded hover:bg-slate-700">
                    Lihat Log
                </button>
            </div>
        </div>
    </div>
</div>

<script>
async function checkDatabaseIssues() {
    try {
        const response = await fetch('/database/check');
        const data = await response.json();
        
        if (data.issues && data.issues.length > 0) {
            alert(`Ditemukan ${data.issues.length} masalah database. Silakan perbaiki.`);
            location.reload();
        } else {
            alert('Database dalam kondisi baik.');
        }
    } catch (error) {
        alert('Gagal mengecek database: ' + error.message);
    }
}

async function fixAllIssues() {
    if (confirm('Apakah Anda yakin ingin memperbaiki semua masalah database?')) {
        try {
            const response = await fetch('/database/fix-all', {
                method: 'POST'
            });
            
            if (response.ok) {
                alert('Semua masalah database berhasil diperbaiki.');
                location.reload();
            } else {
                alert('Gagal memperbaiki database.');
            }
        } catch (error) {
            alert('Gagal memperbaiki database: ' + error.message);
        }
    }
}

async function showDatabaseLogs() {
    try {
        const response = await fetch('/database/logs');
        const logs = await response.json();
        
        let logText = 'Database Logs:\n\n';
        logs.forEach(log => {
            logText += `[${log.timestamp}] ${log.level}: ${log.message}\n`;
        });
        
        alert(logText);
    } catch (error) {
        alert('Gagal mengambil log database: ' + error.message);
    }
}
</script>
