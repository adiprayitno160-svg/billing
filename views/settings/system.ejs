<!-- System Settings Page -->
<div class="container-fluid">
    <!-- Flash Messages -->
    <% if (typeof success !=='undefined' && success) { %>
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 rounded-lg shadow-sm">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-500 text-xl mr-3"></i>
                <p class="text-green-800 font-medium">
                    <%= success %>
                </p>
            </div>
        </div>
        <% } %>

            <% if (typeof error !=='undefined' && error) { %>
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
                        <p class="text-red-800 font-medium">
                            <%= error %>
                        </p>
                    </div>
                </div>
                <% } %>

                    <% // Helper function to convert setting_key to readable label function getReadableLabel(key) {
                        const labels={ 'app_version' : 'Versi Aplikasi' , 'grace_period_days' : 'Hari Grace Period'
                        , 'late_payment_threshold' : 'Batas Late Payment' , 'late_payment_rolling_months'
                        : 'Bulan Rolling Period' , 'consecutive_on_time_reset' : 'Reset Pembayaran Tepat Waktu'
                        , 'late_payment_warning_at_3' : 'Peringatan di 3x Late Payment' , 'late_payment_warning_at_4'
                        : 'Peringatan Final di 4x Late Payment' , 'auto_isolate_enabled' : 'Aktifkan Auto Isolate'
                        , 'auto_restore_enabled' : 'Aktifkan Auto Restore' , 'auto_notifications_enabled'
                        : 'Aktifkan Auto Notifications' , 'auto_logout_enabled' : 'Aktifkan Auto Logout (10 Menit)'
                        , 'domain_url' : 'URL Domain' , 'local_url' : 'URL Lokal' , 'domain_mode_enabled'
                        : 'Aktifkan Domain Mode' , 'local_mode_enabled' : 'Aktifkan Local Mode' }; return labels[key] ||
                        key.replace(/_/g, ' ' ).replace(/\b\w/g, l=> l.toUpperCase());
                        }
                        %>

                        <!-- Form -->
                        <form action="/settings/system" method="POST">
                            <div class="space-y-6">

                                <!-- General Settings -->
                                <% if (groupedSettings && groupedSettings.general) { %>
                                    <div class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                        <div
                                            class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-5 py-4">
                                            <h3 class="text-lg font-bold flex items-center">
                                                <i class="fas fa-cog mr-2"></i>
                                                Umum
                                            </h3>
                                        </div>
                                        <div class="p-5">
                                            <table class="w-full">
                                                <tbody class="divide-y divide-gray-200">
                                                    <% groupedSettings.general.forEach(function(setting) { %>
                                                        <tr class="hover:bg-gray-50">
                                                            <td class="py-3 pr-4">
                                                                <label
                                                                    class="block text-sm font-semibold text-gray-700 mb-1">
                                                                    <%= getReadableLabel(setting.setting_key) %>
                                                                </label>
                                                                <% if (setting.setting_description) { %>
                                                                    <p class="text-xs text-gray-500 mt-0.5">
                                                                        <%= setting.setting_description %>
                                                                    </p>
                                                                    <% } %>
                                                            </td>
                                                            <td class="py-3 w-72">
                                                                <% if (setting.setting_value==='true' ||
                                                                    setting.setting_value==='false' ) { %>
                                                                    <input type="hidden"
                                                                        name="<%= setting.setting_key %>" value="false">
                                                                    <label
                                                                        class="relative inline-flex items-center cursor-pointer">
                                                                        <input type="checkbox"
                                                                            name="<%= setting.setting_key %>"
                                                                            value="true"
                                                                            class="sr-only peer toggle-checkbox"
                                                                            <%=setting.setting_value==='true'
                                                                            ? 'checked' : '' %>>
                                                                        <div
                                                                            class="relative w-10 h-5 bg-amber-400 rounded-full peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:bg-blue-600 transition-colors duration-200">
                                                                            <div
                                                                                class="absolute top-[2px] left-[2px] bg-white border border-amber-500 rounded-full h-4 w-4 transition-transform duration-200 peer-checked:translate-x-5 shadow-md">
                                                                            </div>
                                                                        </div>
                                                                        <span
                                                                            class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                            <%= setting.setting_value==='true' ? 'Aktif'
                                                                                : 'Nonaktif' %>
                                                                        </span>
                                                                    </label>
                                                                    <% } else { %>
                                                                        <input type="text"
                                                                            name="<%= setting.setting_key %>"
                                                                            value="<%= setting.setting_value || '' %>"
                                                                            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                                                                        <% } %>
                                                            </td>
                                                        </tr>
                                                        <% }); %>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                    <% } %>

                                        <!-- URL Settings (Domain & Local) -->
                                        <% if (groupedSettings && groupedSettings.url) { %>
                                            <div
                                                class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                                <div
                                                    class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-5 py-4">
                                                    <h3 class="text-lg font-bold flex items-center">
                                                        <i class="fas fa-network-wired mr-2"></i>
                                                        Konfigurasi URL (Domain & Lokal)
                                                    </h3>
                                                </div>
                                                <div class="p-5">
                                                    <div class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                                                        <p class="text-sm text-blue-800">
                                                            <i class="fas fa-info-circle mr-2"></i>
                                                            <strong>Info:</strong> Anda dapat mengaktifkan kedua mode
                                                            (Domain dan Lokal) secara bersamaan.
                                                            Sistem akan menggunakan URL yang sesuai berdasarkan
                                                            konfigurasi.
                                                        </p>
                                                    </div>
                                                    <table class="w-full">
                                                        <tbody class="divide-y divide-gray-200">
                                                            <% groupedSettings.url.forEach(function(setting) { %>
                                                                <tr class="hover:bg-gray-50">
                                                                    <td class="py-3 pr-4">
                                                                        <label
                                                                            class="block text-sm font-semibold text-gray-700 mb-1">
                                                                            <%= getReadableLabel(setting.setting_key) %>
                                                                        </label>
                                                                        <% if (setting.setting_description) { %>
                                                                            <p class="text-xs text-gray-500 mt-0.5">
                                                                                <%= setting.setting_description %>
                                                                            </p>
                                                                            <% } %>
                                                                    </td>
                                                                    <td class="py-3 w-72">
                                                                        <% if (setting.setting_value==='true' ||
                                                                            setting.setting_value==='false' ) { %>
                                                                            <input type="hidden"
                                                                                name="<%= setting.setting_key %>"
                                                                                value="false">
                                                                            <label
                                                                                class="relative inline-flex items-center cursor-pointer">
                                                                                <input type="checkbox"
                                                                                    name="<%= setting.setting_key %>"
                                                                                    value="true"
                                                                                    class="sr-only peer toggle-checkbox"
                                                                                    <%=setting.setting_value==='true'
                                                                                    ? 'checked' : '' %>>
                                                                                <div
                                                                                    class="relative w-10 h-5 bg-amber-400 rounded-full peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 peer-checked:bg-indigo-600 transition-colors duration-200">
                                                                                    <div
                                                                                        class="absolute top-[2px] left-[2px] bg-white border border-amber-500 rounded-full h-4 w-4 transition-transform duration-200 peer-checked:translate-x-5 shadow-md">
                                                                                    </div>
                                                                                </div>
                                                                                <span
                                                                                    class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                                    <%= setting.setting_value==='true'
                                                                                        ? 'Aktif' : 'Nonaktif' %>
                                                                                </span>
                                                                            </label>
                                                                            <% } else if
                                                                                (setting.setting_key==='domain_url' ||
                                                                                setting.setting_key==='local_url' ) { %>
                                                                                <input type="url"
                                                                                    name="<%= setting.setting_key %>"
                                                                                    value="<%= setting.setting_value || '' %>"
                                                                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono shadow-sm"
                                                                                    placeholder="<%= setting.setting_key === 'domain_url' ? 'https://billing.example.com' : 'http://localhost:3000' %>">
                                                                                <% } else { %>
                                                                                    <input type="text"
                                                                                        name="<%= setting.setting_key %>"
                                                                                        value="<%= setting.setting_value || '' %>"
                                                                                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                                                                                    <% } %>
                                                                    </td>
                                                                </tr>
                                                                <% }); %>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                            <% } %>



                                                <!-- Late Payment Settings -->
                                                <% if (groupedSettings && groupedSettings.late_payment) { %>
                                                    <div
                                                        class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                                        <div
                                                            class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-4">
                                                            <h3 class="text-lg font-bold flex items-center">
                                                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                                                Late Payment
                                                            </h3>
                                                        </div>
                                                        <div class="p-5">
                                                            <table class="w-full">
                                                                <tbody class="divide-y divide-gray-200">
                                                                    <% groupedSettings.late_payment.forEach(function(setting)
                                                                        { %>
                                                                        <tr class="hover:bg-gray-50">
                                                                            <td class="py-3 pr-4">
                                                                                <label
                                                                                    class="block text-sm font-semibold text-gray-700 mb-1">
                                                                                    <%= getReadableLabel(setting.setting_key)
                                                                                        %>
                                                                                </label>
                                                                                <% if (setting.setting_description) { %>
                                                                                    <p
                                                                                        class="text-xs text-gray-500 mt-0.5">
                                                                                        <%= setting.setting_description
                                                                                            %>
                                                                                    </p>
                                                                                    <% } %>
                                                                            </td>
                                                                            <td class="py-3 w-72">
                                                                                <% if (setting.setting_value==='true' ||
                                                                                    setting.setting_value==='false' ||
                                                                                    setting.setting_value==='1' ||
                                                                                    setting.setting_value==='0' ) { %>
                                                                                    <input type="hidden"
                                                                                        name="<%= setting.setting_key %>"
                                                                                        value="0">
                                                                                    <label
                                                                                        class="relative inline-flex items-center cursor-pointer">
                                                                                        <input type="checkbox"
                                                                                            name="<%= setting.setting_key %>"
                                                                                            value="1"
                                                                                            class="sr-only peer toggle-checkbox"
                                                                                            <%=(setting.setting_value==='true'
                                                                                            ||
                                                                                            setting.setting_value==='1'
                                                                                            ) ? 'checked' : '' %>>
                                                                                        <div
                                                                                            class="relative w-10 h-5 bg-amber-400 rounded-full peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-red-300 peer-checked:bg-red-500 transition-colors duration-200">
                                                                                            <div
                                                                                                class="absolute top-[2px] left-[2px] bg-white border border-amber-500 rounded-full h-4 w-4 transition-transform duration-200 peer-checked:translate-x-5 shadow-md">
                                                                                            </div>
                                                                                        </div>
                                                                                        <span
                                                                                            class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                                            <%= (setting.setting_value==='true'
                                                                                                ||
                                                                                                setting.setting_value==='1'
                                                                                                ) ? 'Aktif' : 'Nonaktif'
                                                                                                %>
                                                                                        </span>
                                                                                    </label>
                                                                                    <% } else { %>
                                                                                        <input type="number"
                                                                                            name="<%= setting.setting_key %>"
                                                                                            value="<%= setting.setting_value || '' %>"
                                                                                            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                                                                            min="0">
                                                                                        <% } %>
                                                                            </td>
                                                                        </tr>
                                                                        <% }); %>
                                                                </tbody>
                                                            </table>
                                                        </div>
                                                    </div>
                                                    <% } %>

                                                        <!-- Auto Actions Settings -->
                                                        <% if (groupedSettings && groupedSettings.billing) { %>
                                                            <div
                                                                class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                                                <div
                                                                    class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-5 py-4">
                                                                    <h3 class="text-lg font-bold flex items-center">
                                                                        <i class="fas fa-robot mr-2"></i>
                                                                        Auto Actions
                                                                    </h3>
                                                                </div>
                                                                <div class="p-5">
                                                                    <table class="w-full">
                                                                        <tbody class="divide-y divide-gray-200">
                                                                            <% groupedSettings.billing.forEach(function(setting)
                                                                                { %>
                                                                                <tr class="hover:bg-gray-50">
                                                                                    <td class="py-3 pr-4">
                                                                                        <label
                                                                                            class="block text-sm font-semibold text-gray-700 mb-1">
                                                                                            <%= getReadableLabel(setting.setting_key)
                                                                                                %>
                                                                                        </label>
                                                                                        <% if
                                                                                            (setting.setting_description)
                                                                                            { %>
                                                                                            <p
                                                                                                class="text-xs text-gray-500 mt-0.5">
                                                                                                <%= setting.setting_description
                                                                                                    %>
                                                                                            </p>
                                                                                            <% } %>
                                                                                    </td>
                                                                                    <td class="py-3 w-72">
                                                                                        <% if
                                                                                            (setting.setting_value==='true'
                                                                                            ||
                                                                                            setting.setting_value==='false'
                                                                                            ) { %>
                                                                                            <input type="hidden"
                                                                                                name="<%= setting.setting_key %>"
                                                                                                value="false">
                                                                                            <label
                                                                                                class="relative inline-flex items-center cursor-pointer">
                                                                                                <input type="checkbox"
                                                                                                    name="<%= setting.setting_key %>"
                                                                                                    value="true"
                                                                                                    class="sr-only peer"
                                                                                                    <%=setting.setting_value==='true'
                                                                                                    ? 'checked' : '' %>>
                                                                                                <div
                                                                                                    class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                                                                                                </div>
                                                                                                <span
                                                                                                    class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                                                    <%= setting.setting_value==='true'
                                                                                                        ? 'Aktif'
                                                                                                        : 'Nonaktif' %>
                                                                                                </span>
                                                                                            </label>
                                                                                            <% } else { %>
                                                                                                <input type="text"
                                                                                                    name="<%= setting.setting_key %>"
                                                                                                    value="<%= setting.setting_value || '' %>"
                                                                                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 shadow-sm">
                                                                                                <% } %>
                                                                                    </td>
                                                                                </tr>
                                                                                <% }); %>
                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                            <% } %>

                                                                <!-- Other Categories -->
                                                                <% Object.keys(groupedSettings ||
                                                                    {}).forEach(function(category) { %>
                                                                    <% if (category !=='late_payment' && category
                                                                        !=='billing' && category !=='general' &&
                                                                        category !=='url' ) { %>
                                                                        <div
                                                                            class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                                                            <div
                                                                                class="bg-gradient-to-r from-gray-700 to-gray-800 text-white px-5 py-4">
                                                                                <h3
                                                                                    class="text-lg font-bold capitalize">
                                                                                    <%= category.replace(/_/g, ' ' ) %>
                                                                                </h3>
                                                                            </div>
                                                                            <div class="p-5">
                                                                                <table class="w-full">
                                                                                    <tbody
                                                                                        class="divide-y divide-gray-200">
                                                                                        <% groupedSettings[category].forEach(function(setting)
                                                                                            { %>
                                                                                            <tr
                                                                                                class="hover:bg-gray-50">
                                                                                                <td class="py-3 pr-4">
                                                                                                    <label
                                                                                                        class="block text-sm font-semibold text-gray-700 mb-1">
                                                                                                        <%= getReadableLabel(setting.setting_key)
                                                                                                            %>
                                                                                                    </label>
                                                                                                    <% if
                                                                                                        (setting.setting_description)
                                                                                                        { %>
                                                                                                        <p
                                                                                                            class="text-xs text-gray-500 mt-0.5">
                                                                                                            <%= setting.setting_description
                                                                                                                %>
                                                                                                        </p>
                                                                                                        <% } %>
                                                                                                </td>
                                                                                                <td class="py-3 w-72">
                                                                                                    <% if
                                                                                                        (setting.setting_value==='true'
                                                                                                        ||
                                                                                                        setting.setting_value==='false'
                                                                                                        ) { %>
                                                                                                        <input
                                                                                                            type="hidden"
                                                                                                            name="<%= setting.setting_key %>"
                                                                                                            value="false">
                                                                                                        <label
                                                                                                            class="relative inline-flex items-center cursor-pointer">
                                                                                                            <input
                                                                                                                type="checkbox"
                                                                                                                name="<%= setting.setting_key %>"
                                                                                                                value="true"
                                                                                                                class="sr-only peer toggle-checkbox"
                                                                                                                <%=setting.setting_value==='true'
                                                                                                                ? 'checked'
                                                                                                                : '' %>>
                                                                                                            <div
                                                                                                                class="relative w-10 h-5 bg-amber-400 rounded-full peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-teal-300 peer-checked:bg-teal-600 transition-colors duration-200">
                                                                                                                <div
                                                                                                                    class="absolute top-[2px] left-[2px] bg-white border border-amber-500 rounded-full h-4 w-4 transition-transform duration-200 peer-checked:translate-x-5 shadow-md">
                                                                                                                </div>
                                                                                                            </div>
                                                                                                            <span
                                                                                                                class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                                                                <%= setting.setting_value==='true'
                                                                                                                    ? 'Aktif'
                                                                                                                    : 'Nonaktif'
                                                                                                                    %>
                                                                                                            </span>
                                                                                                        </label>
                                                                                                        <% } else { %>
                                                                                                            <input
                                                                                                                type="text"
                                                                                                                name="<%= setting.setting_key %>"
                                                                                                                value="<%= setting.setting_value || '' %>"
                                                                                                                class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-gray-500 focus:border-gray-500 shadow-sm">
                                                                                                            <% } %>
                                                                                                </td>
                                                                                            </tr>
                                                                                            <% }); %>
                                                                                    </tbody>
                                                                                </table>
                                                                            </div>
                                                                        </div>
                                                                        <% } %>
                                                                            <% }); %>
                            </div>

                            <!-- Save Button -->
                            <div
                                class="flex items-center justify-end gap-4 bg-white p-5 rounded-xl shadow-lg border border-gray-200 mt-6">
                                <a href="/"
                                    class="px-6 py-2.5 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-semibold transition-all text-sm">
                                    <i class="fas fa-times mr-2"></i>Batal
                                </a>
                                <button type="submit"
                                    class="px-8 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 flex items-center font-semibold shadow-lg hover:shadow-xl transition-all text-sm">
                                    <i class="fas fa-save mr-2"></i>Simpan Pengaturan
                                </button>
                            </div>
                        </form>
</div>

<script>
    // Update toggle switch visual and text when clicked
    document.addEventListener('DOMContentLoaded', function () {
        // Find all toggle switches
        const toggleCheckboxes = document.querySelectorAll('input.toggle-checkbox');

        toggleCheckboxes.forEach(function (checkbox) {
            // Get the toggle container and status span
            const toggleContainer = checkbox.closest('label');
            const toggleDiv = toggleContainer ? toggleContainer.querySelector('.relative.w-10') : null;
            const dotDiv = toggleDiv ? toggleDiv.querySelector('.absolute') : null;
            const statusSpan = toggleContainer ? toggleContainer.querySelector('span.toggle-status') : null;

            // Initial state
            updateToggleVisual(checkbox, toggleDiv, dotDiv, statusSpan);

            // Add change event listener
            checkbox.addEventListener('change', function () {
                updateToggleVisual(this, toggleDiv, dotDiv, statusSpan);
            });
        });
    });

    function updateToggleVisual(checkbox, toggleDiv, dotDiv, statusSpan) {
        // Update toggle background color
        if (toggleDiv) {
            const card = checkbox.closest('.bg-white');
            if (card) {
                const header = card.querySelector('[class*="bg-gradient"]');
                if (header) {
                    const headerClass = header.className;
                    if (checkbox.checked) {
                        toggleDiv.classList.remove('bg-slate-300');
                        if (headerClass.includes('purple') || headerClass.includes('indigo')) {
                            toggleDiv.classList.add('bg-blue-600');
                        } else if (headerClass.includes('orange') || headerClass.includes('yellow')) {
                            toggleDiv.classList.add('bg-emerald-500');
                        } else if (headerClass.includes('blue') && headerClass.includes('indigo')) {
                            toggleDiv.classList.add('bg-red-500');
                        } else if (headerClass.includes('green') || headerClass.includes('emerald')) {
                            toggleDiv.classList.add('bg-teal-600');
                        } else {
                            toggleDiv.classList.add('bg-blue-600');
                        }
                    } else {
                        toggleDiv.classList.remove('bg-blue-600', 'bg-emerald-500', 'bg-red-500', 'bg-teal-600');
                        toggleDiv.classList.add('bg-amber-400');
                    }
                }
            }
        }

        // Update dot position (translate-x-5 untuk w-10, sebelumnya w-11)
        if (dotDiv) {
            if (checkbox.checked) {
                dotDiv.classList.remove('translate-x-0');
                dotDiv.classList.add('translate-x-5');
            } else {
                dotDiv.classList.remove('translate-x-5');
                dotDiv.classList.add('translate-x-0');
            }
        }

        // Update status text
        if (statusSpan) {
            if (checkbox.checked) {
                statusSpan.textContent = 'Aktif';
                statusSpan.classList.remove('text-gray-700');
                statusSpan.classList.add('text-green-600', 'font-semibold');
            } else {
                statusSpan.textContent = 'Nonaktif';
                statusSpan.classList.remove('text-green-600', 'font-semibold');
                statusSpan.classList.add('text-gray-700');
            }
        }
    }
</script>