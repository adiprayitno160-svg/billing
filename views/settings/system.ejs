<!-- System Settings Page -->
<div class="container-fluid">
    <!-- Flash Messages -->
    <% if (typeof success !=='undefined' && success) { %>
        <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 rounded-lg shadow-sm">
            <div class="flex items-center">
                <i class="fas fa-check-circle text-green-500 text-xl mr-3"></i>
                <p class="text-green-800 font-medium">
                    <%= success %>
                </p>
            </div>
        </div>
        <% } %>

            <% if (typeof error !=='undefined' && error) { %>
                <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <i class="fas fa-exclamation-circle text-red-500 text-xl mr-3"></i>
                        <p class="text-red-800 font-medium">
                            <%= error %>
                        </p>
                    </div>
                </div>
                <% } %>

                    <% // Flatten all settings for easy lookup in Quick Access const
                        allSettings=Object.values(groupedSettings || {}).flat(); const findValue=(key, def)=> {
                        const found = allSettings.find(s => s.setting_key === key);
                        return found ? found.setting_value : def;
                        };

                        // Helper function to convert setting_key to readable label
                        function getReadableLabel(key) {
                        const labels = {
                        'app_version': 'Versi Aplikasi',
                        'grace_period_days': 'Hari Grace Period',
                        'late_payment_threshold': 'Batas Late Payment',
                        'late_payment_rolling_months': 'Bulan Rolling Period',
                        'consecutive_on_time_reset': 'Reset Pembayaran Tepat Waktu',
                        'late_payment_warning_at_3': 'Peringatan di 3x Late Payment',
                        'late_payment_warning_at_4': 'Peringatan Final di 4x Late Payment',
                        'auto_isolate_enabled': 'Aktifkan Auto Isolate',
                        'auto_restore_enabled': 'Aktifkan Auto Restore',
                        'auto_notifications_enabled': 'Aktifkan Auto Notifications',
                        'auto_logout_enabled': 'Aktifkan Auto Logout (10 Menit)',
                        'domain_url': 'URL Domain',
                        'local_url': 'URL Lokal',
                        'domain_mode_enabled': 'Aktifkan Domain Mode',
                        'local_mode_enabled': 'Aktifkan Local Mode',
                        'ppn_enabled': 'Aktifkan PPN',
                        'ppn_rate': 'Rate PPN (%)',
                        'device_rental_enabled': 'Aktifkan Sewa Perangkat',
                        'device_rental_fee': 'Biaya Sewa Perangkat',
                        'bank_name': 'Nama Bank',
                        'bank_account_number': 'Nomor Rekening',
                        'bank_account_name': 'Atas Nama Rekening',
                        'multiple_banks_enabled': 'Aktifkan Banyak Bank',
                        'payment_banks': 'Daftar Bank Pembayaran'
                        };
                        return labels[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        }
                        %>

                        <!-- Form -->
                        <form action="/settings/system" method="POST">
                            <div class="space-y-6">

                                <!-- Quick Access: Billing & Tax -->
                                <div
                                    class="bg-gradient-to-r from-orange-500 to-red-600 rounded-xl shadow-lg overflow-hidden border border-orange-400">
                                    <div class="px-5 py-3 flex items-center justify-between text-white">
                                        <h3 class="text-lg font-bold flex items-center">
                                            <i class="fas fa-bolt mr-2 text-yellow-300"></i>
                                            Pengaturan Cepat: Pajak & Sewa Alat
                                        </h3>
                                        <span class="text-xs bg-white/20 px-2 py-1 rounded">Update Harga & PPN</span>
                                    </div>
                                    <div class="p-5 bg-orange-50/50 grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <!-- PPN Quick Setting -->
                                        <div class="bg-white p-4 rounded-lg shadow-sm border border-orange-200">
                                            <label class="block text-sm font-bold text-gray-700 mb-2">Rate PPN
                                                (%)</label>
                                            <div class="relative">
                                                <input type="number" name="ppn_rate"
                                                    value="<%= findValue('ppn_rate', '11') %>"
                                                    class="w-full pl-3 pr-10 py-2 border-2 border-orange-100 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg font-bold text-gray-800">
                                                <div
                                                    class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none">
                                                    <span class="text-gray-500 font-bold">%</span>
                                                </div>
                                            </div>
                                            <p class="text-[10px] text-gray-500 mt-1 italic">* Contoh: 11 untuk 11%</p>
                                        </div>

                                        <!-- Device Rental Quick Setting -->
                                        <div class="bg-white p-4 rounded-lg shadow-sm border border-orange-200">
                                            <label class="block text-sm font-bold text-gray-700 mb-2">Harga Sewa Alat
                                                (Rp)</label>
                                            <div class="relative">
                                                <div
                                                    class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                                    <span class="text-gray-500 font-bold">Rp</span>
                                                </div>
                                                <input type="number" name="device_rental_fee"
                                                    value="<%= findValue('device_rental_fee', '0') %>"
                                                    class="w-full pl-10 pr-3 py-2 border-2 border-orange-100 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 text-lg font-bold text-gray-800">
                                            </div>
                                            <p class="text-[10px] text-gray-500 mt-1 italic">* Contoh: 50000</p>
                                        </div>
                                    </div>
                                    <!-- Bank Information -->
                                    <div
                                        class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden mb-6 mt-6">
                                        <div
                                            class="bg-gradient-to-r from-blue-700 to-cyan-600 text-white px-5 py-4 flex justify-between items-center">
                                            <h3 class="text-lg font-bold flex items-center">
                                                <i class="fas fa-university mr-2"></i>
                                                Daftar Rekening Pembayaran
                                            </h3>
                                            <button type="button" onclick="addBankRow()"
                                                class="px-3 py-1.5 bg-white/20 hover:bg-white/30 text-white text-xs font-bold rounded-lg flex items-center gap-1 transition-all">
                                                <i class="fas fa-plus"></i> Tambah Bank
                                            </button>
                                        </div>

                                        <div class="p-5">
                                            <div id="multipleBanksSection">
                                                <p class="text-sm text-gray-600 mb-4">Kelola daftar rekening bank yang
                                                    akan muncul di invoice pelanggan :</p>

                                                <div id="bankListContainer" class="space-y-3">
                                                    <!-- Dynamic Bank Rows will be here -->
                                                </div>

                                                <input type="hidden" name="multiple_banks_enabled" value="true">
                                                <input type="hidden" name="payment_banks" id="paymentBanksJson"
                                                    value="<%= findValue('payment_banks', '[]') %>">
                                            </div>
                                        </div>
                                    </div>

                                    <% if (groupedSettings && groupedSettings.general) { %>
                                        <div
                                            class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                            <div
                                                class="bg-gradient-to-r from-purple-600 to-indigo-600 text-white px-5 py-4">
                                                <h3 class="text-lg font-bold flex items-center">
                                                    <i class="fas fa-cog mr-2"></i>
                                                    Umum
                                                </h3>
                                            </div>
                                            <div class="p-5">
                                                <table class="w-full">
                                                    <tbody class="divide-y divide-gray-200">
                                                        <% groupedSettings.general.forEach(function(setting) { %>
                                                            <tr class="hover:bg-gray-50">
                                                                <td class="py-3 pr-4">
                                                                    <label
                                                                        class="block text-sm font-semibold text-gray-700 mb-1">
                                                                        <%= getReadableLabel(setting.setting_key) %>
                                                                    </label>
                                                                    <% if (setting.setting_description) { %>
                                                                        <p class="text-xs text-gray-500 mt-0.5">
                                                                            <%= setting.setting_description %>
                                                                        </p>
                                                                        <% } %>
                                                                </td>
                                                                <td class="py-3 w-72">
                                                                    <% if (setting.setting_value==='true' ||
                                                                        setting.setting_value==='false' ) { %>
                                                                        <input type="hidden"
                                                                            name="<%= setting.setting_key %>"
                                                                            value="false">
                                                                        <label
                                                                            class="relative inline-flex items-center cursor-pointer">
                                                                            <input type="checkbox"
                                                                                name="<%= setting.setting_key %>"
                                                                                value="true"
                                                                                class="sr-only peer toggle-checkbox"
                                                                                <%=setting.setting_value==='true'
                                                                                ? 'checked' : '' %>>
                                                                            <div
                                                                                class="relative w-10 h-5 bg-amber-400 rounded-full peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:bg-blue-600 transition-colors duration-200">
                                                                                <div
                                                                                    class="absolute top-[2px] left-[2px] bg-white border border-amber-500 rounded-full h-4 w-4 transition-transform duration-200 peer-checked:translate-x-5 shadow-md">
                                                                                </div>
                                                                            </div>
                                                                            <span
                                                                                class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                                <%= setting.setting_value==='true'
                                                                                    ? 'Aktif' : 'Nonaktif' %>
                                                                            </span>
                                                                        </label>
                                                                        <% } else { %>
                                                                            <input type="text"
                                                                                name="<%= setting.setting_key %>"
                                                                                value="<%= setting.setting_value || '' %>"
                                                                                class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500 shadow-sm">
                                                                            <% } %>
                                                                </td>
                                                            </tr>
                                                            <% }); %>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                        <!-- WhatsApp Settings (New) -->
                                        <div
                                            class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden mb-6">
                                            <div
                                                class="bg-gradient-to-r from-teal-600 to-green-600 text-white px-5 py-4">
                                                <h3 class="text-lg font-bold flex items-center">
                                                    <i class="fab fa-whatsapp mr-2"></i>
                                                    Konfigurasi WhatsApp Bot
                                                </h3>
                                            </div>
                                            <div class="p-5">
                                                <div class="mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-500 rounded">
                                                    <p class="text-sm text-yellow-800">
                                                        <strong>Info:</strong> Masukkan nomor HP Owner/Tester di bawah
                                                        ini
                                                        agar Bot mengenali Anda meskipun menggunakan akun yang sama
                                                        (mengatasi masalah LID / ID Aneh).
                                                    </p>
                                                </div>
                                                <div class="grid grid-cols-1 gap-6">
                                                    <div>
                                                        <label
                                                            class="block text-sm font-bold text-gray-700 mb-2">WhatsApp
                                                            Tester Numbers (Comma Separated)</label>
                                                        <input type="text" name="whatsapp_tester_numbers"
                                                            value="<%= findValue('whatsapp_tester_numbers', '63729093849223,089678630707') %>"
                                                            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 shadow-sm"
                                                            placeholder="Contoh: 63729093849223, 0812345678, 62896...">
                                                        <p class="text-xs text-gray-500 mt-1">Masukkan ID LID atau Nomor
                                                            HP,
                                                            pisahkan dengan koma.</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <% } %>

                                            <!-- URL Settings (Domain & Local) -->
                                            <% if (groupedSettings && groupedSettings.url) { %>
                                                <div
                                                    class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                                    <div
                                                        class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-5 py-4">
                                                        <h3 class="text-lg font-bold flex items-center">
                                                            <i class="fas fa-network-wired mr-2"></i>
                                                            Konfigurasi URL (Domain & Lokal)
                                                        </h3>
                                                    </div>
                                                    <div class="p-5">
                                                        <div
                                                            class="mb-4 p-4 bg-blue-50 border-l-4 border-blue-500 rounded">
                                                            <p class="text-sm text-blue-800">
                                                                <i class="fas fa-info-circle mr-2"></i>
                                                                <strong>Info:</strong> Anda dapat mengaktifkan kedua
                                                                mode
                                                                (Domain dan Lokal) secara bersamaan.
                                                                Sistem akan menggunakan URL yang sesuai berdasarkan
                                                                konfigurasi.
                                                            </p>
                                                        </div>
                                                        <table class="w-full">
                                                            <tbody class="divide-y divide-gray-200">
                                                                <% groupedSettings.url.forEach(function(setting) { %>
                                                                    <tr class="hover:bg-gray-50">
                                                                        <td class="py-3 pr-4">
                                                                            <label
                                                                                class="block text-sm font-semibold text-gray-700 mb-1">
                                                                                <%= getReadableLabel(setting.setting_key)
                                                                                    %>
                                                                            </label>
                                                                            <% if (setting.setting_description) { %>
                                                                                <p class="text-xs text-gray-500 mt-0.5">
                                                                                    <%= setting.setting_description %>
                                                                                </p>
                                                                                <% } %>
                                                                        </td>
                                                                        <td class="py-3 w-72">
                                                                            <% if (setting.setting_value==='true' ||
                                                                                setting.setting_value==='false' ) { %>
                                                                                <input type="hidden"
                                                                                    name="<%= setting.setting_key %>"
                                                                                    value="false">
                                                                                <label
                                                                                    class="relative inline-flex items-center cursor-pointer">
                                                                                    <input type="checkbox"
                                                                                        name="<%= setting.setting_key %>"
                                                                                        value="true"
                                                                                        class="sr-only peer toggle-checkbox"
                                                                                        <%=setting.setting_value==='true'
                                                                                        ? 'checked' : '' %>>
                                                                                    <div
                                                                                        class="relative w-10 h-5 bg-amber-400 rounded-full peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-indigo-300 peer-checked:bg-indigo-600 transition-colors duration-200">
                                                                                        <div
                                                                                            class="absolute top-[2px] left-[2px] bg-white border border-amber-500 rounded-full h-4 w-4 transition-transform duration-200 peer-checked:translate-x-5 shadow-md">
                                                                                        </div>
                                                                                    </div>
                                                                                    <span
                                                                                        class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                                        <%= setting.setting_value==='true'
                                                                                            ? 'Aktif' : 'Nonaktif' %>
                                                                                    </span>
                                                                                </label>
                                                                                <% } else if
                                                                                    (setting.setting_key==='domain_url'
                                                                                    || setting.setting_key==='local_url'
                                                                                    ) { %>
                                                                                    <input type="url"
                                                                                        name="<%= setting.setting_key %>"
                                                                                        value="<%= setting.setting_value || '' %>"
                                                                                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono shadow-sm"
                                                                                        placeholder="<%= setting.setting_key === 'domain_url' ? 'https://billing.example.com' : 'http://localhost:3000' %>">
                                                                                    <% } else { %>
                                                                                        <input type="text"
                                                                                            name="<%= setting.setting_key %>"
                                                                                            value="<%= setting.setting_value || '' %>"
                                                                                            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                                                                                        <% } %>
                                                                        </td>
                                                                    </tr>
                                                                    <% }); %>
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                                <% } %>



                                                    <!-- Late Payment Settings -->
                                                    <% if (groupedSettings && groupedSettings.late_payment) { %>
                                                        <div
                                                            class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                                            <div
                                                                class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-5 py-4">
                                                                <h3 class="text-lg font-bold flex items-center">
                                                                    <i class="fas fa-exclamation-triangle mr-2"></i>
                                                                    Late Payment
                                                                </h3>
                                                            </div>
                                                            <div class="p-5">
                                                                <table class="w-full">
                                                                    <tbody class="divide-y divide-gray-200">
                                                                        <% groupedSettings.late_payment.forEach(function(setting)
                                                                            { %>
                                                                            <tr class="hover:bg-gray-50">
                                                                                <td class="py-3 pr-4">
                                                                                    <label
                                                                                        class="block text-sm font-semibold text-gray-700 mb-1">
                                                                                        <%= getReadableLabel(setting.setting_key)
                                                                                            %>
                                                                                    </label>
                                                                                    <% if (setting.setting_description)
                                                                                        { %>
                                                                                        <p
                                                                                            class="text-xs text-gray-500 mt-0.5">
                                                                                            <%= setting.setting_description
                                                                                                %>
                                                                                        </p>
                                                                                        <% } %>
                                                                                </td>
                                                                                <td class="py-3 w-72">
                                                                                    <% if
                                                                                        (setting.setting_value==='true'
                                                                                        ||
                                                                                        setting.setting_value==='false'
                                                                                        || setting.setting_value==='1'
                                                                                        || setting.setting_value==='0' )
                                                                                        { %>
                                                                                        <input type="hidden"
                                                                                            name="<%= setting.setting_key %>"
                                                                                            value="0">
                                                                                        <label
                                                                                            class="relative inline-flex items-center cursor-pointer">
                                                                                            <input type="checkbox"
                                                                                                name="<%= setting.setting_key %>"
                                                                                                value="1"
                                                                                                class="sr-only peer toggle-checkbox"
                                                                                                <%=(setting.setting_value==='true'
                                                                                                ||
                                                                                                setting.setting_value==='1'
                                                                                                ) ? 'checked' : '' %>>
                                                                                            <div
                                                                                                class="relative w-10 h-5 bg-amber-400 rounded-full peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-red-300 peer-checked:bg-red-500 transition-colors duration-200">
                                                                                                <div
                                                                                                    class="absolute top-[2px] left-[2px] bg-white border border-amber-500 rounded-full h-4 w-4 transition-transform duration-200 peer-checked:translate-x-5 shadow-md">
                                                                                                </div>
                                                                                            </div>
                                                                                            <span
                                                                                                class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                                                <%= (setting.setting_value==='true'
                                                                                                    ||
                                                                                                    setting.setting_value==='1'
                                                                                                    ) ? 'Aktif'
                                                                                                    : 'Nonaktif' %>
                                                                                            </span>
                                                                                        </label>
                                                                                        <% } else { %>
                                                                                            <input type="number"
                                                                                                name="<%= setting.setting_key %>"
                                                                                                value="<%= setting.setting_value || '' %>"
                                                                                                class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 shadow-sm"
                                                                                                min="0">
                                                                                            <% } %>
                                                                                </td>
                                                                            </tr>
                                                                            <% }); %>
                                                                    </tbody>
                                                                </table>
                                                            </div>
                                                        </div>
                                                        <% } %>

                                                            <!-- Billing Settings -->
                                                            <% if (groupedSettings && groupedSettings.billing) { %>
                                                                <div
                                                                    class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                                                    <div
                                                                        class="bg-gradient-to-r from-green-600 to-emerald-600 text-white px-5 py-4">
                                                                        <h3 class="text-lg font-bold flex items-center">
                                                                            <i
                                                                                class="fas fa-file-invoice-dollar mr-2"></i>
                                                                            Billing, Pajak & Biaya Alat
                                                                        </h3>
                                                                    </div>
                                                                    <div class="p-5">
                                                                        <table class="w-full">
                                                                            <tbody class="divide-y divide-gray-200">
                                                                                <% groupedSettings.billing.forEach(function(setting)
                                                                                    { %>
                                                                                    <tr class="hover:bg-gray-50">
                                                                                        <td class="py-3 pr-4">
                                                                                            <label
                                                                                                class="block text-sm font-semibold text-gray-700 mb-1">
                                                                                                <%= getReadableLabel(setting.setting_key)
                                                                                                    %>
                                                                                            </label>
                                                                                            <% if
                                                                                                (setting.setting_description)
                                                                                                { %>
                                                                                                <p
                                                                                                    class="text-xs text-gray-500 mt-0.5">
                                                                                                    <%= setting.setting_description
                                                                                                        %>
                                                                                                </p>
                                                                                                <% } %>
                                                                                        </td>
                                                                                        <td class="py-3 w-72">
                                                                                            <% if
                                                                                                (setting.setting_value==='true'
                                                                                                ||
                                                                                                setting.setting_value==='false'
                                                                                                ) { %>
                                                                                                <input type="hidden"
                                                                                                    name="<%= setting.setting_key %>"
                                                                                                    value="false">
                                                                                                <label
                                                                                                    class="relative inline-flex items-center cursor-pointer">
                                                                                                    <input
                                                                                                        type="checkbox"
                                                                                                        name="<%= setting.setting_key %>"
                                                                                                        value="true"
                                                                                                        class="sr-only peer"
                                                                                                        <%=setting.setting_value==='true'
                                                                                                        ? 'checked' : ''
                                                                                                        %>>
                                                                                                    <div
                                                                                                        class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600">
                                                                                                    </div>
                                                                                                    <span
                                                                                                        class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                                                        <%= setting.setting_value==='true'
                                                                                                            ? 'Aktif'
                                                                                                            : 'Nonaktif'
                                                                                                            %>
                                                                                                    </span>
                                                                                                </label>
                                                                                                <% } else { %>
                                                                                                    <input type="text"
                                                                                                        name="<%= setting.setting_key %>"
                                                                                                        value="<%= setting.setting_value || '' %>"
                                                                                                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500 shadow-sm">
                                                                                                    <% } %>
                                                                                        </td>
                                                                                    </tr>
                                                                                    <% }); %>
                                                                            </tbody>
                                                                        </table>
                                                                    </div>
                                                                </div>
                                                                <% } %>

                                                                    <!-- Other Categories -->
                                                                    <% Object.keys(groupedSettings ||
                                                                        {}).forEach(function(category) { %>
                                                                        <% if (category !=='late_payment' && category
                                                                            !=='billing' && category !=='general' &&
                                                                            category !=='url' ) { %>
                                                                            <div
                                                                                class="bg-white border border-gray-200 rounded-xl shadow-lg overflow-hidden">
                                                                                <div
                                                                                    class="bg-gradient-to-r from-gray-700 to-gray-800 text-white px-5 py-4">
                                                                                    <h3
                                                                                        class="text-lg font-bold capitalize">
                                                                                        <%= category.replace(/_/g, ' ' )
                                                                                            %>
                                                                                    </h3>
                                                                                </div>
                                                                                <div class="p-5">
                                                                                    <table class="w-full">
                                                                                        <tbody
                                                                                            class="divide-y divide-gray-200">
                                                                                            <% groupedSettings[category].forEach(function(setting)
                                                                                                { %>
                                                                                                <tr
                                                                                                    class="hover:bg-gray-50">
                                                                                                    <td
                                                                                                        class="py-3 pr-4">
                                                                                                        <label
                                                                                                            class="block text-sm font-semibold text-gray-700 mb-1">
                                                                                                            <%= getReadableLabel(setting.setting_key)
                                                                                                                %>
                                                                                                        </label>
                                                                                                        <% if
                                                                                                            (setting.setting_description)
                                                                                                            { %>
                                                                                                            <p
                                                                                                                class="text-xs text-gray-500 mt-0.5">
                                                                                                                <%= setting.setting_description
                                                                                                                    %>
                                                                                                            </p>
                                                                                                            <% } %>
                                                                                                    </td>
                                                                                                    <td
                                                                                                        class="py-3 w-72">
                                                                                                        <% if
                                                                                                            (setting.setting_value==='true'
                                                                                                            ||
                                                                                                            setting.setting_value==='false'
                                                                                                            ) { %>
                                                                                                            <input
                                                                                                                type="hidden"
                                                                                                                name="<%= setting.setting_key %>"
                                                                                                                value="false">
                                                                                                            <label
                                                                                                                class="relative inline-flex items-center cursor-pointer">
                                                                                                                <input
                                                                                                                    type="checkbox"
                                                                                                                    name="<%= setting.setting_key %>"
                                                                                                                    value="true"
                                                                                                                    class="sr-only peer toggle-checkbox"
                                                                                                                    <%=setting.setting_value==='true'
                                                                                                                    ? 'checked'
                                                                                                                    : ''
                                                                                                                    %>>
                                                                                                                <div
                                                                                                                    class="relative w-10 h-5 bg-amber-400 rounded-full peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-teal-300 peer-checked:bg-teal-600 transition-colors duration-200">
                                                                                                                    <div
                                                                                                                        class="absolute top-[2px] left-[2px] bg-white border border-amber-500 rounded-full h-4 w-4 transition-transform duration-200 peer-checked:translate-x-5 shadow-md">
                                                                                                                    </div>
                                                                                                                </div>
                                                                                                                <span
                                                                                                                    class="ml-3 text-sm font-medium text-gray-700 toggle-status">
                                                                                                                    <%= setting.setting_value==='true'
                                                                                                                        ? 'Aktif'
                                                                                                                        : 'Nonaktif'
                                                                                                                        %>
                                                                                                                </span>
                                                                                                            </label>
                                                                                                            <% } else {
                                                                                                                %>
                                                                                                                <input
                                                                                                                    type="text"
                                                                                                                    name="<%= setting.setting_key %>"
                                                                                                                    value="<%= setting.setting_value || '' %>"
                                                                                                                    class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-gray-500 focus:border-gray-500 shadow-sm">
                                                                                                                <% } %>
                                                                                                    </td>
                                                                                                </tr>
                                                                                                <% }); %>
                                                                                        </tbody>
                                                                                    </table>
                                                                                </div>
                                                                            </div>
                                                                            <% } %>
                                                                                <% }); %>
                                </div>

                                <!-- Save Button -->
                                <div
                                    class="flex items-center justify-end gap-4 bg-white p-5 rounded-xl shadow-lg border border-gray-200 mt-6">
                                    <a href="/"
                                        class="px-6 py-2.5 border-2 border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-semibold transition-all text-sm">
                                        <i class="fas fa-times mr-2"></i>Batal
                                    </a>
                                    <button type="submit"
                                        class="px-8 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-lg hover:from-blue-700 hover:to-indigo-700 flex items-center font-semibold shadow-lg hover:shadow-xl transition-all text-sm">
                                        <i class="fas fa-save mr-2"></i>Simpan Pengaturan
                                    </button>
                                </div>
                        </form>

                        <!-- Application Update Section -->
                        <div class="bg-white border border-gray-200 rounded-xl shadow-xl overflow-hidden mt-10 mb-10">
                            <div
                                class="bg-gradient-to-r from-slate-800 to-slate-900 text-white px-6 py-4 flex justify-between items-center">
                                <h3 class="text-lg font-bold flex items-center">
                                    <i class="fas fa-microchip mr-2 text-cyan-400"></i>
                                    System Engine & Update
                                </h3>
                                <div class="flex items-center gap-3">
                                    <span id="versionBadge"
                                        class="px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider bg-slate-700 text-slate-300">
                                        Checking...
                                    </span>
                                </div>
                            </div>
                            <div class="p-8">
                                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                                    <div class="lg:col-span-3">
                                        <div class="flex flex-col md:flex-row md:items-center gap-6 mb-6">
                                            <div
                                                class="p-4 bg-gray-50 rounded-2xl border border-gray-100 flex items-center gap-4 flex-1">
                                                <div
                                                    class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-blue-600">
                                                    <i class="fas fa-code-branch text-xl"></i>
                                                </div>
                                                <div>
                                                    <p class="text-[10px] font-bold text-gray-400 uppercase">Versi
                                                        Terpasang</p>
                                                    <p class="text-xl font-black text-gray-800"
                                                        id="currentVersionDisplay">v1.0.0</p>
                                                </div>
                                            </div>
                                            <div
                                                class="p-4 bg-gray-50 rounded-2xl border border-gray-100 flex items-center gap-4 flex-1">
                                                <div
                                                    class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-purple-600">
                                                    <i class="fas fa-history text-xl"></i>
                                                </div>
                                                <div>
                                                    <p class="text-[10px] font-bold text-gray-400 uppercase">Status
                                                        Commit</p>
                                                    <p class="text-xs font-medium text-gray-600 truncate max-w-[200px]"
                                                        id="lastCommitDisplay">Memuat data...</p>
                                                </div>
                                            </div>
                                        </div>

                                        <div id="updateStatusMsg"
                                            class="p-4 bg-blue-50 border border-blue-100 rounded-xl text-blue-700 text-sm flex items-start gap-3">
                                            <i class="fas fa-info-circle text-lg mt-0.5"></i>
                                            <div class="flex-1">
                                                <p class="font-semibold">Informasi Sistem</p>
                                                <p class="opacity-80">Klik tombol "Cek Update" untuk melihat apakah ada
                                                    versi kode baru yang tersedia di repositori.</p>
                                            </div>
                                        </div>

                                        <div id="remoteDetailsBox" class="hidden mt-6 animate-fadeIn">
                                            <h4
                                                class="text-xs font-bold text-gray-400 uppercase mb-3 flex items-center gap-2">
                                                <i class="fas fa-list-ul"></i> Catatan Perubahan Terbaru
                                            </h4>
                                            <div class="p-4 bg-slate-900 rounded-xl border border-slate-800 text-cyan-400 text-xs font-mono whitespace-pre-wrap leading-relaxed shadow-2xl"
                                                id="remoteDetailsContent"></div>
                                        </div>
                                    </div>

                                    <div class="flex flex-col gap-3">
                                        <button type="button" id="checkUpdateBtn" onclick="checkUpdate()"
                                            class="w-full px-6 py-4 bg-white border border-gray-200 text-gray-700 rounded-xl hover:border-blue-500 hover:text-blue-600 transition-all shadow-sm font-bold flex items-center justify-center gap-3 group">
                                            <i
                                                class="fas fa-sync-alt group-hover:rotate-180 transition-transform duration-700"></i>
                                            Cek Sekarang
                                        </button>

                                        <button type="button" id="performUpdateBtn" onclick="confirmUpdate()"
                                            class="hidden w-full px-6 py-4 bg-gradient-to-br from-blue-600 to-indigo-700 text-white rounded-xl hover:shadow-lg hover:shadow-blue-500/40 transition-all font-bold flex items-center justify-center gap-3 transform hover:-translate-y-1">
                                            <i class="fas fa-download"></i>
                                            Update Sistem
                                        </button>

                                        <p class="text-[10px] text-gray-400 text-center italic mt-2">
                                            Pastikan koneksi internet stabil sebelum melakukan update kode.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
</div>

<script>
    // Update toggle switch visual and text when clicked
    document.addEventListener('DOMContentLoaded', function () {
        // Find all toggle switches
        const toggleCheckboxes = document.querySelectorAll('input.toggle-checkbox');

        toggleCheckboxes.forEach(function (checkbox) {
            // Get the toggle container and status span
            const toggleContainer = checkbox.closest('label');
            const toggleDiv = toggleContainer ? toggleContainer.querySelector('.relative.w-10') : null;
            const dotDiv = toggleDiv ? toggleDiv.querySelector('.absolute') : null;
            const statusSpan = toggleContainer ? toggleContainer.querySelector('span.toggle-status') : null;

            // Initial state
            updateToggleVisual(checkbox, toggleDiv, dotDiv, statusSpan);

            // Add change event listener
            checkbox.addEventListener('change', function () {
                updateToggleVisual(this, toggleDiv, dotDiv, statusSpan);
            });
        });
    });

    function updateToggleVisual(checkbox, toggleDiv, dotDiv, statusSpan) {
        // Update toggle background color
        if (toggleDiv) {
            const card = checkbox.closest('.bg-white');
            if (card) {
                const header = card.querySelector('[class*="bg-gradient"]');
                if (header) {
                    const headerClass = header.className;
                    if (checkbox.checked) {
                        toggleDiv.classList.remove('bg-slate-300');
                        if (headerClass.includes('purple') || headerClass.includes('indigo')) {
                            toggleDiv.classList.add('bg-blue-600');
                        } else if (headerClass.includes('orange') || headerClass.includes('yellow')) {
                            toggleDiv.classList.add('bg-emerald-500');
                        } else if (headerClass.includes('blue') && headerClass.includes('indigo')) {
                            toggleDiv.classList.add('bg-red-500');
                        } else if (headerClass.includes('green') || headerClass.includes('emerald')) {
                            toggleDiv.classList.add('bg-teal-600');
                        } else {
                            toggleDiv.classList.add('bg-blue-600');
                        }
                    } else {
                        toggleDiv.classList.remove('bg-blue-600', 'bg-emerald-500', 'bg-red-500', 'bg-teal-600');
                        toggleDiv.classList.add('bg-amber-400');
                    }
                }
            }
        }

        // Update dot position (translate-x-5 untuk w-10, sebelumnya w-11)
        if (dotDiv) {
            if (checkbox.checked) {
                dotDiv.classList.remove('translate-x-0');
                dotDiv.classList.add('translate-x-5');
            } else {
                dotDiv.classList.remove('translate-x-5');
                dotDiv.classList.add('translate-x-0');
            }
        }

        // Update status text
        if (statusSpan) {
            if (checkbox.checked) {
                statusSpan.textContent = 'Aktif';
                statusSpan.classList.remove('text-gray-700');
                statusSpan.classList.add('text-green-600', 'font-semibold');
            } else {
                statusSpan.textContent = 'Nonaktif';
                statusSpan.classList.remove('text-green-600', 'font-semibold');
                statusSpan.classList.add('text-gray-700');
            }
        }
    }

    // --- Application Update Logic ---
    function checkUpdate() {
        const btn = document.getElementById('checkUpdateBtn');
        const statusMsg = document.getElementById('updateStatusMsg');
        const versionBadge = document.getElementById('versionBadge');

        if (!btn) return; // Guard clause if element missing

        // Show loading state
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i>Checking...';
        if (statusMsg) {
            statusMsg.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sedang memeriksa update...';
            statusMsg.className = 'mt-4 p-3 bg-gray-50 text-gray-800 rounded-lg text-sm border border-gray-200 flex items-start';
        }

        fetch('/settings/system/check-update', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Cek Lagi';

                const currentVerElem = document.getElementById('currentVersionDisplay');
                if (currentVerElem) currentVerElem.textContent = data.currentVersion || 'Unknown';

                const lastCommitElem = document.getElementById('lastCommitDisplay');
                if (lastCommitElem) lastCommitElem.textContent = data.lastCommit ? `Commit Terakhir: ${data.lastCommit}` : '';

                if (data.success) {
                    if (data.hasUpdate) {
                        // LOGIC: Auto update if NOT major, otherwise show notification
                        if (!data.isMajor) {
                            // AUTO UPDATE (MINOR)
                            if (versionBadge) {
                                versionBadge.textContent = 'Auto Updating...';
                                versionBadge.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800 animate-pulse';
                            }
                            if (statusMsg) {
                                statusMsg.innerHTML = '<i class="fas fa-magic mr-2"></i>Update minor ditemukan. Sedang melakukan update otomatis...';
                                statusMsg.className = 'mt-4 p-3 bg-purple-50 text-purple-800 rounded-lg text-sm border border-purple-200 flex items-start';
                            }
                            // Trigger performUpdate automatically
                            performUpdate();
                            return;
                        }

                        // MAJOR UPDATE - Manual Action Required
                        if (versionBadge) {
                            versionBadge.textContent = 'Versi Baru Tersedia';
                            versionBadge.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 animate-pulse';
                        }

                        if (statusMsg) {
                            statusMsg.innerHTML = `
                                    <div class="flex-1">
                                        <div class="font-bold text-amber-800 mb-1"><i class="fas fa-exclamation-circle mr-2"></i>Versi Baru Tersedia (${data.remoteVersion})</div>
                                        <div class="text-amber-700">Terdapat perubahan signifikan (Versi Mayor). Silakan lakukan update manual.</div>
                                    </div>
                                `;
                            statusMsg.className = 'mt-4 p-3 bg-amber-50 text-amber-800 rounded-lg text-sm border border-amber-200 flex items-start';
                        }

                        // Show update button
                        const updateBtn = document.getElementById('performUpdateBtn');
                        if (updateBtn) updateBtn.classList.remove('hidden');

                        // Show remote details
                        if (data.remoteDetails) {
                            const detailsBox = document.getElementById('remoteDetailsBox');
                            const detailsContent = document.getElementById('remoteDetailsContent');
                            if (detailsBox) detailsBox.classList.remove('hidden');
                            if (detailsContent) detailsContent.textContent = data.remoteDetails;
                        }
                    } else {
                        // Up to date
                        if (versionBadge) {
                            versionBadge.textContent = 'Versi Terbaru';
                            versionBadge.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800';
                        }

                        if (statusMsg) {
                            statusMsg.innerHTML = '<i class="fas fa-check-circle mr-2"></i>' + data.message;
                            statusMsg.className = 'mt-4 p-3 bg-green-50 text-green-800 rounded-lg text-sm border border-green-200 flex items-start';
                        }

                        const updateBtn = document.getElementById('performUpdateBtn');
                        const detailsBox = document.getElementById('remoteDetailsBox');

                        if (updateBtn) updateBtn.classList.add('hidden');
                        if (detailsBox) detailsBox.classList.add('hidden');
                    }
                } else {
                    // Error handled in logic but request success
                    throw new Error(data.error || 'Unknown error');
                }
            })
            .catch(err => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Coba Lagi';

                if (statusMsg) {
                    statusMsg.innerHTML = '<i class="fas fa-times-circle mr-2"></i>Gagal cek update: ' + (err.message || 'Unknown error');
                    statusMsg.className = 'mt-4 p-3 bg-red-50 text-red-800 rounded-lg text-sm border border-red-200 flex items-start';
                }

                if (versionBadge) {
                    versionBadge.textContent = 'Error';
                    versionBadge.className = 'px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800';
                }
            });
    }

    // --- Dynamic Bank List Logic ---
    let bankList = [];
    try {
        const rawJson = document.getElementById('paymentBanksJson').value;
        bankList = JSON.parse(rawJson || '[]');
    } catch (e) {
        bankList = [];
    }

    function renderBankList() {
        const container = document.getElementById('bankListContainer');
        container.innerHTML = '';

        if (bankList.length === 0) {
            container.innerHTML = `<div class="p-8 text-center bg-gray-50 border-2 border-dashed border-gray-200 rounded-lg text-gray-400">
                <i class="fas fa-university text-3xl mb-2"></i>
                <p class="text-sm">Belum ada rekening bank. Klik "Tambah Bank" di atas.</p>
            </div>`;
            return;
        }

        bankList.forEach((bank, index) => {
            const row = document.createElement('div');
            row.className = 'flex flex-col md:flex-row gap-3 p-4 bg-gray-50 rounded-lg border border-gray-200 shadow-sm relative group';
            row.innerHTML = `
                <div class="flex-1">
                    <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Nama Bank</label>
                    <input type="text" value="${bank.name || ''}" onchange="updateBank(${index}, 'name', this.value)"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 shadow-sm" placeholder="Contoh: BCA / Mandiri">
                </div>
                <div class="flex-1">
                    <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Nomor Rekening</label>
                    <input type="text" value="${bank.account_number || ''}" onchange="updateBank(${index}, 'account_number', this.value)"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 shadow-sm" placeholder="Contoh: 123456789">
                </div>
                <div class="flex-1">
                    <label class="block text-[10px] uppercase font-bold text-gray-400 mb-1">Atas Nama</label>
                    <input type="text" value="${bank.account_name || ''}" onchange="updateBank(${index}, 'account_name', this.value)"
                        class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-blue-500 shadow-sm" placeholder="Contoh: PT ISP NET">
                </div>
                <div class="flex items-end justify-end">
                    <button type="button" onclick="removeBankRow(${index})" 
                        class="p-2.5 bg-red-100 text-red-600 rounded-md hover:bg-red-600 hover:text-white transition-all">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            `;
            container.appendChild(row);
        });
    }

    function addBankRow() {
        bankList.push({ name: '', account_number: '', account_name: '' });
        syncBankData();
        renderBankList();
    }

    function removeBankRow(index) {
        bankList.splice(index, 1);
        syncBankData();
        renderBankList();
    }

    function updateBank(index, field, value) {
        bankList[index][field] = value;
        syncBankData();
    }

    function syncBankData() {
        document.getElementById('paymentBanksJson').value = JSON.stringify(bankList);
    }



    // Initial render
    renderBankList();

    function confirmUpdate() {
        if (confirm('APAKAH ANDA YAKIN?\n\nAplikasi akan melakukan update kode dari GitHub dan melakukan restart otomatis.\n\nPASTIKAN INTERNET LANCAR.\nLayanan akan terputus selama beberapa detik.')) {
            performUpdate();
        }
    }

    function performUpdate() {
        const btn = document.getElementById('performUpdateBtn');
        const statusMsg = document.getElementById('updateStatusMsg');

        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i>Updating...';
        }

        if (statusMsg) {
            statusMsg.innerHTML = `
                <div class="flex-1">
                    <div class="font-bold text-blue-800 mb-1"><i class="fas fa-cog fa-spin mr-2"></i>Sedang Melakukan Update...</div>
                    <div class="text-blue-700">Mohon jangan tutup halaman ini. Proses ini meliputi download kode, build, dan restart aplikasi.</div>
                </div>
            `;
            statusMsg.className = 'mt-4 p-3 bg-blue-50 text-blue-800 rounded-lg text-sm border border-blue-200 flex items-start';
        }

        fetch('/settings/system/perform-update', { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    if (statusMsg) {
                        statusMsg.innerHTML = `
                            <div class="flex-1">
                                <div class="font-bold text-green-800 mb-1"><i class="fas fa-check-circle mr-2"></i>Update Berhasil!</div>
                                <div class="text-green-700">${data.message}</div>
                                <div class="mt-2 text-xs text-green-600">Halaman akan reload otomatis dalam 20 detik...</div>
                            </div>
                        `;
                        statusMsg.className = 'mt-4 p-3 bg-green-50 text-green-800 rounded-lg text-sm border border-green-200 flex items-start';
                    }

                    // Reload page after delay
                    setTimeout(() => {
                        window.location.reload();
                    }, 20000);
                } else {
                    throw new Error(data.error);
                }
            })
            .catch(err => {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="fas fa-download mr-2"></i>Update Sekarang';
                }

                if (statusMsg) {
                    statusMsg.innerHTML = `
                        <div class="flex-1">
                            <div class="font-bold text-red-800 mb-1"><i class="fas fa-times-circle mr-2"></i>Update Gagal</div>
                            <div class="text-red-700">${err.message}</div>
                        </div>
                    `;
                    statusMsg.className = 'mt-4 p-3 bg-red-50 text-red-800 rounded-lg text-sm border border-red-200 flex items-start';
                }
            });
    }

    // Auto check on load
    document.addEventListener('DOMContentLoaded', function () {
        setTimeout(checkUpdate, 1000); // Small delay to let page load
    });
</script>