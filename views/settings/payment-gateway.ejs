<div class="space-y-6">
  <!-- Header -->
  <div class="rounded-2xl border border-indigo-200 bg-gradient-to-br from-indigo-50 to-sky-50 p-6">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-xl font-bold text-indigo-900">Pengaturan Payment Gateway</h2>
        <p class="text-indigo-700/80 mt-1 text-sm">Kelola kredensial dan preferensi integrasi pembayaran.</p>
      </div>
      <div class="hidden sm:flex items-center gap-2 text-xs text-indigo-700/70">
        <span class="px-2 py-1 rounded-full border border-indigo-200 bg-white">Secure Input</span>
        <span class="px-2 py-1 rounded-full border border-sky-200 bg-white">Webhook Ready</span>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Form -->
    <div class="lg:col-span-2">
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
        <form method="post" action="/settings/payment-gateway" class="space-y-6">
          <!-- Provider Selection -->
          <div>
            <label class="block text-sm font-semibold mb-2 text-slate-800">Provider Payment</label>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-3" id="providerCards">
              <label class="group flex items-center gap-2 p-3 border rounded-lg hover:border-indigo-300 cursor-pointer">
                <input type="radio" name="provider" value="midtrans" class="accent-indigo-600" />
                <span class="inline-flex items-center gap-2 text-sm">
                  <span class="inline-block w-4 h-4 rounded bg-indigo-600 group-hover:opacity-90" aria-hidden="true"></span>
                  Midtrans
                </span>
              </label>
              <label class="group flex items-center gap-2 p-3 border rounded-lg hover:border-indigo-300 cursor-pointer">
                <input type="radio" name="provider" value="xendit" class="accent-indigo-600" />
                <span class="inline-flex items-center gap-2 text-sm">
                  <span class="inline-block w-4 h-4 rounded bg-sky-500 group-hover:opacity-90" aria-hidden="true"></span>
                  Xendit
                </span>
              </label>
              <label class="group flex items-center gap-2 p-3 border rounded-lg hover:border-indigo-300 cursor-pointer">
                <input type="radio" name="provider" value="doku" class="accent-indigo-600" />
                <span class="inline-flex items-center gap-2 text-sm">
                  <span class="inline-block w-4 h-4 rounded bg-rose-500 group-hover:opacity-90" aria-hidden="true"></span>
                  DOKU
                </span>
              </label>
              <label class="group flex items-center gap-2 p-3 border rounded-lg hover:border-indigo-300 cursor-pointer">
                <input type="radio" name="provider" value="manual" class="accent-indigo-600" />
                <span class="inline-flex items-center gap-2 text-sm">
                  <span class="inline-block w-4 h-4 rounded bg-slate-400 group-hover:opacity-90" aria-hidden="true"></span>
                  Manual
                </span>
              </label>
            </div>
            <div id="providerHelper" class="mt-3 hidden rounded-lg border border-indigo-200 bg-indigo-50 text-indigo-900 text-sm p-3"></div>
          </div>

          <!-- Credentials -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">API Key</label>
              <input type="password" name="api_key" class="w-full border border-slate-300 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200 rounded px-3 py-2 outline-none transition bg-white" placeholder="Masukkan API Key" />
              <p class="text-xs text-slate-500 mt-1">Disediakan oleh dashboard provider.</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Secret Key</label>
              <input type="password" name="secret_key" class="w-full border border-slate-300 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200 rounded px-3 py-2 outline-none transition bg-white" placeholder="Masukkan Secret Key" />
              <p class="text-xs text-slate-500 mt-1">Jaga kerahasiaan kredensial Anda.</p>
            </div>
          </div>

          <!-- Webhook & Callback -->
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Webhook URL</label>
              <input type="url" name="webhook_url" class="w-full border border-slate-300 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200 rounded px-3 py-2 outline-none transition bg-white" placeholder="https://domain.com/webhook/payment" />
              <p class="text-xs text-slate-500 mt-1">Endpoint untuk menerima notifikasi pembayaran.</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700 mb-1">Callback URL (opsional)</label>
              <input type="url" name="callback_url" class="w-full border border-slate-300 focus:border-indigo-400 focus:ring-2 focus:ring-indigo-200 rounded px-3 py-2 outline-none transition bg-white" placeholder="https://domain.com/payment/callback" />
              <p class="text-xs text-slate-500 mt-1">Halaman redirect setelah pembayaran.</p>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex items-center gap-3">
            <button type="submit" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg shadow-sm transition">Simpan Pengaturan</button>
            <button type="button" id="btnTestGateway" class="px-4 py-2 border border-slate-300 text-slate-700 hover:bg-slate-50 rounded-lg transition">Test Koneksi</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Side Panel: Tips & Status -->
    <div>
      <div class="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm space-y-4">
        <h3 class="text-base font-semibold text-slate-900">Status & Tips</h3>
        <div class="text-sm text-slate-600">
          <p>• Pastikan API key/secret sesuai dengan mode (sandbox/production).</p>
          <p>• Daftarkan Webhook URL di dashboard provider.</p>
          <p>• Gunakan jam server yang sinkron (NTP) untuk tanda tangan yang valid.</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">Mode</label>
          <div class="flex items-center gap-3 text-sm">
            <label class="flex items-center gap-2"><input type="radio" name="mode" value="sandbox" class="accent-indigo-600" /> Sandbox</label>
            <label class="flex items-center gap-2"><input type="radio" name="mode" value="production" class="accent-indigo-600" /> Production</label>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const testBtn = document.getElementById('btnTestGateway');
  const providerHelper = document.getElementById('providerHelper');
  const providerRadios = document.querySelectorAll('input[name="provider"]');
  const tips = {
    midtrans: {
      title: 'Midtrans Tips',
      items: [
        'Gunakan Server Key untuk server, Client Key hanya di frontend.',
        'Pastikan Notification URL (Webhook) diaktifkan pada dashboard Midtrans.',
        'Uji transaksi dengan mode Sandbox sebelum Production.'
      ]
    },
    xendit: {
      title: 'Xendit Tips',
      items: [
        'API key berbentuk "xnd_development_..." (sandbox) atau "xnd_production_...".',
        'Whitelist domain aplikasi Anda di dashboard Xendit.',
        'Gunakan callback virtual account untuk update status pembayaran.'
      ]
    },
    doku: {
      title: 'DOKU Tips',
      items: [
        'Pastikan Mall ID/Merchant ID sesuai dengan environment.',
        'Periksa signature generation sesuai dokumentasi.',
        'Uji notifikasi pembayaran dari dashboard DOKU.'
      ]
    },
    manual: {
      title: 'Manual Transfer Tips',
      items: [
        'Cantumkan instruksi transfer dan SLA verifikasi.',
        'Sediakan form unggah bukti transfer.',
        'Gunakan verifikasi manual atau semi otomatis.'
      ]
    }
  };

  function renderTips(provider){
    if (!providerHelper) return;
    const cfg = tips[provider];
    if (!cfg) { providerHelper.classList.add('hidden'); providerHelper.innerHTML=''; return; }
    providerHelper.classList.remove('hidden');
    providerHelper.innerHTML = `
      <div class="font-semibold mb-1">${cfg.title}</div>
      <ul class="list-disc pl-5 space-y-1">
        ${cfg.items.map(i=>`<li>${i}</li>`).join('')}
      </ul>
    `;
  }

  providerRadios.forEach(r => {
    r.addEventListener('change', function(){ renderTips(this.value); });
  });

  if (testBtn) {
    testBtn.addEventListener('click', async function(){
      testBtn.disabled = true;
      testBtn.textContent = 'Testing...';
      try {
        const form = this.closest('form');
        const formData = new FormData(form);
        const payload = Object.fromEntries(formData.entries());
        const res = await fetch('/payment/test', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await res.json().catch(()=>({}));
        alert(res.ok ? 'Koneksi OK' : ('Gagal: ' + (data.error || res.status)));
      } catch (e) {
        console.error(e);
        alert('Gagal menguji koneksi');
      } finally {
        testBtn.disabled = false;
        testBtn.textContent = 'Test Koneksi';
      }
    });
  }
});
</script>
