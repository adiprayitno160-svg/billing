<div class="space-y-6">
    <!-- Page Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-monitor-heart-rate mr-3 text-blue-600"></i>
            Dashboard Monitoring
        </h1>
        <p class="text-gray-600">Monitor status pelanggan PPPoE dan Static IP secara real-time</p>
    </div>

    <!-- System Health Section -->
    <div class="mb-8">
        <div class="flex flex-wrap gap-4">
            <% if (typeof healthInfo !=='undefined' && healthInfo.length> 0) { %>
                <% healthInfo.forEach(item=> {
                    let icon = 'fa-thermometer-half';
                    let colorClass = 'text-blue-600';
                    let bgClass = 'bg-blue-100';
                    let valueSuffix = '';

                    if (item.name && typeof item.name === 'string' && item.name.toLowerCase().includes('temperature')) {
                    valueSuffix = '°C';
                    if (parseFloat(item.value) > 60) {
                    colorClass = 'text-red-600'; bgClass = 'bg-red-100';
                    } else if (parseFloat(item.value) > 50) {
                    colorClass = 'text-orange-600'; bgClass = 'bg-orange-100';
                    }
                    } else if (item.name && typeof item.name === 'string' &&
                    item.name.toLowerCase().includes('voltage')) {
                    icon = 'fa-bolt';
                    valueSuffix = 'V';
                    }
                    %>
                    <div
                        class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex items-center gap-4 min-w-[180px]">
                        <div class="w-10 h-10 <%= bgClass %> rounded-lg flex items-center justify-center">
                            <i class="fas <%= icon %> text-lg <%= colorClass %>"></i>
                        </div>
                        <div>
                            <p class="text-[10px] text-gray-500 uppercase font-bold tracking-wider">
                                <%= item.name %>
                            </p>
                            <h4 class="text-lg font-bold text-gray-800">
                                <%= item.value %>
                                    <%= valueSuffix %>
                            </h4>
                        </div>
                    </div>
                    <% }); %>
                        <% } %>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Total PPPoE -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Total PPPoE</p>
                    <h3 class="text-3xl font-bold text-gray-800">
                        <%= pppoeStats.total %>
                    </h3>
                </div>
                <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-users text-2xl text-blue-600"></i>
                </div>
            </div>
            <div class="mt-4 text-sm">
                <span class="text-green-600 font-medium">
                    <%= pppoeStats.active %> Active
                </span>
                <span class="text-gray-400 mx-2">•</span>
                <span class="text-red-600 font-medium">
                    <%= pppoeStats.isolated %> Isolated
                </span>
            </div>
        </div>

        <!-- Online PPPoE -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">PPPoE Online</p>
                    <h3 class="text-3xl font-bold text-green-600">
                        <%= onlinePPPoE %>
                    </h3>
                </div>
                <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-signal text-2xl text-green-600"></i>
                </div>
            </div>
            <div class="mt-4">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-600 h-2 rounded-full transition-all duration-300"
                        style="width: <%= pppoeStats.total > 0 ? (onlinePPPoE / pppoeStats.total * 100).toFixed(1) : 0 %>%">
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-1">
                    <%= pppoeStats.total> 0 ? (onlinePPPoE / pppoeStats.total * 100).toFixed(1) : 0 %>% dari
                        total PPPoE
                </p>
            </div>
        </div>

        <!-- Total Static IP -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Total Static IP</p>
                    <h3 class="text-3xl font-bold text-gray-800">
                        <%= staticIpStats.total %>
                    </h3>
                </div>
                <div class="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-network-wired text-2xl text-purple-600"></i>
                </div>
            </div>
            <div class="mt-4 text-sm">
                <span class="text-green-600 font-medium">
                    <%= staticIpStats.active %> Active
                </span>
                <span class="text-gray-400 mx-2">•</span>
                <span class="text-gray-600 font-medium">
                    <%= staticIpStats.total - staticIpStats.active %> Inactive
                </span>
            </div>
        </div>

        <!-- Total All -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-600 mb-1">Total Semua Pelanggan</p>
                    <h3 class="text-3xl font-bold text-gray-800">
                        <%= pppoeStats.total + staticIpStats.total %>
                    </h3>
                </div>
                <div class="w-14 h-14 bg-orange-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-chart-pie text-2xl text-orange-600"></i>
                </div>
            </div>
            <div class="mt-4 text-sm">
                <span class="text-blue-600 font-medium">
                    <%= pppoeStats.total %> PPPoE
                </span>
                <span class="text-gray-400 mx-2">•</span>
                <span class="text-purple-600 font-medium">
                    <%= staticIpStats.total %> Static IP
                </span>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- PPPoE Monitoring -->
        <a href="/monitoring/pppoe"
            class="block bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-users-line mr-2 text-blue-600"></i>
                    Monitor PPPoE
                </h3>
                <i class="fas fa-arrow-right text-gray-400"></i>
            </div>
            <p class="text-gray-600 text-sm mb-4">
                Monitor status koneksi, session aktif, dan bandwidth pelanggan PPPoE
            </p>
            <div class="flex items-center text-sm">
                <span
                    class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                    <%= onlinePPPoE %> Online
                </span>
                <span class="ml-2 text-gray-500">dari <%= pppoeStats.total %> total</span>
            </div>
        </a>

        <!-- Static IP Monitoring -->
        <a href="/monitoring/static-ip"
            class="block bg-white rounded-xl shadow-sm border border-gray-200 p-6 hover:shadow-lg transition-shadow duration-200">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-network-wired mr-2 text-purple-600"></i>
                    Monitor Static IP
                </h3>
                <i class="fas fa-arrow-right text-gray-400"></i>
            </div>
            <p class="text-gray-600 text-sm mb-4">
                Monitor status dan konektivitas pelanggan dengan Static IP
            </p>
            <div class="flex items-center text-sm">
                <span
                    class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                    <%= staticIpStats.active %> Active
                </span>
                <span class="ml-2 text-gray-500">dari <%= staticIpStats.total %> total</span>
            </div>
        </a>
    </div>

    <!-- Bandwidth & AI Monitoring Section -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
        <!-- Bandwidth Stats -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                    Bandwidth Usage
                </h3>
                <button onclick="loadBandwidthStats()" class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="bandwidthStats" class="space-y-4">
                <div class="flex items-center justify-center py-8">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-3xl text-blue-600 mb-2"></i>
                        <p class="text-gray-600 text-sm">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Alerts -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800">
                    <i class="fas fa-brain mr-2 text-purple-600"></i>
                    AI Alerts
                </h3>
                <button onclick="loadAIAlerts()" class="text-purple-600 hover:text-purple-800">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>
            <div id="aiAlerts" class="space-y-4">
                <div class="flex items-center justify-center py-8">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-3xl text-purple-600 mb-2"></i>
                        <p class="text-gray-600 text-sm">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Info -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-xl p-4">
        <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 text-xl mt-1 mr-3"></i>
            <div>
                <h4 class="font-semibold text-blue-900 mb-1">Informasi Monitoring</h4>
                <p class="text-sm text-blue-800">
                    Data monitoring diambil secara real-time dari MikroTik Router dan database.
                    Status online PPPoE diambil dari active session di MikroTik.
                    Refresh halaman untuk mendapatkan data terbaru.
                </p>
            </div>
        </div>
    </div>
</div>

<script>
    // Load bandwidth stats on page load
    loadBandwidthStats();
    loadAIAlerts();

    // Auto refresh setiap 30 detik
    setTimeout(() => {
        location.reload();
    }, 30000);

    // Load bandwidth statistics
    async function loadBandwidthStats() {
        try {
            const response = await fetch('/monitoring/analytics/bandwidth?days=1');
            const result = await response.json();

            if (result.success && result.data.summary) {
                const summary = result.data.summary.today;
                const statsHtml = `
                <div class="space-y-3">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-xs text-blue-600 mb-1">Total Today</p>
                                <h3 class="text-2xl font-bold text-blue-700">
                                    ${formatBytes(summary.total_bytes)}
                                </h3>
                            </div>
                            <div class="w-12 h-12 bg-blue-200 rounded-full flex items-center justify-center">
                                <i class="fas fa-server text-blue-600"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-green-50 rounded-lg p-3">
                            <p class="text-xs text-green-600 mb-1">Upload</p>
                            <p class="text-sm font-semibold text-green-700">
                                ${formatBytes(summary.bytes_out)}
                            </p>
                        </div>
                        <div class="bg-orange-50 rounded-lg p-3">
                            <p class="text-xs text-orange-600 mb-1">Download</p>
                            <p class="text-sm font-semibold text-orange-700">
                                ${formatBytes(summary.bytes_in)}
                            </p>
                        </div>
                    </div>
                    
                    <div class="text-xs text-gray-500 text-center">
                        ${summary.customer_count} pelanggan aktif
                    </div>
                </div>
            `;
                document.getElementById('bandwidthStats').innerHTML = statsHtml;
            } else {
                document.getElementById('bandwidthStats').innerHTML = `
                <div class="text-center py-4 text-gray-500">
                    <i class="fas fa-exclamation-circle text-2xl mb-2"></i>
                    <p class="text-sm">Data tidak tersedia</p>
                </div>
            `;
            }
        } catch (error) {
            console.error('Error loading bandwidth stats:', error);
            document.getElementById('bandwidthStats').innerHTML = `
            <div class="text-center py-4 text-red-500">
                <i class="fas fa-times-circle text-2xl mb-2"></i>
                <p class="text-sm">Gagal memuat data</p>
            </div>
        `;
        }
    }

    // Load AI alerts/anomalies
    async function loadAIAlerts() {
        try {
            const response = await fetch('/monitoring/analytics/anomalies');
            const result = await response.json();

            if (result.success && result.data.length > 0) {
                let alertsHtml = '';
                result.data.forEach(anomaly => {
                    const severityClass = {
                        'critical': 'bg-red-100 border-red-300 text-red-700',
                        'major': 'bg-orange-100 border-orange-300 text-orange-700',
                        'minor': 'bg-yellow-100 border-yellow-300 text-yellow-700'
                    }[anomaly.severity] || 'bg-gray-100 border-gray-300 text-gray-700';

                    const icon = {
                        'critical': '🔴',
                        'major': '🟠',
                        'minor': '🟡'
                    }[anomaly.severity] || '⚪';

                    alertsHtml += `
                    <div class="border-l-4 ${severityClass.split(' ')[1]} bg-white rounded-lg p-3">
                        <div class="flex items-start">
                            <span class="text-xl mr-2">${icon}</span>
                            <div class="flex-1">
                                <p class="text-sm font-semibold">${getMetricName(anomaly.metric)}</p>
                                <p class="text-xs text-gray-600 mt-1">
                                    Anomaly Score: ${Math.round(anomaly.anomaly_score)}%
                                </p>
                                <p class="text-xs text-gray-600">
                                    Current: ${anomaly.current_value.toFixed(1)}
                                </p>
                            </div>
                        </div>
                    </div>
                `;
                });
                document.getElementById('aiAlerts').innerHTML = alertsHtml;
            } else {
                document.getElementById('aiAlerts').innerHTML = `
                <div class="text-center py-4 text-green-600">
                    <i class="fas fa-check-circle text-3xl mb-2"></i>
                    <p class="text-sm font-medium">Tidak ada anomali terdeteksi</p>
                    <p class="text-xs text-gray-500 mt-1">Semua sistem berjalan normal</p>
                </div>
            `;
            }
        } catch (error) {
            console.error('Error loading AI alerts:', error);
            document.getElementById('aiAlerts').innerHTML = `
            <div class="text-center py-4 text-gray-500">
                <i class="fas fa-times-circle text-2xl mb-2"></i>
                <p class="text-sm">Gagal memuat alerts</p>
            </div>
        `;
        }
    }

    // Helper: Format bytes
    function formatBytes(bytes) {
        if (!bytes) return '0 B';
        if (bytes >= 1099511627776) return (bytes / 1099511627776).toFixed(2) + ' TB';
        if (bytes >= 1073741824) return (bytes / 1073741824).toFixed(2) + ' GB';
        if (bytes >= 1048576) return (bytes / 1048576).toFixed(2) + ' MB';
        if (bytes >= 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return bytes + ' B';
    }

    // Helper: Get metric name
    function getMetricName(metric) {
        const names = {
            'downtime_count': 'Downtime Spike',
            'avg_latency': 'Latency Degradation',
            'packet_loss': 'Packet Loss Spike',
            'bandwidth_usage': 'Bandwidth Saturation'
        };
        return names[metric] || metric;
    }
</script>