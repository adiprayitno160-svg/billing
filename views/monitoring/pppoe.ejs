<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Billing System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <%- include('../partials/navbar') %>
    
    <div class="flex">
        <main class="flex-1 p-6 lg:p-8 max-w-7xl mx-auto w-full">
            <!-- Page Header -->
            <div class="mb-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                    <div>
                        <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2 flex items-center">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-users-line text-white text-xl"></i>
                            </div>
                            Monitor PPPoE
                        </h1>
                        <p class="text-gray-600 ml-16">Monitor status dan koneksi pelanggan PPPoE secara real-time</p>
                    </div>
                    <div class="flex gap-2 ml-16 sm:ml-0">
                        <button onclick="location.reload()" class="px-4 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200 shadow-sm flex items-center gap-2">
                            <i class="fas fa-sync-alt"></i>
                            <span class="hidden sm:inline">Refresh</span>
                        </button>
                        <a href="/monitoring/dashboard" class="px-4 py-2.5 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-all duration-200 shadow-sm flex items-center gap-2">
                            <i class="fas fa-arrow-left"></i>
                            <span class="hidden sm:inline">Kembali</span>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Stats Summary Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6 mb-8">
                <!-- Total Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-users text-blue-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">TOTAL</span>
                    </div>
                    <div class="text-3xl font-bold text-gray-900 mb-1"><%= pagination.totalCount %></div>
                    <div class="text-sm text-gray-500">Total Pelanggan</div>
                </div>

                <!-- Online Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-green-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-signal text-green-600 text-xl animate-pulse-slow"></i>
                        </div>
                        <span class="text-xs font-semibold text-green-600 bg-green-50 px-3 py-1 rounded-full">ONLINE</span>
                    </div>
                    <div class="text-3xl font-bold text-green-600 mb-1">
                        <%= customers.filter(c => c.is_online).length %>
                    </div>
                    <div class="text-sm text-gray-500">Sedang Terhubung</div>
                </div>

                <!-- Offline Card -->
                <div class="bg-white rounded-2xl shadow-sm border border-red-200 p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
                            <i class="fas fa-signal-slash text-red-600 text-xl"></i>
                        </div>
                        <span class="text-xs font-semibold text-red-600 bg-red-50 px-3 py-1 rounded-full">OFFLINE</span>
                    </div>
                    <div class="text-3xl font-bold text-red-600 mb-1">
                        <%= customers.filter(c => !c.is_online).length %>
                    </div>
                    <div class="text-sm text-gray-500">Tidak Terhubung</div>
                </div>

                <!-- Uptime Rate Card -->
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-2xl shadow-lg p-6 text-white hover:shadow-xl transition-shadow duration-200">
                    <div class="flex items-center justify-between mb-4">
                        <div class="w-12 h-12 bg-white bg-opacity-20 rounded-xl flex items-center justify-center">
                            <i class="fas fa-chart-line text-white text-xl"></i>
                        </div>
                        <span class="text-xs font-semibold bg-white bg-opacity-20 px-3 py-1 rounded-full">RATE</span>
                    </div>
                    <div class="text-3xl font-bold mb-1">
                        <%= customers.length > 0 ? ((customers.filter(c => c.is_online).length / customers.length) * 100).toFixed(1) : 0 %>%
                    </div>
                    <div class="text-sm text-purple-100">Uptime Rate</div>
                    <div class="mt-3 bg-white bg-opacity-20 rounded-full h-2">
                        <div class="bg-white rounded-full h-2 transition-all duration-500" 
                             style="width: <%= customers.length > 0 ? ((customers.filter(c => c.is_online).length / customers.length) * 100).toFixed(1) : 0 %>%">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6 mb-6">
                <div class="flex items-center mb-4">
                    <i class="fas fa-filter text-gray-400 mr-2"></i>
                    <h3 class="font-semibold text-gray-700">Filter & Pencarian</h3>
                </div>
                <form method="GET" action="/monitoring/pppoe" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Status Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-toggle-on text-gray-400 mr-1"></i>
                            Status
                        </label>
                        <select name="status" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white transition-all">
                            <option value="">Semua Status</option>
                            <option value="active" <%= filters.status === 'active' ? 'selected' : '' %>>✓ Active</option>
                            <option value="inactive" <%= filters.status === 'inactive' ? 'selected' : '' %>>✗ Inactive</option>
                            <option value="suspended" <%= filters.status === 'suspended' ? 'selected' : '' %>>⏸ Suspended</option>
                        </select>
                    </div>

                    <!-- ODC Filter -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-map-marker-alt text-gray-400 mr-1"></i>
                            Area ODC
                        </label>
                        <select name="odc_id" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white transition-all">
                            <option value="">Semua ODC</option>
                            <% odcList.forEach(odc => { %>
                                <option value="<%= odc.id %>" <%= filters.odc_id == odc.id ? 'selected' : '' %>>
                                    <%= odc.name %>
                                </option>
                            <% }); %>
                        </select>
                    </div>

                    <!-- Search -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-search text-gray-400 mr-1"></i>
                            Pencarian
                        </label>
                        <input type="text" name="search" value="<%= filters.search %>" 
                               placeholder="Nama, kode, username..." 
                               class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all">
                    </div>

                    <!-- Buttons -->
                    <div class="flex items-end gap-2">
                        <button type="submit" class="flex-1 px-6 py-2.5 bg-gradient-to-r from-blue-600 to-blue-700 text-white rounded-lg hover:from-blue-700 hover:to-blue-800 transition-all duration-200 shadow-sm font-medium">
                            <i class="fas fa-search mr-2"></i>Cari
                        </button>
                        <a href="/monitoring/pppoe" class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all duration-200">
                            <i class="fas fa-redo"></i>
                        </a>
                    </div>
                </form>
            </div>

            <!-- Table Section -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-200 overflow-hidden">
                <!-- Table Header -->
                <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                    <div class="flex items-center justify-between">
                        <h3 class="font-semibold text-gray-800 flex items-center">
                            <i class="fas fa-table text-gray-400 mr-2"></i>
                            Daftar Pelanggan PPPoE
                        </h3>
                        <span class="text-sm text-gray-500">
                            Menampilkan <%= customers.length %> dari <%= pagination.totalCount %> data
                        </span>
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    <i class="fas fa-circle-dot mr-1"></i> Status
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    <i class="fas fa-user mr-1"></i> Pelanggan
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    <i class="fas fa-key mr-1"></i> Username
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    <i class="fas fa-box mr-1"></i> Paket
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    <i class="fas fa-building mr-1"></i> ODC
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    <i class="fas fa-info-circle mr-1"></i> Session
                                </th>
                                <th class="px-6 py-4 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">
                                    <i class="fas fa-cog mr-1"></i> Aksi
                                </th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-100">
                            <% if (customers.length === 0) { %>
                                <tr>
                                    <td colspan="7" class="px-6 py-16 text-center">
                                        <div class="flex flex-col items-center justify-center">
                                            <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
                                                <i class="fas fa-inbox text-4xl text-gray-300"></i>
                                            </div>
                                            <p class="text-gray-500 font-medium mb-1">Tidak ada data pelanggan</p>
                                            <p class="text-sm text-gray-400">Coba ubah filter pencarian</p>
                                        </div>
                                    </td>
                                </tr>
                            <% } else { %>
                                <% customers.forEach((customer, index) => { %>
                                    <tr class="hover:bg-blue-50 transition-colors duration-150 <%= index % 2 === 0 ? 'bg-white' : 'bg-gray-50' %>">
                                        <!-- Status -->
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <% if (customer.is_online) { %>
                                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold bg-green-100 text-green-800 border border-green-200">
                                                    <span class="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></span>
                                                    Online
                                                </span>
                                            <% } else { %>
                                                <span class="inline-flex items-center px-3 py-1.5 rounded-full text-xs font-semibold bg-gray-100 text-gray-700 border border-gray-200">
                                                    <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
                                                    Offline
                                                </span>
                                            <% } %>
                                        </td>

                                        <!-- Customer Info -->
                                        <td class="px-6 py-4">
                                            <div class="flex items-center">
                                                <div class="flex-shrink-0 h-10 w-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-lg flex items-center justify-center text-white font-bold mr-3">
                                                    <%= customer.name ? customer.name.charAt(0).toUpperCase() : '?' %>
                                                </div>
                                                <div>
                                                    <div class="font-semibold text-gray-900"><%= customer.name %></div>
                                                    <div class="text-sm text-gray-500">
                                                        <i class="fas fa-hashtag text-xs"></i> <%= customer.customer_code %>
                                                    </div>
                                                </div>
                                            </div>
                                        </td>

                                        <!-- Username -->
                                        <td class="px-6 py-4">
                                            <code class="text-sm bg-blue-50 text-blue-700 px-3 py-1.5 rounded-lg border border-blue-200 font-mono">
                                                <%= customer.pppoe_username %>
                                            </code>
                                        </td>

                                        <!-- Package -->
                                        <td class="px-6 py-4">
                                            <div class="text-sm font-medium text-gray-900">
                                                <%= customer.package_name || '-' %>
                                            </div>
                                            <% if (customer.rate_limit_rx && customer.rate_limit_tx) { %>
                                                <div class="text-xs text-gray-500 mt-1 flex items-center gap-2">
                                                    <span class="inline-flex items-center">
                                                        <i class="fas fa-download text-green-500 text-xs mr-1"></i>
                                                        <%= customer.rate_limit_rx %>
                                                    </span>
                                                    <span class="text-gray-300">|</span>
                                                    <span class="inline-flex items-center">
                                                        <i class="fas fa-upload text-blue-500 text-xs mr-1"></i>
                                                        <%= customer.rate_limit_tx %>
                                                    </span>
                                                </div>
                                            <% } else { %>
                                                <div class="text-xs text-gray-400 mt-1">No speed limit</div>
                                            <% } %>
                                        </td>

                                        <!-- ODC -->
                                        <td class="px-6 py-4">
                                            <% if (customer.odc_name) { %>
                                                <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200">
                                                    <i class="fas fa-map-marker-alt mr-1.5"></i>
                                                    <%= customer.odc_name %>
                                                </span>
                                            <% } else { %>
                                                <span class="text-gray-400 text-sm">-</span>
                                            <% } %>
                                        </td>

                                        <!-- Session Info -->
                                        <td class="px-6 py-4">
                                            <% if (customer.session_info) { %>
                                                <div class="text-sm">
                                                    <div class="text-gray-900 font-medium mb-1">
                                                        <i class="fas fa-network-wired text-blue-500 text-xs mr-1"></i>
                                                        <%= customer.session_info.address || '-' %>
                                                    </div>
                                                    <div class="text-xs text-gray-500">
                                                        <i class="fas fa-clock text-gray-400 mr-1"></i>
                                                        <%= customer.session_info.uptime || '-' %>
                                                    </div>
                                                </div>
                                            <% } else { %>
                                                <span class="text-gray-400 text-sm">No session</span>
                                            <% } %>
                                        </td>

                                        <!-- Actions -->
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <div class="flex items-center gap-2">
                                                <% if (customer.is_online && customer.session_info) { %>
                                                    <button onclick="disconnectSession('<%= customer.session_info['.id'] %>')" 
                                                            class="inline-flex items-center px-3 py-1.5 bg-red-50 text-red-700 rounded-lg hover:bg-red-100 transition-colors text-sm font-medium border border-red-200" 
                                                            title="Putus Koneksi">
                                                        <i class="fas fa-plug-circle-xmark mr-1.5"></i>
                                                        Putus
                                                    </button>
                                                <% } %>
                                                <a href="/customers/<%= customer.id %>" 
                                                   class="inline-flex items-center px-3 py-1.5 bg-blue-50 text-blue-700 rounded-lg hover:bg-blue-100 transition-colors text-sm font-medium border border-blue-200" 
                                                   title="Lihat Detail">
                                                    <i class="fas fa-eye mr-1.5"></i>
                                                    Detail
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                <% }); %>
                            <% } %>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <% if (pagination.totalPages > 1) { %>
                    <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                            <div class="text-sm text-gray-700">
                                Menampilkan 
                                <span class="font-semibold text-gray-900"><%= ((pagination.currentPage - 1) * pagination.limit) + 1 %></span>
                                - 
                                <span class="font-semibold text-gray-900"><%= Math.min(pagination.currentPage * pagination.limit, pagination.totalCount) %></span>
                                dari 
                                <span class="font-semibold text-gray-900"><%= pagination.totalCount %></span> 
                                hasil
                            </div>
                            <div class="flex gap-1">
                                <% if (pagination.currentPage > 1) { %>
                                    <a href="?page=<%= pagination.currentPage - 1 %>&status=<%= filters.status %>&odc_id=<%= filters.odc_id %>&search=<%= filters.search %>" 
                                       class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 transition-colors bg-white">
                                        <i class="fas fa-chevron-left"></i>
                                    </a>
                                <% } %>
                                
                                <% for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) { %>
                                    <a href="?page=<%= i %>&status=<%= filters.status %>&odc_id=<%= filters.odc_id %>&search=<%= filters.search %>" 
                                       class="px-4 py-2 border rounded-lg text-sm transition-colors <%= i === pagination.currentPage ? 'bg-blue-600 text-white border-blue-600 font-semibold' : 'border-gray-300 hover:bg-gray-100 bg-white' %>">
                                        <%= i %>
                                    </a>
                                <% } %>
                                
                                <% if (pagination.currentPage < pagination.totalPages) { %>
                                    <a href="?page=<%= pagination.currentPage + 1 %>&status=<%= filters.status %>&odc_id=<%= filters.odc_id %>&search=<%= filters.search %>" 
                                       class="px-3 py-2 border border-gray-300 rounded-lg text-sm hover:bg-gray-100 transition-colors bg-white">
                                        <i class="fas fa-chevron-right"></i>
                                    </a>
                                <% } %>
                            </div>
                        </div>
                    </div>
                <% } %>
            </div>

            <!-- Info Footer -->
            <div class="mt-6 bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-xl p-4">
                <div class="flex items-start gap-3">
                    <div class="flex-shrink-0 w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                        <i class="fas fa-info-circle text-blue-600 text-lg"></i>
                    </div>
                    <div class="flex-1">
                        <h4 class="font-semibold text-blue-900 mb-1">Informasi Monitoring</h4>
                        <p class="text-sm text-blue-800">
                            Data monitoring diperbarui secara real-time dari MikroTik Router. 
                            Status <span class="font-semibold">Online</span> menunjukkan pelanggan yang sedang terhubung ke jaringan.
                            Halaman akan refresh otomatis setiap 60 detik.
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        async function disconnectSession(sessionId) {
            if (!confirm('⚠️ Yakin ingin memutus koneksi session ini?\n\nPelanggan akan terputus dari jaringan.')) return;
            
            const button = event.target.closest('button');
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1.5"></i>Memutus...';
            
            try {
                const response = await fetch('/monitoring/disconnect-session', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ sessionId })
                });
                
                const result = await response.json();
                if (result.success) {
                    // Show success message
                    button.innerHTML = '<i class="fas fa-check mr-1.5"></i>Berhasil';
                    button.className = button.className.replace('bg-red-50 text-red-700 border-red-200', 'bg-green-50 text-green-700 border-green-200');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                } else {
                    alert('❌ Gagal: ' + result.message);
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                }
            } catch (error) {
                alert('❌ Error: ' + error.message);
                button.innerHTML = originalHTML;
                button.disabled = false;
            }
        }

        // Auto refresh setiap 60 detik
        let refreshCountdown = 60;
        const refreshInterval = setInterval(() => {
            refreshCountdown--;
            if (refreshCountdown <= 0) {
                location.reload();
            }
        }, 1000);

        // Show countdown in console (optional)
        console.log('Auto-refresh enabled. Page will refresh in 60 seconds.');
    </script>
</body>
</html>
