<div class="rounded border border-slate-200 bg-white p-4">
    <div class="mb-4">
        <h2 class="text-lg font-semibold">Tambah OLT</h2>
    </div>

    <form method="post" action="/ftth/olt" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Nama OLT</label>
                <input type="text" name="name" required
                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Contoh: OLT-01">
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">IP Address</label>
                <input type="text" name="ip_address"
                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="192.168.1.100">
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Lokasi</label>
                <input type="text" name="location"
                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Contoh: Gedung A, Lantai 1">
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                <select name="status"
                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="online">Online</option>
                    <option value="offline">Offline</option>
                    <option value="maintenance">Maintenance</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Total Ports</label>
                <input type="number" name="total_ports" min="1"
                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="64">
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Used Ports</label>
                <input type="number" name="used_ports" min="0"
                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="0">
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Latitude</label>
                <input type="number" step="0.0000001" name="latitude"
                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="-6.2000000">
            </div>

            <div>
                <label class="block text-sm font-medium text-slate-700 mb-1">Longitude</label>
                <input type="number" step="0.0000001" name="longitude"
                    class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="106.8000000">
            </div>
        </div>

        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Deskripsi</label>
            <textarea name="description" rows="3"
                class="w-full px-3 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="Deskripsi OLT (opsional)"></textarea>
        </div>

        <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">Peta Lokasi</label>
            <div id="mapOlt" class="h-64 w-full rounded border border-slate-200 z-10"></div>
            <button type="button" id="btnGetLocation"
                class="mt-2 px-3 py-1.5 text-xs rounded bg-green-600 text-white hover:bg-green-700">Ambil Lokasi Saat
                Ini</button>
        </div>

        <div class="flex gap-2 pt-4">
            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                Simpan
            </button>
            <a href="/ftth/olt" class="px-4 py-2 border border-slate-300 text-slate-700 rounded-md hover:bg-slate-50">
                Batal
            </a>
        </div>
    </form>
</div>

<!-- Leaflet Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        let map, marker;

        function waitForLeaflet() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;

                const checkLeaflet = () => {
                    attempts++;
                    if (typeof L !== 'undefined') {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Leaflet tidak dapat dimuat'));
                    } else {
                        setTimeout(checkLeaflet, 100);
                    }
                };

                checkLeaflet();
            });
        }

        function initMap() {
            try {
                const mapElement = document.getElementById('mapOlt');
                if (!mapElement) return;

                if (mapElement.offsetWidth === 0 || mapElement.offsetHeight === 0) {
                    setTimeout(initMap, 200);
                    return;
                }

                if (map) map.remove();

                map = L.map('mapOlt').setView([-6.2, 106.8], 11);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                marker = L.marker([-6.2, 106.8]).addTo(map);

                const latInput = document.querySelector('input[name="latitude"]');
                const lngInput = document.querySelector('input[name="longitude"]');

                map.on('click', function (e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;

                    marker.setLatLng([lat, lng]);

                    if (latInput) latInput.value = lat.toFixed(7);
                    if (lngInput) lngInput.value = lng.toFixed(7);
                });

                setTimeout(() => { if (map) map.invalidateSize(); }, 100);

                // Auto location if empty
                if ((!latInput || !latInput.value) && (!lngInput || !lngInput.value)) {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(function (position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            if (map) {
                                map.setView([lat, lng], 15);
                                marker.setLatLng([lat, lng]);
                            }
                            if (latInput) latInput.value = lat.toFixed(7);
                            if (lngInput) lngInput.value = lng.toFixed(7);
                        }, function (error) {
                            console.log('Geo error:', error.message);
                        }, { enableHighAccuracy: true });
                    }
                }
            } catch (error) {
                console.error('Map init error:', error);
            }
        }

        const getLocationBtn = document.getElementById('btnGetLocation');
        if (getLocationBtn) {
            getLocationBtn.addEventListener('click', function () {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        if (map) {
                            map.setView([lat, lng], 15);
                            marker.setLatLng([lat, lng]);
                        }
                        const latInput = document.querySelector('input[name="latitude"]');
                        const lngInput = document.querySelector('input[name="longitude"]');
                        if (latInput) latInput.value = lat.toFixed(7);
                        if (lngInput) lngInput.value = lng.toFixed(7);
                    }, function (error) {
                        alert('Error: ' + error.message);
                    });
                } else {
                    alert('Geolocation not supported');
                }
            });
        }

        waitForLeaflet().then(() => {
            setTimeout(initMap, 100);
        }).catch(console.error);
    });
</script>