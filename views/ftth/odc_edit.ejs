<div class="rounded border border-slate-200 bg-white p-4">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Edit ODC</h2>
        <a href="/ftth/odc<%= item.olt_id ? ('?olt_id=' + item.olt_id) : '' %>"
            class="px-3 py-1.5 rounded border border-slate-300 text-sm">Kembali</a>
    </div>
    <form method="post" action="/ftth/odc/<%= item.id %>" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
        <div>
            <label class="block text-xs text-slate-600 mb-1">Pilih OLT</label>
            <select name="olt_id" required class="w-full rounded border border-slate-300 px-2 py-1.5">
                <% (olts || []).forEach(function(olt){ %>
                    <option value="<%= olt.id %>" <%=(item.olt_id==olt.id) ? 'selected' : '' %>><%= olt.name %>
                    </option>
                    <% }) %>
            </select>
        </div>

        <div>
            <label class="block text-xs text-slate-600 mb-1">Pilih Area (Opsional)</label>
            <select name="area_id" class="w-full rounded border border-slate-300 px-2 py-1.5">
                <option value="">-- Pilih Area --</option>
                <% if (typeof areas !=='undefined' && areas.length> 0) { %>
                    <% areas.forEach(function(area){ %>
                        <option value="<%= area.id %>" <%=(item.area_id==area.id) ? 'selected' : '' %>>
                            <%= area.name %> (<%= area.code %>)
                        </option>
                        <% }) %>
                            <% } else { %>
                                <option value="" disabled>Belum ada area (Buat di Master Area)</option>
                                <% } %>
            </select>
        </div>
        <div>
            <label class="block text-xs text-slate-600 mb-1">Nama</label>
            <input name="name" value="<%= item.name %>" required
                class="w-full rounded border border-slate-300 px-2 py-1.5" />
        </div>
        <div>
            <label class="block text-xs text-slate-600 mb-1">Lokasi</label>
            <input name="location" value="<%= item.location || '' %>"
                class="w-full rounded border border-slate-300 px-2 py-1.5" />
        </div>
        <div>
            <label class="block text-xs text-slate-600 mb-1">Latitude</label>
            <input name="latitude" type="number" step="0.0000001" value="<%= item.latitude || '' %>"
                class="w-full rounded border border-slate-300 px-2 py-1.5" />
        </div>
        <div>
            <label class="block text-xs text-slate-600 mb-1">Longitude</label>
            <input name="longitude" type="number" step="0.0000001" value="<%= item.longitude || '' %>"
                class="w-full rounded border border-slate-300 px-2 py-1.5" />
        </div>
        <div>
            <label class="block text-xs text-slate-600 mb-1">Total Port</label>
            <input name="total_ports" type="number" min="0" value="<%= item.total_ports %>" required
                class="w-full rounded border border-slate-300 px-2 py-1.5" />
        </div>
        <div>
            <label class="block text-xs text-slate-600 mb-1">Terpakai (Otomatis)</label>
            <input name="used_ports" type="number" min="0" value="<%= item.used_ports %>" readonly
                class="w-full rounded border border-slate-300 px-2 py-1.5 bg-slate-100 text-slate-500 cursor-not-allowed" />
        </div>
        <div>
            <label class="block text-xs text-slate-600 mb-1">Baris Kartu OLT</label>
            <select name="olt_card" class="w-full rounded border border-slate-300 px-2 py-1.5">
                <option value="">-- Pilih Baris --</option>
                <% (olts || []).forEach(function(olt){ %>
                    <% const maxCards=(olt.line_cards || 0); %>
                        <% for (var c=1; c <=maxCards; c++) { %>
                            <option value="<%= c %>" <%=(item.olt_card==c) ? 'selected' : '' %>>Baris <%= c %> - <%=
                                        olt.name %>
                            </option>
                            <% } %>
                                <% }) %>
            </select>
        </div>
        <div class="sm:col-span-2">
            <label class="block text-xs text-slate-600 mb-1">Catatan</label>
            <textarea name="notes"
                class="w-full rounded border border-slate-300 px-2 py-1.5"><%= item.notes || '' %></textarea>
        </div>

        <div class="sm:col-span-2">
            <label class="block text-xs text-slate-600 mb-1">Peta Lokasi</label>
            <div id="mapOdc" class="h-64 w-full rounded border border-slate-200"></div>
            <button type="button" id="btnGetLocation"
                class="mt-2 px-3 py-1.5 text-xs rounded bg-green-600 text-white hover:bg-green-700">Ambil Lokasi Saat
                Ini</button>
        </div>

        <div class="sm:col-span-2 flex justify-end gap-2">
            <a href="/ftth/odc<%= item.olt_id ? ('?olt_id=' + item.olt_id) : '' %>"
                class="px-3 py-1.5 rounded border border-slate-300">Batal</a>
            <button type="submit" class="px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-700">Simpan</button>
        </div>
    </form>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let map, marker;
        const initialLat = <%= item.latitude || -6.2 %>;
        const initialLng = <%= item.longitude || 106.8 %>;
        const hasLocation = <%= (item.latitude && item.longitude) ? 'true' : 'false' %>;

        function waitForLeaflet() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;

                const checkLeaflet = () => {
                    attempts++;
                    if (typeof L !== 'undefined') {
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error('Leaflet tidak dapat dimuat'));
                    } else {
                        setTimeout(checkLeaflet, 100);
                    }
                };

                checkLeaflet();
            });
        }

        function initMap() {
            try {
                const mapElement = document.getElementById('mapOdc');
                if (!mapElement) return;

                if (mapElement.offsetWidth === 0 || mapElement.offsetHeight === 0) {
                    setTimeout(initMap, 200);
                    return;
                }

                if (map) map.remove();

                map = L.map('mapOdc').setView([initialLat, initialLng], hasLocation ? 15 : 11);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '© OpenStreetMap'
                }).addTo(map);

                marker = L.marker([initialLat, initialLng]).addTo(map);

                const latInput = document.querySelector('input[name="latitude"]');
                const lngInput = document.querySelector('input[name="longitude"]');

                map.on('click', function (e) {
                    const lat = e.latlng.lat;
                    const lng = e.latlng.lng;

                    marker.setLatLng([lat, lng]);

                    if (latInput) latInput.value = lat.toFixed(7);
                    if (lngInput) lngInput.value = lng.toFixed(7);
                });

                setTimeout(() => { if (map) map.invalidateSize(); }, 100);
            } catch (error) {
                console.error('Map init error:', error);
            }
        }

        const getLocationBtn = document.getElementById('btnGetLocation');
        if (getLocationBtn) {
            getLocationBtn.addEventListener('click', function () {
                const btn = this;
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '⏳ Mencari...';

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function (position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        if (map) {
                            map.setView([lat, lng], 15);
                            if (typeof marker !== 'undefined' && marker) {
                                marker.setLatLng([lat, lng]);
                            } else {
                                marker = L.marker([lat, lng]).addTo(map);
                            }
                        }
                        const latInput = document.querySelector('input[name="latitude"]');
                        const lngInput = document.querySelector('input[name="longitude"]');
                        if (latInput) latInput.value = lat.toFixed(7);
                        if (lngInput) lngInput.value = lng.toFixed(7);

                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }, function (error) {
                        let msg = error.message;
                        if (error.code === 1) msg = "Izin lokasi ditolak";
                        else if (error.code === 2) msg = "Posisi tidak tersedia";
                        else if (error.code === 3) msg = "Timeout";

                        alert('Error: ' + msg);
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                } else {
                    alert('Geolocation not supported');
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            });
        }

        waitForLeaflet().then(() => {
            setTimeout(initMap, 100);
        }).catch(console.error);
    });
</script>