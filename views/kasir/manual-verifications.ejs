<%- include('../partials/header', { title }) %>

    <div class="container-fluid px-4">
        <h1 class="mt-4">
            <%= title %>
        </h1>

        <ol class="breadcrumb mb-4">
            <li class="breadcrumb-item"><a href="/kasir/dashboard">Dashboard</a></li>
            <li class="breadcrumb-item active">Verifikasi Manual</li>
        </ol>

        <%- include('../partials/flash') %>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-check-circle me-1"></i>
                    Daftar Bukti Transfer yang Memerlukan Verifikasi
                </div>
                <div class="card-body">
                    <!-- Filter -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <select class="form-select" id="statusFilter">
                                <option value="pending">Pending</option>
                                <option value="approved">Approved</option>
                                <option value="rejected">Rejected</option>
                            </select>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-sm table-hover" id="verificationsTable">
                            <thead>
                                <tr>
                                    <th>Tanggal</th>
                                    <th>Customer</th>
                                    <th>Invoice</th>
                                    <th>Jumlah</th>
                                    <th>Bukti</th>
                                    <th>Gemini AI</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                <tr>
                                    <td colspan="7" class="text-center">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav>
                        <ul class="pagination pagination-sm" id="pagination"></ul>
                    </nav>
                </div>
            </div>
    </div>

    <!-- Preview Modal -->
    <div class="modal fade" id="previewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Preview Bukti Transfer</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="proofImage" src="" class="img-fluid" alt="Bukti Transfer">
                    <div class="mt-3">
                        <h6>Detail Verifikasi:</h6>
                        <div id="verificationDetails"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-danger" id="btnReject">Tolak</button>
                    <button type="button" class="btn btn-success" id="btnApprove">Setujui</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentStatus = 'pending';
        let currentVerificationId = null;

        // Load data
        async function loadVerifications() {
            try {
                const response = await fetch(`/kasir/api/manual-verifications?status=${currentStatus}&page=${currentPage}&limit=20`);
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.message);
                }

                renderTable(result.data);
                renderPagination(result.pagination);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('tableBody').innerHTML = `
            <tr><td colspan="7" class="text-center text-danger">Error: ${error.message}</td></tr>
        `;
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Tidak ada data</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
        <tr>
            <td>${new Date(item.created_at).toLocaleDateString('id-ID')}</td>
            <td>
                <strong>${item.customer_name || '-'}</strong><br>
                <small class="text-muted">${item.customer_code || '-'}</small>
            </td>
            <td>
                ${item.invoice_number || '-'}<br>
                <small class="text-muted">${item.period || '-'}</small>
            </td>
            <td>Rp ${(item.amount || 0).toLocaleString('id-ID')}</td>
            <td>
                <button class="btn btn-sm btn-info" onclick="showProof(${item.id}, '${item.proof_image_path}', ${JSON.stringify(item).replace(/"/g, '&quot;')})">
                    <i class="fas fa-image"></i> Lihat
                </button>
            </td>
            <td>
                ${item.gemini_verified ?
                    `<span class="badge bg-success">Confidence: ${item.confidence_score}%</span>` :
                    `<span class="badge bg-warning">${item.reason || 'Memerlukan review'}</span>`
                }
            </td>
            <td>
                ${item.status === 'pending' ? `
                    <button class="btn btn-sm btn-success" onclick="approve(${item.id})">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="reject(${item.id})">
                        <i class="fas fa-times"></i>
                    </button>
                ` : `
                    <span class="badge bg-${item.status === 'approved' ? 'success' : 'danger'}">
                        ${item.status === 'approved' ? 'Disetujui' : 'Ditolak'}
                    </span>
                `}
            </td>
        </tr>
    `).join('');
        }

        function renderPagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            let html = '';

            for (let i = 1; i <= pagination.pages; i++) {
                html += `
            <li class="page-item ${i === pagination.page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
            </li>
        `;
            }

            paginationEl.innerHTML = html;
        }

        function changePage(page) {
            currentPage = page;
            loadVerifications();
        }

        function showProof(id, imagePath, data) {
            currentVerificationId = id;
            document.getElementById('proofImage').src = imagePath;
            document.getElementById('verificationDetails').innerHTML = `
        <p><strong>Customer:</strong> ${data.customer_name}</p>
        <p><strong>Invoice:</strong> ${data.invoice_number}</p>
        <p><strong>Jumlah:</strong> Rp ${(data.amount || 0).toLocaleString('id-ID')}</p>
        <p><strong>AI Result:</strong> ${data.reason || '-'}</p>
    `;

            new bootstrap.Modal(document.getElementById('previewModal')).show();
        }

        async function approve(id) {
            if (!confirm('Setujui pembayaran ini?')) return;

            try {
                const response = await fetch(`/kasir/manual-verifications/${id}/approve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadVerifications();
                    bootstrap.Modal.getInstance(document.getElementById('previewModal'))?.hide();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function reject(id) {
            const reason = prompt('Alasan penolakan:');
            if (!reason) return;

            try {
                const response = await fetch(`/kasir/manual-verifications/${id}/reject`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ reason })
                });

                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    loadVerifications();
                    bootstrap.Modal.getInstance(document.getElementById('previewModal'))?.hide();
                } else {
                    alert('Error: ' + result.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', (e) => {
            currentStatus = e.target.value;
            currentPage = 1;
            loadVerifications();
        });

        document.getElementById('btnApprove').addEventListener('click', () => {
            if (currentVerificationId) approve(currentVerificationId);
        });

        document.getElementById('btnReject').addEventListener('click', () => {
            if (currentVerificationId) reject(currentVerificationId);
        });

        // Load on page load
        loadVerifications();
    </script>

    <%- include('../partials/footer') %>