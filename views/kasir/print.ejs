<!-- Print Tagihan Individual -->
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-white rounded-xl shadow-sm p-6 border-l-4 border-purple-500">
        <h2 class="text-2xl font-bold text-gray-900 mb-2">
            <i class="fas fa-print text-purple-600 mr-2"></i>
            Print Tagihan Individual
        </h2>
        <p class="text-gray-600">Cari dan print tagihan pelanggan secara individual</p>
    </div>

    <!-- Search Customer -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-search text-purple-600 mr-2"></i>
            Cari Pelanggan
        </h3>
        
        <div class="mb-4">
            <input 
                type="text" 
                id="customerSearch" 
                placeholder="Cari by Customer Code, Nama, No HP..." 
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent text-lg"
                autofocus
            >
        </div>

        <!-- Search Results -->
        <div id="searchResults" class="hidden">
            <div class="border-t pt-4">
                <h4 class="font-semibold text-gray-700 mb-3">Hasil Pencarian:</h4>
                <div id="customerList" class="space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Customer Invoices -->
    <div id="invoicesCard" class="hidden bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-gray-900 mb-4">
            <i class="fas fa-file-invoice text-purple-600 mr-2"></i>
            Daftar Tagihan
        </h3>
        
        <div id="customerInfo" class="mb-4 p-4 bg-gray-50 rounded-lg"></div>
        <div id="invoicesList" class="space-y-2"></div>
    </div>
</div>

<script>
let searchTimeout;

// Search customer
document.getElementById('customerSearch').addEventListener('input', function(e) {
    const query = e.target.value.trim();
    
    clearTimeout(searchTimeout);
    
    if (query.length < 2) {
        document.getElementById('searchResults').classList.add('hidden');
        return;
    }
    
    searchTimeout = setTimeout(() => {
        searchCustomers(query);
    }, 300);
});

async function searchCustomers(query) {
    try {
        const response = await fetch(`/kasir/api/search-customer?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.success && data.data.length > 0) {
            displaySearchResults(data.data);
        } else {
            document.getElementById('customerList').innerHTML = '<p class="text-gray-500 text-center py-4">Tidak ada hasil ditemukan</p>';
            document.getElementById('searchResults').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error searching customers:', error);
    }
}

function displaySearchResults(customers) {
    const listEl = document.getElementById('customerList');
    listEl.innerHTML = customers.map(customer => `
        <div class="border rounded-lg p-4 hover:bg-purple-50 cursor-pointer transition" onclick='selectCustomer(${JSON.stringify(customer)})'>
            <div class="flex items-center justify-between">
                <div class="flex-1">
                    <div class="font-semibold text-gray-900">${customer.name} (${customer.customer_code})</div>
                    <div class="text-sm text-gray-600">
                        📞 ${customer.phone || '-'} | 📦 ${customer.package_name || 'No Package'}
                    </div>
                </div>
                <div>
                    ${customer.pending_count > 0 ? 
                        `<span class="inline-block px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-semibold">
                            ${customer.pending_count} Tagihan
                        </span>` : 
                        '<span class="text-green-600 text-sm">✓ Lunas</span>'}
                </div>
            </div>
        </div>
    `).join('');
    
    document.getElementById('searchResults').classList.remove('hidden');
}

async function selectCustomer(customer) {
    // Hide search results
    document.getElementById('searchResults').classList.add('hidden');
    document.getElementById('customerSearch').value = `${customer.name} (${customer.customer_code})`;
    
    // Display customer info
    document.getElementById('customerInfo').innerHTML = `
        <div class="flex items-center">
            <div class="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center mr-4">
                <i class="fas fa-user text-white text-xl"></i>
            </div>
            <div>
                <div class="font-semibold text-gray-900 text-lg">${customer.name}</div>
                <div class="text-sm text-gray-600">
                    ID: ${customer.customer_code} | 
                    📞 ${customer.phone || '-'} | 
                    📦 ${customer.package_name || '-'}
                </div>
            </div>
        </div>
    `;
    
    // Load invoices
    await loadCustomerInvoices(customer.id);
}

async function loadCustomerInvoices(customerId) {
    try {
        const response = await fetch(`/kasir/api/customer/${customerId}/invoices`);
        const data = await response.json();
        
        if (data.success) {
            displayInvoices(data.data);
            document.getElementById('invoicesCard').classList.remove('hidden');
        }
    } catch (error) {
        console.error('Error loading invoices:', error);
    }
}

function displayInvoices(invoices) {
    const listEl = document.getElementById('invoicesList');
    
    if (invoices.length === 0) {
        listEl.innerHTML = '<p class="text-green-600 text-center py-4">✓ Tidak ada tagihan pending</p>';
        return;
    }
    
    listEl.innerHTML = invoices.map(invoice => {
        const amount = invoice.remaining_amount || invoice.total_amount;
        const statusClass = invoice.status === 'overdue' ? 'bg-red-100 text-red-800' : 
                           invoice.status === 'partial' ? 'bg-yellow-100 text-yellow-800' : 
                           'bg-blue-100 text-blue-800';
        
        return `
            <div class="border rounded-lg p-4">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <div class="font-semibold text-gray-900">${invoice.invoice_number}</div>
                        <div class="text-sm text-gray-600">Periode: ${invoice.period}</div>
                    </div>
                    <div class="text-right">
                        <div class="font-bold text-lg text-gray-900">Rp ${amount.toLocaleString('id-ID')}</div>
                        <span class="inline-block px-2 py-1 ${statusClass} rounded text-xs font-semibold uppercase">${invoice.status}</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <a href="/billing/tagihan/${invoice.id}/print-thermal" target="_blank" 
                       class="flex-1 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition text-center">
                        <i class="fas fa-print mr-2"></i>Print Thermal (58mm)
                    </a>
                    <a href="/billing/tagihan/${invoice.id}/print" target="_blank"
                       class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-center">
                        <i class="fas fa-file-pdf mr-2"></i>Print A4
                    </a>
                </div>
            </div>
        `;
    }).join('');
}

// Focus on search input
document.getElementById('customerSearch').focus();
</script>



