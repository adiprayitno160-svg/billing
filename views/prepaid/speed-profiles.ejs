<!-- Speed Profiles Management Page (PPPoE Profiles) -->
<div class="container-fluid">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Speed Profiles Management</h1>
        <p class="text-gray-600">Kelola PPPoE speed profiles di Mikrotik untuk prepaid customers</p>
    </div>

    <!-- Flash Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
    <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 rounded">
        <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
            <p class="text-green-800 font-semibold"><%= success %></p>
        </div>
    </div>
    <% } %>

    <% if (typeof error !== 'undefined' && error) { %>
    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 text-2xl mr-3"></i>
            <p class="text-red-800 font-semibold"><%= error %></p>
        </div>
    </div>
    <% } %>

    <% if (!mikrotikConfigured) { %>
    <!-- Mikrotik Not Configured -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center">
        <i class="fas fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-900 mb-3">Mikrotik Belum Dikonfigurasi</h3>
        <p class="text-gray-600 mb-6">Silakan konfigurasi Mikrotik terlebih dahulu</p>
        <a href="/settings/mikrotik" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg hover:bg-blue-700 shadow-lg">
            <i class="fas fa-cog mr-2"></i>
            Konfigurasi Mikrotik
        </a>
    </div>
    <% } else { %>

    <!-- Mikrotik Connection Info -->
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <i class="fas fa-network-wired text-blue-600 text-2xl"></i>
                <div>
                    <h4 class="font-bold text-blue-900">Mikrotik Connection</h4>
                    <p class="text-sm text-blue-700">
                        <strong>Host:</strong> <%= typeof mikrotikHost !== 'undefined' ? mikrotikHost : 'Unknown' %> | 
                        <strong>Port:</strong> <%= typeof mikrotikPort !== 'undefined' ? mikrotikPort : 8728 %>
                    </p>
                </div>
            </div>
            <a href="/settings/mikrotik" class="text-blue-600 hover:text-blue-800 text-sm">
                <i class="fas fa-edit mr-1"></i>
                Edit Settings
            </a>
        </div>
    </div>

    <!-- Info Card -->
    <div class="bg-purple-50 border border-purple-200 rounded-lg p-6 mb-6">
        <h4 class="font-bold text-purple-900 mb-3 flex items-center">
            <i class="fas fa-info-circle mr-2"></i>
            Tentang Speed Profiles
        </h4>
        <ul class="space-y-2 text-sm text-purple-800">
            <li class="flex items-start">
                <i class="fas fa-check text-purple-600 mr-2 mt-1"></i>
                <span><strong>Speed Profiles</strong> = PPPoE Profiles di Mikrotik dengan rate-limit</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-purple-600 mr-2 mt-1"></i>
                <span><strong>Untuk PPPoE customers only</strong> (bukan untuk Static IP)</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-purple-600 mr-2 mt-1"></i>
                <span><strong>Upload/Download speed</strong> di-set via rate-limit (contoh: 10M/10M)</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check text-purple-600 mr-2 mt-1"></i>
                <span><strong>Address List</strong> optional untuk grouping (prepaid-active, prepaid-no-package)</span>
            </li>
        </ul>
    </div>

    <!-- Create Profile Form -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6 mb-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-plus-circle text-green-600 mr-2"></i>
            Tambah Profile Baru
        </h3>
        <form action="/prepaid/speed-profiles/create" method="POST" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Profile Name *</label>
                <input type="text" name="profile_name" required placeholder="prepaid-100mbps" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500">
                <p class="text-xs text-gray-500 mt-1">Contoh: prepaid-10mbps, prepaid-20mbps</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Download Speed (Mbps) *</label>
                <input type="number" name="download_speed" required placeholder="10" min="1" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500">
                <p class="text-xs text-gray-500 mt-1">Speed download dalam Mbps</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Upload Speed (Mbps) *</label>
                <input type="number" name="upload_speed" required placeholder="10" min="1" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500">
                <p class="text-xs text-gray-500 mt-1">Speed upload dalam Mbps</p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Address List</label>
                <select name="address_list" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500">
                    <option value="">-- Pilih (Optional) --</option>
                    <option value="prepaid-active">prepaid-active</option>
                    <option value="prepaid-no-package">prepaid-no-package</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Untuk grouping firewall rules</p>
            </div>
            <div class="md:col-span-2 lg:col-span-3">
                <label class="block text-sm font-medium text-gray-700 mb-2">Comment</label>
                <input type="text" name="comment" placeholder="Profile untuk prepaid 100Mbps" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500">
            </div>
            <div class="flex items-end">
                <button type="submit" class="w-full bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700 transition-colors font-semibold">
                    <i class="fas fa-plus mr-2"></i>
                    Tambah Profile
                </button>
            </div>
        </form>
    </div>

    <!-- Profiles List -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm">
        <div class="bg-gradient-to-r from-purple-500 to-indigo-500 text-white px-6 py-4 rounded-t-lg">
            <h3 class="text-lg font-bold flex items-center justify-between">
                <span>
                    <i class="fas fa-tachometer-alt mr-2"></i>
                    PPPoE Speed Profiles
                </span>
                <span class="bg-white/20 px-3 py-1 rounded-full text-sm font-semibold">
                    <%= profiles.length %> Profiles
                </span>
            </h3>
        </div>

        <% if (profiles.length === 0) { %>
        <div class="p-8 text-center text-gray-500">
            <i class="fas fa-inbox text-5xl mb-4"></i>
            <p class="text-lg">Belum ada PPPoE profiles</p>
            <p class="text-sm mt-2">Tambah profile baru menggunakan form di atas</p>
        </div>
        <% } else { %>
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Profile Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rate Limit</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Address List</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Only One</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Comment</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    <% profiles.forEach(function(profile) { %>
                    <tr class="hover:bg-gray-50 <%= profile.isPrepaid ? 'bg-purple-50' : '' %>">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <% if (profile.isPrepaid) { %>
                                <i class="fas fa-star text-purple-500 mr-2"></i>
                                <% } %>
                                <div>
                                    <div class="text-sm font-semibold text-gray-900"><%= profile.name %></div>
                                    <% if (profile.isPrepaid) { %>
                                    <div class="text-xs text-purple-600">Prepaid Profile</div>
                                    <% } %>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-mono text-gray-900"><%= profile.rateLimit %></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <% if (profile.addressList !== '-') { %>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                <%= profile.addressList %>
                            </span>
                            <% } else { %>
                            <span class="text-sm text-gray-400">-</span>
                            <% } %>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <% if (profile.onlyOne === 'yes') { %>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                <i class="fas fa-check mr-1"></i>Yes
                            </span>
                            <% } else { %>
                            <span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">No</span>
                            <% } %>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-600 max-w-xs truncate"><%= profile.comment || '-' %></div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <div class="flex items-center justify-center gap-2">
                                <button onclick="editProfile('<%= profile.id %>', '<%= profile.name %>', '<%= profile.rateLimit %>', '<%= profile.addressList %>', '<%= profile.comment %>')" 
                                        class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded hover:bg-blue-50">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <% if (profile.name !== 'default' && profile.name !== 'default-encryption') { %>
                                <form action="/prepaid/speed-profiles/delete/<%= profile.id %>" method="POST" 
                                      onsubmit="return confirm('Hapus profile <%= profile.name %>?\n\nPastikan tidak ada customer yang menggunakan profile ini!')" 
                                      class="inline">
                                    <button type="submit" class="text-red-600 hover:text-red-800 px-3 py-1 rounded hover:bg-red-50">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                                <% } else { %>
                                <span class="text-gray-400 px-3 py-1" title="Default profile tidak bisa dihapus">
                                    <i class="fas fa-lock"></i>
                                </span>
                                <% } %>
                            </div>
                        </td>
                    </tr>
                    <% }); %>
                </tbody>
            </table>
        </div>
        <% } %>
    </div>

    <% } %>
</div>

<!-- Edit Profile Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-2xl w-full mx-4">
        <h3 class="text-2xl font-bold text-gray-900 mb-6">Edit Profile</h3>
        <form id="editForm" method="POST">
            <input type="hidden" id="edit_profile_name" readonly>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Profile Name</label>
                <input type="text" id="edit_name_display" readonly class="w-full border border-gray-300 rounded-lg px-4 py-2 bg-gray-100 font-semibold">
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Download Speed (Mbps) *</label>
                    <input type="number" name="download_speed" id="edit_download" required min="1" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Speed (Mbps) *</label>
                    <input type="number" name="upload_speed" id="edit_upload" required min="1" 
                           class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
            </div>

            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Address List</label>
                <select name="address_list" id="edit_address_list" class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
                    <option value="">-- Tidak ada --</option>
                    <option value="prepaid-active">prepaid-active</option>
                    <option value="prepaid-no-package">prepaid-no-package</option>
                </select>
            </div>

            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Comment</label>
                <input type="text" name="comment" id="edit_comment" 
                       class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-blue-500">
            </div>

            <div class="flex gap-4">
                <button type="button" onclick="closeEditModal()" 
                        class="flex-1 bg-gray-200 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-300 font-semibold">
                    Cancel
                </button>
                <button type="submit" 
                        class="flex-1 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 font-semibold">
                    <i class="fas fa-save mr-2"></i>
                    Update Profile
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function editProfile(id, name, rateLimit, addressList, comment) {
    // Parse rate limit (format: "10M/10M")
    const parts = rateLimit.split('/');
    const upload = parts[0] ? parseInt(parts[0].replace('M', '')) : 0;
    const download = parts[1] ? parseInt(parts[1].replace('M', '')) : 0;

    // Set form action
    document.getElementById('editForm').action = '/prepaid/speed-profiles/update/' + id;

    // Fill form
    document.getElementById('edit_profile_name').value = name;
    document.getElementById('edit_name_display').value = name;
    document.getElementById('edit_download').value = download;
    document.getElementById('edit_upload').value = upload;
    document.getElementById('edit_address_list').value = addressList === '-' ? '' : addressList;
    document.getElementById('edit_comment').value = comment === '-' ? '' : comment;

    // Show modal
    document.getElementById('editModal').classList.remove('hidden');
    document.getElementById('editModal').classList.add('flex');
}

function closeEditModal() {
    document.getElementById('editModal').classList.add('hidden');
    document.getElementById('editModal').classList.remove('flex');
}

// Close modal on ESC key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
    }
});

// Close modal on click outside
document.getElementById('editModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeEditModal();
    }
});
</script>

