<!-- Mikrotik Setup Wizard - One Click Setup -->
<div class="container-fluid">
    <div class="mb-6">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">🚀 Mikrotik Setup Wizard</h1>
        <p class="text-gray-600">Setup Mikrotik untuk sistem prepaid - Tinggal klik tombol!</p>
    </div>

    <!-- Flash Messages -->
    <% if (typeof success !== 'undefined' && success) { %>
    <div class="bg-green-50 border-l-4 border-green-500 p-4 mb-6 rounded animate-pulse">
        <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 text-2xl mr-3"></i>
            <p class="text-green-800 font-semibold"><%= success %></p>
        </div>
    </div>
    <% } %>

    <% if (typeof error !== 'undefined' && error) { %>
    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-6 rounded">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle text-red-500 text-2xl mr-3"></i>
            <p class="text-red-800 font-semibold"><%= error %></p>
        </div>
    </div>
    <% } %>

    <% if (!mikrotikConfigured) { %>
    <!-- Mikrotik Not Configured -->
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-8 text-center">
        <i class="fas fa-exclamation-triangle text-yellow-500 text-5xl mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-900 mb-3">Mikrotik Belum Dikonfigurasi</h3>
        <p class="text-gray-600 mb-6">Silakan konfigurasi koneksi Mikrotik terlebih dahulu di Settings</p>
        <a href="/settings/mikrotik" class="inline-flex items-center px-6 py-3 bg-blue-600 text-white text-lg font-semibold rounded-lg hover:bg-blue-700 shadow-lg">
            <i class="fas fa-cog mr-2"></i>
            Konfigurasi Mikrotik
        </a>
    </div>
    <% } else { %>

    <!-- Setup Status Cards -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Portal URL Card -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-globe text-blue-600 mr-2"></i>
                Portal URL Configuration
            </h3>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">Portal URL</label>
                <div class="relative">
                    <input type="text" id="portal-url-display" value="<%= portalUrl %>" readonly
                           class="w-full border border-gray-300 rounded-lg px-4 py-3 bg-gray-50 font-mono text-sm">
                    <a href="/settings/system" class="absolute right-2 top-1/2 transform -translate-y-1/2 text-blue-600 hover:text-blue-800">
                        <i class="fas fa-edit"></i>
                    </a>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    URL ini akan digunakan untuk redirect. <a href="/settings/system" class="text-blue-600 hover:underline">Ubah di System Settings</a>
                </p>
            </div>

            <% if (portalUrl) { %>
            <div class="bg-green-50 border border-green-200 rounded p-3">
                <p class="text-sm text-green-800">
                    <i class="fas fa-check-circle mr-1"></i>
                    <strong>IP:</strong> <%= portalUrl.replace(/^https?:\/\//, '').split(':')[0] %> | 
                    <strong>Port:</strong> <%= portalUrl.includes(':') ? portalUrl.split(':').pop() : (portalUrl.includes('https') ? '443' : '80') %>
                </p>
            </div>
            <% } %>
        </div>

        <!-- Mikrotik Connection Card -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-6">
            <h3 class="text-lg font-bold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-network-wired text-purple-600 mr-2"></i>
                Mikrotik Connection
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Host:</span>
                    <span class="font-mono text-sm font-semibold"><%= mikrotikSettings.host %></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Port:</span>
                    <span class="font-mono text-sm font-semibold"><%= mikrotikSettings.api_port || 8728 %></span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-sm text-gray-600">Username:</span>
                    <span class="font-mono text-sm font-semibold"><%= mikrotikSettings.username %></span>
                </div>
            </div>
            
            <button onclick="testConnection()" 
                    class="w-full mt-4 bg-purple-100 text-purple-700 px-4 py-2 rounded-lg hover:bg-purple-200 transition-colors font-semibold">
                <i class="fas fa-plug mr-2"></i>
                Test Connection
            </button>

            <div id="connection-result" class="mt-3 hidden"></div>
        </div>
    </div>

    <!-- Setup Status -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-6 mb-6">
        <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center">
            <i class="fas fa-tasks text-blue-600 mr-2"></i>
            Status Setup
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white rounded-lg p-4 text-center">
                <div class="text-3xl mb-2">
                    <% if (setupStatus.profiles) { %>
                        <i class="fas fa-check-circle text-green-500"></i>
                    <% } else { %>
                        <i class="fas fa-times-circle text-red-500"></i>
                    <% } %>
                </div>
                <div class="text-sm font-semibold text-gray-900">PPPoE Profiles</div>
                <div class="text-xs text-gray-600 mt-1">
                    <%= setupStatus.profiles ? 'Sudah dibuat' : 'Belum dibuat' %>
                </div>
            </div>

            <div class="bg-white rounded-lg p-4 text-center">
                <div class="text-3xl mb-2">
                    <% if (setupStatus.natRules) { %>
                        <i class="fas fa-check-circle text-green-500"></i>
                    <% } else { %>
                        <i class="fas fa-times-circle text-red-500"></i>
                    <% } %>
                </div>
                <div class="text-sm font-semibold text-gray-900">NAT Rules</div>
                <div class="text-xs text-gray-600 mt-1">
                    <%= setupStatus.natRules ? 'Sudah dibuat' : 'Belum dibuat' %>
                </div>
            </div>

            <div class="bg-white rounded-lg p-4 text-center">
                <div class="text-3xl mb-2">
                    <% if (setupStatus.filterRules) { %>
                        <i class="fas fa-check-circle text-green-500"></i>
                    <% } else { %>
                        <i class="fas fa-times-circle text-red-500"></i>
                    <% } %>
                </div>
                <div class="text-sm font-semibold text-gray-900">Filter Rules</div>
                <div class="text-xs text-gray-600 mt-1">
                    <%= setupStatus.filterRules ? 'Sudah dibuat' : 'Belum dibuat' %>
                </div>
            </div>
        </div>

        <% if (setupStatus.ready) { %>
        <div class="mt-4 bg-green-100 border border-green-300 rounded-lg p-4 text-center">
            <i class="fas fa-check-circle text-green-600 text-2xl mb-2"></i>
            <p class="text-green-800 font-semibold">Setup Sudah Lengkap! Sistem siap digunakan. ✅</p>
        </div>
        <% } else { %>
        <div class="mt-4 bg-yellow-100 border border-yellow-300 rounded-lg p-4 text-center">
            <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl mb-2"></i>
            <p class="text-yellow-800 font-semibold">Setup belum lengkap. Klik tombol "Setup Mikrotik" di bawah.</p>
        </div>
        <% } %>
    </div>

    <!-- Main Setup Form -->
    <form action="/prepaid/mikrotik-setup/setup" method="POST" id="setup-form" onsubmit="return confirmSetup()">
        <input type="hidden" name="portal_url" value="<%= portalUrl %>">

        <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-8">
            <h3 class="text-2xl font-bold text-gray-900 mb-4 text-center">
                <i class="fas fa-magic mr-2 text-purple-600"></i>
                One-Click Setup
            </h3>

            <div class="bg-gradient-to-r from-purple-50 to-pink-50 border border-purple-200 rounded-lg p-6 mb-6">
                <h4 class="font-bold text-purple-900 mb-3 flex items-center">
                    <i class="fas fa-info-circle mr-2"></i>
                    Yang Akan Di-Setup:
                </h4>
                <ul class="space-y-2 text-sm text-purple-800">
                    <li class="flex items-start">
                        <i class="fas fa-check text-purple-600 mr-2 mt-1"></i>
                        <span><strong>PPPoE Profiles:</strong> prepaid-no-package, prepaid-10mbps, prepaid-20mbps, prepaid-50mbps, prepaid-100mbps</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-purple-600 mr-2 mt-1"></i>
                        <span><strong>NAT Redirect Rules:</strong> HTTP & HTTPS redirect ke <%= portalUrl %></span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-purple-600 mr-2 mt-1"></i>
                        <span><strong>Firewall Filter Rules:</strong> Allow active prepaid, block prepaid tanpa paket</span>
                    </li>
                    <li class="flex items-start">
                        <i class="fas fa-check text-purple-600 mr-2 mt-1"></i>
                        <span><strong>Address Lists:</strong> prepaid-no-package, prepaid-active (otomatis dari profile)</span>
                    </li>
                </ul>
            </div>

            <div class="flex gap-4">
                <% if (setupStatus.ready) { %>
                <!-- Re-Setup Button (jika sudah setup) -->
                <button type="submit" 
                        class="flex-1 bg-gradient-to-r from-blue-500 to-indigo-600 text-white px-8 py-4 rounded-lg text-xl font-bold hover:shadow-xl transition-all duration-200 flex items-center justify-center">
                    <i class="fas fa-sync-alt mr-3"></i>
                    Re-Setup / Update Mikrotik
                </button>
                
                <!-- Reset Button -->
                <button type="button" onclick="confirmReset()" 
                        class="bg-red-100 text-red-700 px-6 py-4 rounded-lg font-bold hover:bg-red-200 transition-colors flex items-center">
                    <i class="fas fa-trash-alt mr-2"></i>
                    Reset Setup
                </button>
                <% } else { %>
                <!-- Initial Setup Button -->
                <button type="submit" 
                        class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white px-8 py-5 rounded-lg text-2xl font-bold hover:shadow-2xl transition-all duration-200 transform hover:scale-105 flex items-center justify-center">
                    <i class="fas fa-rocket mr-3 animate-bounce"></i>
                    Setup Mikrotik Sekarang!
                </button>
                <% } %>
            </div>
        </div>
    </form>

    <!-- Info Cards -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
        <!-- How It Works -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h4 class="font-bold text-blue-900 mb-3 flex items-center">
                <i class="fas fa-lightbulb mr-2"></i>
                Cara Kerja
            </h4>
            <ol class="space-y-2 text-sm text-blue-800 list-decimal list-inside">
                <li>Klik tombol <strong>"Setup Mikrotik"</strong></li>
                <li>Sistem otomatis create PPPoE profiles di Mikrotik</li>
                <li>Sistem otomatis create NAT redirect rules</li>
                <li>Sistem otomatis create firewall filter rules</li>
                <li><strong>DONE!</strong> Sistem siap digunakan</li>
            </ol>
        </div>

        <!-- After Setup -->
        <div class="bg-green-50 border border-green-200 rounded-lg p-6">
            <h4 class="font-bold text-green-900 mb-3 flex items-center">
                <i class="fas fa-check-double mr-2"></i>
                Setelah Setup
            </h4>
            <ul class="space-y-2 text-sm text-green-800">
                <li class="flex items-start">
                    <i class="fas fa-arrow-right text-green-600 mr-2 mt-1"></i>
                    <span>Customer prepaid otomatis di-redirect ke portal</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-arrow-right text-green-600 mr-2 mt-1"></i>
                    <span>PPPoE users pakai profile sesuai paket mereka</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-arrow-right text-green-600 mr-2 mt-1"></i>
                    <span>Static IP masuk address-list otomatis</span>
                </li>
                <li class="flex items-start">
                    <i class="fas fa-arrow-right text-green-600 mr-2 mt-1"></i>
                    <span>Sistem monitoring berjalan otomatis</span>
                </li>
            </ul>
        </div>
    </div>

    <% } %>
</div>

<!-- Reset Form (Hidden) -->
<form id="reset-form" action="/prepaid/mikrotik-setup/reset" method="POST" style="display: none;"></form>

<script>
function testConnection() {
    const btn = event.target;
    const resultDiv = document.getElementById('connection-result');
    
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Testing...';
    
    fetch('/prepaid/mikrotik-setup/test', { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            resultDiv.classList.remove('hidden');
            if (data.success) {
                resultDiv.className = 'mt-3 bg-green-100 border border-green-300 rounded p-3 text-sm';
                resultDiv.innerHTML = `
                    <i class="fas fa-check-circle text-green-600 mr-2"></i>
                    <strong>${data.message}</strong><br>
                    <span class="text-xs">Router: ${data.identity || 'Unknown'}</span>
                `;
            } else {
                resultDiv.className = 'mt-3 bg-red-100 border border-red-300 rounded p-3 text-sm';
                resultDiv.innerHTML = `
                    <i class="fas fa-times-circle text-red-600 mr-2"></i>
                    <strong>${data.message}</strong>
                `;
            }
        })
        .catch(err => {
            resultDiv.classList.remove('hidden');
            resultDiv.className = 'mt-3 bg-red-100 border border-red-300 rounded p-3 text-sm';
            resultDiv.innerHTML = `
                <i class="fas fa-times-circle text-red-600 mr-2"></i>
                <strong>Error: ${err.message}</strong>
            `;
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-plug mr-2"></i> Test Connection';
        });
}

function confirmSetup() {
    const portalUrl = document.querySelector('input[name="portal_url"]').value;
    
    if (!portalUrl) {
        alert('Portal URL belum diset! Silakan set Portal URL di System Settings dulu.');
        return false;
    }
    
    return confirm(
        '🚀 Setup Mikrotik sekarang?\n\n' +
        'Sistem akan otomatis membuat:\n' +
        '• PPPoE Profiles (5 profiles)\n' +
        '• NAT Redirect Rules (2 rules)\n' +
        '• Firewall Filter Rules (4 rules)\n\n' +
        'Portal URL: ' + portalUrl + '\n\n' +
        'Proses ini memakan waktu 10-30 detik.\n' +
        'Lanjutkan?'
    );
}

function confirmReset() {
    if (confirm(
        '⚠️ RESET SETUP?\n\n' +
        'Semua rules prepaid akan dihapus dari Mikrotik:\n' +
        '• NAT Rules\n' +
        '• Filter Rules\n\n' +
        'PPPoE Profiles TIDAK akan dihapus.\n\n' +
        'Yakin ingin reset?'
    )) {
        document.getElementById('reset-form').submit();
    }
}
</script>

<style>
@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}
.animate-bounce {
    animation: bounce 1s infinite;
}
</style>

