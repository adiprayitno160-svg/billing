<%- include('../partials/header') %>
    <%- include('../partials/sidebar') %>

        <div class="content-wrapper">
            <div class="content-header">
                <div class="container-fluid">
                    <div class="row mb-2">
                        <div class="col-sm-6">
                            <button class="btn btn-primary float-right" data-toggle="modal" data-target="#voucherModal"
                                onclick="resetForm()">
                                <i class="fas fa-plus"></i> Create Voucher
                            </button>
                            <h1 class="m-0"><i class="fas fa-ticket-alt"></i> Value Vouchers</h1>
                        </div>
                        <div class="col-sm-6">
                            <ol class="breadcrumb float-sm-right">
                                <li class="breadcrumb-item"><a href="/dashboard">Home</a></li>
                                <li class="breadcrumb-item active">Vouchers</li>
                            </ol>
                        </div>
                    </div>
                </div>
            </div>

            <section class="content">
                <div class="container-fluid">
                    <div class="card">
                        <div class="card-body table-responsive p-0">
                            <table class="table table-hover text-nowrap">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Description</th>
                                        <th>Discount</th>
                                        <th>Validity</th>
                                        <th>Usage</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <% if (vouchers && vouchers.length> 0) { %>
                                        <% vouchers.forEach(function(v) { %>
                                            <tr>
                                                <td>
                                                    <strong class="text-primary">
                                                        <%= v.code %>
                                                    </strong>
                                                </td>
                                                <td>
                                                    <strong>
                                                        <%= v.name %>
                                                    </strong><br>
                                                    <small class="text-muted">
                                                        <%= v.description || '-' %>
                                                    </small>
                                                </td>
                                                <td>
                                                    <% if (v.discount_type==='percentage' ) { %>
                                                        <span class="badge badge-info">
                                                            <%= v.discount_value %>% OFF
                                                        </span>
                                                        <% } else if (v.discount_type==='fixed' ) { %>
                                                            <span class="badge badge-success">Rp <%=
                                                                    v.discount_value.toLocaleString('id-ID') %>
                                                                    OFF</span>
                                                            <% } else { %>
                                                                <span class="badge badge-warning">FREE <%=
                                                                        v.discount_value %> DAYS</span>
                                                                <% } %>
                                                                    <br>
                                                                    <small>Min purchase: Rp <%=
                                                                            v.min_purchase.toLocaleString('id-ID') %>
                                                                            </small>
                                                </td>
                                                <td>
                                                    <%= new Date(v.valid_from).toLocaleDateString() %> - <%= new
                                                            Date(v.valid_until).toLocaleDateString() %>
                                                </td>
                                                <td>
                                                    <%= v.total_usage || 0 %> / <%= v.usage_limit || 'âˆž' %>
                                                </td>
                                                <td>
                                                    <span
                                                        class="badge badge-<%= v.status === 'active' ? 'success' : 'danger' %>">
                                                        <%= v.status.toUpperCase() %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-sm btn-info"
                                                        onclick="editVoucher(<%= JSON.stringify(v) %>)">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-danger"
                                                        onclick="deleteVoucher(<%= v.id %>)">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                            <% }); %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="7" class="text-center">No vouchers found</td>
                                                    </tr>
                                                    <% } %>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Voucher Modal -->
        <div class="modal fade" id="voucherModal" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <form id="voucherForm" onsubmit="saveVoucher(event)">
                        <input type="hidden" id="voucherId" name="id">
                        <div class="modal-header">
                            <h5 class="modal-title" id="modalTitle">Create Voucher</h5>
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Voucher Code</label>
                                        <input type="text" class="form-control" name="code" id="code" required
                                            style="text-transform: uppercase;">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Name</label>
                                        <input type="text" class="form-control" name="name" id="name" required>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>Description</label>
                                <textarea class="form-control" name="description" id="description" rows="2"></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Type</label>
                                        <select class="form-control" name="discount_type" id="discount_type" required>
                                            <option value="percentage">Percentage (%)</option>
                                            <option value="fixed">Fixed Amount (Rp)</option>
                                            <option value="free_days">Free Days</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Value</label>
                                        <input type="number" class="form-control" name="discount_value"
                                            id="discount_value" required min="0">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-group">
                                        <label>Min Purchase</label>
                                        <input type="number" class="form-control" name="min_purchase" id="min_purchase"
                                            value="0" min="0">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Valid From</label>
                                        <input type="date" class="form-control" name="valid_from" id="valid_from"
                                            required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Valid Until</label>
                                        <input type="date" class="form-control" name="valid_until" id="valid_until"
                                            required>
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Usage Limit (leave empty for unlimited)</label>
                                        <input type="number" class="form-control" name="usage_limit" id="usage_limit"
                                            min="1">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label>Target Customer</label>
                                        <select class="form-control" name="customer_type" id="customer_type">
                                            <option value="all">All Customers</option>
                                            <option value="new">New Customers Only (< 7 days)</option>
                                            <option value="existing">Existing Customers Only</option>
                                            <option value="prepaid">Prepaid Only</option>
                                            <option value="postpaid">Postpaid Only</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="form-group">
                                <div class="custom-control custom-switch">
                                    <input type="checkbox" class="custom-control-input" id="status" name="status"
                                        checked>
                                    <label class="custom-control-label" for="status">Active</label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save Voucher</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <script>
            function resetForm() {
                $('#voucherForm')[0].reset();
                $('#voucherId').val('');
                $('#modalTitle').text('Create Voucher');
                $('#code').prop('readonly', false);

                // Set default dates
                const today = new Date().toISOString().split('T')[0];
                $('#valid_from').val(today);

                const nextMonth = new Date();
                nextMonth.setMonth(nextMonth.getMonth() + 1);
                $('#valid_until').val(nextMonth.toISOString().split('T')[0]);
            }

            function editVoucher(voucher) {
                resetForm();
                $('#modalTitle').text('Edit Voucher');
                $('#voucherId').val(voucher.id);
                $('#code').val(voucher.code).prop('readonly', true);
                $('#name').val(voucher.name);
                $('#description').val(voucher.description);
                $('#discount_type').val(voucher.discount_type);
                $('#discount_value').val(voucher.discount_value);
                $('#min_purchase').val(voucher.min_purchase);
                $('#usage_limit').val(voucher.usage_limit);
                $('#customer_type').val(voucher.customer_type);

                $('#valid_from').val(new Date(voucher.valid_from).toISOString().split('T')[0]);
                $('#valid_until').val(new Date(voucher.valid_until).toISOString().split('T')[0]);

                $('#status').prop('checked', voucher.status === 'active');

                $('#voucherModal').modal('show');
            }

            function saveVoucher(e) {
                e.preventDefault();

                const id = $('#voucherId').val();
                const data = {
                    code: $('#code').val(),
                    name: $('#name').val(),
                    description: $('#description').val(),
                    discount_type: $('#discount_type').val(),
                    discount_value: parseFloat($('#discount_value').val()),
                    min_purchase: parseFloat($('#min_purchase').val()),
                    valid_from: $('#valid_from').val() + ' 00:00:00',
                    valid_until: $('#valid_until').val() + ' 23:59:59',
                    usage_limit: $('#usage_limit').val() ? parseInt($('#usage_limit').val()) : null,
                    customer_type: $('#customer_type').val(),
                    status: $('#status').is(':checked') ? 'active' : 'inactive'
                };

                const url = id ? '/prepaid/vouchers/' + id : '/prepaid/vouchers';
                const method = id ? 'PUT' : 'POST';

                $.ajax({
                    url: url,
                    method: method,
                    data: data,
                    success: function (response) {
                        if (response.success) {
                            alert('Voucher saved successfully');
                            location.reload();
                        } else {
                            alert('Error: ' + response.message);
                        }
                    },
                    error: function () {
                        alert('Failed to save voucher');
                    }
                });
            }

            function deleteVoucher(id) {
                if (confirm('Are you sure you want to delete this voucher?')) {
                    $.ajax({
                        url: '/prepaid/vouchers/' + id,
                        method: 'DELETE',
                        success: function (response) {
                            if (response.success) {
                                location.reload();
                            } else {
                                alert('Error: ' + response.message);
                            }
                        }
                    });
                }
            }
        </script>

        <%- include('../partials/footer') %>