<div class="max-w-5xl mx-auto space-y-6">
    <!-- Header Navigation -->
    <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
            <a href="/technician"
                class="p-2 bg-white rounded-lg shadow-sm border border-gray-200 text-gray-600 hover:bg-gray-50 transition-colors">
                <i class="fas fa-arrow-left"></i>
            </a>
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Detail Pekerjaan</h1>
                <p class="text-sm text-gray-500">Tiket: <span class="font-mono font-medium text-gray-700">
                        <%= job.ticket_number %>
                    </span></p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <% var statusColors={ 'pending' : 'bg-gray-100 text-gray-800' , 'accepted' : 'bg-blue-100 text-blue-800'
                , 'in_progress' : 'bg-yellow-100 text-yellow-800' , 'completed' : 'bg-green-100 text-green-800'
                , 'cancelled' : 'bg-red-100 text-red-800' }; var stLabel=(job.status || 'pending'
                ).toString().toUpperCase().replace('_', ' ' ); var stClass=statusColors[job.status]
                || 'bg-gray-100 text-gray-800' ; var prioColors={ 'low' : 'bg-gray-50 text-gray-600' , 'medium'
                : 'bg-blue-50 text-blue-600' , 'high' : 'bg-orange-50 text-orange-600' , 'critical'
                : 'bg-red-50 text-red-600' }; var prClass=prioColors[job.priority] || 'bg-gray-50 text-gray-600' ; %>
                <span
                    class="px-3 py-1 rounded-full text-xs font-bold <%= prClass %> border border-opacity-20 flex items-center gap-1">
                    <i class="fas fa-flag"></i>
                    <%= (job.priority || 'NORMAL' ).toUpperCase() %>
                </span>
                <span
                    class="px-3 py-1 rounded-full text-xs font-bold <%= stClass %> border border-opacity-20 flex items-center gap-1">
                    <i class="fas fa-info-circle"></i>
                    <%= stLabel %>
                </span>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Main Info Column -->
        <div class="lg:col-span-2 space-y-6">

            <!-- Job Essentials Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="p-6">
                    <h2 class="text-xl font-bold text-gray-900 mb-4">
                        <%= job.title %>
                    </h2>

                    <div
                        class="prose prose-sm max-w-none text-gray-600 bg-gray-50 p-4 rounded-lg border border-gray-100">
                        <p class="whitespace-pre-wrap">
                            <%= job.description || 'Tidak ada deskripsi detail.' %>
                        </p>
                    </div>

                    <div class="mt-6 flex flex-wrap gap-4 text-sm text-gray-500">
                        <div class="flex items-center gap-2">
                            <i class="far fa-calendar-alt"></i>
                            <span>Dibuat: <%= job.created_at ? new Date(job.created_at).toLocaleString('id-ID') : '-' %>
                                    </span>
                        </div>
                        <% if(job.accepted_at) { %>
                            <div class="flex items-center gap-2">
                                <i class="far fa-clock"></i>
                                <span>Diambil: <%= new Date(job.accepted_at).toLocaleString('id-ID') %></span>
                            </div>
                            <% } %>
                    </div>
                </div>
            </div>

            <!-- Customer & Location Card -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                    <h3 class="font-semibold text-gray-800">Informasi Lokasi & Pelanggan</h3>
                </div>
                <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Customer Info -->
                    <div>
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Pelanggan</label>
                        <div class="mt-1">
                            <p class="font-bold text-gray-900 text-lg">
                                <%= job.customer_name || 'Non-Member / Umum' %>
                            </p>
                            <% if (job.customer_phone) { %>
                                <div class="flex items-center gap-2 mt-1 text-gray-600">
                                    <i class="fas fa-phone text-xs"></i>
                                    <span>
                                        <%= job.customer_phone %>
                                    </span>
                                </div>
                                <% var wa=(job.customer_phone || '' ).toString().replace(/[^0-9]/g, ''
                                    ).replace(/^0/, '62' ); %>
                                    <a href="https://wa.me/<%= wa %>" target="_blank"
                                        class="mt-2 inline-flex items-center gap-2 text-sm font-medium text-green-600 hover:text-green-700 hover:underline">
                                        <i class="fab fa-whatsapp"></i> Chat WhatsApp
                                    </a>
                                    <% } %>
                        </div>
                    </div>

                    <!-- Address Info -->
                    <div>
                        <label class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Alamat</label>
                        <p class="mt-1 text-gray-700 leading-relaxed">
                            <%= job.address || '-' %>
                        </p>
                    </div>
                </div>

                <!-- Leaflet Map Integration -->
                <div class="h-64 w-full bg-gray-100 relative z-0 border-t border-gray-100">
                    <div id="jobMap" class="h-full w-full z-0"></div>
                </div>
                <div
                    class="px-6 py-3 bg-gray-50 text-xs text-gray-500 border-t border-gray-100 flex justify-between items-center">
                    <span><i class="fas fa-map-marker-alt mr-1"></i>
                        <%= job.coordinates || 'Lokasi tidak tersedia' %>
                    </span>
                    <% if (job.coordinates) { %>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=<%= job.coordinates %>"
                            target="_blank" class="text-blue-600 hover:underline font-medium">
                            <i class="fas fa-directions mr-1"></i> Petunjuk Arah Google
                        </a>
                        <% } %>
                </div>
            </div>

        </div>

        <!-- Sidebar / Actions Column -->
        <div class="space-y-6">

            <!-- Action Panel -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden sticky top-6">
                <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
                    <h3 class="font-semibold text-gray-800">Tindakan</h3>
                </div>

                <div class="p-6">
                    <% if (job.status==='completed' ) { %>
                        <!-- Completed View -->
                        <div class="bg-green-50 rounded-lg p-4 border border-green-100 mb-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-check-circle text-green-600 mt-1"></i>
                                <div>
                                    <h4 class="font-bold text-green-800 text-sm">Pekerjaan Selesai</h4>
                                    <p class="text-xs text-green-700 mt-1">Diselesaikan pada <%= new
                                            Date(job.completed_at).toLocaleString('id-ID') %>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <div class="space-y-4">
                            <div>
                                <label class="text-xs font-semibold text-gray-500 uppercase">Catatan
                                    Penyelesaian</label>
                                <p class="text-sm text-gray-700 mt-1">
                                    <%= job.completion_notes %>
                                </p>
                            </div>

                            <% if (job.completion_proof) { %>
                                <div>
                                    <label class="text-xs font-semibold text-gray-500 uppercase">Bukti Foto</label>
                                    <a href="<%= job.completion_proof %>" target="_blank"
                                        class="block mt-2 group relative overflow-hidden rounded-lg border border-gray-200">
                                        <img src="<%= job.completion_proof %>" alt="Bukti"
                                            class="w-full h-32 object-cover group-hover:scale-105 transition-transform duration-300">
                                        <div
                                            class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-opacity">
                                        </div>
                                    </a>
                                </div>
                                <% } %>
                        </div>

                        <% } else if (job.technician_id && job.technician_id===user.id && (job.status==='in_progress' ||
                            job.status==='accepted' )) { %>
                            <!-- Completion Form -->
                            <form id="detailCompletionForm" class="space-y-4">
                                <input type="hidden" id="jobId" value="<%= job.id %>">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Catatan Laporan</label>
                                    <textarea id="detailNotes"
                                        class="w-full text-sm border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"
                                        rows="4" placeholder="Jelaskan apa yang dikerjakan..." required></textarea>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Upload Bukti
                                        (Foto)</label>
                                    <input type="file" id="detailProof" accept="image/*"
                                        class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 max-w-full">
                                </div>
                                <button type="submit"
                                    class="w-full py-2.5 bg-green-600 text-white rounded-lg font-semibold shadow-sm hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-all">
                                    <i class="fas fa-check mr-2"></i> Update Selesai
                                </button>
                            </form>

                            <div class="mt-6 pt-6 border-t border-gray-100">
                                <button onclick="declineJobFromDetail(<%= job.id %>)"
                                    class="w-full py-2 bg-white border border-red-200 text-red-600 rounded-lg font-medium text-sm hover:bg-red-50 hover:text-red-700 transition-colors">
                                    <i class="fas fa-undo mr-2"></i> Kembalikan ke Antrian
                                </button>
                            </div>

                            <% } else if (job.status==='pending' ) { %>
                                <!-- Accept Action -->
                                <div class="text-center py-6">
                                    <div
                                        class="bg-blue-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-600 text-2xl">
                                        <i class="fas fa-hand-paper"></i>
                                    </div>
                                    <h3 class="text-lg font-medium text-gray-900">Ambil Tiket Ini?</h3>
                                    <p class="text-gray-500 text-sm mt-1 mb-6">Pekerjaan akan ditugaskan ke Anda dan
                                        masuk ke daftar aktif.</p>
                                    <button onclick="acceptJobFromDetail(<%= job.id %>)"
                                        class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all transform hover:-translate-y-1">
                                        AMBIL SEKARANG
                                    </button>
                                </div>

                                <% } else { %>
                                    <!-- Forbidden/Other View -->
                                    <div class="text-center p-4">
                                        <p class="text-gray-500 italic">Anda hanya melihat detail pekerjaan ini (Read
                                            Only).</p>
                                    </div>
                                    <% } %>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- LEAFLET CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize Map
        const rawCoords = "<%= job.coordinates || '' %>";
        const mapContainer = document.getElementById('jobMap');

        if (rawCoords && mapContainer) {
            try {
                // Parse coordinates "lat, long"
                const parts = rawCoords.split(',').map(s => parseFloat(s.trim()));
                if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                    const lat = parts[0];
                    const lng = parts[1];

                    const map = L.map('jobMap').setView([lat, lng], 15);

                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '&copy; OpenStreetMap contributors'
                    }).addTo(map);

                    L.marker([lat, lng]).addTo(map)
                        .bindPopup("<b>Lokasi Pekerjaan</b><br><%= job.customer_name %>")
                        .openPopup();

                    // Force refresh size incase of rendering issues
                    setTimeout(() => { map.invalidateSize(); }, 500);
                } else {
                    mapContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 text-sm bg-gray-50">Format koordinat tidak valid</div>';
                }
            } catch (e) {
                console.error("Map init error:", e);
                mapContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 text-sm bg-gray-50">Gagal memuat peta</div>';
            }
        } else {
            if (mapContainer) {
                mapContainer.innerHTML = '<div class="flex items-center justify-center h-full text-gray-400 text-sm bg-gray-50 italic">Koordinat lokasi tidak tersedia</div>';
            }
        }
    });

    // Action Scripts
    async function acceptJobFromDetail(id) {
        if (!confirm('Konfirmasi: Ambil pekerjaan ini sekarang?')) return;
        try {
            const res = await fetch('/api/technician/jobs/accept', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id }) });
            const result = await res.json();
            if (result.success) {
                // Show success toast or reload
                window.location.reload();
            } else {
                alert('Gagal: ' + result.error);
            }
        } catch (e) { alert('Error Connection'); }
    }

    async function declineJobFromDetail(id) {
        if (!confirm('Konfirmasi: Kembalikan pekerjaan ke antrian umum?')) return;
        try {
            const res = await fetch('/api/technician/jobs/decline', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ id: id }) });
            const result = await res.json();
            if (result.success) { window.location.reload(); } else { alert(result.error); }
        } catch (e) { alert('Error Connection'); }
    }

    var df = document.getElementById('detailCompletionForm');
    if (df) {
        df.addEventListener('submit', async function (e) {
            e.preventDefault();
            var id = document.getElementById('jobId').value;
            var notes = document.getElementById('detailNotes').value;
            var proof = document.getElementById('detailProof').files[0];

            if (!notes) { alert('Mohon isi catatan penyelesaian.'); return; }
            if (!confirm('Pastikan data sudah benar. Selesaikan pekerjaan ini?')) return;

            // Show loading state
            var btn = df.querySelector('button[type="submit"]');
            var originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Mengirim...';

            var fd = new FormData();
            fd.append('id', id);
            fd.append('notes', notes);
            if (proof) fd.append('proof', proof);
            try {
                var res = await fetch('/api/technician/jobs/complete', { method: 'POST', body: fd });
                var result = await res.json();
                if (result.success) {
                    window.location.reload();
                } else {
                    alert('Gagal: ' + result.error);
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                }
            } catch (e) {
                alert('Error Connection');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });
    }
</script>