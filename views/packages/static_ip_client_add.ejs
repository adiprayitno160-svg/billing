<div class="rounded border border-slate-200 bg-white p-4">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Tambah Client ke Paket: <%= package.name %>
        </h2>
        <a href="/packages/static-ip/<%= package.id %>/clients"
            class="px-3 py-1.5 rounded border border-slate-300 text-slate-700 hover:bg-slate-50">
            ← Kembali
        </a>
    </div>

    <% if (error && error.length> 0) { %>
        <div class="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded">
            <%= error[0] %>
        </div>
        <% } %>

            <!-- Informasi Paket -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded">
                <h3 class="font-medium text-blue-700 mb-2">ℹ️ Informasi Paket</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-600">
                    <div><span class="font-medium">Max Clients:</span>
                        <%= package.max_clients || 1 %>
                    </div>
                    <div><span class="font-medium">Upload Limit:</span>
                        <%= package.max_limit_upload %>
                    </div>
                    <div><span class="font-medium">Download Limit:</span>
                        <%= package.max_limit_download %>
                    </div>
                    <div><span class="font-medium">Parent Upload:</span>
                        <%= package.parent_upload_name || '-' %>
                    </div>
                    <div><span class="font-medium">Parent Download:</span>
                        <%= package.parent_download_name || '-' %>
                    </div>
                    <div><span class="font-medium">Child Parent (View Only):</span>
                        <span class="px-2 py-1 text-xs rounded bg-purple-100 text-purple-700">
                            <%= package.parent_upload_name %> / <%= package.parent_download_name %>
                        </span>
                    </div>
                </div>
            </div>

            <form method="post" action="/packages/static-ip/<%= package.id %>/clients"
                class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nama Client *</label>
                    <input name="client_name" required placeholder="Contoh: Client A"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <p class="text-xs text-slate-500 mt-1">Nama untuk mengidentifikasi client</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">IP Address *</label>
                    <input name="ip_address" required placeholder="192.168.1.1/30"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <p class="text-xs text-slate-500 mt-1">IP address yang akan digunakan client</p>
                </div>

                <!-- Informasi Kontak -->
                <div class="sm:col-span-2">
                    <h3 class="text-md font-medium text-slate-700 mb-3 border-b border-slate-200 pb-2">📞 Informasi
                        Kontak</h3>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Alamat</label>
                    <textarea name="address" placeholder="Alamat lengkap pelanggan"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        rows="3"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nomor Telepon</label>
                    <input name="phone_number" placeholder="08123456789"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>

                <!-- Koordinat & Maps -->
                <div class="sm:col-span-2">
                    <h3 class="text-md font-medium text-slate-700 mb-3 border-b border-slate-200 pb-2">📍 Koordinat &
                        Maps</h3>
                </div>

                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Koordinat (Latitude, Longitude)</label>
                    <div class="flex gap-2">
                        <input id="coordinates" placeholder="-6.xxxx, 106.xxxx"
                            class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 font-mono text-sm" />
                        <button type="button" id="btnGetLocation"
                            class="px-3 py-2 bg-slate-100 border border-slate-300 rounded text-slate-600 hover:bg-slate-200 transition-colors">📍</button>
                    </div>
                    <input name="latitude" type="hidden" />
                    <input name="longitude" type="hidden" />
                    <p class="text-[10px] text-slate-500 mt-1">Format: -6.xxxx, 106.xxxx atau klik ikon pin</p>
                </div>


                <!-- OLT, ODC, ODP -->
                <div class="sm:col-span-2">
                    <h3 class="text-md font-medium text-slate-700 mb-3 border-b border-slate-200 pb-2">🏗️ Infrastruktur
                        FTTH</h3>
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">OLT (View Only)</label>
                    <input name="olt_display" readonly
                        class="w-full rounded border border-slate-300 px-3 py-2 bg-slate-50"
                        placeholder="Akan muncul setelah memilih ODP" />
                    <input name="olt_id" type="hidden" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">ODC (View Only)</label>
                    <input name="odc_display" readonly
                        class="w-full rounded border border-slate-300 px-3 py-2 bg-slate-50"
                        placeholder="Akan muncul setelah memilih ODP" />
                    <input name="odc_id" type="hidden" />
                </div>

                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">ODP *</label>
                    <select name="odp_id" required
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        onchange="updateOLTODC()">
                        <option value="">Pilih ODP</option>
                        <!-- ODP options akan diisi dari server -->
                    </select>
                    <p class="text-xs text-slate-500 mt-1">Pilih ODP untuk mengisi OLT dan ODC secara otomatis</p>
                </div>

                <!-- Informasi Sistem Share -->
                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Sistem Share</label>
                    <div class="p-3 bg-green-50 border border-green-200 rounded text-sm text-green-700">
                        <p class="font-medium mb-1">✅ Informasi Sistem Share:</p>
                        <p>• Child parent diambil dari parent paket (view only)</p>
                        <p>• Bandwidth akan dibagi rata sesuai max clients</p>
                        <p>• Contoh: <%= package.max_limit_upload %> untuk <%= package.max_clients || 1 %> clients =
                                    <%= package.max_clients> 1 ?
                                        Math.floor(parseInt(package.max_limit_upload.replace(/[^0-9]/g, '')) /
                                        package.max_clients) + 'M' : package.max_limit_upload %> per client</p>
                    </div>
                </div>

                <!-- Garis Pembatas -->
                <div class="sm:col-span-2 border-t border-slate-200 my-4"></div>

                <!-- Child Template untuk Pelanggan -->
                <div class="sm:col-span-2">
                    <h3 class="text-base font-semibold mb-2">Child Template untuk Pelanggan</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Interface MikroTik</label>
                            <select name="interface" required class="w-full rounded border border-slate-300 px-3 py-2">
                                <option value="">-- Pilih Interface --</option>
                                <% (interfaces || []).forEach(function(ifc){ %>
                                    <option value="<%= ifc.name %>">
                                        <%= ifc.name %>
                                    </option>
                                    <% }) %>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Packet Mark (preview)</label>
                            <input id="clientPacketMarkPreview" readonly
                                class="w-full rounded border border-slate-300 px-3 py-2 bg-slate-50" />
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Child Download Queue Name</label>
                            <input id="clientChildDownloadName" readonly
                                class="w-full rounded border border-slate-300 px-3 py-2 bg-slate-50" />
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Child Upload Queue Name</label>
                            <input id="clientChildUploadName" readonly
                                class="w-full rounded border border-slate-300 px-3 py-2 bg-slate-50" />
                        </div>
                    </div>
                </div>

                <div class="sm:col-span-2 flex justify-end gap-3">
                    <a href="/packages/static-ip/<%= package.id %>/clients"
                        class="px-4 py-2 rounded border border-slate-300 text-slate-700 hover:bg-slate-50">
                        Batal
                    </a>
                    <button type="submit" class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700">
                        Tambah Client
                    </button>
                </div>
            </form>

            <script>
                // Data ODP untuk lookup OLT/ODC
                const odpData = <% - JSON.stringify(odpData || []) %>;

                function updateOLTODC() {
                    const odpSelect = document.querySelector('select[name="odp_id"]');
                    const oltDisplay = document.querySelector('input[name="olt_display"]');
                    const odcDisplay = document.querySelector('input[name="odc_display"]');
                    const oltIdInput = document.querySelector('input[name="olt_id"]');
                    const odcIdInput = document.querySelector('input[name="odc_id"]');

                    const selectedOdpId = odpSelect.value;
                    if (selectedOdpId) {
                        const odp = odpData.find(o => o.id == selectedOdpId);
                        if (odp) {
                            oltDisplay.value = odp.olt_name || '';
                            odcDisplay.value = odp.odc_name || '';
                            oltIdInput.value = odp.olt_id || '';
                            odcIdInput.value = odp.odc_id || '';
                        }
                    } else {
                        oltDisplay.value = '';
                        odcDisplay.value = '';
                        oltIdInput.value = '';
                        odcIdInput.value = '';
                    }
                }

                // Maps integration
                function initMaps() {
                    const coordInput = document.getElementById('coordinates');
                    const latInput = document.querySelector('input[name="latitude"]');
                    const lngInput = document.querySelector('input[name="longitude"]');
                    const btnGet = document.getElementById('btnGetLocation');

                    if (coordInput) {
                        coordInput.addEventListener('change', () => {
                            const parts = coordInput.value.split(',').map(s => s.trim());
                            if (parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))) {
                                latInput.value = parseFloat(parts[0]);
                                lngInput.value = parseFloat(parts[1]);
                            }
                        });
                    }

                    if (btnGet) {
                        btnGet.addEventListener('click', () => {
                            if ("geolocation" in navigator) {
                                btnGet.textContent = '...';
                                navigator.geolocation.getCurrentPosition(pos => {
                                    const { latitude, longitude } = pos.coords;
                                    latInput.value = latitude.toFixed(6);
                                    lngInput.value = longitude.toFixed(6);
                                    coordInput.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                                    btnGet.textContent = '📍';
                                }, err => {
                                    alert('Gagal mendapatkan lokasi: ' + err.message);
                                    btnGet.textContent = '📍';
                                });
                            }
                        });
                    }
                }

                function initFormProtection() {
                    const forms = document.querySelectorAll('form');
                    forms.forEach(form => {
                        form.addEventListener('submit', function (e) {
                            const btn = this.querySelector('button[type="submit"]');
                            if (btn && !btn.disabled) {
                                btn.disabled = true;
                                const originalText = btn.innerHTML;
                                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Memproses...';

                                // Re-enable after 10 seconds just in case server hangs (optional safety)
                                setTimeout(() => {
                                    if (btn.disabled) {
                                        btn.disabled = false;
                                        btn.innerHTML = originalText;
                                    }
                                }, 10000);
                            }
                        });
                    });
                }

                (function () {
                    const ipInput = document.querySelector('input[name="ip_address"]');
                    const nameInput = document.querySelector('input[name="client_name"]');
                    const markEl = document.getElementById('clientPacketMarkPreview');
                    const cdEl = document.getElementById('clientChildDownloadName');
                    const cuEl = document.getElementById('clientChildUploadName');
                    function ipToInt(ip) { return ip.split('.').reduce((acc, oct) => (acc << 8) + parseInt(oct), 0) >>> 0 }
                    function intToIp(int) { return [(int >>> 24) & 255, (int >>> 16) & 255, (int >>> 8) & 255, int & 255].join('.') }
                    function update() {
                        const v = (ipInput.value || '').trim();
                        const [ip, prefStr] = v.split('/');
                        const pref = Number(prefStr || '0');
                        if (!ip) { if (markEl) markEl.value = ''; return; }

                        // FIX: Always use CLIENT IP for Marks/Queues
                        let peer = ip;
                        // Remove swapped logic for display to match backend

                        if (markEl) markEl.value = `Download: ${peer} | Upload: UP-${peer}`;
                        const name = (nameInput && nameInput.value) ? nameInput.value.trim() : '';
                        if (cdEl) cdEl.value = name ? `${name}_DOWNLOAD` : '';
                        if (cuEl) cuEl.value = name ? `${name}_UPLOAD` : '';
                    }
                    if (ipInput) ipInput.addEventListener('input', update);
                    if (nameInput) nameInput.addEventListener('input', update);
                    update();

                    // Initialize maps
                    initMaps();
                    // Initialize Form Protection
                    initFormProtection();
                })();
            </script>
</div>