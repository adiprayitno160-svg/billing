<div class="max-w-5xl mx-auto space-y-6">
    <!-- Breadcrumb & Title -->
    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
            <nav class="flex text-sm text-slate-500 mb-2" aria-label="Breadcrumb">
                <ol class="list-none p-0 inline-flex">
                    <li class="flex items-center">
                        <a href="/packages/static-ip" class="hover:text-blue-600 transition-colors">Paket Static IP</a>
                        <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
                    </li>
                    <li class="flex items-center">
                        <a href="/packages/static-ip/<%= package.id %>/clients"
                            class="hover:text-blue-600 transition-colors">Clients</a>
                        <i class="fas fa-chevron-right mx-2 text-[10px]"></i>
                    </li>
                    <li class="text-blue-600 font-semibold">Tambah Client</li>
                </ol>
            </nav>
            <h2 class="text-2xl font-bold text-slate-800">Tambah Client Baru</h2>
            <p class="text-slate-500 text-sm">Paket: <span class="font-bold text-slate-700">
                    <%= package.name %>
                </span></p>
        </div>
        <a href="/packages/static-ip/<%= package.id %>/clients"
            class="flex items-center justify-center gap-2 px-4 py-2 rounded-xl border border-slate-300 bg-white text-slate-700 font-medium text-sm hover:bg-slate-50 transition-all active:scale-95 shadow-sm">
            <i class="fas fa-arrow-left"></i>
            Kembali
        </a>
    </div>

    <% if (error && error.length> 0) { %>
        <div
            class="animate-shake p-4 bg-rose-50 border border-rose-100 text-rose-700 rounded-2xl flex items-center gap-3 shadow-sm">
            <i class="fas fa-exclamation-circle text-xl"></i>
            <p class="font-medium text-sm">
                <%= error[0] %>
            </p>
        </div>
        <% } %>

            <form method="post" action="/packages/static-ip/<%= package.id %>/clients" id="main-client-form">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

                    <!-- Left Column: Primary Data -->
                    <div class="lg:col-span-2 space-y-6">

                        <!-- Section 1: Customer Link -->
                        <div
                            class="bg-white rounded-3xl border border-slate-100 shadow-xl shadow-slate-200/50 overflow-hidden">
                            <div class="p-5 border-b border-slate-50 bg-blue-50/30 flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-blue-600 flex items-center justify-center text-white shadow-lg shadow-blue-200">
                                    <i class="fas fa-link"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 leading-tight">Link Akun Pelanggan</h3>
                                    <p class="text-[10px] text-blue-600 font-bold uppercase tracking-wider">Otomatisasi
                                        Data Billing</p>
                                </div>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Cari Pelanggan
                                        Eksisting</label>
                                    <div class="relative group">
                                        <select id="customer_selector" onchange="selectCustomer(this.value)"
                                            class="w-full rounded-2xl border border-slate-200 px-4 py-3 bg-slate-50 focus:bg-white focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400 transition-all appearance-none cursor-pointer">
                                            <option value="">-- Buat Pelanggan Baru (Manual) --</option>
                                            <% (customers || []).forEach(function(cust) { %>
                                                <option value="<%= cust.id %>" data-name="<%= cust.name %>"
                                                    data-phone="<%= cust.phone %>" data-address="<%= cust.address %>">
                                                    <%= cust.name %> (<%= cust.customer_code %>)
                                                </option>
                                                <% }) %>
                                        </select>
                                        <div
                                            class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                            <i class="fas fa-search"></i>
                                        </div>
                                    </div>
                                    <p class="text-[11px] text-slate-400 mt-2 italic flex items-center gap-1">
                                        <i class="fas fa-info-circle text-blue-400"></i>
                                        Memilih pelanggan akan mengisi nama, telepon, dan alamat secara otomatis.
                                    </p>
                                    <input type="hidden" name="customer_id" id="customer_id_input" />
                                </div>
                            </div>
                        </div>

                        <!-- Section 2: Basic Identity -->
                        <div
                            class="bg-white rounded-3xl border border-slate-100 shadow-xl shadow-slate-200/50 overflow-hidden">
                            <div class="p-5 border-b border-slate-50 flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-slate-800 flex items-center justify-center text-white shadow-lg shadow-slate-200">
                                    <i class="fas fa-user-tag"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 leading-tight">Informasi Dasar</h3>
                                    <p class="text-[10px] text-slate-400 font-bold uppercase tracking-wider">Identitas &
                                        IP Client</p>
                                </div>
                            </div>
                            <div class="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">Nama Client <span
                                            class="text-rose-500">*</span></label>
                                    <input name="client_name" id="client_name_input" required
                                        placeholder="Contoh: Budi Santoso"
                                        class="w-full rounded-2xl border border-slate-200 px-4 py-3 bg-slate-50 focus:bg-white focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400 transition-all" />
                                </div>
                                <div>
                                    <label class="block text-sm font-bold text-slate-700 mb-2">IP Address <span
                                            class="text-rose-500">*</span></label>
                                    <div class="relative">
                                        <input name="ip_address" required placeholder="192.168.239.x"
                                            class="w-full rounded-2xl border border-slate-200 px-4 py-3 bg-slate-50 focus:bg-white focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400 font-mono transition-all" />
                                        <div
                                            class="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-md">
                                            /30</div>
                                    </div>
                                </div>
                                <div class="md:col-span-2 p-4 bg-indigo-50/50 rounded-2xl border border-indigo-100">
                                    <div class="flex items-center gap-3 mb-2">
                                        <i class="fas fa-shield-alt text-indigo-600"></i>
                                        <span
                                            class="text-xs font-bold text-indigo-700 uppercase tracking-widest">Preview
                                            MikroTik</span>
                                    </div>
                                    <input id="clientPacketMarkPreview" readonly
                                        class="w-full bg-transparent border-none p-0 text-sm font-mono text-indigo-800 focus:ring-0 cursor-default"
                                        value="Masukkan IP untuk melihat preview..." />
                                </div>
                            </div>
                        </div>

                        <!-- Section 3: Contact & Location -->
                        <div
                            class="bg-white rounded-3xl border border-slate-100 shadow-xl shadow-slate-200/50 overflow-hidden">
                            <div class="p-5 border-b border-slate-50 flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-amber-500 flex items-center justify-center text-white shadow-lg shadow-amber-100">
                                    <i class="fas fa-map-marked-alt"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 leading-tight">Kontak & Lokasi</h3>
                                    <p class="text-[10px] text-amber-600 font-bold uppercase tracking-wider">Alamat &
                                        Koordinat GPS</p>
                                </div>
                            </div>
                            <div class="p-6 space-y-6">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div class="md:col-span-2">
                                        <label class="block text-sm font-bold text-slate-700 mb-2">Alamat
                                            Lengkap</label>
                                        <textarea name="address" id="address_input"
                                            placeholder="Jln. Melati No. 45, RT 02/03..."
                                            class="w-full rounded-2xl border border-slate-200 px-4 py-3 bg-slate-50 focus:bg-white focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400 transition-all"
                                            rows="3"></textarea>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-2">Nomor Telepon</label>
                                        <div class="relative">
                                            <input name="phone_number" id="phone_input" placeholder="0812xxxxxx"
                                                class="w-full rounded-2xl border border-slate-200 pl-10 pr-4 py-3 bg-slate-50 focus:bg-white focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400 transition-all" />
                                            <div
                                                class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs">
                                                <i class="fas fa-phone-alt"></i>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-bold text-slate-700 mb-2">Koordinat GPS</label>
                                        <div class="flex gap-2">
                                            <div class="relative flex-1">
                                                <input id="coordinates" placeholder="-6.xxxx, 106.xxxx"
                                                    class="w-full rounded-2xl border border-slate-200 pl-10 pr-4 py-3 bg-slate-50 focus:bg-white focus:outline-none focus:ring-4 focus:ring-blue-100 focus:border-blue-400 font-mono text-sm transition-all" />
                                                <div
                                                    class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs">
                                                    <i class="fas fa-crosshairs"></i>
                                                </div>
                                            </div>
                                            <button type="button" id="btnGetLocation"
                                                class="px-4 py-3 bg-amber-500 text-white rounded-2xl hover:bg-amber-600 shadow-md shadow-amber-100 transition-all active:scale-95">
                                                <i class="fas fa-location-arrow"></i>
                                            </button>
                                        </div>
                                        <input name="latitude" type="hidden" />
                                        <input name="longitude" type="hidden" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Infrastructure & Meta -->
                    <div class="space-y-6">
                        <!-- Section 4: Infrastructure -->
                        <div
                            class="bg-white rounded-3xl border border-slate-100 shadow-xl shadow-slate-200/50 overflow-hidden">
                            <div class="p-5 border-b border-slate-50 bg-emerald-50/30 flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-emerald-600 flex items-center justify-center text-white shadow-lg shadow-emerald-100">
                                    <i class="fas fa-network-wired"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 leading-tight">FTTH Infrastruktur</h3>
                                    <p class="text-[10px] text-emerald-600 font-bold uppercase tracking-wider">OLT, ODC
                                        & ODP</p>
                                </div>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label
                                        class="block text-xs font-black text-slate-400 uppercase mb-2 tracking-tighter">Pilih
                                        ODP *</label>
                                    <select name="odp_id" required onchange="updateOLTODC()"
                                        class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-slate-50 focus:ring-4 focus:ring-emerald-100 focus:border-emerald-400 transition-all">
                                        <option value="">-- Pilih ODP --</option>
                                        <% (odpData || []).forEach(o=> { %>
                                            <option value="<%= o.id %>">
                                                <%= o.odp_name %>
                                            </option>
                                            <% }) %>
                                    </select>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label
                                            class="block text-[9px] font-black text-slate-400 uppercase mb-1">OLT</label>
                                        <input name="olt_display" readonly
                                            class="w-full rounded-lg border border-slate-100 px-3 py-2 bg-slate-100 text-xs text-slate-500 font-bold"
                                            value="-" />
                                        <input name="olt_id" type="hidden" />
                                    </div>
                                    <div>
                                        <label
                                            class="block text-[9px] font-black text-slate-400 uppercase mb-1">ODC</label>
                                        <input name="odc_display" readonly
                                            class="w-full rounded-lg border border-slate-100 px-3 py-2 bg-slate-100 text-xs text-slate-500 font-bold"
                                            value="-" />
                                        <input name="odc_id" type="hidden" />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 5: MikroTik Config -->
                        <div
                            class="bg-white rounded-3xl border border-slate-100 shadow-xl shadow-slate-200/50 overflow-hidden">
                            <div class="p-5 border-b border-slate-50 bg-purple-50/30 flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-xl bg-purple-600 flex items-center justify-center text-white shadow-lg shadow-purple-100">
                                    <i class="fas fa-microchip"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-slate-800 leading-tight">MikroTik Router</h3>
                                    <p class="text-[10px] text-purple-600 font-bold uppercase tracking-wider">Interface
                                        & Queue</p>
                                </div>
                            </div>
                            <div class="p-6 space-y-4">
                                <div>
                                    <label
                                        class="block text-xs font-black text-slate-400 uppercase mb-2 tracking-tighter">Interface
                                        *</label>
                                    <select name="interface" required
                                        class="w-full rounded-xl border border-slate-200 px-3 py-2.5 bg-slate-50 focus:ring-4 focus:ring-purple-100 focus:border-purple-400 transition-all">
                                        <option value="">-- Pilih Interface --</option>
                                        <% (interfaces || []).forEach(f=> { %>
                                            <option value="<%= f.name %>">
                                                <%= f.name %>
                                            </option>
                                            <% }) %>
                                    </select>
                                </div>
                                <div class="space-y-2">
                                    <div class="p-3 rounded-xl bg-slate-50 border border-slate-100">
                                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Queue Download</p>
                                        <input id="clientChildDownloadName" readonly
                                            class="w-full bg-transparent border-none p-0 text-[11px] font-mono text-slate-600 focus:ring-0"
                                            placeholder="Akan diisi otomatis..." />
                                    </div>
                                    <div class="p-3 rounded-xl bg-slate-50 border border-slate-100">
                                        <p class="text-[9px] font-bold text-slate-400 uppercase mb-1">Queue Upload</p>
                                        <input id="clientChildUploadName" readonly
                                            class="w-full bg-transparent border-none p-0 text-[11px] font-mono text-slate-600 focus:ring-0"
                                            placeholder="Akan diisi otomatis..." />
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Section 6: Package Summary (Mini Widget) -->
                        <div
                            class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-3xl p-6 text-white shadow-xl shadow-blue-200">
                            <div class="flex items-center gap-2 mb-4">
                                <i class="fas fa-box-open opacity-50"></i>
                                <span class="text-[10px] font-bold uppercase tracking-widest text-blue-100">Ringkasan
                                    Paket</span>
                            </div>
                            <div class="space-y-3">
                                <div class="flex justify-between items-center border-b border-white/20 pb-2">
                                    <span class="text-xs text-blue-100">Limit Download</span>
                                    <span class="font-bold">
                                        <%= package.max_limit_download %>
                                    </span>
                                </div>
                                <div class="flex justify-between items-center border-b border-white/20 pb-2">
                                    <span class="text-xs text-blue-100">Limit Upload</span>
                                    <span class="font-bold">
                                        <%= package.max_limit_upload %>
                                    </span>
                                </div>
                                <div class="flex justify-between items-center bg-white/10 p-3 rounded-xl">
                                    <span class="text-xs text-blue-100">Share per User</span>
                                    <span class="font-bold text-amber-300">
                                        <%= package.max_clients> 1 ?
                                            Math.floor(parseInt(package.max_limit_download.replace(/[^0-9]/g, '')) /
                                            package.max_clients) + 'M' : package.max_limit_download %>
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div
                        class="lg:col-span-3 flex items-center justify-between p-6 bg-slate-100/50 rounded-3xl border border-slate-200/50 mt-4">
                        <p class="text-xs text-slate-500 hidden sm:block">Pastikan semua data bertanda <span
                                class="text-rose-500 font-bold">*</span> telah diisi dengan benar.</p>
                        <div class="flex gap-3 w-full sm:w-auto">
                            <a href="/packages/static-ip/<%= package.id %>/clients"
                                class="flex-1 sm:flex-none text-center px-8 py-3 rounded-2xl bg-white border border-slate-300 text-slate-700 font-bold hover:bg-slate-50 transition-all active:scale-95 shadow-sm">
                                Batal
                            </a>
                            <button type="submit"
                                class="flex-1 sm:flex-none px-12 py-3 rounded-2xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-lg shadow-blue-200 transition-all active:scale-95 transform">
                                Simpan Client
                            </button>
                        </div>
                    </div>
                </div>
            </form>

            <script>
                function selectCustomer(id) {
                    const selector = document.getElementById('customer_selector');
                    const nameInput = document.getElementById('client_name_input');
                    const phoneInput = document.getElementById('phone_input');
                    const addressInput = document.getElementById('address_input');
                    const customerIdInput = document.getElementById('customer_id_input');

                    if (!id) {
                        customerIdInput.value = '';
                        return;
                    }

                    const option = selector.options[selector.selectedIndex];
                    const name = option.getAttribute('data-name');
                    const phone = option.getAttribute('data-phone');
                    const address = option.getAttribute('data-address');

                    if (nameInput) nameInput.value = name || '';
                    if (phoneInput) phoneInput.value = (phone && phone !== 'null') ? phone : '';
                    if (addressInput) addressInput.value = (address && address !== 'null') ? address : '';
                    if (customerIdInput) customerIdInput.value = id;

                    // Trigger update for preview
                    if (window.globalUpdate) window.globalUpdate();
                }

                // Data ODP untuk lookup OLT/ODC
                const odpData = <% - JSON.stringify(odpData || []) %>;

                function updateOLTODC() {
                    const odpSelect = document.querySelector('select[name="odp_id"]');
                    const oltDisplay = document.querySelector('input[name="olt_display"]');
                    const odcDisplay = document.querySelector('input[name="odc_display"]');
                    const oltIdInput = document.querySelector('input[name="olt_id"]');
                    const odcIdInput = document.querySelector('input[name="odc_id"]');

                    const selectedOdpId = odpSelect.value;
                    if (selectedOdpId) {
                        const odp = odpData.find(o => o.id == selectedOdpId);
                        if (odp) {
                            oltDisplay.value = odp.olt_name || '-';
                            odcDisplay.value = odp.odc_name || '-';
                            oltIdInput.value = odp.olt_id || '';
                            odcIdInput.value = odp.odc_id || '';
                        }
                    } else {
                        oltDisplay.value = '-';
                        odcDisplay.value = '-';
                        oltIdInput.value = '';
                        odcIdInput.value = '';
                    }
                }

                // Maps integration
                function initMaps() {
                    const coordInput = document.getElementById('coordinates');
                    const latInput = document.querySelector('input[name="latitude"]');
                    const lngInput = document.querySelector('input[name="longitude"]');
                    const btnGet = document.getElementById('btnGetLocation');

                    if (coordInput) {
                        coordInput.addEventListener('change', () => {
                            const parts = coordInput.value.split(',').map(s => s.trim());
                            if (parts.length === 2 && !isNaN(parseFloat(parts[0])) && !isNaN(parseFloat(parts[1]))) {
                                latInput.value = parseFloat(parts[0]);
                                lngInput.value = parseFloat(parts[1]);
                            }
                        });
                    }

                    if (btnGet) {
                        btnGet.addEventListener('click', () => {
                            if ("geolocation" in navigator) {
                                const originalContent = btnGet.innerHTML;
                                btnGet.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                                navigator.geolocation.getCurrentPosition(pos => {
                                    const { latitude, longitude } = pos.coords;
                                    latInput.value = latitude.toFixed(6);
                                    lngInput.value = longitude.toFixed(6);
                                    coordInput.value = `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
                                    btnGet.innerHTML = originalContent;

                                    // Visual feedback
                                    btnGet.classList.remove('bg-amber-500');
                                    btnGet.classList.add('bg-emerald-500');
                                    setTimeout(() => {
                                        btnGet.classList.remove('bg-emerald-500');
                                        btnGet.classList.add('bg-amber-500');
                                    }, 2000);
                                }, err => {
                                    alert('Gagal mendapatkan lokasi: ' + err.message);
                                    btnGet.innerHTML = originalContent;
                                }, { timeout: 10000 });
                            }
                        });
                    }
                }

                function initFormProtection() {
                    const form = document.getElementById('main-client-form');
                    if (!form) return;
                    form.addEventListener('submit', function (e) {
                        const btn = this.querySelector('button[type="submit"]');
                        if (btn && !btn.disabled) {
                            btn.disabled = true;
                            btn.classList.add('opacity-70', 'cursor-not-allowed');
                            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin mr-2"></i> Manyimpan...';
                        }
                    });
                }

                (function () {
                    const ipInput = document.querySelector('input[name="ip_address"]');
                    const nameInput = document.querySelector('input[name="client_name"]');
                    const markEl = document.getElementById('clientPacketMarkPreview');
                    const cdEl = document.getElementById('clientChildDownloadName');
                    const cuEl = document.getElementById('clientChildUploadName');

                    function update() {
                        const v = (ipInput.value || '').trim();
                        const [ip] = v.split('/');
                        if (!ip) {
                            if (markEl) markEl.value = 'Masukkan IP untuk melihat preview...';
                            return;
                        }

                        // FIX: Always use CLIENT IP for Marks/Queues
                        let peer = ip;
                        if (markEl) markEl.value = `Download: ${peer} | Upload: UP-${peer} (Mangle Marks)`;

                        const name = (nameInput && nameInput.value) ? nameInput.value.trim().toUpperCase() : '';
                        if (cdEl) cdEl.value = name ? `${name}_DOWNLOAD` : 'Otomatis dari Nama...';
                        if (cuEl) cuEl.value = name ? `${name}_UPLOAD` : 'Otomatis dari Nama...';
                    }

                    if (ipInput) ipInput.addEventListener('input', update);
                    if (nameInput) nameInput.addEventListener('input', update);
                    window.globalUpdate = update;
                    update();

                    // Initialize features
                    initMaps();
                    initFormProtection();
                })();
            </script>
</div>