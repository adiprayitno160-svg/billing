<div class="rounded border border-slate-200 bg-white p-4">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Tambah Paket IP Static</h2>
        <a href="/packages/static-ip"
            class="px-3 py-1.5 rounded border border-slate-300 text-slate-700 hover:bg-slate-50">
            ← Kembali
        </a>
    </div>

    <% if (error && error.length> 0) { %>
        <div class="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded">
            <%= error[0] %>
        </div>
        <% } %>

            <form method="post" action="/packages/static-ip" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <!-- Baris 1: Nama Paket & Status -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Nama Paket *</label>
                    <input name="name" required
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Status</label>
                    <select name="status"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="active">Aktif</option>
                        <option value="inactive">Nonaktif</option>
                    </select>
                </div>

                <!-- Baris 2: Harga Reguler -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Harga Reguler (Rp) *</label>
                    <input name="price" type="number" min="0" step="1000" required
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>

                <!-- Baris 2b: Harga Prepaid -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Harga Prepaid 7 Hari (Rp)</label>
                    <input name="price_7_days" type="number" min="0" step="1000"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="0 (kosongkan jika tidak digunakan untuk prepaid)" />
                </div>

                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Harga Prepaid 30 Hari (Rp)</label>
                    <input name="price_30_days" type="number" min="0" step="1000"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        placeholder="0 (kosongkan jika tidak digunakan untuk prepaid)" />
                </div>


                <!-- Baris 3: Parent Upload & Parent Download (HIDDEN - handled automatically) -->
                <div class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Parent Upload *</label>
                    <input name="parent_upload_name" type="text" value="SIMPLE_QUEUE_PARENT"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <p class="text-xs text-slate-500 mt-1">Ketik nama parent upload yang sudah ada di MikroTik</p>
                </div>
                <div class="hidden">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Parent Download *</label>
                    <input name="parent_download_name" type="text" value="SIMPLE_QUEUE_PARENT"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <p class="text-xs text-slate-500 mt-1">Ketik nama parent download yang sudah ada di MikroTik</p>
                </div>

                <!-- Baris 4: Limit Upload & Download -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Max Limit Upload *</label>
                    <input name="max_limit_upload" required placeholder="10M"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <p class="text-xs text-slate-500 mt-1">Contoh: 10M, 5M, 1M</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Limit At Upload</label>
                    <input name="limit_at_upload" placeholder="mis: 2M"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Max Limit Download *</label>
                    <input name="max_limit_download" required placeholder="20M"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <p class="text-xs text-slate-500 mt-1">Contoh: 20M, 10M, 5M</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Limit At Download</label>
                    <input name="limit_at_download" placeholder="mis: 2M"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                </div>

                <!-- Baris 5: Max Clients & Sistem Share -->
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Max Clients *</label>
                    <input name="max_clients" type="number" min="1" required placeholder="1"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    <p class="text-xs text-slate-500 mt-1">Jumlah maksimal client yang bisa menggunakan paket ini</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">Sistem Share</label>
                    <div class="p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-700">
                        <p class="font-medium mb-1">ℹ️ Informasi Sistem Share:</p>
                        <p>• Jika Max Clients > 1, bandwidth akan dibagi rata</p>
                        <p>• Contoh: 10M untuk 2 clients = 5M per client</p>
                        <p>• Child parent akan diambil dari parent paket (view only)</p>
                    </div>
                </div>

                <!-- Garis Pembatas -->
                <div class="sm:col-span-2 border-t border-slate-200 my-4"></div>

                <!-- Child Template untuk Pelanggan -->
                <div class="sm:col-span-2">
                    <h3 class="text-lg font-semibold text-slate-700 mb-3">📋 Child Template untuk Pelanggan</h3>
                    <div class="p-4 bg-slate-50 border border-slate-200 rounded">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Nama Paket *</label>
                                <input name="child_upload_name" readonly placeholder="PAKET_NAME_UPLOAD"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p class="text-xs text-slate-500 mt-1">Diisi otomatis dari Nama Paket (format:
                                    NAMA_PAKET_UPLOAD)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Nama Paket *</label>
                                <input name="child_download_name" readonly placeholder="PAKET_NAME_DOWNLOAD"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p class="text-xs text-slate-500 mt-1">Diisi otomatis dari Nama Paket (format:
                                    NAMA_PAKET_DOWNLOAD)</p>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Max Upload</label>
                                <input name="child_upload_limit" placeholder="5M"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p class="text-xs text-slate-500 mt-1">Batas upload per pelanggan</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Max Download</label>
                                <input name="child_download_limit" placeholder="10M"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p class="text-xs text-slate-500 mt-1">Batas download per pelanggan</p>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Child Limit-At
                                    Upload</label>
                                <input name="child_limit_at_upload" placeholder="2M"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p class="text-xs text-slate-500 mt-1">Nilai limit-at upload (opsional)</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Child Limit-At
                                    Download</label>
                                <input name="child_limit_at_download" placeholder="2M"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                <p class="text-xs text-slate-500 mt-1">Nilai limit-at download (opsional)</p>
                            </div>
                        </div>

                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Queue Type Download</label>
                                <select name="child_queue_type_download"
                                    class="w-full rounded border border-slate-300 px-3 py-2">
                                    <option value="pcq-download-default" selected>pcq-download-default</option>
                                    <option value="default">default</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Queue Type Upload</label>
                                <select name="child_queue_type_upload"
                                    class="w-full rounded border border-slate-300 px-3 py-2">
                                    <option value="pcq-upload-default" selected>pcq-upload-default</option>
                                    <option value="default">default</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Priority Download</label>
                                <select name="child_priority_download"
                                    class="w-full rounded border border-slate-300 px-3 py-2">
                                    <% for (var p=1;p<=8;p++){ %>
                                        <option value="<%= p %>" <%=p===8 ? 'selected' : '' %>><%= p %>
                                        </option>
                                        <% } %>
                                </select>
                                <div class="mt-3">
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Child Burst
                                        Download</label>
                                    <input name="child_burst_download" placeholder="10M"
                                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    <p class="text-xs text-slate-500 mt-1">Nilai burst-limit download (opsional)</p>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Priority Upload</label>
                                <select name="child_priority_upload"
                                    class="w-full rounded border border-slate-300 px-3 py-2">
                                    <% for (var p=1;p<=8;p++){ %>
                                        <option value="<%= p %>" <%=p===8 ? 'selected' : '' %>><%= p %>
                                        </option>
                                        <% } %>
                                </select>
                                <div class="mt-3">
                                    <label class="block text-sm font-medium text-slate-600 mb-1">Child Burst
                                        Upload</label>
                                    <input name="child_burst_upload" placeholder="10M"
                                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                                    <p class="text-xs text-slate-500 mt-1">Nilai burst-limit upload (opsional)</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Child Burst Threshold
                                    Upload</label>
                                <input name="child_burst_threshold_upload"
                                    placeholder="otomatis dari burst-limit (mis: 70%)"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Child Burst Threshold
                                    Download</label>
                                <input name="child_burst_threshold_download"
                                    placeholder="otomatis dari burst-limit (mis: 70%)"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Child Burst Time
                                    Upload</label>
                                <input name="child_burst_time_upload" placeholder="mis: 20s"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-600 mb-1">Child Burst Time
                                    Download</label>
                                <input name="child_burst_time_download" placeholder="mis: 20s"
                                    class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500" />
                            </div>
                        </div>
                        <div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded text-sm text-blue-700">
                            <p class="font-medium mb-1">ℹ️ Informasi Child Template:</p>
                            <p>• Child ini akan dibuat otomatis di MikroTik untuk setiap pelanggan</p>
                            <p>• Pelanggan A akan menggunakan child ini di bawah parent paket</p>
                            <p>• Speed akan dibagi sesuai max_clients yang ditentukan</p>
                            <p>• Template ini akan disimpan di database untuk referensi</p>
                        </div>
                    </div>
                </div>

                <div class="sm:col-span-2">
                    <label class="block text-sm font-medium text-slate-700 mb-1">Deskripsi</label>
                    <textarea name="description"
                        class="w-full rounded border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        rows="3" placeholder="Deskripsi paket (opsional)"></textarea>
                </div>
                <div class="sm:col-span-2 flex justify-end gap-3">
                    <button type="button" onclick="autoCalculateAll()"
                        class="px-4 py-2 rounded bg-amber-500 text-white hover:bg-amber-600 flex items-center gap-2 shadow-sm transition-all font-semibold">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
                        </svg>
                        Otomatis Isi Share & Burst
                    </button>
                    <a href="/packages/static-ip"
                        class="px-4 py-2 rounded border border-slate-300 text-slate-700 hover:bg-slate-50 font-semibold">
                        Batal
                    </a>
                    <button type="submit"
                        class="px-4 py-2 rounded bg-blue-600 text-white hover:bg-blue-700 font-semibold shadow-sm">
                        Simpan Paket
                    </button>
                </div>
                <script>
                    function parseBandwidth(val) {
                        if (!val) return 0;
                        val = val.toUpperCase().trim();
                        let num = parseFloat(val);
                        if (val.endsWith('M')) return num * 1024 * 1024;
                        if (val.endsWith('K')) return num * 1024;
                        if (val.endsWith('G')) return num * 1024 * 1024 * 1024;
                        return num;
                    }

                    function formatBandwidth(bits) {
                        if (bits >= 1024 * 1024 * 1024) return Math.round(bits / (1024 * 1024 * 1024)) + 'G';
                        if (bits >= 1024 * 1024) return Math.round(bits / (1024 * 1024)) + 'M';
                        if (bits >= 1024) return Math.round(bits / 1024) + 'K';
                        return Math.round(bits);
                    }

                    function autoCalculateAll() {
                        const maxUp = document.querySelector('input[name="max_limit_upload"]').value;
                        const maxDown = document.querySelector('input[name="max_limit_download"]').value;
                        const maxClients = parseInt(document.querySelector('input[name="max_clients"]').value) || 1;

                        if (!maxUp || !maxDown) {
                            alert('Silakan isi Max Limit Upload & Download terlebih dahulu!');
                            return;
                        }

                        const upBits = parseBandwidth(maxUp);
                        const downBits = parseBandwidth(maxDown);

                        // 1. Limit-At (Shared) - Default 1/2 of max limit
                        document.querySelector('input[name="limit_at_upload"]').value = formatBandwidth(upBits / 2);
                        document.querySelector('input[name="limit_at_download"]').value = formatBandwidth(downBits / 2);

                        // 2. Child Limits
                        const childUp = upBits / maxClients;
                        const childDown = downBits / maxClients;
                        document.querySelector('input[name="child_upload_limit"]').value = formatBandwidth(childUp);
                        document.querySelector('input[name="child_download_limit"]').value = formatBandwidth(childDown);

                        // 3. Child Limit-At (Default 1/4 of child max)
                        document.querySelector('input[name="child_limit_at_upload"]').value = formatBandwidth(childUp / 2);
                        document.querySelector('input[name="child_limit_at_download"]').value = formatBandwidth(childDown / 2);

                        // 4. Burst Calculator
                        // Burst Limit: 2x Max Limit
                        document.querySelector('input[name="child_burst_upload"]').value = formatBandwidth(childUp * 2);
                        document.querySelector('input[name="child_burst_download"]').value = formatBandwidth(childDown * 2);

                        // Burst Threshold: 80% of Max Limit
                        document.querySelector('input[name="child_burst_threshold_upload"]').value = formatBandwidth(childUp * 0.8);
                        document.querySelector('input[name="child_burst_threshold_download"]').value = formatBandwidth(childDown * 0.8);

                        // Burst Time: 20s (default stable)
                        document.querySelector('input[name="child_burst_time_upload"]').value = '20s';
                        document.querySelector('input[name="child_burst_time_download"]').value = '20s';

                        alert('✅ Kalkulasi otomatis selesai! Silakan sesuaikan kembali jika diperlukan.');
                    }

                    (function () {
                        var nameInput = document.querySelector('input[name="name"]');
                        var upload = document.querySelector('input[name="child_upload_name"]');
                        var download = document.querySelector('input[name="child_download_name"]');
                        function sync() {
                            var raw = (nameInput && nameInput.value) ? nameInput.value.trim() : '';
                            // Make it safe for MikroTik names (no spaces, special chars)
                            var safeRaw = raw.replace(/[^a-zA-Z0-9-]/g, '_');

                            if (upload) upload.value = safeRaw ? safeRaw + '_UPLOAD' : '';
                            if (download) download.value = safeRaw ? safeRaw + '_DOWNLOAD' : '';
                        }
                        if (nameInput) {
                            nameInput.addEventListener('input', sync);
                            window.addEventListener('DOMContentLoaded', sync);
                        }
                    })();

                    // Calculate expiry date for Static IP
                    function calculateStaticIpExpiry() {
                        const durationDays = parseInt(document.getElementById('duration_days').value) || 0;
                        if (durationDays <= 0) {
                            document.getElementById('static_ip_expiry_preview').textContent = '';
                            return;
                        }

                        const today = new Date();
                        const expiryDate = new Date(today);
                        expiryDate.setDate(today.getDate() + durationDays);

                        const options = { year: 'numeric', month: 'long', day: 'numeric' };
                        const formattedDate = expiryDate.toLocaleDateString('id-ID', options);

                        document.getElementById('static_ip_expiry_preview').textContent =
                            `📅 Jika aktivasi hari ini: Berakhir pada ${formattedDate}`;
                    }

                    // Initialize on page load
                    document.addEventListener('DOMContentLoaded', function () {
                        calculateStaticIpExpiry();
                    });
                </script>
            </form>
</div>