<div class="rounded border border-slate-200 bg-white p-4">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold">Daftar Paket IP Static</h2>
        <div class="flex gap-2">
            <form action="/packages/static-ip/sync-all" method="POST"
                onsubmit="return confirm('Yakin ingin sync semua Queue paket ke MikroTik? Proses ini akan membuat/update Simple Queue untuk SEMUA paket.');">
                <button type="submit"
                    class="px-4 py-2 rounded bg-orange-500 text-white font-semibold hover:bg-orange-600 inline-flex items-center gap-2 shadow-sm transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                    </svg>
                    Sync Semua Queue
                </button>
            </form>
            <a href="/packages/static-ip/add"
                class="px-4 py-2 rounded bg-blue-600 text-white font-semibold hover:bg-blue-700 inline-flex items-center gap-2 shadow-sm transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Tambah Paket
            </a>
        </div>
    </div>

    <% if (success && success.length>0) { %>
        <div class="mb-4 p-3 bg-green-100 border border-green-300 text-green-700 rounded">
            <%= success[0] %>
        </div>
        <% } %>

            <% if (error && error.length>0) { %>
                <div class="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded">
                    <%= error[0] %>
                </div>
                <% } %>

                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="text-left text-slate-600">
                                <tr>
                                    <th class="py-2 pr-4">Nama Paket</th>
                                    <!-- Simple Queue Mode: Hiding Parent/Child Names -->
                                    <th class="py-2 pr-4">Upload Limit</th>
                                    <th class="py-2 pr-4">Download Limit</th>
                                    <th class="py-2 pr-4">Max Clients</th>
                                    <th class="py-2 pr-4">Current Clients</th>
                                    <th class="py-2 pr-4">Shared Upload</th>
                                    <th class="py-2 pr-4">Shared Download</th>
                                    <th class="py-2 pr-4">Harga</th>
                                    <th class="py-2 pr-4">Status</th>
                                    <th class="py-2 pr-4">Aksi</th>
                                </tr>
                            </thead>
                            <tbody>
                                <% (packages || []).forEach(function(pkg){ %>
                                    <tr class="border-t border-slate-100">
                                        <td class="py-2 pr-4 font-medium">
                                            <div class="flex items-center gap-2">
                                                <span>
                                                    <%= pkg.name %>
                                                </span>
                                                <button type="button" onclick="copyToClipboard('<%= pkg.name %>')"
                                                    class="text-slate-400 hover:text-blue-600 transition-colors"
                                                    title="Copy Packet Name">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none"
                                                        viewBox="0 0 24 24" stroke="currentColor">
                                                        <path stroke-linecap="round" stroke-linejoin="round"
                                                            stroke-width="2"
                                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                                    </svg>
                                                </button>
                                            </div>
                                        </td>
                                        <!-- Removed Parent Upload/Download TDs -->
                                        <td class="py-2 pr-4">
                                            <%= pkg.max_limit_upload %>
                                        </td>
                                        <td class="py-2 pr-4">
                                            <%= pkg.max_limit_download %>
                                        </td>
                                        <td class="py-2 pr-4">
                                            <span class="px-2 py-1 text-xs rounded bg-blue-100 text-blue-700">
                                                <%= pkg.max_clients || 1 %>
                                            </span>
                                        </td>
                                        <td class="py-2 pr-4">
                                            <span
                                                class="px-2 py-1 text-xs rounded <%= (pkg.current_clients || 0) >= (pkg.max_clients || 1) ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700' %>">
                                                <%= pkg.current_clients || 0 %>/<%= pkg.max_clients || 1 %>
                                            </span>
                                        </td>
                                        <!-- Removed Child Upload/Download TDs -->
                                        <td class="py-2 pr-4">
                                            <span class="px-2 py-1 text-xs rounded bg-purple-100 text-purple-700">
                                                <%= pkg.shared_upload_limit || pkg.max_limit_upload %>
                                            </span>
                                        </td>
                                        <td class="py-2 pr-4">
                                            <span class="px-2 py-1 text-xs rounded bg-purple-100 text-purple-700">
                                                <%= pkg.shared_download_limit || pkg.max_limit_download %>
                                            </span>
                                        </td>
                                        <td class="py-2 pr-4">Rp <%= Number(pkg.price).toLocaleString('id-ID') %>
                                        </td>

                                        <td class="py-2 pr-4">
                                            <span
                                                class="px-2 py-1 text-xs rounded <%= pkg.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-700' %>">
                                                <%= pkg.status==='active' ? 'Aktif' : 'Nonaktif' %>
                                            </span>
                                        </td>
                                        <td class="py-2 pr-4">
                                            <div class="flex flex-wrap gap-2">
                                                <form action="/packages/static-ip/<%= pkg.id %>/create-queues"
                                                    method="POST" class="inline"
                                                    onsubmit="return confirm('Sync Queue Parent ke MikroTik?');">
                                                    <button type="submit"
                                                        class="px-2 py-1 text-xs rounded border border-blue-300 text-blue-700 hover:bg-blue-50 inline-block"
                                                        title="Sync Parent Queue (Simple Queue)">
                                                        Sync Queue
                                                    </button>
                                                </form>
                                                <a href="/packages/static-ip/<%= pkg.id %>/clients"
                                                    class="px-2 py-1 text-xs rounded border border-green-300 text-green-700 hover:bg-green-50 inline-block">
                                                    Client
                                                </a>
                                                <a href="/packages/static-ip/<%= pkg.id %>/edit"
                                                    class="px-2 py-1 text-xs rounded border border-slate-300 text-slate-700 hover:bg-slate-50 inline-block">
                                                    Edit
                                                </a>
                                                <button type="button"
                                                    class="px-2 py-1 text-xs rounded border border-rose-300 text-rose-700 hover:bg-rose-50 btn-delete"
                                                    data-id="<%= pkg.id %>" data-name="<%= pkg.name %>"
                                                    data-child-upload="<%= pkg.child_upload_name %>"
                                                    data-child-download="<%= pkg.child_download_name %>">
                                                    Hapus Paket
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                    <% }) %>
                                        <% if (!packages || packages.length===0) { %>
                                            <tr>
                                                <td colspan="14" class="py-6 text-center text-slate-500">Belum ada
                                                    paket.
                                                    Klik "Tambah Paket" untuk membuat paket baru.</td>
                                            </tr>
                                            <% } %>
                            </tbody>
                        </table>
                    </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl max-w-md w-full mx-4 overflow-hidden">
        <div class="px-6 py-4 bg-gradient-to-r from-red-500 to-rose-500 text-white">
            <h3 class="text-lg font-bold">⚠️ Konfirmasi Hapus</h3>
        </div>
        <div class="p-6">
            <p class="text-slate-700 mb-4">
                Anda akan menghapus paket: <br>
                <strong class="text-lg" id="deletePackageName">-</strong>
            </p>

            <div class="bg-slate-50 rounded-lg p-4 mb-4">
                <label class="flex items-start gap-3 cursor-pointer">
                    <input type="checkbox" id="deleteQueuesCheckbox"
                        class="w-5 h-5 mt-0.5 rounded border-slate-300 text-red-600 focus:ring-red-500">
                    <div>
                        <span class="font-semibold text-slate-800">Hapus Queue Tree di MikroTik</span>
                        <p class="text-sm text-slate-500 mt-1">
                            Jika dicentang, queue berikut akan dihapus dari MikroTik:
                        </p>
                        <ul class="text-sm text-slate-600 mt-2 space-y-1" id="queueToDeleteList">
                            <li class="flex items-center gap-1">
                                <span class="w-2 h-2 bg-blue-500 rounded-full"></span>
                                Queue Upload: <code class="bg-blue-100 px-1 rounded" id="childUploadQueue">-</code>
                            </li>
                            <li class="flex items-center gap-1">
                                <span class="w-2 h-2 bg-green-500 rounded-full"></span>
                                Queue Download: <code class="bg-green-100 px-1 rounded" id="childDownloadQueue">-</code>
                            </li>
                        </ul>
                    </div>
                </label>
            </div>

            <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 text-sm text-amber-800">
                <strong>⚠️ Peringatan:</strong> Data yang dihapus tidak dapat dikembalikan!
            </div>
        </div>
        <div class="px-6 py-4 bg-slate-50 flex justify-end gap-3">
            <button type="button" id="cancelDelete"
                class="px-4 py-2 rounded-lg border border-slate-300 text-slate-700 hover:bg-slate-100 font-medium">
                Batal
            </button>
            <button type="button" id="confirmDelete"
                class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 font-medium flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                    </path>
                </svg>
                Hapus Paket
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const modal = document.getElementById('deleteModal');
        const cancelBtn = document.getElementById('cancelDelete');
        const confirmBtn = document.getElementById('confirmDelete');
        const deleteQueuesCheckbox = document.getElementById('deleteQueuesCheckbox');
        let currentPackageId = null;

        // Open modal on delete button click
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.addEventListener('click', function () {
                currentPackageId = this.dataset.id;
                document.getElementById('deletePackageName').textContent = this.dataset.name;
                document.getElementById('childUploadQueue').textContent = this.dataset.childUpload || '-';
                document.getElementById('childDownloadQueue').textContent = this.dataset.childDownload || '-';
                deleteQueuesCheckbox.checked = false;
                modal.classList.remove('hidden');
            });
        });

        // Close modal
        cancelBtn.addEventListener('click', function () {
            modal.classList.add('hidden');
            currentPackageId = null;
        });

        // Click outside to close
        modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                modal.classList.add('hidden');
                currentPackageId = null;
            }
        });

        // Confirm delete
        confirmBtn.addEventListener('click', async function () {
            if (!currentPackageId) return;

            const deleteQueues = deleteQueuesCheckbox.checked;
            const originalContent = confirmBtn.innerHTML;

            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Menghapus...';

            try {
                const response = await fetch(`/api/packages/static-ip/${currentPackageId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ deleteQueues: deleteQueues })
                });

                const result = await response.json();

                if (result.success) {
                    alert('✅ ' + result.message);
                    window.location.reload();
                } else {
                    alert('❌ Gagal: ' + result.message);
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = originalContent;
                }
            } catch (err) {
                alert('❌ Terjadi kesalahan: ' + err.message);
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalContent;
            }
        });
    });

    function copyToClipboard(text) {
        if (!text) return;
        navigator.clipboard.writeText(text).then(() => {
            // Optional: Show toast or tooltip
            // alert('Copied: ' + text); 
            // Better UX: change icon temporarily
        }).catch(err => {
            console.error('Failed to copy text: ', err);
        });
    }
</script>