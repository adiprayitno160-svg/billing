<div class="space-y-6">
	<!-- Recent Monitoring Alerts (NEW) -->
	<% if (typeof recentAlerts !=='undefined' && recentAlerts.length> 0) { %>
		<div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-xl shadow-md animate-pulse">
			<div class="flex items-center justify-between">
				<div class="flex items-center">
					<div class="flex-shrink-0">
						<svg class="h-6 w-6 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
							<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
								d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
						</svg>
					</div>
					<div class="ml-3">
						<p class="text-sm font-bold text-red-800">
							Gangguan Baru Terdeteksi! (<%= recentAlerts.length %> Perangkat Offline)
						</p>
						<div class="text-xs text-red-700 mt-1">
							<% recentAlerts.slice(0, 3).forEach(alert=> { %>
								<span class="font-semibold">
									<%= alert.customer_name || alert.device_name %>
								</span> (<%= alert.device_type %>)
									sejak <%= new Date(alert.timestamp).toLocaleTimeString('id-ID') %>;
										<% }) %>
											<% if (recentAlerts.length> 3) { %> ...dan <%= recentAlerts.length - 3 %>
													lainnya <% } %>
						</div>
					</div>
				</div>
				<div>
					<a href="/monitoring/trouble"
						class="bg-red-600 text-white px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-700 transition">Detail</a>
				</div>
			</div>
		</div>
		<% } %>

			<!-- KPI Cards - Modern Grid Design -->
			<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 md:gap-4">
				<!-- Total Pelanggan -->
				<div class="bg-gradient-to-br from-indigo-500 via-purple-600 to-purple-700 rounded-xl p-4 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 text-white text-center border border-white/70"
					style="background: linear-gradient(135deg, #6366f1 0%, #9333ea 50%, #7c3aed 100%) !important;">
					<div class="flex items-center justify-center gap-2 mb-3">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" viewBox="0 0 24 24"
							fill="none" stroke="currentColor" stroke-width="2.5">
							<path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
							<circle cx="9" cy="7" r="4" />
							<path d="M23 21v-2a4 4 0 00-3-3.87" />
							<path d="M16 3.13a4 4 0 010 7.75" />
						</svg>
					</div>
					<div class="text-2xl md:text-3xl font-bold leading-none mb-2 tracking-tight">
						<%= stats.totalCustomers %>
					</div>
					<div class="text-xs opacity-90 font-semibold uppercase tracking-wide">Total</div>
				</div>

				<!-- Pelanggan Aktif -->
				<div class="bg-gradient-to-br from-teal-500 via-emerald-500 to-green-600 rounded-xl p-4 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 text-white text-center border border-white/70"
					style="background: linear-gradient(135deg, #14b8a6 0%, #10b981 50%, #16a34a 100%) !important;">
					<div class="flex items-center justify-center gap-2 mb-3">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" viewBox="0 0 24 24"
							fill="none" stroke="currentColor" stroke-width="2.5">
							<path d="M22 11.08V12a10 10 0 11-5.93-9.14" />
							<polyline points="22 4 12 14.01 9 11.01" />
						</svg>
					</div>
					<div class="text-2xl md:text-3xl font-bold leading-none mb-2 tracking-tight">
						<%= stats.activeCustomers %>
					</div>
					<div class="text-xs opacity-90 font-semibold uppercase tracking-wide">Aktif</div>
				</div>

				<!-- PPPoE -->
				<div class="bg-gradient-to-br from-blue-400 via-cyan-400 to-cyan-500 rounded-xl p-4 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 text-white text-center border border-white/70"
					style="background: linear-gradient(135deg, #60a5fa 0%, #22d3ee 50%, #06b6d4 100%) !important;">
					<div class="flex items-center justify-center gap-2 mb-3">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" viewBox="0 0 24 24"
							fill="none" stroke="currentColor" stroke-width="2.5">
							<rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
							<path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16" />
						</svg>
					</div>
					<div class="text-2xl md:text-3xl font-bold leading-none mb-2 tracking-tight">
						<%= stats.pppoeCustomers %>
					</div>
					<div class="text-xs opacity-90 font-semibold uppercase tracking-wide">PPPoE</div>
				</div>

				<!-- IP Static -->
				<div class="bg-gradient-to-br from-pink-400 via-rose-500 to-amber-500 rounded-xl p-4 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 text-white text-center border border-white/70"
					style="background: linear-gradient(135deg, #f472b6 0%, #f43f5e 50%, #f59e0b 100%) !important;">
					<div class="flex items-center justify-center gap-2 mb-3">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" viewBox="0 0 24 24"
							fill="none" stroke="currentColor" stroke-width="2.5">
							<rect x="2" y="2" width="20" height="8" rx="2" ry="2" />
							<rect x="2" y="14" width="20" height="8" rx="2" ry="2" />
							<line x1="6" y1="6" x2="6.01" y2="6" />
							<line x1="6" y1="18" x2="6.01" y2="18" />
						</svg>
					</div>
					<div class="text-2xl md:text-3xl font-bold leading-none mb-2 tracking-tight">
						<%= stats.staticIpCustomers %>
					</div>
					<div class="text-xs opacity-90 font-semibold uppercase tracking-wide">Static IP</div>
				</div>

				<!-- Isolir -->
				<div class="bg-gradient-to-br from-fuchsia-400 via-pink-500 to-red-500 rounded-xl p-4 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 text-white text-center border border-white/70"
					style="background: linear-gradient(135deg, #e879f9 0%, #ec4899 50%, #ef4444 100%) !important;">
					<div class="flex items-center justify-center gap-2 mb-3">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" viewBox="0 0 24 24"
							fill="none" stroke="currentColor" stroke-width="2.5">
							<circle cx="12" cy="12" r="10" />
							<line x1="4.93" y1="4.93" x2="19.07" y2="19.07" />
						</svg>
					</div>
					<div class="text-2xl md:text-3xl font-bold leading-none mb-2 tracking-tight">
						<%= stats.suspendedCustomers %>
					</div>
					<div class="text-xs opacity-90 font-semibold uppercase tracking-wide">Isolir</div>
				</div>

				<!-- Nonaktif -->
				<div class="bg-gradient-to-br from-gray-400 via-slate-500 to-gray-600 rounded-xl p-4 shadow-xl hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-1 text-white text-center border border-gray-500"
					style="background: linear-gradient(135deg, #9ca3af 0%, #64748b 50%, #4b5563 100%) !important;">
					<div class="flex items-center justify-center gap-2 mb-3">
						<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 opacity-90" viewBox="0 0 24 24"
							fill="none" stroke="currentColor" stroke-width="2.5">
							<path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9" />
							<path d="M13.73 21a2 2 0 01-3.46 0" />
						</svg>
					</div>
					<div class="text-2xl md:text-3xl font-bold leading-none mb-2 tracking-tight text-white">
						<%= stats.inactiveCustomers %>
					</div>
					<div class="text-xs opacity-90 font-semibold uppercase tracking-wide text-white">Nonaktif</div>
				</div>


			</div>




			<!-- MikroTik Status, Server Monitoring & Interface Speed -->
			<div class="grid gap-6 grid-cols-1 lg:grid-cols-3">
				<!-- Status MikroTik (Kiri) -->
				<% if (typeof settings !=='undefined' && settings) { %>
					<div class="bg-white border border-gray-300 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300"
						style="background-color: #ffffff !important; border: 2px solid #d1d5db !important;">
						<div class="flex items-center justify-between mb-4">
							<h2 class="text-lg font-semibold text-gray-900">Status MikroTik</h2>
							<span id="mt-connection-status"
								class="inline-flex items-center rounded-full bg-gray-100 px-3 py-1 text-sm text-gray-800">
								<span class="h-2 w-2 rounded-full bg-gray-400 mr-2 animate-pulse"></span>
								Connecting...
							</span>
						</div>
						<div class="grid grid-cols-2 gap-3" id="mt-info-grid">
							<div class="bg-gray-50 rounded-lg p-3">
								<div class="text-xs text-gray-600 font-medium">Identity</div>
								<div class="text-sm font-bold text-gray-900 truncate" id="mt-identity">-</div>
							</div>
							<div class="bg-gray-50 rounded-lg p-3">
								<div class="text-xs text-gray-600 font-medium">Version</div>
								<div class="text-sm font-bold text-gray-900" id="mt-version">-</div>
							</div>
							<div class="bg-gray-50 rounded-lg p-3">
								<div class="text-xs text-gray-600 font-medium">Uptime</div>
								<div class="text-sm font-bold text-gray-900" id="mt-uptime">-</div>
							</div>
							<div class="bg-gray-50 rounded-lg p-3">
								<div class="text-xs text-gray-600 font-medium">CPU Load</div>
								<div class="text-sm font-bold text-gray-900" id="mt-cpu-load">-</div>
							</div>
							<div class="bg-gray-50 rounded-lg p-3">
								<div class="text-xs text-gray-600 font-medium">Board</div>
								<div class="text-sm font-bold text-gray-900" id="mt-board">-</div>
							</div>
							<div class="bg-gray-50 rounded-lg p-3">
								<div class="text-xs text-gray-600 font-medium">CPU</div>
								<div class="text-sm font-bold text-gray-900" id="mt-cpu">-</div>
							</div>
						</div>
					</div>

					<script>
						document.addEventListener('DOMContentLoaded', function () {
							const statusEl = document.getElementById('mt-connection-status');

							fetch('/api/mikrotik/info')
								.then(response => response.json())
								.then(data => {
									if (data.ok && data.info) {
										// Update Status Badge
										statusEl.className = 'inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-sm text-green-800';
										statusEl.innerHTML = '<span class="h-2 w-2 rounded-full bg-green-400 mr-2"></span>Terhubung';

										// Update Fields
										document.getElementById('mt-identity').textContent = data.info.identity || '-';
										document.getElementById('mt-version').textContent = data.info.version || '-';
										document.getElementById('mt-uptime').textContent = data.info.uptime || '-';
										document.getElementById('mt-cpu-load').textContent = (data.info.cpuLoad || '-') + '%';
										document.getElementById('mt-board').textContent = data.info['board-name'] || '-';
										document.getElementById('mt-cpu').textContent = data.info.cpu || '-';
									} else {
										throw new Error(data.error || 'Failed to connect');
									}
								})
								.catch(err => {
									console.error('Mikrotik Info Error:', err);
									statusEl.className = 'inline-flex items-center rounded-full bg-red-100 px-3 py-1 text-sm text-red-800';
									statusEl.innerHTML = '<span class="h-2 w-2 rounded-full bg-red-400 mr-2"></span>Terputus';
								});
						});
					</script>
					<% } else { %>
						<div class="bg-white border border-gray-300 rounded-2xl p-6 shadow-xl"
							style="background-color: #ffffff !important; border: 2px solid #d1d5db !important;">
							<h2 class="text-lg font-semibold text-gray-900 mb-4">Status MikroTik</h2>
							<div class="text-center py-8">
								<p class="text-gray-500 mb-3">MikroTik belum dikonfigurasi</p>
								<a href="/settings/mikrotik"
									class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors duration-200 text-sm font-medium shadow-md hover:shadow-lg">Konfigurasi
									Sekarang</a>
							</div>
						</div>
						<% } %>

							<!-- Server Monitoring (Tengah) -->
							<% if (typeof serverMonitoring !=='undefined' && serverMonitoring) { %>
								<div class="bg-white border border-gray-300 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300"
									style="background-color: #ffffff !important; border: 2px solid #d1d5db !important;">
									<div class="flex items-center justify-between mb-4">
										<h2 class="text-lg font-semibold text-gray-900">Monitoring Server</h2>
										<% if (serverMonitoring.server.status==='online' ) { %>
											<span
												class="inline-flex items-center rounded-full bg-green-100 px-3 py-1 text-sm text-green-800">
												<span
													class="h-2 w-2 rounded-full bg-green-400 mr-2 animate-pulse"></span>
												Online
											</span>
											<% } else { %>
												<span
													class="inline-flex items-center rounded-full bg-red-100 px-3 py-1 text-sm text-red-800">
													<span class="h-2 w-2 rounded-full bg-red-400 mr-2"></span>
													Offline
												</span>
												<% } %>
									</div>
									<div class="grid grid-cols-2 gap-3">
										<div class="bg-gray-50 rounded-lg p-3">
											<div class="text-xs text-gray-600 font-medium">CPU Load (1m)</div>
											<div class="text-sm font-bold text-gray-900">
												<% const cpuLoadPercent=serverMonitoring.server.cpu.loadPercent || 0;
													const cpuColor=cpuLoadPercent> 80 ? 'text-red-600' : cpuLoadPercent
													> 60 ?
													'text-yellow-600' : 'text-green-600';
													%>
													<span class="<%= cpuColor %>">
														<%= cpuLoadPercent.toFixed(1) %>%
													</span>
											</div>
										</div>
										<div class="bg-gray-50 rounded-lg p-3">
											<div class="text-xs text-gray-600 font-medium">CPU Cores</div>
											<div class="text-sm font-bold text-gray-900">
												<%= serverMonitoring.server.cpu.cores %>
											</div>
										</div>
										<div class="bg-gray-50 rounded-lg p-3">
											<div class="text-xs text-gray-600 font-medium">Memory Usage</div>
											<div class="text-sm font-bold text-gray-900">
												<% const
													memPercent=serverMonitoring.server.memory.usagePercent.toFixed(1);
													const memColor=memPercent> 80 ? 'text-red-600' : memPercent > 60 ?
													'text-yellow-600' : 'text-green-600';
													%>
													<span class="<%= memColor %>">
														<%= memPercent %>%
													</span>
											</div>
										</div>
										<div class="bg-gray-50 rounded-lg p-3">
											<div class="text-xs text-gray-600 font-medium">Memory Used</div>
											<div class="text-sm font-bold text-gray-900">
												<% const memUsedGB=(serverMonitoring.server.memory.used / (1024 * 1024 *
													1024)).toFixed(2); const
													memTotalGB=(serverMonitoring.server.memory.total / (1024 * 1024 *
													1024)).toFixed(2); %>
													<%= memUsedGB %> / <%= memTotalGB %> GB
											</div>
										</div>
										<div class="bg-gray-50 rounded-lg p-3">
											<div class="text-xs text-gray-600 font-medium">Server Uptime</div>
											<div class="text-sm font-bold text-gray-900">
												<%= serverMonitoring.server.uptime %>
											</div>
										</div>
										<div class="bg-gray-50 rounded-lg p-3">
											<div class="text-xs text-gray-600 font-medium">Database</div>
											<div
												class="text-sm font-bold <%= serverMonitoring.database.connected ? 'text-green-600' : 'text-red-600' %>">
												<%= serverMonitoring.database.connected ? 'Connected' : 'Disconnected'
													%>
											</div>
										</div>
									</div>
									<div class="mt-4 pt-4 border-t border-gray-200">
										<div class="flex items-center justify-between text-xs">
											<div class="text-gray-600">
												<span class="font-medium">Platform:</span>
												<%= serverMonitoring.server.platform %>
											</div>
											<div class="text-gray-600">
												<span class="font-medium">Node:</span>
												<%= serverMonitoring.server.nodeVersion %>
											</div>
										</div>
										<div class="mt-2 flex items-center justify-between text-xs">
											<div class="text-gray-600">
												<span class="font-medium">System Health:</span>
												<% if (serverMonitoring.systemHealth.overall_status==='healthy' ) { %>
													<span class="text-green-600 font-semibold">Healthy</span>
													<% } else if
														(serverMonitoring.systemHealth.overall_status==='warning' ) { %>
														<span class="text-yellow-600 font-semibold">Warning</span>
														<% } else { %>
															<span class="text-red-600 font-semibold">Unhealthy</span>
															<% } %>
											</div>
											<div class="text-gray-500">
												Last check: <%= new
													Date(serverMonitoring.lastCheck).toLocaleTimeString('id-ID') %>
											</div>
										</div>
									</div>
								</div>
								<% } else { %>
									<div class="bg-white border border-gray-300 rounded-2xl p-6 shadow-xl"
										style="background-color: #ffffff !important; border: 2px solid #d1d5db !important;">
										<h2 class="text-lg font-semibold text-gray-900 mb-4">Monitoring Server</h2>
										<div class="text-center py-8">
											<p class="text-gray-500 mb-3">Data monitoring tidak tersedia</p>
										</div>
									</div>
									<% } %>

										<!-- Interface Traffic Realtime (New & Improved) -->
										<div class="bg-white border border-gray-300 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300 lg:col-span-1"
											style="background-color: #ffffff !important; border: 2px solid #d1d5db !important;">

											<div class="flex items-center justify-between mb-2">
												<h2 class="text-lg font-semibold text-gray-900">Live Traffic</h2>
												<% if (typeof interfaces !=='undefined' && interfaces &&
													interfaces.length> 0) {
													%>
													<div class="flex flex-col items-end gap-1">
														<!-- Toggle Switch -->
														<div class="flex items-center gap-2"
															title="Enable/Disable Live Traffic">
															<span class="text-xs text-gray-500 font-medium">Live
																Update</span>
															<label for="liveTrafficToggle"
																class="flex items-center cursor-pointer relative mb-0">
																<input type="checkbox" id="liveTrafficToggle"
																	class="sr-only">
																<div
																	class="toggle-bg bg-gray-200 border-2 border-gray-200 h-4 w-8 rounded-full transition-colors duration-200 ease-in-out">
																</div>
																<div
																	class="toggle-dot absolute left-0.5 top-0.5 bg-white border border-gray-300 h-3 w-3 rounded-full shadow transition-transform duration-200 ease-in-out">
																</div>
															</label>
														</div>

														<style>
															#liveTrafficToggle:checked+.toggle-bg {
																background-color: #10b981;
																border-color: #10b981;
															}

															#liveTrafficToggle:checked+.toggle-bg+.toggle-dot {
																transform: translateX(100%);
																border-color: white;
															}

															#liveTrafficToggle:not(:checked)+.toggle-bg {
																background-color: #e5e7eb;
																border-color: #d1d5db;
															}

															/* Adjust translate for small size */
															#liveTrafficToggle:checked+.toggle-bg+.toggle-dot {
																transform: translateX(100%);
															}
														</style>

														<select id="interfaceSelect"
															class="text-xs border-gray-300 rounded-md shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 w-28 truncate cursor-pointer py-1">
															<% interfaces.forEach(function(iface) { %>
																<option value="<%= iface.name %>">
																	<%= iface.name %>
																</option>
																<% }); %>
														</select>
													</div>
													<% } %>
											</div>

											<hr class="mb-4 border-gray-100">

											<% if (typeof interfaces !=='undefined' && interfaces && interfaces.length>
												0) { %>
												<div class="relative h-56 w-full">
													<canvas id="trafficChart"></canvas>
													<div id="trafficLoading"
														class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 z-10">
														<div class="text-center text-gray-500 text-sm">
															<svg class="animate-spin h-8 w-8 text-blue-500 mx-auto mb-2"
																xmlns="http://www.w3.org/2000/svg" fill="none"
																viewBox="0 0 24 24">
																<circle class="opacity-25" cx="12" cy="12" r="10"
																	stroke="currentColor" stroke-width="4"></circle>
																<path class="opacity-75" fill="currentColor"
																	d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
																</path>
															</svg>
															Memuat data...
														</div>
													</div>
												</div>

												<div class="grid grid-cols-2 gap-4 mt-4 text-center">
													<div class="bg-blue-50 rounded-lg p-2 border border-blue-100">
														<div
															class="text-xs text-blue-600 font-medium uppercase tracking-wider">
															Download (RX)</div>
														<div id="rxSpeed" class="text-lg font-bold text-blue-700">0 bps
														</div>
													</div>
													<div class="bg-green-50 rounded-lg p-2 border border-green-100">
														<div
															class="text-xs text-green-600 font-medium uppercase tracking-wider">
															Upload (TX)</div>
														<div id="txSpeed" class="text-lg font-bold text-green-700">0 bps
														</div>
													</div>
												</div>

												<script
													src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
												<script>
													document.addEventListener('DOMContentLoaded', function () {
														const ctx = document.getElementById('trafficChart').getContext('2d');
														const select = document.getElementById('interfaceSelect');
														const loading = document.getElementById('trafficLoading');
														const rxDisplay = document.getElementById('rxSpeed');
														const txDisplay = document.getElementById('txSpeed');

														let chart;
														let pollInterval;
														let previousData = { rx: 0, tx: 0 };
														let lastTime = Date.now();

														// Smoothing variables (Exponential Moving Average)
														const EMA_ALPHA = 0.3; // Smoothing factor (0.1 = very smooth, 0.5 = responsive)
														let smoothedRx = 0;
														let smoothedTx = 0;
														let isFirstReading = true;
														let isPaused = false;

														// Toggle Checkbox
														const toggleCheckbox = document.getElementById('liveTrafficToggle');

														if (toggleCheckbox) {
															// 1. Read from LocalStorage
															const savedState = localStorage.getItem('dashboardLiveTrafficEnabled');

															// 2. Set initial state (default to true if null)
															if (savedState !== 'false') {
																toggleCheckbox.checked = true; // default to ON if not explicitly 'false'
															}

															// 3. Sync internal variable immediately
															isPaused = !toggleCheckbox.checked;

															// 4. Update on change
															toggleCheckbox.addEventListener('change', function () {
																isPaused = !this.checked;
																localStorage.setItem('dashboardLiveTrafficEnabled', this.checked);
															});
														}

														function formatSpeed(bits) {
															if (bits >= 1000000000) return (bits / 1000000000).toFixed(2) + ' Gbps';
															if (bits >= 1000000) return (bits / 1000000).toFixed(2) + ' Mbps';
															if (bits >= 1000) return (bits / 1000).toFixed(2) + ' Kbps';
															return bits.toFixed(0) + ' bps';
														}

														function initChart() {
															chart = new Chart(ctx, {
																type: 'line',
																data: {
																	labels: Array(20).fill(''),
																	datasets: [
																		{
																			label: 'Download (RX)',
																			data: Array(20).fill(0),
																			borderColor: '#2563eb', // Blue-600
																			backgroundColor: 'rgba(37, 99, 235, 0.1)',
																			borderWidth: 2,
																			fill: true,
																			tension: 0.4,
																			pointRadius: 0
																		},
																		{
																			label: 'Upload (TX)',
																			data: Array(20).fill(0),
																			borderColor: '#16a34a', // Green-600
																			backgroundColor: 'rgba(22, 163, 74, 0.05)',
																			borderWidth: 2,
																			borderDash: [5, 5],
																			fill: true,
																			tension: 0.4,
																			pointRadius: 0
																		}
																	]
																},
																options: {
																	responsive: true,
																	maintainAspectRatio: false,
																	animation: {
																		duration: 750, // Smooth animation
																		easing: 'easeOutQuart'
																	},
																	interaction: {
																		mode: 'index',
																		intersect: false,
																	},
																	plugins: {
																		legend: { display: false },
																		tooltip: {
																			callbacks: {
																				label: function (context) {
																					return context.dataset.label + ': ' + formatSpeed(context.parsed.y);
																				}
																			}
																		}
																	},
																	scales: {
																		y: {
																			beginAtZero: true,
																			ticks: {
																				callback: function (value) {
																					return formatSpeed(value);
																				}
																			},
																			grid: {
																				color: 'rgba(0, 0, 0, 0.05)'
																			}
																		},
																		x: {
																			display: false
																		}
																	}
																}
															});
														}

														async function updateTraffic() {
															if (!select || isPaused) return;
															const ifaceName = select.value;

															try {
																const response = await fetch('/api/interface-stats');
																if (!response.ok) throw new Error('Network error');
																const data = await response.json();

																const iface = data.find(i => i.name === ifaceName);
																if (!iface) return;

																const currentTime = Date.now();
																const timeDiff = (currentTime - lastTime) / 1000; // seconds
																if (timeDiff <= 0) return;

																// Ensure numeric values
																const currentRx = parseInt(iface['rx-byte'] || iface.rxByte || 0);
																const currentTx = parseInt(iface['tx-byte'] || iface.txByte || 0);

																// Calculate speed (bits per second)
																// (Current Bytes - Previous Bytes) * 8 / Time Difference
																// Handle counter wrap or initial run where pervious is 0
																let rawRxSpeed = 0;
																let rawTxSpeed = 0;

																if (previousData.rx > 0 && currentRx >= previousData.rx) {
																	rawRxSpeed = ((currentRx - previousData.rx) * 8) / timeDiff;
																}
																if (previousData.tx > 0 && currentTx >= previousData.tx) {
																	rawTxSpeed = ((currentTx - previousData.tx) * 8) / timeDiff;
																}

																// Apply Exponential Moving Average for smoothing
																if (isFirstReading && (rawRxSpeed > 0 || rawTxSpeed > 0)) {
																	smoothedRx = rawRxSpeed;
																	smoothedTx = rawTxSpeed;
																	isFirstReading = false;
																} else {
																	// EMA formula: smoothed = alpha * current + (1 - alpha) * previous
																	smoothedRx = EMA_ALPHA * rawRxSpeed + (1 - EMA_ALPHA) * smoothedRx;
																	smoothedTx = EMA_ALPHA * rawTxSpeed + (1 - EMA_ALPHA) * smoothedTx;
																}

																// Update Display with smoothed values
																rxDisplay.textContent = formatSpeed(smoothedRx);
																txDisplay.textContent = formatSpeed(smoothedTx);

																// Update Chart
																if (chart) {
																	// Shift old data
																	chart.data.labels.shift();
																	chart.data.labels.push('');

																	chart.data.datasets[0].data.shift();
																	chart.data.datasets[0].data.push(smoothedRx);

																	chart.data.datasets[1].data.shift();
																	chart.data.datasets[1].data.push(smoothedTx);

																	chart.update(); // Use default animation
																}

																// Store current as previous
																previousData.rx = currentRx;
																previousData.tx = currentTx;
																lastTime = currentTime;

																// Hide loading once we have data
																if (loading) loading.style.display = 'none';

															} catch (e) {
																console.error('Traffic update error:', e);
															}
														}

														// Initialize
														if (typeof Chart !== 'undefined') {
															initChart();
															// Initial data fetch immediately, then interval
															updateTraffic();
															pollInterval = setInterval(updateTraffic, 3000);
														} else {
															console.error('Chart.js not loaded');
															if (loading) loading.innerHTML = '<span class="text-red-500">Gagal memuat library grafik</span>';
														}

														// Reset chart data when interface changes
														select.addEventListener('change', function () {
															if (loading) loading.style.display = 'flex';
															previousData = { rx: 0, tx: 0 }; // Reset counter baseline
															smoothedRx = 0;
															smoothedTx = 0;
															isFirstReading = true;
															if (chart) {
																chart.data.datasets[0].data = Array(20).fill(0);
																chart.data.datasets[1].data = Array(20).fill(0);
																chart.update();
															}
														});
													});
												</script>
												<% } else { %>
													<div
														class="h-40 flex flex-col items-center justify-center text-gray-400">
														<svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mb-2"
															fill="none" viewBox="0 0 24 24" stroke="currentColor">
															<path stroke-linecap="round" stroke-linejoin="round"
																stroke-width="2"
																d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
														</svg>
														<span class="text-sm">Data interface tidak tersedia</span>
													</div>
													<% } %>
										</div>
			</div>

			<!-- Monitor Pelanggan Trouble -->
			<div class="bg-white border border-gray-300 rounded-2xl p-6 shadow-xl hover:shadow-2xl transition-all duration-300"
				style="background-color: #ffffff !important; border: 2px solid #d1d5db !important;">
				<div class="flex items-center justify-between mb-4">
					<h2 class="text-lg font-semibold text-gray-900">Monitor Pelanggan Trouble</h2>
					<a href="/monitoring/trouble" class="text-sm text-blue-600 hover:text-blue-800">Lihat Semua</a>
				</div>
				<div class="overflow-x-auto">
					<table class="min-w-full text-sm">
						<thead>
							<tr class="text-left text-gray-600 border-b border-gray-200">
								<th class="py-3 pr-4 font-medium">Kode</th>
								<th class="py-3 pr-4 font-medium">Nama Pelanggan</th>
								<th class="py-3 pr-4 font-medium">Username</th>
								<th class="py-3 pr-4 font-medium">Tipe</th>
								<th class="py-3 pr-4 font-medium">Issue</th>
								<th class="py-3 pr-4 font-medium">Status</th>
								<th class="py-3 pr-4 font-medium">Sejak</th>
							</tr>
						</thead>
						<tbody>
							<% if (typeof troubleCustomers !=='undefined' && troubleCustomers &&
								troubleCustomers.length> 0) {
								%>
								<% troubleCustomers.forEach(function(customer) { %>
									<tr class="border-b border-gray-100 hover:bg-gray-50">
										<td class="py-3 pr-4 text-gray-800 font-medium">
											<%= customer.customer_code || '-' %>
										</td>
										<td class="py-3 pr-4 text-gray-900">
											<%= customer.name %>
										</td>
										<td class="py-3 pr-4 text-gray-600">
											<%= customer.pppoe_username || '-' %>
										</td>
										<td class="py-3 pr-4">
											<% if (customer.connection_type==='pppoe' ) { %>
												<span
													class="inline-flex items-center rounded-full bg-purple-100 px-2 py-1 text-xs text-purple-800">PPPoE</span>
												<% } else if (customer.connection_type==='static_ip' ) { %>
													<span
														class="inline-flex items-center rounded-full bg-indigo-100 px-2 py-1 text-xs text-indigo-800">Static
														IP</span>
													<% } else { %>
														<span
															class="inline-flex items-center rounded-full bg-gray-100 px-2 py-1 text-xs text-gray-800">
															<%= customer.connection_type || '-' %>
														</span>
														<% } %>
										</td>
										<td class="py-3 pr-4 text-gray-600">
											<%= customer.issue_type || '-' %>
										</td>
										<td class="py-3 pr-4">
											<% if (customer.maintenance_status==='in_progress' ) { %>
												<span
													class="inline-flex items-center rounded-full bg-yellow-100 px-2 py-1 text-xs text-yellow-800">Sedang
													Ditangani</span>
												<% } else if (customer.maintenance_status==='scheduled' ) { %>
													<span
														class="inline-flex items-center rounded-full bg-blue-100 px-2 py-1 text-xs text-blue-800">Terjadwal</span>
													<% } else if (customer.issue_type==='Offline' ) { %>
														<span
															class="inline-flex items-center rounded-full bg-red-100 px-2 py-1 text-xs text-red-800">🔴
															Offline</span>
														<% } else if (customer.issue_type &&
															customer.issue_type.startsWith('SLA:')) { %>
															<span
																class="inline-flex items-center rounded-full bg-orange-100 px-2 py-1 text-xs text-orange-800">⚠️
																<%= customer.issue_type %>
															</span>
															<% } else if (customer.status==='active' ) { %>
																<span
																	class="inline-flex items-center rounded-full bg-green-100 px-2 py-1 text-xs text-green-800">Normal</span>
																<% } else if (customer.status==='suspended' ) { %>
																	<span
																		class="inline-flex items-center rounded-full bg-red-100 px-2 py-1 text-xs text-red-800">Isolir</span>
																	<% } else { %>
																		<span
																			class="inline-flex items-center rounded-full bg-gray-100 px-2 py-1 text-xs text-gray-800">
																			<%= customer.status %>
																		</span>
																		<% } %>
										</td>
										<td class="py-3 pr-4 text-gray-600">
											<% if (customer.trouble_since) { %>
												<%= new Date(customer.trouble_since).toLocaleString('id-ID', {
													day: '2-digit' , month: 'short' , year: 'numeric' , hour: '2-digit'
													, minute: '2-digit' }) %>
													<% } else { %>
														-
														<% } %>
										</td>
									</tr>
									<% }) %>
										<% } else { %>
											<tr>
												<td class="py-8 text-center text-gray-500" colspan="7">
													<div class="flex flex-col items-center">
														<svg xmlns="http://www.w3.org/2000/svg"
															class="h-12 w-12 text-gray-400 mb-2" fill="none"
															viewBox="0 0 24 24" stroke="currentColor">
															<path stroke-linecap="round" stroke-linejoin="round"
																stroke-width="2"
																d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
														</svg>
														<p>Tidak ada pelanggan yang mengalami
															trouble</p>
													</div>
												</td>
											</tr>
											<% } %>
						</tbody>
					</table>
				</div>
			</div>

			<script>
				// Dashboard scripts