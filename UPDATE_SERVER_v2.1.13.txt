═══════════════════════════════════════════════════════════════════════════════
  UPDATE SERVER v2.1.13 - FIX CUSTOMER CODE FORMAT
═══════════════════════════════════════════════════════════════════════════════

📌 IMPORTANT: Backup database dulu sebelum update!
┌─────────────────────────────────────────────────────────────────────────────┐
│ ⚠️  Migration ini akan update format customer_code untuk konsistensi        │
└─────────────────────────────────────────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════════════════
🔄 QUICK UPDATE (COPY-PASTE)
═══════════════════════════════════════════════════════════════════════════════

cd /opt/billing && \
git pull origin main && \
npm install && \
npm run build && \
npm install --production && \
pm2 restart billing-app --update-env

# Setelah itu, jalankan migration:
mysql -u root -p billing < migrations/fix_customer_code_format.sql

═══════════════════════════════════════════════════════════════════════════════
📋 DETAILED UPDATE STEPS
═══════════════════════════════════════════════════════════════════════════════

1. Backup Database (WAJIB!):
   ──────────────────────────────────────────────────────────────────────────
   mysqldump -u username -p nama_database > backup_$(date +%Y%m%d_%H%M%S).sql

2. Masuk ke Direktori Aplikasi:
   ──────────────────────────────────────────────────────────────────────────
   cd /opt/billing

3. Git Pull:
   ──────────────────────────────────────────────────────────────────────────
   git pull origin main

4. Install Dependencies:
   ──────────────────────────────────────────────────────────────────────────
   npm install

5. Build TypeScript:
   ──────────────────────────────────────────────────────────────────────────
   npm run build

6. Install Production Dependencies:
   ──────────────────────────────────────────────────────────────────────────
   npm install --production

7. Restart PM2:
   ──────────────────────────────────────────────────────────────────────────
   pm2 restart billing-app --update-env

8. Check Status:
   ──────────────────────────────────────────────────────────────────────────
   pm2 status
   pm2 logs billing-app --lines 50

9. Run Migration (PENTING!):
   ──────────────────────────────────────────────────────────────────────────
   mysql -u username -p database_name < migrations/fix_customer_code_format.sql

═══════════════════════════════════════════════════════════════════════════════
✨ FITUR BARU v2.1.13
═══════════════════════════════════════════════════════════════════════════════

🔧 FIX CUSTOMER CODE FORMAT
─────────────────────────────────────────────────────────────────────────────
✅ Format standar: YYYYMMDDHHMMSS (14 digit)
✅ Auto-generate untuk customer lama yang tidak punya
✅ Konsistensi dengan PPPoE dan Static IP
✅ Excel import otomatis generate format yang benar

🎯 MIGRATION DETAILS:
─────────────────────────────────────────────────────────────────────────────
1. Update customer tanpa customer_code → Generate dari created_at
2. Update customer dengan format tidak valid → Fix ke format YYYYMMDDHHMMSS
3. Semua customer baru otomatis dapat format yang benar
4. Maintain backward compatibility

═══════════════════════════════════════════════════════════════════════════════
⚠️  PENTING UNTUK DIKETAHUI
═══════════════════════════════════════════════════════════════════════════════

BEFORE MIGRATION:
─────────────────────────────────────────────────────────────────────────────
• Check existing data: `SELECT id, customer_code FROM customers WHERE customer_code IS NULL OR LENGTH(customer_code) != 14`
• Pastikan backup database sudah dijalankan
• Verify aplikasi running normal setelah update code

AFTER MIGRATION:
─────────────────────────────────────────────────────────────────────────────
• Verify: `SELECT COUNT(*) FROM customers WHERE customer_code IS NULL OR LENGTH(customer_code) != 14` (should be 0)
• Check customer list masih load normal
• Test create new customer (format auto-generate)

BENEFITS:
─────────────────────────────────────────────────────────────────────────────
✅ Konsistensi data
✅ Customer ID format standardized
✅ Excel import lebih reliable
✅ Easier debugging dan tracking

═══════════════════════════════════════════════════════════════════════════════
🧪 VERIFICATION QUERIES
═══════════════════════════════════════════════════════════════════════════════

Pre-Migration Check:
─────────────────────────────────────────────────────────────────────────────
SELECT COUNT(*) as invalid_count
FROM customers 
WHERE customer_code IS NULL 
   OR customer_code = '' 
   OR LENGTH(customer_code) != 14 
   OR customer_code NOT REGEXP '^[0-9]{14}$';

Post-Migration Verification:
─────────────────────────────────────────────────────────────────────────────
-- Should return 0
SELECT COUNT(*) as invalid_count 
FROM customers 
WHERE customer_code IS NULL 
   OR customer_code = '' 
   OR LENGTH(customer_code) != 14;

Sample Valid Data:
─────────────────────────────────────────────────────────────────────────────
SELECT id, customer_code, name 
FROM customers 
ORDER BY id DESC 
LIMIT 10;

-- Example output:
-- 45 | 20251030120000 | Customer Name

═══════════════════════════════════════════════════════════════════════════════
🚨 TROUBLESHOOTING
═══════════════════════════════════════════════════════════════════════════════

Problem: Migration error - duplicate key
Solution:
─────────────────────────────────────────────────────────────────────────────
1. Check for duplicates: SELECT customer_code, COUNT(*) FROM customers GROUP BY customer_code HAVING COUNT(*) > 1
2. Update duplicates manually dengan different timestamp
3. Re-run migration

Problem: Customer list tidak load
Solution:
─────────────────────────────────────────────────────────────────────────────
1. Check PM2 status: pm2 status
2. Check logs: pm2 logs billing-app --lines 100
3. Verify migration completed: Check verification queries
4. Restart PM2: pm2 restart billing-app

Problem: Excel import masih error
Solution:
─────────────────────────────────────────────────────────────────────────────
1. Check import logs di console browser
2. Verify Excel format sesuai template
3. Check PM2 logs untuk error messages

═══════════════════════════════════════════════════════════════════════════════
📁 FILES CHANGED
═══════════════════════════════════════════════════════════════════════════════

New Files:
─────────────────────────────────────────────────────────────────────────────
✅ migrations/fix_customer_code_format.sql - Migration script
✅ CHANGELOG_v2.1.13.md
✅ UPDATE_SERVER_v2.1.13.txt (file ini)

Modified Behavior:
─────────────────────────────────────────────────────────────────────────────
✅ Excel import otomatis generate customer_code
✅ PPPoE creation uses CustomerIdGenerator
✅ Static IP creation uses CustomerIdGenerator
✅ Consistent format across all customer types

Version Files:
─────────────────────────────────────────────────────────────────────────────
✅ VERSION, VERSION_MAJOR, VERSION_HOTFIX
✅ package.json

═══════════════════════════════════════════════════════════════════════════════
✅ UPDATE SELESAI
═══════════════════════════════════════════════════════════════════════════════

Check Version:
─────────────────────────────────────────────────────────────────────────────
cat VERSION
# Should show: 2.1.13

Check PM2:
─────────────────────────────────────────────────────────────────────────────
pm2 status
pm2 logs billing-app --lines 20

Verify Migration:
─────────────────────────────────────────────────────────────────────────────
mysql -u username -p database_name -e "SELECT COUNT(*) as invalid FROM customers WHERE customer_code IS NULL OR LENGTH(customer_code) != 14;"
# Should return: 0

Test Application:
─────────────────────────────────────────────────────────────────────────────
1. Buka browser
2. Login ke aplikasi
3. Buka customer list
4. Verify semua customer punya customer_code 14 digit
5. Test create new customer

═══════════════════════════════════════════════════════════════════════════════
📞 SUPPORT
═══════════════════════════════════════════════════════════════════════════════

Jika ada masalah:
1. Check log: pm2 logs billing-app
2. Check error messages
3. Verify migration completed
4. Run verification queries
5. Rollback dengan backup jika perlu

═══════════════════════════════════════════════════════════════════════════════

Release: v2.1.13
Date: 30 Oktober 2025
Type: Data Integrity Fix
Status: ✅ Production Ready
Requires Migration: Yes

═══════════════════════════════════════════════════════════════════════════════

